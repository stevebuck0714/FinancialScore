generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Consultant {
  id              String    @id @default(cuid())
  userId          String    @unique
  type            String?
  fullName        String
  address         String?
  phone           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  companyAddress1 String?
  companyAddress2 String?
  companyCity     String?
  companyName     String?
  companyState    String?
  companyWebsite  String?
  companyZip      String?
  companies       Company[]
  teamMembers     User[]    @relation("ConsultantTeamMembers")
  user            User      @relation("PrimaryConsultant", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Company {
  id                         String                 @id @default(cuid())
  name                       String
  consultantId               String
  addressStreet              String?
  addressCity                String?
  addressState               String?
  addressZip                 String?
  addressCountry             String?
  industrySector             Int?
  subscriptionMonthlyPrice   Float?
  subscriptionQuarterlyPrice Float?
  subscriptionAnnualPrice    Float?
  createdAt                  DateTime               @default(now())
  updatedAt                  DateTime               @updatedAt
  selectedSubscriptionPlan   String?
  affiliateCode              String?
  affiliateId                String?
  linesOfBusiness            Json?                  // Array of LOB names defined for this company
  accountMappings            AccountMapping[]
  accountingConnections      AccountingConnection[]
  apiSyncLogs                ApiSyncLog[]
  assessmentRecords          AssessmentRecord[]
  affiliate                  Affiliate?             @relation(fields: [affiliateId], references: [id])
  consultant                 Consultant             @relation(fields: [consultantId], references: [id], onDelete: Cascade)
  profile                    CompanyProfile?
  financialRecords           FinancialRecord[]
  subscription               Subscription?
  users                      User[]

  @@index([consultantId])
  @@index([affiliateId])
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  passwordHash         String
  name                 String
  title                String?
  phone                String?
  role                 UserRole
  userType             UserType?
  companyId            String?
  consultantId         String?
  isPrimaryContact     Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  passwordResetExpires DateTime?
  passwordResetToken   String?            @unique
  backupCodes          String?
  mfaEnabled           Boolean            @default(false)
  mfaSecret            String?
  assessmentRecords    AssessmentRecord[]
  primaryConsultant    Consultant?        @relation("PrimaryConsultant")
  consultantFirm       Consultant?        @relation("ConsultantTeamMembers", fields: [consultantId], references: [id], onDelete: Cascade)
  financialRecords     FinancialRecord[]
  company              Company?           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([companyId])
  @@index([consultantId])
  @@index([passwordResetToken])
}

model FinancialRecord {
  id               String             @id @default(cuid())
  companyId        String
  uploadedByUserId String
  fileName         String
  fileUrl          String?
  rawData          Json
  columnMapping    Json
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  company          Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploadedBy       User               @relation(fields: [uploadedByUserId], references: [id])
  monthlyData      MonthlyFinancial[]

  @@index([companyId])
  @@index([uploadedByUserId])
}

model MonthlyFinancial {
  id                       String          @id @default(cuid())
  companyId                String
  financialRecordId        String
  monthDate                DateTime
  revenue                  Float           @default(0)
  revenueBreakdown         Json?           // LOB breakdown: { "LOB Name": amount, ... }
  expense                  Float           @default(0)
  expenseBreakdown         Json?           // LOB breakdown for total expenses
  cogsPayroll              Float           @default(0)
  cogsOwnerPay             Float           @default(0)
  cogsContractors          Float           @default(0)
  cogsMaterials            Float           @default(0)
  cogsCommissions          Float           @default(0)
  cogsOther                Float           @default(0)
  cogsTotal                Float           @default(0)
  cogsBreakdown            Json?           // LOB breakdown for total COGS
  payroll                  Float           @default(0)
  ownerBasePay             Float           @default(0)
  benefits                 Float           @default(0)
  insurance                Float           @default(0)
  professionalFees         Float           @default(0)
  subcontractors           Float           @default(0)
  rent                     Float           @default(0)
  taxLicense               Float           @default(0)
  phoneComm                Float           @default(0)
  infrastructure           Float           @default(0)
  autoTravel               Float           @default(0)
  salesExpense             Float           @default(0)
  marketing                Float           @default(0)
  trainingCert             Float           @default(0)
  mealsEntertainment       Float           @default(0)
  interestExpense          Float           @default(0)
  depreciationAmortization Float           @default(0)
  otherExpense             Float           @default(0)
  nonOperatingIncome       Float           @default(0)
  extraordinaryItems       Float           @default(0)
  lobBreakdowns            Json?           // Comprehensive LOB breakdowns for all fields
  cash                     Float           @default(0)
  ar                       Float           @default(0)
  inventory                Float           @default(0)
  otherCA                  Float           @default(0)
  tca                      Float           @default(0)
  fixedAssets              Float           @default(0)
  otherAssets              Float           @default(0)
  totalAssets              Float           @default(0)
  ap                       Float           @default(0)
  otherCL                  Float           @default(0)
  tcl                      Float           @default(0)
  ltd                      Float           @default(0)
  totalLiab                Float           @default(0)
  ownersCapital            Float           @default(0)
  ownersDraw               Float           @default(0)
  commonStock              Float           @default(0)
  preferredStock           Float           @default(0)
  retainedEarnings         Float           @default(0)
  additionalPaidInCapital  Float           @default(0)
  treasuryStock            Float           @default(0)
  totalEquity              Float           @default(0)
  totalLAndE               Float           @default(0)
  createdAt                DateTime        @default(now())
  financialRecord          FinancialRecord @relation(fields: [financialRecordId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([financialRecordId])
  @@index([monthDate])
}

model AssessmentRecord {
  id           String    @id @default(cuid())
  userId       String
  companyId    String
  responses    Json
  notes        Json
  isCompleted  Boolean   @default(false)
  overallScore Float?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([isCompleted])
  @@index([completedAt])
}

model CompanyProfile {
  id             String   @id @default(cuid())
  companyId      String   @unique
  legalStructure String?
  businessStatus String?
  ownership      String?
  workforce      String?
  keyAdvisors    String?
  specialNotes   String?
  qoeNotes       String?
  disclosures    Json
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())
  keyEmployees   Json?
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  userEmail  String
  action     String
  entityType String
  entityId   String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model IndustryBenchmark {
  id                String   @id @default(cuid())
  industryId        String
  industryName      String
  assetSizeCategory String
  metricName        String
  fiveYearValue     Float?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([industryId, assetSizeCategory, metricName])
  @@index([industryId])
  @@index([assetSizeCategory])
}

model AccountingConnection {
  id                 String             @id @default(cuid())
  companyId          String
  platform           AccountingPlatform
  status             ConnectionStatus   @default(INACTIVE)
  accessToken        String?
  refreshToken       String?
  tokenExpiresAt     DateTime?
  realmId            String?
  tenantId           String?
  organizationId     String?
  lastSyncAt         DateTime?
  autoSync           Boolean            @default(false)
  syncFrequency      String             @default("manual")
  platformVersion    String?
  connectionMetadata Json?
  errorMessage       String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, platform])
  @@index([companyId])
  @@index([status])
  @@index([lastSyncAt])
}

model ApiSyncLog {
  id              String             @id @default(cuid())
  companyId       String
  platform        AccountingPlatform
  syncType        String
  status          String
  recordsImported Int                @default(0)
  errorCount      Int                @default(0)
  errorDetails    Json?
  duration        Int?
  createdAt       DateTime           @default(now())
  intuitTid       String?
  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([platform])
  @@index([createdAt])
}

model AccountMapping {
  id                      String   @id @default(cuid())
  companyId               String
  qbAccount               String
  qbAccountId             String?
  qbAccountCode           String?
  qbAccountClassification String?
  targetField             String
  confidence              String   @default("medium")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  lobAllocations          Json?
  company                 Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, qbAccount])
  @@index([companyId])
}

model ExpenseGoal {
  id        String   @id @default(cuid())
  companyId String   @unique
  goals     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model ValuationSettings {
  id                 String   @id @default(cuid())
  companyId          String   @unique
  sdeMultiplier      Float    @default(2.5)
  ebitdaMultiplier   Float    @default(5.0)
  dcfDiscountRate    Float    @default(10.0)
  dcfTerminalGrowth  Float    @default(2.0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([companyId])
}

model SystemSettings {
  id                       String   @id @default(cuid())
  key                      String   @unique
  businessMonthlyPrice     Float?   @default(0)
  businessQuarterlyPrice   Float?   @default(0)
  businessAnnualPrice      Float?   @default(0)
  consultantMonthlyPrice   Float?   @default(0)
  consultantQuarterlyPrice Float?   @default(0)
  consultantAnnualPrice    Float?   @default(0)
  updatedAt                DateTime @updatedAt
  createdAt                DateTime @default(now())

  @@index([key])
}

model Affiliate {
  id           String          @id @default(cuid())
  name         String          @unique
  contactName  String?
  contactEmail String?
  contactPhone String?
  address      String?
  city         String?
  state        String?
  zip          String?
  website      String?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  codes        AffiliateCode[]
  companies    Company[]

  @@index([name])
}

model AffiliateCode {
  id             String    @id @default(cuid())
  affiliateId    String
  code           String    @unique
  description    String?
  isActive       Boolean   @default(true)
  expiresAt      DateTime?
  maxUses        Int?
  currentUses    Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  annualPrice    Float     @default(0)
  monthlyPrice   Float     @default(0)
  quarterlyPrice Float     @default(0)
  affiliate      Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([code])
}

model Subscription {
  id                 String               @id @default(cuid())
  companyId          String               @unique
  usaepayCustomerId  String?
  usaepayBillingId   String?
  plan               String
  amount             Float
  status             SubscriptionStatus   @default(PENDING)
  nextBillingDate    DateTime?
  lastPaymentDate    DateTime?
  billingStartDate   DateTime?
  billingEndDate     DateTime?
  cardLast4          String?
  cardType           String?
  cardExpMonth       String?
  cardExpYear        String?
  failedPaymentCount Int                  @default(0)
  lastFailureReason  String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  transactions       PaymentTransaction[]
  company            Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([nextBillingDate])
}

model PaymentTransaction {
  id             String        @id @default(cuid())
  subscriptionId String?
  companyId      String
  amount         Float
  status         PaymentStatus
  type           PaymentType
  transactionId  String?
  authCode       String?
  cardLast4      String?
  cardType       String?
  errorMessage   String?
  errorCode      String?
  description    String?
  invoice        String?
  createdAt      DateTime      @default(now())
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
}

enum UserRole {
  SITEADMIN
  CONSULTANT
  USER
}

enum UserType {
  COMPANY
  ASSESSMENT
}

enum BusinessStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum AccountingPlatform {
  QUICKBOOKS
  SAGE
  NETSUITE
  DYNAMICS365
}

enum ConnectionStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  SUSPENDED
  PENDING
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
  REFUNDED
}

enum PaymentType {
  INITIAL
  RECURRING
  MANUAL
  REFUND
}
