'use client';

import { useState, useMemo, useEffect, useCallback, ChangeEvent } from 'react';
import dynamic from 'next/dynamic';
import * as XLSX from 'xlsx';
import { Upload, AlertCircle, TrendingUp, DollarSign, FileSpreadsheet } from 'lucide-react';
import { INDUSTRY_SECTORS, SECTOR_CATEGORIES } from '../data/industrySectors';
import { assessmentData } from '../data/assessmentData';
import { authApi, companiesApi, usersApi, consultantsApi, financialsApi, assessmentsApi, profilesApi, benchmarksApi, ApiError } from '@/lib/api-client';
// Dynamic imports to prevent SSR issues with browser API dependent components
const InactivityLogout = dynamic(() => import('./components/InactivityLogout'), { ssr: false });
import { parseDateLike, monthKey, sum, pctChange, getAssetSizeCategory } from './utils/financial';
import { clamp, revenueGrowthScore_24mo, rgsAdjustmentFrom6mo } from './utils/scoring';
import { getBenchmarkValue, sixMonthGrowthFromMonthly, normalizeRows, ltmVsPrior } from './utils/data-processing';
import { exportDataReviewToExcel, exportMonthlyRatiosToExcel } from './utils/excel-export';
import type { Mappings, NormalRow, MonthlyDataRow, Company, CompanyProfile, AssessmentResponses, AssessmentNotes, AssessmentRecord, Consultant, User, FinancialDataRecord, LOBData } from './types';
import { US_STATES, KPI_TO_BENCHMARK_MAP } from './constants';
import { KPI_FORMULAS } from './constants/kpi-formulas';
const LoginView = dynamic(() => import('./components/auth/LoginView'), { ssr: false });
// Dynamic chart components
const LineChart = dynamic(() => import('./components/charts/Charts').then(mod => mod.LineChart), { ssr: false });
const ProjectionChart = dynamic(() => import('./components/charts/Charts').then(mod => mod.ProjectionChart), { ssr: false });
const CompanyDetailsModal = dynamic(() => import('./components/modals/CompanyDetailsModal'), { ssr: false });
const DataReviewTab = dynamic(() => import('./components/dashboard/DataReviewTab'), { ssr: false });
const TeamManagementTab = dynamic(() => import('./components/dashboard/TeamManagementTab'), { ssr: false });
const PaymentsTab = dynamic(() => import('./components/dashboard/PaymentsTab'), { ssr: false });
const ProfileTab = dynamic(() => import('./components/dashboard/ProfileTab'), { ssr: false });
const LOBReportingTab = dynamic(() => import('./components/dashboard/LOBReportingTab'), { ssr: false });
const ConsultantDashboard = dynamic(() => import('./components/consultant/ConsultantDashboard'), { ssr: false });
const CompanyManagementTab = dynamic(() => import('./components/admin/CompanyManagementTab'), { ssr: false });
const CompanySettingsTab = dynamic(() => import('./components/admin/CompanySettingsTab'), { ssr: false });

// Feature flag for covenants module
const COVENANTS_ENABLED = process.env.NEXT_PUBLIC_COVENANTS_ENABLED === 'true' || true; // Default to enabled for development

const CovenantsTab = COVENANTS_ENABLED ? dynamic(() => import('./covenants/components/CovenantsTab'), { ssr: false }) : null;

const Header = dynamic(() => import('./components/layout/Header'), { ssr: false });
const SiteAdminDashboard = dynamic(() => import('./components/siteadmin/SiteAdminDashboard'), { ssr: false });
import { renderColumnSelector as renderColumnSelectorUtil } from './utils/import-helpers';
import { saveProjectionDefaults as saveProjectionDefaultsUtil } from './utils/projection-helpers';
const MAWelcomeView = dynamic(() => import('./components/assessment/MAWelcomeView'), { ssr: false });
const MAScoringGuideView = dynamic(() => import('./components/assessment/MAScoringGuideView'), { ssr: false });
const MAScoresSummaryView = dynamic(() => import('./components/assessment/MAScoresSummaryView'), { ssr: false });
const MAYourResultsView = dynamic(() => import('./components/assessment/MAYourResultsView'), { ssr: false });
const TextToSpeech = dynamic(() => import('./components/common/TextToSpeech'), { ssr: false });
import { parseTrialBalanceCSV, getAccountsForMapping, processTrialBalanceToMonthly, ACCOUNT_TYPE_CLASSIFICATIONS, type ParsedTrialBalance } from '@/lib/trial-balance-parser';
import { useMasterData, masterDataStore } from '@/lib/master-data-store';
const AccountMappingTable = dynamic(() => import('./components/dashboard/AccountMappingTable'), { ssr: false });
const AggregatedFinancialsTab = dynamic(() => import('./components/AggregatedFinancialsTab'), { ssr: false });
const AggregatedFinancialsTab = dynamic(() => import('./components/AggregatedFinancialsTab'), { ssr: false });
import GoalsView from './components/GoalsView';
import TrendAnalysisView from './components/TrendAnalysisView';
import SimpleChart from './components/SimpleChart';
import toast, { Toaster } from 'react-hot-toast';

// Constants (now imported from ./constants)

// Types
// Type definitions (now imported from ./types)

// Helper functions (now imported from ./utils/*)

// Format currency as $1,234,567 (no decimals, with commas)
const formatDollar = (value: number): string => {
  return '$' + Math.round(Math.abs(value)).toLocaleString('en-US');
};

function FinancialScorePage() {
  // State - Authentication
  const [isLoggedIn, setIsLoggedIn] = useState<boolean>(false);
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [loginEmail, setLoginEmail] = useState('');
  const [loginPassword, setLoginPassword] = useState('');
  const [loginName, setLoginName] = useState('');
  const [loginPhone, setLoginPhone] = useState('');
  const [loginCompanyName, setLoginCompanyName] = useState('');
  const [loginCompanyAddress1, setLoginCompanyAddress1] = useState('');
  const [loginCompanyAddress2, setLoginCompanyAddress2] = useState('');
  const [loginCompanyCity, setLoginCompanyCity] = useState('');
  const [loginCompanyState, setLoginCompanyState] = useState('');
  const [loginCompanyZip, setLoginCompanyZip] = useState('');
  const [loginCompanyWebsite, setLoginCompanyWebsite] = useState('');
  const [isRegistering, setIsRegistering] = useState(false);
  const [loginError, setLoginError] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [resetEmail, setResetEmail] = useState('');
  const [resetSuccess, setResetSuccess] = useState('');
  
  // State - Consultants
  const [consultants, setConsultants] = useState<Consultant[]>([]);
  const [newConsultantType, setNewConsultantType] = useState('');
  const [newConsultantFullName, setNewConsultantFullName] = useState('');
  const [newConsultantAddress, setNewConsultantAddress] = useState('');
  const [newConsultantEmail, setNewConsultantEmail] = useState('');
  const [newConsultantPhone, setNewConsultantPhone] = useState('');
  const [newConsultantPassword, setNewConsultantPassword] = useState('');
  const [newConsultantCompanyName, setNewConsultantCompanyName] = useState('');
  const [newConsultantCompanyAddress1, setNewConsultantCompanyAddress1] = useState('');
  const [newConsultantCompanyAddress2, setNewConsultantCompanyAddress2] = useState('');
  const [newConsultantCompanyCity, setNewConsultantCompanyCity] = useState('');
  const [newConsultantCompanyState, setNewConsultantCompanyState] = useState('');
  const [newConsultantCompanyZip, setNewConsultantCompanyZip] = useState('');
  const [newConsultantCompanyWebsite, setNewConsultantCompanyWebsite] = useState('');
  
  // State - Site Administrators
  const [siteAdmins, setSiteAdmins] = useState<any[]>([]);
  const [newSiteAdminFirstName, setNewSiteAdminFirstName] = useState('');
  const [newSiteAdminLastName, setNewSiteAdminLastName] = useState('');
  const [newSiteAdminEmail, setNewSiteAdminEmail] = useState('');
  const [newSiteAdminPassword, setNewSiteAdminPassword] = useState('');
  const [showAddSiteAdminForm, setShowAddSiteAdminForm] = useState(false);
  const [selectedConsultantId, setSelectedConsultantId] = useState('');
  const [expandedCompanyIds, setExpandedCompanyIds] = useState<string[]>([]);
  
  // State - Companies & Users
  const [companies, setCompanies] = useState<Company[]>([]);

  // Safeguard to ensure companies is always an array
  const safeSetCompanies = (value: any) => {
    if (Array.isArray(value)) {
      setCompanies(value);
    } else if (value && typeof value === 'object' && value.companies && Array.isArray(value.companies)) {
      setCompanies(value.companies);
    } else {
      console.warn('Attempted to set companies to invalid value:', value);
      setCompanies([]);
    }
  };
  const [users, setUsers] = useState<User[]>([]);
  const [selectedCompanyId, setSelectedCompanyId] = useState('');
  const [newCompanyName, setNewCompanyName] = useState('');
  const [newUserName, setNewUserName] = useState('');
  const [newUserEmail, setNewUserEmail] = useState('');
  const [selectedAffiliateCodeForNewCompany, setSelectedAffiliateCodeForNewCompany] = useState('');
  
  // State - Subscription Selection
  const [selectedSubscriptionPlan, setSelectedSubscriptionPlan] = useState<string | null>(null);
  const [showCheckoutModal, setShowCheckoutModal] = useState(false);
  
  // State - Active Subscription Management
  const [activeSubscription, setActiveSubscription] = useState<any>(null);

  // Master data for dynamic categories
  const masterData = useMasterData(selectedCompanyId);
  const cogsCategories = masterData.data?.cogsCategories || [];
  const expenseCategories = masterData.data?.expenseCategories || [];

  // Clear master data cache when company changes
  useEffect(() => {
    if (selectedCompanyId) {
      masterDataStore.clearCompanyCache(selectedCompanyId);
    }
  }, [selectedCompanyId]);
  const [loadingSubscription, setLoadingSubscription] = useState(false);
  const [showUpdatePaymentModal, setShowUpdatePaymentModal] = useState(false);
  const [updatingPayment, setUpdatingPayment] = useState(false);
  const [updatePaymentData, setUpdatePaymentData] = useState({
    cardNumber: '',
    cardholderName: '',
    expirationMonth: '',
    expirationYear: '',
    cvv: '',
    billingStreet: '',
    billingCity: '',
    billingState: '',
    billingZip: '',
  });
  const [newUserPassword, setNewUserPassword] = useState('');
  // Separate state for Company Users
  const [newCompanyUserName, setNewCompanyUserName] = useState('');
  const [newCompanyUserTitle, setNewCompanyUserTitle] = useState('');
  const [newCompanyUserEmail, setNewCompanyUserEmail] = useState('');
  const [newCompanyUserPhone, setNewCompanyUserPhone] = useState('');
  const [newCompanyUserPassword, setNewCompanyUserPassword] = useState('');
  // Separate state for Assessment Users (no phone field)
  const [newAssessmentUserName, setNewAssessmentUserName] = useState('');
  const [newAssessmentUserTitle, setNewAssessmentUserTitle] = useState('');
  const [newAssessmentUserEmail, setNewAssessmentUserEmail] = useState('');
  const [newAssessmentUserPassword, setNewAssessmentUserPassword] = useState('');
  
  // State - Company Details
  const [showCompanyDetailsModal, setShowCompanyDetailsModal] = useState(false);
  const [editingCompanyId, setEditingCompanyId] = useState('');
  const [companyAddressStreet, setCompanyAddressStreet] = useState('');
  const [companyAddressCity, setCompanyAddressCity] = useState('');
  const [companyAddressState, setCompanyAddressState] = useState('');
  const [companyAddressZip, setCompanyAddressZip] = useState('');
  const [companyAddressCountry, setCompanyAddressCountry] = useState('USA');
  const [companyIndustrySector, setCompanyIndustrySector] = useState<number | ''>('');
  const [expandedCompanyInfoId, setExpandedCompanyInfoId] = useState('');
  const [isManagementAssessmentExpanded, setIsManagementAssessmentExpanded] = useState(false);
  const [isFinancialScoreExpanded, setIsFinancialScoreExpanded] = useState(false);
  
  // State - Default Pricing
  const [defaultBusinessMonthlyPrice, setDefaultBusinessMonthlyPrice] = useState(195);
  const [defaultBusinessQuarterlyPrice, setDefaultBusinessQuarterlyPrice] = useState(500);
  const [defaultBusinessAnnualPrice, setDefaultBusinessAnnualPrice] = useState(1750);
  const [defaultConsultantMonthlyPrice, setDefaultConsultantMonthlyPrice] = useState(195);
  const [defaultConsultantQuarterlyPrice, setDefaultConsultantQuarterlyPrice] = useState(500);
  const [defaultConsultantAnnualPrice, setDefaultConsultantAnnualPrice] = useState(1750);
  
  // State - Projections
  const [defaultBestCaseRevMult, setDefaultBestCaseRevMult] = useState(1.5);
  const [defaultBestCaseExpMult, setDefaultBestCaseExpMult] = useState(0.7);
  const [defaultWorstCaseRevMult, setDefaultWorstCaseRevMult] = useState(0.5);
  const [defaultWorstCaseExpMult, setDefaultWorstCaseExpMult] = useState(1.3);
  const [bestCaseRevMultiplier, setBestCaseRevMultiplier] = useState(1.5);
  const [bestCaseExpMultiplier, setBestCaseExpMultiplier] = useState(0.7);
  const [worstCaseRevMultiplier, setWorstCaseRevMultiplier] = useState(0.5);
  const [worstCaseExpMultiplier, setWorstCaseExpMultiplier] = useState(1.3);
  const [showDefaultSettings, setShowDefaultSettings] = useState(false);
  
  // State - Financial Data
  const [financialDataRecords, setFinancialDataRecords] = useState<FinancialDataRecord[]>([]);
  const [file, setFile] = useState<File | null>(null);
  const [rawRows, setRawRows] = useState<any[]>([]);
  const [columns, setColumns] = useState<string[]>([]);
  const [mapping, setMapping] = useState<Mappings>({ date: '' });
  const [error, setError] = useState<string | null>(null);
  const [isFreshUpload, setIsFreshUpload] = useState<boolean>(false);
  const [loadedMonthlyData, setLoadedMonthlyData] = useState<MonthlyDataRow[]>([]);
  const [currentView, setCurrentView] = useState<'login' | 'admin' | 'consultant-dashboard' | 'siteadmin' | 'upload' | 'results' | 'kpis' | 'mda' | 'projections' | 'working-capital' | 'valuation' | 'cash-flow' | 'financial-statements' | 'trend-analysis' | 'profile' | 'goals' | 'fs-intro' | 'fs-score' | 'ma-welcome' | 'ma-questionnaire' | 'ma-your-results' | 'ma-scores-summary' | 'ma-scoring-guide' | 'ma-charts' | 'custom-print' | 'dashboard'>('login');
  
  // State - Dashboard Customization
  const [selectedDashboardWidgets, setSelectedDashboardWidgets] = useState<string[]>([]);
  const [showDashboardCustomizer, setShowDashboardCustomizer] = useState(false);


  // Check if current view is allowed for assessment users
  const isAssessmentUserViewAllowed = (view: string) => {
    if (currentUser?.userType !== 'assessment') return true;
    const allowedViews = ['ma-welcome', 'ma-questionnaire', 'ma-your-results', 'ma-scores-summary', 'ma-scoring-guide', 'ma-charts'];
    return allowedViews.includes(view);
  };

  // Handle navigation with payment gate
  const handleNavigation = (view: string) => {
    if (isPaymentRequired()) {
      alert('âš ï¸ Payment Required\n\nPlease complete your subscription payment before accessing other features.');
      setAdminDashboardTab('payments');
      setCurrentView('admin');
      return;
    }
    setCurrentView(view as any);
  };

  // Handle admin dashboard tab navigation with payment gate
  const handleAdminTabNavigation = (tab: 'company-management' | 'company-settings' | 'payments' | 'import-financials' | 'api-connections' | 'data-review' | 'data-mapping' | 'covenants') => {
    // Always allow payments tab
    if (tab === 'payments') {
      setAdminDashboardTab(tab);
      return;
    }

    // Block other tabs if payment is required
    if (isPaymentRequired()) {
      alert('âš ï¸ Payment Required\n\nPlease complete your subscription payment on the Payments tab before accessing other features.');
      setAdminDashboardTab('payments');
      return;
    }
    
    // Reset company management sub-tab when switching to company-management
    if (tab === 'company-management') {
      setCompanyManagementSubTab('details');
    }
    
    setAdminDashboardTab(tab);
  };

  // Redirect assessment users if they try to access unauthorized views - but not during login
  // Handle pending login after business registration redirect
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const pendingLoginStr = sessionStorage.getItem('pendingLogin');
    if (pendingLoginStr && !isLoggedIn) {
      try {
        const { user, timestamp } = JSON.parse(pendingLoginStr);
        // Only process if less than 10 seconds old
        if (Date.now() - timestamp < 10000) {
          // Normalize role and userType to lowercase
          const normalizedUser = {
            ...user,
            role: user.role.toLowerCase(),
            userType: user.userType?.toLowerCase(),
            consultantType: user.consultantType, // Preserve consultantType
            consultantCompanyName: user.consultantCompanyName, // Preserve consultant company name
            consultantId: user.consultantId // Preserve consultant ID
          };
          
          setCurrentUser(normalizedUser);
          setIsLoggedIn(true);
          
          // Set appropriate view for business users (consultants)
          if (normalizedUser.role === 'consultant') {
            setCurrentView('consultant-dashboard');
            // Load companies for the consultant
            if (user.consultantId) {
              companiesApi.getAll(user.consultantId).then(({ companies: loadedCompanies }) => {
                safeSetCompanies(Array.isArray(loadedCompanies) ? loadedCompanies : []);

                let needsPayment = false;
                
                if (user.companyId && loadedCompanies && loadedCompanies.length > 0) {
                  // Business user - check their company's payment
                  const newCompany = loadedCompanies.find((c: any) => c.id === user.companyId);
                  if (newCompany) {
                    setSelectedCompanyId(newCompany.id);
                    setExpandedCompanyInfoId(newCompany.id);
                    needsPayment = !newCompany.selectedSubscriptionPlan;
                  } else {
                    // Fallback: try to select company with master data for testing
                    const companyWithMasterData = loadedCompanies.find((c: any) => c.id === 'cmgmttbfh0004qhgwm6vd9oa5');
                    if (companyWithMasterData) {
                      setSelectedCompanyId(companyWithMasterData.id);
                      setExpandedCompanyInfoId(companyWithMasterData.id);
                      needsPayment = !companyWithMasterData.selectedSubscriptionPlan;
                    }
                  }
                } else if (loadedCompanies && loadedCompanies.length > 0) {
                  // Consultant with companies
                  const firstCompany = loadedCompanies[0];
                  setSelectedCompanyId(firstCompany.id);
                  setExpandedCompanyInfoId(firstCompany.id);
                  needsPayment = !firstCompany.selectedSubscriptionPlan;
                }
                
                // Always direct to company management on login
                setAdminDashboardTab('company-management');
              }).catch(error => {
                console.error('Error loading companies:', error);
                safeSetCompanies([]); // Set empty array on error
              });
            }
          } else if (normalizedUser.role === 'siteadmin') {
            setCurrentView('siteadmin');
          } else if (normalizedUser.userType === 'assessment') {
            setCurrentView('ma-welcome');
          } else if (normalizedUser.userType === 'company') {
            // Company users see the same dashboard as consultants
            setCurrentView('admin');
            setSelectedCompanyId(user.companyId || '');
            // Load the company data for this user
            if (user.companyId) {
              fetch(`/api/companies?companyId=${user.companyId}`)
                .then(res => res.json())
                .then(data => {
                  if (data.companies && Array.isArray(data.companies) && data.companies.length > 0) {
                    safeSetCompanies(data.companies);
                  } else {
                    safeSetCompanies([]);
                  }
                })
                .catch(err => console.error('Error loading company:', err));
            }
          } else {
            setCurrentView('upload');
            setSelectedCompanyId(user.companyId || '');
          }
        }
        // Clear the pending login data
        sessionStorage.removeItem('pendingLogin');
      } catch (error) {
        console.error('Error processing pending login:', error);
        sessionStorage.removeItem('pendingLogin');
      }
    }
  }, []);

  useEffect(() => {
    if (currentUser?.userType === 'assessment' && isLoggedIn && currentView !== 'login' && !isAssessmentUserViewAllowed(currentView)) {
      console.log('ðŸš« useEffect redirecting from', currentView, 'to ma-welcome');
      setCurrentView('ma-welcome');
    }
  }, [currentView, currentUser, isLoggedIn]);

  // Helper function to handle view changes for assessment users
  const handleViewChange = (newView: string) => {
    console.log('ðŸ”„ handleViewChange called - newView:', newView, 'userType:', currentUser?.userType, 'isAllowed:', isAssessmentUserViewAllowed(newView));
    if (currentUser?.userType === 'assessment' && !isAssessmentUserViewAllowed(newView)) {
      console.log('ðŸš« View not allowed, redirecting to ma-welcome');
      setCurrentView('ma-welcome');
    } else {
      console.log('ðŸ”„ Setting view to:', newView);
      setCurrentView(newView as any);
    }
  };
  const [adminDashboardTab, setAdminDashboardTab] = useState<'company-management' | 'company-settings' | 'import-financials' | 'api-connections' | 'data-review' | 'data-mapping' | 'goals' | 'payments' | 'covenants'>('company-management');

  // Master data for dynamic goals
  const [masterDataCategories, setMasterDataCategories] = useState<any[]>([]);
  const [companyManagementSubTab, setCompanyManagementSubTab] = useState<'details' | 'profile' | 'covenants'>('details');
  const [consultantDashboardTab, setConsultantDashboardTab] = useState<'team-management' | 'company-list'>('team-management');
  const [siteAdminTab, setSiteAdminTab] = useState<'consultants' | 'businesses' | 'affiliates' | 'default-pricing' | 'billing' | 'siteadmins'>('consultants');
  const [expandedBusinessIds, setExpandedBusinessIds] = useState<Set<string>>(new Set());
  const [editingPricing, setEditingPricing] = useState<{[key: string]: any}>({});
  const [editingConsultantInfo, setEditingConsultantInfo] = useState<{[key: string]: any}>({});
  const [expandedConsultantInfo, setExpandedConsultantInfo] = useState<Set<string>>(new Set());
  const [companyToDelete, setCompanyToDelete] = useState<{companyId: string, businessId: string, companyName: string} | null>(null);
  const [showDeleteConfirmation, setShowDeleteConfirmation] = useState(false);
  const [siteAdminViewingAs, setSiteAdminViewingAs] = useState<any>(null);
  const [showAddConsultantForm, setShowAddConsultantForm] = useState(false);
  
  // Affiliate management state
  const [affiliates, setAffiliates] = useState<any[]>([]);
  const [editingAffiliate, setEditingAffiliate] = useState<any>(null);
  const [showAddAffiliateForm, setShowAddAffiliateForm] = useState(false);
  const [expandedAffiliateId, setExpandedAffiliateId] = useState<string | null>(null);
  const [newAffiliateCode, setNewAffiliateCode] = useState({code: '', description: '', maxUses: '', expiresAt: '', monthlyPrice: '', quarterlyPrice: '', annualPrice: ''});
  const [editingAffiliateCode, setEditingAffiliateCode] = useState<any>(null);
  
  // Team management state
  const [consultantTeamMembers, setConsultantTeamMembers] = useState<any[]>([]);
  const [showAddTeamMemberForm, setShowAddTeamMemberForm] = useState(false);
  const [newTeamMember, setNewTeamMember] = useState({name: '', email: '', phone: '', title: '', password: ''});
  
  const [kpiDashboardTab, setKpiDashboardTab] = useState<'all-ratios' | 'priority-ratios' | 'monthly-ratios'>('all-ratios');
  const [priorityRatios, setPriorityRatios] = useState<string[]>([
    'Current Ratio', 'Quick Ratio', 'ROE', 'ROA', 'Interest Coverage', 'Debt/Net Worth'
  ]);

  // Available ratios by category for Priority Ratios tab
  const ratioCategories = {
    'Liquidity': ['Current Ratio', 'Quick Ratio'],
    'Activity': ['Inventory Turnover', 'Receivables Turnover', 'Payables Turnover', 'Days Inventory', 'Days Receivables', 'Days Payables', 'Sales/Working Capital'],
    'Coverage': ['Interest Coverage', 'Debt Service Coverage', 'Cash Flow to Debt'],
    'Leverage': ['Debt/Net Worth', 'Fixed Assets/Net Worth', 'Leverage Ratio'],
    'Operating': ['Total Asset Turnover', 'ROE', 'ROA', 'EBITDA Margin', 'EBIT Margin']
  };

  const allAvailableRatios = Object.values(ratioCategories).flat();

  // Helper function to get ratio value key for LineChart
  const getRatioValueKey = (ratioName: string): string => {
    const ratioMap: Record<string, string> = {
      'Current Ratio': 'currentRatio',
      'Quick Ratio': 'quickRatio',
      'Inventory Turnover': 'invTurnover',
      'Receivables Turnover': 'arTurnover',
      'Payables Turnover': 'apTurnover',
      'Days Inventory': 'daysInv',
      'Days Receivables': 'daysAR',
      'Days Payables': 'daysAP',
      'Sales/Working Capital': 'salesWC',
      'Interest Coverage': 'interestCov',
      'Debt Service Coverage': 'debtSvcCov',
      'Cash Flow to Debt': 'cfToDebt',
      'Debt/Net Worth': 'debtToNW',
      'Fixed Assets/Net Worth': 'fixedToNW',
      'Leverage Ratio': 'leverage',
      'Total Asset Turnover': 'totalAssetTO',
      'ROE': 'roe',
      'ROA': 'roa',
      'EBITDA Margin': 'ebitdaMargin',
      'EBIT Margin': 'ebitMargin'
    };
    return ratioMap[ratioName] || '';
  };

  // Helper function to get ratio color
  const getRatioColor = (ratioName: string): string => {
    const colorMap: Record<string, string> = {
      'Current Ratio': '#10b981',
      'Quick Ratio': '#14b8a6',
      'Inventory Turnover': '#f59e0b',
      'Receivables Turnover': '#f97316',
      'Payables Turnover': '#ef4444',
      'Days Inventory': '#fbbf24',
      'Days Receivables': '#fb923c',
      'Days Payables': '#f87171',
      'Sales/Working Capital': '#06b6d4',
      'Interest Coverage': '#8b5cf6',
      'Debt Service Coverage': '#a78bfa',
      'Cash Flow to Debt': '#c4b5fd',
      'Debt/Net Worth': '#ec4899',
      'Fixed Assets/Net Worth': '#f472b6',
      'Leverage Ratio': '#f9a8d4',
      'Total Asset Turnover': '#3b82f6',
      'ROE': '#60a5fa',
      'ROA': '#93c5fd',
      'EBITDA Margin': '#2563eb',
      'EBIT Margin': '#1e40af'
    };
    return colorMap[ratioName] || '#64748b';
  };

  // Helper function to get ratio formatter
  const getRatioFormatter = (ratioName: string): ((v: number) => string) => {
    if (ratioName.includes('Days')) {
      return (v: number) => v.toFixed(0);
    }
    return (v: number) => v.toFixed(1);
  };

  // Function to save priority ratios
  const savePriorityRatios = () => {
    localStorage.setItem('fs_priorityRatios', JSON.stringify(priorityRatios));
    alert('Priority ratios saved successfully!');
  };
  
  // State - Subscription Pricing
  const [subscriptionMonthlyPrice, setSubscriptionMonthlyPrice] = useState<number | undefined>();
  const [subscriptionQuarterlyPrice, setSubscriptionQuarterlyPrice] = useState<number | undefined>();
  const [subscriptionAnnualPrice, setSubscriptionAnnualPrice] = useState<number | undefined>();

  // Affiliate pricing cache removed - pricing now stored permanently in database

  // Check if payment is required for the current company
  const isPaymentRequired = useCallback(() => {
    if (!selectedCompanyId || !currentUser) return false;

    // If companies is not an array, assume payment is not required (avoid errors)
    if (!Array.isArray(companies)) return false;

    const selectedCompany = companies.find(c => c.id === selectedCompanyId);
    if (!selectedCompany) return false;

    // Check if company is free (multiple ways to detect)
    // 1. Explicit free status
    if (selectedCompany.subscriptionStatus === "free") {
      console.log('ðŸ”’ Company marked as free - no payment required');
      return false;
    }

    // 2. Check dedicated pricing fields
    let monthly = selectedCompany.subscriptionMonthlyPrice;
    let quarterly = selectedCompany.subscriptionQuarterlyPrice;
    let annual = selectedCompany.subscriptionAnnualPrice;

    // 3. Fall back to userDefinedAllocations if dedicated fields are null
    if ((monthly === null || monthly === undefined) &&
        selectedCompany.userDefinedAllocations?.subscriptionPricing) {
      monthly = selectedCompany.userDefinedAllocations.subscriptionPricing.monthly;
      quarterly = selectedCompany.userDefinedAllocations.subscriptionPricing.quarterly;
      annual = selectedCompany.userDefinedAllocations.subscriptionPricing.annual;
    }

    // 4. Check if pricing is $0
    if (monthly === 0 && quarterly === 0 && annual === 0) {
      console.log('ðŸ”’ Company has $0 pricing - no payment required');
      return false;
    }

    // 5. If no pricing data or non-zero pricing, payment required
    console.log('ðŸ”’ Payment required - no free pricing detected');
    return true;

    // If pricing hasn't loaded yet, don't block (avoid false positives)
    if (subscriptionMonthlyPrice === undefined || subscriptionQuarterlyPrice === undefined || subscriptionAnnualPrice === undefined) {
      console.log('ðŸ”’ Pricing still loading - allowing access temporarily');
      return false; // Don't block while pricing is loading
    }

    // Payment required for non-free pricing
    console.log('ðŸ”’ Payment required for pricing:', { subscriptionMonthlyPrice, subscriptionQuarterlyPrice, subscriptionAnnualPrice });
    return true;
  }, [selectedCompanyId, currentUser, companies, subscriptionMonthlyPrice, subscriptionQuarterlyPrice, subscriptionAnnualPrice]);

  // State - Management Assessment
  const [assessmentResponses, setAssessmentResponses] = useState<AssessmentResponses>({});
  const [assessmentNotes, setAssessmentNotes] = useState<AssessmentNotes>({});
  const [assessmentRecords, setAssessmentRecords] = useState<AssessmentRecord[]>([]);
  const [unansweredQuestions, setUnansweredQuestions] = useState<string[]>([]);
  
  // State - Trend Analysis
  const [selectedTrendItem, setSelectedTrendItem] = useState<string>('revenue');
  const [selectedTrendItems, setSelectedTrendItems] = useState<string[]>(['Revenue', 'Gross Profit', 'Total Operating Expenses', 'Net Income']);
  const [trendAnalysisTab, setTrendAnalysisTab] = useState<'item-trends' | 'expense-analysis'>('item-trends');

  // State - Expense Analysis
  const [selectedExpenseItem, setSelectedExpenseItem] = useState<string>('total-expenses');
  const [selectedExpenseItems, setSelectedExpenseItems] = useState<string[]>(['total-expenses', 'cogs-total', 'payroll', 'rent']);
  
  // Helper function to get full display name for trend items
  const getTrendItemDisplayName = (item: string): string => {
    const displayNames: { [key: string]: string } = {
      // Income Statement
      'revenue': 'Total Revenue',
      'expense': 'Total Expenses',
      'cogsTotal': 'COGS Total',
      'cogsPayroll': 'COGS Payroll',
      'cogsOwnerPay': 'COGS Owner Pay',
      'cogsContractors': 'COGS Contractors',
      'cogsMaterials': 'COGS Materials',
      'cogsCommissions': 'COGS Commissions',
      'cogsOther': 'COGS Other',
      'salesExpense': 'Sales & Marketing',
      'rent': 'Rent/Lease',
      'infrastructure': 'Infrastructure/Utilities',
      'autoTravel': 'Auto & Travel',
      'professionalFees': 'Professional Services',
      'insurance': 'Insurance',
      'marketing': 'OPEX Other',
      'payroll': 'OPEX Payroll',
      'ownerBasePay': 'Owners Base Pay',
      'ownersRetirement': 'Owners Retirement',
      'subcontractors': 'Contractors/Distribution',
      'interestExpense': 'Interest Expense',
      'depreciationAmortization': 'Depreciation Expense',
      'operatingExpenseTotal': 'Operating Expense Total',
      'nonOperatingIncome': 'Non-Operating Income',
      'extraordinaryItems': 'Extraordinary Items',
      'netProfit': 'Net Profit',
      'grossProfit': 'Gross Profit',
      'ebitda': 'EBITDA',
      'ebit': 'EBIT',
      // Balance Sheet - Assets
      'totalAssets': 'Total Assets',
      'cash': 'Cash',
      'ar': 'Accounts Receivable',
      'inventory': 'Inventory',
      'otherCA': 'Other Current Assets',
      'tca': 'Total Current Assets',
      'fixedAssets': 'Fixed Assets',
      'otherAssets': 'Other Assets',
      // Balance Sheet - Liabilities
      'totalLiab': 'Total Liabilities',
      'ap': 'Accounts Payable',
      'otherCL': 'Other Current Liabilities',
      'tcl': 'Total Current Liabilities',
      'ltd': 'Long Term Debt',
      // Balance Sheet - Equity
      'totalEquity': 'Total Equity'
    };
    
    return displayNames[item] || item.charAt(0).toUpperCase() + item.slice(1).replace(/([A-Z])/g, ' $1');
  };

  // Helper function to get display name for expense analysis items
  const getExpenseFieldDisplayName = (item: string): string => {
    const displayNames: { [key: string]: string } = {
      'total-expenses': 'Total Expenses',
      'cogs-total': 'COGS Total',
      'cogs-payroll': 'COGS Payroll',
      'cogs-owner-pay': 'COGS Owner Pay',
      'cogs-contractors': 'COGS Contractors',
      'cogs-materials': 'COGS Materials',
      'cogs-commissions': 'COGS Commissions',
      'cogs-other': 'COGS Other',
      'payroll': 'Payroll',
      'owner-base-pay': 'Owner Base Pay',
      'owners-retirement': 'Owners Retirement',
      'subcontractors': 'Subcontractors',
      'professional-fees': 'Professional Fees',
      'insurance': 'Insurance',
      'rent': 'Rent',
      'phone-comm': 'Phone & Communications',
      'infrastructure': 'Infrastructure',
      'auto-travel': 'Auto & Travel',
      'sales-expense': 'Sales Expense',
      'marketing': 'Marketing',
      'training-cert': 'Training & Certification',
      'meals-entertainment': 'Meals & Entertainment',
      'interest-expense': 'Interest Expense',
      'depreciation-amortization': 'Depreciation & Amortization',
      'other-expense': 'Other Expense'
    };

    return displayNames[item] || item.charAt(0).toUpperCase() + item.slice(1).replace(/-/g, ' ');
  };

  // State - Valuation
  const [sdeMultiplier, setSdeMultiplier] = useState(2.5);
  const [ebitdaMultiplier, setEbitdaMultiplier] = useState(5.0);
  const [dcfDiscountRate, setDcfDiscountRate] = useState(10.0);
  const [dcfTerminalGrowth, setDcfTerminalGrowth] = useState(2.0);
  const [valuationSaveStatus, setValuationSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle');

  // State - Goals
  const [expenseGoals, setExpenseGoals] = useState<{[key: string]: number}>({});
  const [goalsSaveStatus, setGoalsSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle');

  // State - Industry Benchmarks
  const [benchmarks, setBenchmarks] = useState<any[]>([]);

  // State - Company Profiles
  const [companyProfiles, setCompanyProfiles] = useState<CompanyProfile[]>([]);
  
  // State - QuickBooks Raw Data
  const [qbRawData, setQbRawData] = useState<any>(null);
  const [dataRefreshKey, setDataRefreshKey] = useState(0);
  
  // State - CSV Trial Balance Data
  const [csvTrialBalanceData, setCsvTrialBalanceData] = useState<any>(null);

  // State - QuickBooks Connection
  const [qbConnected, setQbConnected] = useState(false);

  // State - Financial Statements
  const [statementType, setStatementType] = useState<'income-statement' | 'balance-sheet' | 'income-statement-percent'>('income-statement');
  const [statementPeriod, setStatementPeriod] = useState<'current-month' | 'current-quarter' | 'last-12-months' | 'ytd' | 'last-year' | 'last-3-years'>('current-month');
  const [financialStatementsTab, setFinancialStatementsTab] = useState<'aggregated' | 'line-of-business'>('aggregated');
  const [selectedLineOfBusiness, setSelectedLineOfBusiness] = useState<string>('all');
  const [statementDisplay, setStatementDisplay] = useState<'monthly' | 'quarterly' | 'annual'>('monthly');
  const [cashFlowDisplay, setCashFlowDisplay] = useState<'monthly' | 'quarterly' | 'annual'>('monthly');

  // State - MD&A Tabs
  const [mdaTab, setMdaTab] = useState<'executive-summary' | 'strengths-insights' | 'key-metrics'>('executive-summary');
  
  // State - Formula Popup
  const [showFormulaPopup, setShowFormulaPopup] = useState<string | null>(null);

  // State - AI Mapping
  const [aiMappings, setAiMappings] = useState<any[]>([]);
  const [isGeneratingMappings, setIsGeneratingMappings] = useState(false);
  const [isSavingMappings, setIsSavingMappings] = useState(false);
  
  // State - Lines of Business
  const [linesOfBusiness, setLinesOfBusiness] = useState<LOBData[]>([]);
  const [userDefinedAllocations, setUserDefinedAllocations] = useState<{ lobName: string; percentage: number }[]>([]);
  const [showMappingSection, setShowMappingSection] = useState(false);
  const [isProcessingMonthlyData, setIsProcessingMonthlyData] = useState(false);
  const [openTargetFieldDropdown, setOpenTargetFieldDropdown] = useState<number | null>(null);
  const [qbStatus, setQbStatus] = useState<'ACTIVE' | 'INACTIVE' | 'ERROR' | 'EXPIRED' | 'NOT_CONNECTED'>('NOT_CONNECTED');
  const [qbLastSync, setQbLastSync] = useState<Date | null>(null);
  const [qbSyncing, setQbSyncing] = useState(false);
  const [qbError, setQbError] = useState<string | null>(null);
  

  // State - API Loading & Errors
  const [isLoading, setIsLoading] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [dataLoaded, setDataLoaded] = useState(false);

  // State - Custom Print Package
  const [printPackageSelections, setPrintPackageSelections] = useState({
    mda: false,
    financialScore: false,
    priorityRatios: false,
    workingCapital: false,
    dashboard: false,
    cashFlow4Quarters: false,
    cashFlow3Years: false,
    incomeStatement12MonthsQuarterly: false,
    incomeStatement3YearsAnnual: false,
    balanceSheet12MonthsQuarterly: false,
    balanceSheet3YearsAnnual: false,
    profile: false
  });

  const handleExportMdaToWord = async () => {
    try {
      let executiveSummaryText = '';
      if (typeof document !== 'undefined') {
        const container = document.getElementById('mda-executive-summary-container');
        if (container) {
          executiveSummaryText = container.innerText || '';
        }
      }

      const response = await fetch('/api/mda/export', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          companyName,
          executiveSummary: executiveSummaryText,
          strengths: mdaAnalysis.strengths,
          weaknesses: mdaAnalysis.weaknesses,
          insights: mdaAnalysis.insights,
        }),
      });

      if (!response.ok) {
        console.error('Failed to export MD&A:', await response.text());
        alert('Unable to export MD&A to Word. Please try again.');
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const safeCompanyName =
        (companyName || 'Company').toString().replace(/[^a-zA-Z0-9 \-_.]/g, '').trim() || 'Company';
      link.download = `MDA - ${safeCompanyName}.docx`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Error exporting MD&A:', error);
      alert('An unexpected error occurred while exporting MD&A.');
    }
  };


  // Reload companies data when accessing payments tab to get fresh pricing
  // eslint-disable-next-line react-hooks/exhaustive-deps
  useEffect(() => {
    const consultantId = currentUser?.consultantId;
    if (adminDashboardTab === 'payments' && consultantId && selectedCompanyId) {
      const refreshCompanyData = async () => {
        try {
          const fetchedCompanies = await companiesApi.getAll(consultantId);
          safeSetCompanies(fetchedCompanies);
        } catch (error) {
          console.error('Error refreshing company data:', error);
        }
      };
      refreshCompanyData();
    }
  }, [adminDashboardTab, selectedCompanyId]);

  // Load subscription details when accessing payments tab
  useEffect(() => {
    const loadSubscriptionDetails = async () => {
      if (adminDashboardTab === 'payments' && selectedCompanyId) {
        setLoadingSubscription(true);
        try {
          const response = await fetch(`/api/subscriptions?companyId=${selectedCompanyId}`);
          const data = await response.json();
          
          if (data.subscription) {
            setActiveSubscription(data.subscription);
          } else {
            setActiveSubscription(null);
          }
        } catch (error) {
          console.error('Error loading subscription:', error);
          setActiveSubscription(null);
        } finally {
          setLoadingSubscription(false);
        }
      }
    };

    loadSubscriptionDetails();
  }, [adminDashboardTab, selectedCompanyId]);

  // Update payment method handler
  const handleUpdatePaymentMethod = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!selectedCompanyId) {
      alert('No company selected');
      return;
    }
    
    setUpdatingPayment(true);
    
    try {
      const response = await fetch('/api/subscriptions', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          companyId: selectedCompanyId,
          cardNumber: updatePaymentData.cardNumber.replace(/\s/g, ''),
          cardholderName: updatePaymentData.cardholderName,
          expirationMonth: updatePaymentData.expirationMonth.padStart(2, '0'),
          expirationYear: updatePaymentData.expirationYear,
          cvv: updatePaymentData.cvv,
          billingAddress: {
            street: updatePaymentData.billingStreet,
            city: updatePaymentData.billingCity,
            state: updatePaymentData.billingState,
            zip: updatePaymentData.billingZip,
          },
        }),
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert('âœ… Payment method updated successfully!');
        setShowUpdatePaymentModal(false);
        // Reset form
        setUpdatePaymentData({
          cardNumber: '',
          cardholderName: '',
          expirationMonth: '',
          expirationYear: '',
          cvv: '',
          billingStreet: '',
          billingCity: '',
          billingState: '',
          billingZip: '',
        });
        // Reload subscription details
        const subResponse = await fetch(`/api/subscriptions?companyId=${selectedCompanyId}`);
        const subData = await subResponse.json();
        if (subData.subscription) {
          setActiveSubscription(subData.subscription);
        }
      } else {
        alert(`âŒ Failed to update payment method\n\n${result.error || 'Please try again or contact support.'}`);
      }
    } catch (error) {
      console.error('Update payment method error:', error);
      alert('âŒ An error occurred while updating your payment method. Please try again.');
    } finally {
      setUpdatingPayment(false);
    }
  };

  // Delete company handler
  const handleDeleteCompany = async () => {
    if (!companyToDelete) return;

    console.log('Attempting to delete company:', companyToDelete);

    try {
      const response = await fetch(`/api/companies/${companyToDelete.companyId}`, {
        method: 'DELETE',
      });

      console.log('Delete response status:', response.status);
      const result = await response.json();
      console.log('Delete result:', result);

      // Handle both success and 404 (company already deleted/hidden)
      if (result.success || response.status === 404) {
        const message = result.hidden
          ? `âœ… Company "${companyToDelete.companyName}" has been removed from your dashboard.`
          : result.softDelete
          ? `âš ï¸ Company "${companyToDelete.companyName}" has been marked as deleted (temporary workaround). It will be fully removed after the next deployment.`
          : result.success
          ? `âœ… Company "${companyToDelete.companyName}" has been deleted successfully.`
          : `âœ… Company "${companyToDelete.companyName}" has been removed (already deleted from database).`;

        alert(message);

        console.log('Before delete - companies:', companies.length, 'consultants:', consultants.length);

        // Always remove the company from the UI, regardless of server response
        // This ensures the company disappears from the user's view immediately
        safeSetCompanies(Array.isArray(companies) ? companies.filter(c => c.id !== companyToDelete.companyId) : []);

        // Clear localStorage companies data to prevent reappearance on navigation
        if (typeof window !== 'undefined') {
          localStorage.removeItem('fs_companies');
          console.log('ðŸ—‘ï¸ Cleared localStorage companies data after deletion');
        }

        // Force reload companies from API to ensure deletion took effect
        if (currentUser?.role === 'consultant' && currentUser?.consultantId) {
          console.log('ðŸ”„ Reloading companies from API after deletion');
          setTimeout(async () => {
            try {
              const { companies: freshCompanies } = await companiesApi.getAll(currentUser.consultantId);
              safeSetCompanies(freshCompanies || []);
              console.log('âœ… Reloaded companies after deletion:', freshCompanies?.length || 0, 'companies');
            } catch (error) {
              console.error('âŒ Failed to reload companies after deletion:', error);
            }
          }, 1000); // Small delay to ensure deletion is processed
        }

        // Remove the business/consultant from the consultants list
        setConsultants(Array.isArray(consultants) ? consultants.filter(c => c.id !== companyToDelete.businessId) : []);

        console.log('After delete - filtered companies:', Array.isArray(companies) ? companies.filter(c => c.id !== companyToDelete.companyId).length : 0);
        console.log('After delete - filtered consultants:', Array.isArray(consultants) ? consultants.filter(c => c.id !== companyToDelete.businessId).length : 0);

        // Close the confirmation dialog
        setShowDeleteConfirmation(false);
        setCompanyToDelete(null);
      } else {
        // Even if the server says it failed, still remove from UI for better UX
        console.log('Server reported failure, but removing from UI anyway for better user experience');

        safeSetCompanies(Array.isArray(companies) ? companies.filter(c => c.id !== companyToDelete.companyId) : []);

        // Clear localStorage companies data to prevent reappearance on navigation
        if (typeof window !== 'undefined') {
          localStorage.removeItem('fs_companies');
          console.log('ðŸ—‘ï¸ Cleared localStorage companies data after deletion (server error)');
        }

        // Force reload companies from API to ensure deletion took effect
        if (currentUser?.role === 'consultant' && currentUser?.consultantId) {
          console.log('ðŸ”„ Reloading companies from API after deletion (server error)');
          setTimeout(async () => {
            try {
              const { companies: freshCompanies } = await companiesApi.getAll(currentUser.consultantId);
              safeSetCompanies(freshCompanies || []);
              console.log('âœ… Reloaded companies after deletion (server error):', freshCompanies?.length || 0, 'companies');
            } catch (error) {
              console.error('âŒ Failed to reload companies after deletion (server error):', error);
            }
          }, 1000); // Small delay to ensure deletion is processed
        }

        setConsultants(Array.isArray(consultants) ? consultants.filter(c => c.id !== companyToDelete.businessId) : []);

        alert(`âœ… Company "${companyToDelete.companyName}" has been removed from your view. (Server update may be pending)`);

        setShowDeleteConfirmation(false);
        setCompanyToDelete(null);
      }
    } catch (error) {
      console.error('Error deleting company:', error);
      alert('âŒ An error occurred while deleting the company');
    }
  };

  // Load from localStorage (DEPRECATED - will be removed)
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const saved = {
      consultants: localStorage.getItem('fs_consultants'),
      companies: localStorage.getItem('fs_companies'),
      users: localStorage.getItem('fs_users'),
      currentUser: localStorage.getItem('fs_currentUser'),
      records: localStorage.getItem('fs_financialDataRecords'),
      selectedCompany: localStorage.getItem('fs_selectedCompanyId'),
      defaults: localStorage.getItem('fs_projectionDefaults'),
      assessmentResponses: localStorage.getItem('fs_assessmentResponses'),
      assessmentNotes: localStorage.getItem('fs_assessmentNotes'),
      assessmentRecords: localStorage.getItem('fs_assessmentRecords'),
      companyProfiles: localStorage.getItem('fs_companyProfiles'),
      priorityRatios: localStorage.getItem('fs_priorityRatios')
    };
    
    // Check user type first to determine if we should load assessment data
    const savedUser = saved.currentUser ? JSON.parse(saved.currentUser) : null;
    const isAssessmentUser = savedUser?.userType === 'assessment';
    
    if (saved.consultants) setConsultants(JSON.parse(saved.consultants));
    if (saved.companies) {
      const parsed = JSON.parse(saved.companies);
      safeSetCompanies(Array.isArray(parsed) ? parsed : []);
    }
    if (saved.users) setUsers(JSON.parse(saved.users));
    if (saved.records) setFinancialDataRecords(JSON.parse(saved.records));
    if (saved.selectedCompany) setSelectedCompanyId(saved.selectedCompany);
    // Don't load assessment responses from localStorage for assessment users - they'll load from DB
    if (saved.assessmentResponses && !isAssessmentUser) setAssessmentResponses(JSON.parse(saved.assessmentResponses));
    if (saved.assessmentNotes && !isAssessmentUser) setAssessmentNotes(JSON.parse(saved.assessmentNotes));
    if (saved.assessmentRecords) setAssessmentRecords(JSON.parse(saved.assessmentRecords));
    if (saved.companyProfiles) setCompanyProfiles(JSON.parse(saved.companyProfiles));
    if (saved.priorityRatios) setPriorityRatios(JSON.parse(saved.priorityRatios));
    
    if (saved.defaults) {
      const d = JSON.parse(saved.defaults);
      setDefaultBestCaseRevMult(d.bestCaseRev || 1.5);
      setDefaultBestCaseExpMult(d.bestCaseExp || 0.7);
      setDefaultWorstCaseRevMult(d.worstCaseRev || 0.5);
      setDefaultWorstCaseExpMult(d.worstCaseExp || 1.3);
      setBestCaseRevMultiplier(d.bestCaseRev || 1.5);
      setBestCaseExpMultiplier(d.bestCaseExp || 0.7);
      setWorstCaseRevMultiplier(d.worstCaseRev || 0.5);
      setWorstCaseExpMultiplier(d.worstCaseExp || 1.3);
    }
    
    if (saved.currentUser) {
      const user = JSON.parse(saved.currentUser);
      
      // Don't auto-login assessment users from localStorage - they should login fresh each time
      if (user.userType === 'assessment') {
        localStorage.removeItem('fs_currentUser');
        return;
      }
      
      setCurrentUser(user);
      setIsLoggedIn(true);
      
      // Set appropriate default view based on user type
      if (user.role === 'siteadmin') {
        setCurrentView('siteadmin');
      } else if (user.role === 'consultant') {
        setCurrentView('consultant-dashboard');
      } else {
        setCurrentView('upload');
      }
    }
  }, []);

  useEffect(() => { if (typeof window !== 'undefined' && consultants.length > 0) localStorage.setItem('fs_consultants', JSON.stringify(consultants)); }, [consultants]);
  useEffect(() => { if (typeof window !== 'undefined' && companies.length > 0) localStorage.setItem('fs_companies', JSON.stringify(companies)); }, [companies]);
  useEffect(() => { if (typeof window !== 'undefined' && users.length > 0) localStorage.setItem('fs_users', JSON.stringify(users)); }, [users]);
  useEffect(() => { if (typeof window !== 'undefined' && currentUser) localStorage.setItem('fs_currentUser', JSON.stringify(currentUser)); }, [currentUser]);
  useEffect(() => { if (typeof window !== 'undefined' && financialDataRecords.length > 0) localStorage.setItem('fs_financialDataRecords', JSON.stringify(financialDataRecords)); }, [financialDataRecords]);

  useEffect(() => { if (typeof window !== 'undefined' && Object.keys(assessmentResponses).length > 0 && currentUser?.userType !== 'assessment') localStorage.setItem('fs_assessmentResponses', JSON.stringify(assessmentResponses)); }, [assessmentResponses, currentUser]);
  useEffect(() => { if (typeof window !== 'undefined' && Object.keys(assessmentNotes).length > 0 && currentUser?.userType !== 'assessment') localStorage.setItem('fs_assessmentNotes', JSON.stringify(assessmentNotes)); }, [assessmentNotes, currentUser]);
  useEffect(() => { if (typeof window !== 'undefined' && assessmentRecords.length > 0) localStorage.setItem('fs_assessmentRecords', JSON.stringify(assessmentRecords)); }, [assessmentRecords]);
  useEffect(() => { if (typeof window !== 'undefined' && companyProfiles.length > 0) localStorage.setItem('fs_companyProfiles', JSON.stringify(companyProfiles)); }, [companyProfiles]);
  useEffect(() => { if (typeof window !== 'undefined' && priorityRatios.length > 0) localStorage.setItem('fs_priorityRatios', JSON.stringify(priorityRatios)); }, [priorityRatios]);
  
  // Fetch team members when viewing team management tab
  useEffect(() => {
    if (currentUser?.role === 'consultant' && currentUser?.consultantId && currentView === 'consultant-dashboard') {
      fetchTeamMembers();
    }
  }, [currentUser, currentView]);

  useEffect(() => {
    if (selectedCompanyId) {
      localStorage.setItem('fs_selectedCompanyId', selectedCompanyId);
      const record = financialDataRecords.find(r => r.companyId === selectedCompanyId);
      if (record) {
        setIsFreshUpload(false);
        setRawRows(record.rawRows);
        setMapping(record.mapping);
        setFile({ name: record.fileName } as File);
        setColumns(record.rawRows.length > 0 ? Object.keys(record.rawRows[0]) : []);
      } else {
        setRawRows([]);
        setMapping({ date: '' });
        setFile(null);
        setColumns([]);
        setIsFreshUpload(false);
      }
    }
  }, [selectedCompanyId, financialDataRecords]);

  // Load expense goals when Goals, Trend Analysis, or MD&A view is accessed
  useEffect(() => {
    if (selectedCompanyId && (currentView === 'goals' || currentView === 'trend-analysis' || currentView === 'mda')) {
      console.log('ðŸ“Š Loading expense goals for company:', selectedCompanyId);
      // Reset to empty first, so fields are blank while loading
      setExpenseGoals({});
      
      fetch(`/api/expense-goals?companyId=${selectedCompanyId}`)
        .then(res => res.json())
        .then(data => {
          console.log('ðŸ“Š Expense goals loaded:', data);
          if (data.success && data.goals) {
            // Filter out any zero or invalid values so fields stay blank
            const filteredGoals: {[key: string]: number} = {};
            Object.entries(data.goals).forEach(([key, value]) => {
              if (typeof value === 'number' && value > 0) {
                filteredGoals[key] = value;
              }
            });
            setExpenseGoals(filteredGoals);
          } else {
            // Keep empty if no goals found for this company
            setExpenseGoals({});
          }
        })
        .catch(err => {
          console.error('? Error loading expense goals:', err);
          // Keep empty on error
          setExpenseGoals({});
        });
    }
  }, [selectedCompanyId, currentView]);

  // Load valuation settings when company changes
  useEffect(() => {
    if (selectedCompanyId) {
      fetch(`/api/valuation-settings?companyId=${selectedCompanyId}`)
        .then(res => res.json())
        .then(data => {
          console.log('ðŸ“Š Valuation settings loaded:', data);
          setSdeMultiplier(data.sdeMultiplier || 2.5);
          setEbitdaMultiplier(data.ebitdaMultiplier || 5.0);
          setDcfDiscountRate(data.dcfDiscountRate || 10.0);
          setDcfTerminalGrowth(data.dcfTerminalGrowth || 2.0);
        })
        .catch(err => {
          console.error('? Error loading valuation settings:', err);
          // Keep defaults on error
          setSdeMultiplier(2.5);
          setEbitdaMultiplier(5.0);
          setDcfDiscountRate(10.0);
          setDcfTerminalGrowth(2.0);
        });
    }
  }, [selectedCompanyId]);

  // Load dashboard widgets from localStorage when company changes
  useEffect(() => {
    if (selectedCompanyId) {
      const storageKey = `dashboardWidgets_${selectedCompanyId}`;
      const savedWidgets = localStorage.getItem(storageKey);
      if (savedWidgets) {
        try {
          const widgets = JSON.parse(savedWidgets);
          // Filter out obsolete widget names that are no longer available
          const obsoleteWidgets = ['Revenue Trend', 'Expense Trend', 'Net Profit Trend', 'Gross Margin Trend'];
          const cleanedWidgets = widgets.filter((w: string) => !obsoleteWidgets.includes(w));
          setSelectedDashboardWidgets(cleanedWidgets);
          
          // Update localStorage if we removed any obsolete widgets
          if (cleanedWidgets.length !== widgets.length) {
            localStorage.setItem(storageKey, JSON.stringify(cleanedWidgets));
          }
        } catch (err) {
          console.error('Error loading dashboard widgets:', err);
          setSelectedDashboardWidgets([]);
        }
      } else {
        // No saved widgets for this company, start fresh
        setSelectedDashboardWidgets([]);
      }
    }
  }, [selectedCompanyId]);

  // Load saved account mappings and CSV data when company changes or data-mapping tab is visited
  useEffect(() => {
    if (selectedCompanyId && adminDashboardTab === 'data-mapping') {
      console.log('ðŸ“Š Loading saved data for company:', selectedCompanyId);
      
      // Load CSV Trial Balance data from localStorage
      const savedCsvData = localStorage.getItem(`csvTrialBalance_${selectedCompanyId}`);
      if (savedCsvData && !csvTrialBalanceData) {
        try {
          const parsed = JSON.parse(savedCsvData);
          if (parsed._companyId === selectedCompanyId) {
            console.log('? Loaded CSV Trial Balance from localStorage:', parsed.fileName);
            setCsvTrialBalanceData(parsed);
          }
        } catch (err) {
          console.error('? Error parsing saved CSV data:', err);
        }
      }
      
      // Load account mappings from database
      fetch(`/api/account-mappings?companyId=${selectedCompanyId}`)
        .then(res => res.json())
        .then(data => {
          if (data.mappings && data.mappings.length > 0) {
            console.log(`? Loaded ${data.mappings.length} saved account mappings`);
            // Convert to aiMappings format
            const loadedMappings = data.mappings.map((m: any) => ({
              qbAccount: m.qbAccount,
              qbAccountId: m.qbAccountId,
              qbAccountClassification: m.qbAccountClassification,
              targetField: m.targetField,
              confidence: m.confidence || 'medium',
              lobAllocations: m.lobAllocations,
            }));
            setAiMappings(loadedMappings);
            setShowMappingSection(true);
          }
          if (data.linesOfBusiness && Array.isArray(data.linesOfBusiness) && data.linesOfBusiness.length > 0) {
            console.log('? Loaded saved Lines of Business:', data.linesOfBusiness);
            // Convert from stored format to LOBData format
            const lobData = data.linesOfBusiness.map((lob: any) => ({
              name: typeof lob === 'string' ? lob : (lob.name || ''),
              headcountPercentage: typeof lob === 'object' ? (lob.headcountPercentage || 0) : 0,
              customPercentage: typeof lob === 'object' ? (lob.customPercentage || 0) : 0
            })).filter((lob: LOBData) => lob.name.trim() !== '');
            setLinesOfBusiness(lobData);

            // Load user defined allocations
            if (data.userDefinedAllocations && Array.isArray(data.userDefinedAllocations)) {
              setUserDefinedAllocations(data.userDefinedAllocations);
            } else {
              setUserDefinedAllocations([]);
            }
          } else {
            setLinesOfBusiness([]);
            setUserDefinedAllocations([]);
          }
        })
        .catch(err => {
          console.error('? Error loading saved mappings:', err);
        });
    }
  }, [selectedCompanyId, adminDashboardTab]);

  // Save dashboard widgets to localStorage whenever they change
  useEffect(() => {
    if (selectedCompanyId && selectedDashboardWidgets) {
      const storageKey = `dashboardWidgets_${selectedCompanyId}`;
      localStorage.setItem(storageKey, JSON.stringify(selectedDashboardWidgets));
    }
  }, [selectedCompanyId, selectedDashboardWidgets]);

  // Load affiliates when Affiliates tab is opened
  useEffect(() => {
    if (siteAdminTab === 'affiliates') {
      fetch('/api/affiliates')
        .then(res => res.json())
        .then(data => {
          if (data.affiliates) {
            setAffiliates(data.affiliates);
          }
        })
        .catch(err => console.error('Error loading affiliates:', err));
    }
  }, [siteAdminTab]);


  // Load site administrators when tab is opened
  useEffect(() => {
    if (siteAdminTab === 'siteadmins') {
      fetch('/api/siteadmins')
        .then(res => {
          if (!res.ok) {
            throw new Error('Failed to fetch site administrators');
          }
          return res.json();
        })
        .then(data => {
          setSiteAdmins(Array.isArray(data) ? data : []);
        })
        .catch(error => {
          console.error('Error loading site administrators:', error);
          setSiteAdmins([]);
        });
    }
  }, [siteAdminTab]);

  // Load default pricing when Default Pricing tab is opened
  useEffect(() => {
    if (siteAdminTab === 'default-pricing') {
      fetch('/api/settings')
        .then(res => res.json())
        .then(data => {
          if (data.settings) {
            setDefaultBusinessMonthlyPrice(data.settings.businessMonthlyPrice ?? 195);
            setDefaultBusinessQuarterlyPrice(data.settings.businessQuarterlyPrice ?? 500);
            setDefaultBusinessAnnualPrice(data.settings.businessAnnualPrice ?? 1750);
            setDefaultConsultantMonthlyPrice(data.settings.consultantMonthlyPrice ?? 195);
            setDefaultConsultantQuarterlyPrice(data.settings.consultantQuarterlyPrice ?? 500);
            setDefaultConsultantAnnualPrice(data.settings.consultantAnnualPrice ?? 1750);
          }
        })
        .catch(err => console.error('Error loading default pricing:', err));
    }
  }, [siteAdminTab]);

  // Handle URL parameters for navigation and messages
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const urlParams = new URLSearchParams(window.location.search);
    const view = urlParams.get('view');
    const tab = urlParams.get('tab');
    const success = urlParams.get('success');
    const error = urlParams.get('error');

    // Set view if specified
    if (view === 'admin') {
      setCurrentView('admin');
    }

    // Set admin dashboard tab if specified
    if (tab === 'api-connections' || tab === 'import-financials' || tab === 'company-management' || tab === 'data-review') {
      setAdminDashboardTab(tab);
    }

    // Show success message
    if (success === 'quickbooks_connected') {
      alert('QuickBooks connected successfully! You can now sync your financial data.');
      // Clean URL
      window.history.replaceState({}, '', window.location.pathname + '?view=admin');
    }

    // Show error message
    if (error === 'quickbooks_connection_failed') {
      alert('Failed to connect to QuickBooks. Please try again.');
      // Clean URL
      window.history.replaceState({}, '', window.location.pathname + '?view=admin');
    }
  }, []);

  // Load company-specific data from API when company is selected
  useEffect(() => {
    const loadCompanyData = async () => {
      // Prevent execution during server-side rendering
      if (typeof window === 'undefined') return;

      if (!selectedCompanyId || !currentUser) return;
      
      try {
        // ALWAYS clear state at the start to prevent stale data
        console.log('ðŸ§¹ Clearing all state before loading new company data');
        setQbRawData(null);
        setRawRows([]);
        setMapping({ date: '' });
        setFile(null);
        setColumns([]);
        
        // Load users for this company
        console.log('Loading users for company:', selectedCompanyId);
        const { users: companyUsers } = await usersApi.getByCompany(selectedCompanyId);
        console.log('Users loaded from API:', companyUsers);
        
        // Normalize role and userType to lowercase
        const normalizedUsers = companyUsers.map((u: any) => ({
          ...u,
          role: u.role.toLowerCase(),
          userType: u.userType?.toLowerCase()
        }));
        console.log('Normalized users:', normalizedUsers);
        
        setUsers((prevUsers) => {
          const otherUsers = prevUsers.filter(u => u.companyId !== selectedCompanyId);
          const newUsers = [...otherUsers, ...normalizedUsers];
          console.log('Setting users state:', newUsers);
          return newUsers;
        });
        
        // Load financial records
        const selectedCompany = Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined;
        const companyName = selectedCompany?.name || 'Unknown';
        console.log(`ðŸ“‚ LOADING DATA FOR: "${companyName}" (ID: ${selectedCompanyId})`);
        
        const { records } = await financialsApi.getByCompany(selectedCompanyId);
        console.log(`ðŸ“‚ Found ${records.length} financial records for company "${companyName}"`);
        
        // If no records found, clear aiMappings as well
        if (!records || records.length === 0) {
          console.log(`ðŸ§¹ No records found - clearing aiMappings too`);
          setAiMappings([]);
        } else if (records && records.length > 0) {
          const latestRecord = records[0];
          console.log(`ðŸ“‚ Latest record ID: ${latestRecord.id}, created: ${latestRecord.createdAt}`);
          
          // Check if this is QuickBooks data and extract raw QB financial statements
          if (latestRecord.rawData && typeof latestRecord.rawData === 'object' && 
              !Array.isArray(latestRecord.rawData) &&
              (latestRecord.rawData.profitAndLoss || latestRecord.rawData.balanceSheet)) {
            // QuickBooks data - use monthlyData directly
            console.log(`ðŸ”„ Loading QB data for company: "${companyName}" (${selectedCompanyId})`);
            console.log(`ðŸ“„ Record belongs to company ID: ${latestRecord.companyId}`);
            console.log(`ðŸ“… QB Data sync date:`, latestRecord.rawData.syncDate);
            console.log(`ðŸ”‘ QB rawData object keys:`, Object.keys(latestRecord.rawData));
            console.log(`? SETTING qbRawData with sync date:`, latestRecord.rawData.syncDate);
            // Add companyId to the raw data so we can verify it matches
            setQbRawData({
              ...latestRecord.rawData,
              _companyId: selectedCompanyId,
              _recordId: latestRecord.id
            });
            console.log(`ðŸ’¾ Set qbRawData for company: ${selectedCompanyId}, record: ${latestRecord.id}`);
            // Force re-render of Financial Statements view
            setDataRefreshKey(prev => prev + 1);
            setRawRows([]); // Set empty array since rawRows is not used for QB data
            setMapping(latestRecord.columnMapping || { date: '' });
            setFile({ name: latestRecord.fileName } as File);
            setColumns([]);
            
            // Convert monthlyData to the format expected by the app
            const convertedMonthly = latestRecord.monthlyData.map((m: any) => ({
              date: new Date(m.monthDate),
              month: new Date(m.monthDate).toLocaleDateString('en-US', { month: '2-digit', year: 'numeric' }),
              revenue: m.revenue || 0,
              expense: m.expense || 0,
              cogsPayroll: m.cogsPayroll || 0,
              cogsOwnerPay: m.cogsOwnerPay || 0,
              cogsContractors: m.cogsContractors || 0,
              cogsMaterials: m.cogsMaterials || 0,
              cogsCommissions: m.cogsCommissions || 0,
              cogsOther: m.cogsOther || 0,
              cogsTotal: m.cogsTotal || 0,
              payroll: m.payroll || 0,
              ownerBasePay: m.ownerBasePay || 0,
              benefits: m.benefits || 0,
              insurance: m.insurance || 0,
              professionalFees: m.professionalFees || 0,
              subcontractors: m.subcontractors || 0,
              rent: m.rent || 0,
              taxLicense: m.taxLicense || 0,
              phoneComm: m.phoneComm || 0,
              infrastructure: m.infrastructure || 0,
              autoTravel: m.autoTravel || 0,
              salesExpense: m.salesExpense || 0,
              marketing: m.marketing || 0,
              trainingCert: m.trainingCert || 0,
              mealsEntertainment: m.mealsEntertainment || 0,
              interestExpense: m.interestExpense || 0,
              depreciationAmortization: m.depreciationAmortization || 0,
              otherExpense: m.otherExpense || 0,
              nonOperatingIncome: m.nonOperatingIncome || 0,
              extraordinaryItems: m.extraordinaryItems || 0,
              netProfit: m.netProfit || 0,
              ownersRetirement: 0,
              operatingExpenseTotal: m.expense || 0,
              cash: m.cash || 0,
              ar: m.ar || 0,
              inventory: m.inventory || 0,
              otherCA: m.otherCA || 0,
              tca: m.tca || 0,
              fixedAssets: m.fixedAssets || 0,
              otherAssets: m.otherAssets || 0,
              totalAssets: m.totalAssets || 0,
              ap: m.ap || 0,
              otherCL: m.otherCL || 0,
              tcl: m.tcl || 0,
              ltd: m.ltd || 0,
              totalLiab: m.totalLiab || 0,
              ownersCapital: m.ownersCapital || 0,
              ownersDraw: m.ownersDraw || 0,
              commonStock: m.commonStock || 0,
              preferredStock: m.preferredStock || 0,
              retainedEarnings: m.retainedEarnings || 0,
              additionalPaidInCapital: m.additionalPaidInCapital || 0,
              treasuryStock: m.treasuryStock || 0,
              totalEquity: m.totalEquity || 0,
              totalLAndE: m.totalLAndE || 0,
              // LOB Breakdown fields
              revenueBreakdown: m.revenueBreakdown || null,
              expenseBreakdown: m.expenseBreakdown || null,
              cogsBreakdown: m.cogsBreakdown || null,
              lobBreakdowns: m.lobBreakdowns || null
            }));
            setLoadedMonthlyData(convertedMonthly);
          } else {
            // CSV/Trial Balance data - check if it has processed monthly data
            setQbRawData(null);
            
            // If this record has monthlyData, it's a processed Trial Balance - load it like QB data
            if (latestRecord.monthlyData && latestRecord.monthlyData.length > 0) {
              console.log(`ðŸ“Š Loading processed Trial Balance data: ${latestRecord.monthlyData.length} months`);
              const convertedMonthly = latestRecord.monthlyData.map((m: any) => ({
                date: new Date(m.monthDate),
                month: new Date(m.monthDate).toLocaleDateString('en-US', { month: '2-digit', year: 'numeric' }),
                revenue: m.revenue || 0,
                revenueBreakdown: m.revenueBreakdown || null,
                expense: m.expense || 0,
                expenseBreakdown: m.expenseBreakdown || null,
                cogsPayroll: m.cogsPayroll || 0,
                cogsOwnerPay: m.cogsOwnerPay || 0,
                cogsContractors: m.cogsContractors || 0,
                cogsMaterials: m.cogsMaterials || 0,
                cogsCommissions: m.cogsCommissions || 0,
                cogsOther: m.cogsOther || 0,
                cogsTotal: m.cogsTotal || 0,
                cogsBreakdown: m.cogsBreakdown || null,
                // Operating Expenses - map DB names to display names
                payroll: m.payroll || 0,
                ownerBasePay: m.ownerBasePay || 0,
                ownersRetirement: 0,
                benefits: m.benefits || 0,
                insurance: m.insurance || 0,
                professionalFees: m.professionalFees || 0,
                subcontractors: m.subcontractors || 0,
                rent: m.rent || 0,
                taxLicense: m.taxLicense || 0,
                phoneComm: m.phoneComm || 0,
                infrastructure: m.infrastructure || 0,
                autoTravel: m.autoTravel || 0,
                salesExpense: m.salesExpense || 0,
                marketing: m.marketing || m.otherExpense || 0,
                trainingCert: m.trainingCert || 0,
                mealsEntertainment: m.mealsEntertainment || 0,
                interestExpense: m.interestExpense || 0,
                depreciationAmortization: m.depreciationAmortization || 0,
                otherExpense: m.otherExpense || 0,
                operatingExpenseTotal: m.expense || 0,
                nonOperatingIncome: m.nonOperatingIncome || 0,
                extraordinaryItems: m.extraordinaryItems || 0,
                netProfit: m.netProfit || 0,
                // Balance Sheet
                cash: m.cash || 0,
                ar: m.ar || 0,
                inventory: m.inventory || 0,
                otherCA: m.otherCA || 0,
                tca: m.tca || 0,
                fixedAssets: m.fixedAssets || 0,
                otherAssets: m.otherAssets || 0,
                totalAssets: m.totalAssets || 0,
                ap: m.ap || 0,
                otherCL: m.otherCL || 0,
                tcl: m.tcl || 0,
                ltd: m.ltd || 0,
                totalLiab: m.totalLiab || 0,
                // Equity
                ownersCapital: m.ownersCapital || 0,
                ownersDraw: m.ownersDraw || 0,
                commonStock: m.commonStock || 0,
                preferredStock: m.preferredStock || 0,
                retainedEarnings: m.retainedEarnings || 0,
                additionalPaidInCapital: m.additionalPaidInCapital || 0,
                treasuryStock: m.treasuryStock || 0,
                totalEquity: m.totalEquity || 0,
                totalLAndE: m.totalLAndE || 0,
                lobBreakdowns: m.lobBreakdowns || null
              }));
              setLoadedMonthlyData(convertedMonthly);
              console.log(`? Trial Balance monthly data loaded with ${convertedMonthly.length} months`);
            } else {
              // Legacy CSV upload - set rawRows for manual processing
              setRawRows(latestRecord.rawData);
              setMapping(latestRecord.columnMapping);
              setFile({ name: latestRecord.fileName } as File);
              setColumns(Object.keys(latestRecord.rawData[0] || {}));
              setLoadedMonthlyData([]); // Only clear for legacy CSV that needs processing
            }
          }
        }
        
        // Load assessment records
        console.log(`ðŸ“Š Loading assessment records for company: ${selectedCompanyId}`);
        const { records: assessments } = await assessmentsApi.getByCompany(selectedCompanyId);
        console.log(`ðŸ“Š Loaded ${assessments?.length || 0} assessment records:`, assessments);
        setAssessmentRecords(assessments || []);
        console.log(`? Assessment records set in state`);
        
        // Load company profile
        const { profile } = await profilesApi.get(selectedCompanyId);
        if (profile) {
          setCompanyProfiles((prev) => {
            const filtered = prev.filter(p => p.companyId !== selectedCompanyId);
            return [...filtered, profile];
          });
        }
        
        // Load saved account mappings
        try {
          const mappingsResponse = await fetch(`/api/account-mappings?companyId=${selectedCompanyId}`);
          if (mappingsResponse.ok) {
            const { mappings, linesOfBusiness: savedLobs } = await mappingsResponse.json();
            if (mappings && mappings.length > 0) {
              console.log('Loaded saved account mappings:', mappings);
              setAiMappings(mappings);
              if (savedLobs && Array.isArray(savedLobs) && savedLobs.length > 0) {
                console.log('Loaded saved Lines of Business:', savedLobs);
              // Convert from stored format to LOBData format
              const lobData = savedLobs.map((lob: any) => ({
                name: typeof lob === 'string' ? lob : (lob.name || ''),
                headcountPercentage: typeof lob === 'object' ? (lob.headcountPercentage || 0) : 0,
                customPercentage: typeof lob === 'object' ? (lob.customPercentage || 0) : 0
              })).filter((lob: LOBData) => lob.name.trim() !== '');
              setLinesOfBusiness(lobData);
              // Note: userDefinedAllocations not loaded from this endpoint, will be loaded separately
              }
              setShowMappingSection(true);
            }
          }
        } catch (error) {
          console.error('Error loading account mappings:', error);
        }
        
        // Load industry benchmarks
        const company = Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined;
        if (company && company.industrySector) {
          console.log('Company has industry sector:', company.industrySector);
          // Get the latest Total Assets to determine asset size category
          let assetCategory = '1m-5m'; // Default to middle range
          if (records && records.length > 0) {
            const latestRecord = records[0];
            const monthlyData = latestRecord.monthlyData || [];
            if (monthlyData.length > 0) {
              const mostRecentMonth = monthlyData[monthlyData.length - 1];
              const totalAssets = mostRecentMonth.totalAssets || 0;
              assetCategory = getAssetSizeCategory(totalAssets);
              console.log('Total Assets:', totalAssets, '-> Asset Category:', assetCategory);
            }
          }
          
          // Fetch benchmarks for this industry and asset size
          console.log('Fetching benchmarks for industry:', company.industrySector, 'assetSize:', assetCategory);
          const benchmarkData = await benchmarksApi.get(String(company.industrySector), assetCategory);
          setBenchmarks(benchmarkData || []);
          console.log('? Loaded', benchmarkData?.length || 0, 'benchmarks');
          if (benchmarkData && benchmarkData.length > 0) {
            console.log('Sample benchmarks:', benchmarkData.slice(0, 3).map((b: any) => b.metricName).join(', '));
          }
        } else {
          console.log('âš ï¸ Cannot load benchmarks:', !company ? 'Company not found' : 'Industry sector not set');
        }

          // Load subscription pricing for this company (now stored permanently in DB)
          if (company) {
            console.log('ðŸ” Loading pricing from company data:', {
              name: company.name,
              id: company.id,
              monthly: company.subscriptionMonthlyPrice,
              quarterly: company.subscriptionQuarterlyPrice,
              annual: company.subscriptionAnnualPrice
            });

            // Load pricing from database (try dedicated fields first, then userDefinedAllocations)
            let monthly = company.subscriptionMonthlyPrice;
            let quarterly = company.subscriptionQuarterlyPrice;
            let annual = company.subscriptionAnnualPrice;

            // If dedicated pricing fields are null/undefined, try userDefinedAllocations backup
            if ((monthly === null || monthly === undefined) &&
                company.userDefinedAllocations?.subscriptionPricing) {
              console.log('ðŸ”„ Using backup pricing from userDefinedAllocations');
              monthly = company.userDefinedAllocations.subscriptionPricing.monthly;
              quarterly = company.userDefinedAllocations.subscriptionPricing.quarterly;
              annual = company.userDefinedAllocations.subscriptionPricing.annual;
            }

            // Check if we have valid pricing data
            const hasPricingData = monthly !== null && quarterly !== null && annual !== null &&
                                  monthly !== undefined && quarterly !== undefined && annual !== undefined;

            if (hasPricingData) {
              // Use stored pricing from database
              setSubscriptionMonthlyPrice(monthly);
              setSubscriptionQuarterlyPrice(quarterly);
              setSubscriptionAnnualPrice(annual);
              console.log('âœ… Loaded pricing from database:', { monthly, quarterly, annual, isFree: monthly === 0 && quarterly === 0 && annual === 0 });
            } else {
              // No pricing data available, fall back to defaults
              console.log('âš ï¸ No pricing data available, using defaults');
              setSubscriptionMonthlyPrice(195);
              setSubscriptionQuarterlyPrice(500);
              setSubscriptionAnnualPrice(1750);
            }

            console.log('âœ… Pricing loaded from database:', {
              monthly: company.subscriptionMonthlyPrice ?? 195,
              quarterly: company.subscriptionQuarterlyPrice ?? 500,
              annual: company.subscriptionAnnualPrice ?? 1750,
              isFree: (company.subscriptionMonthlyPrice ?? 195) === 0 &&
                      (company.subscriptionQuarterlyPrice ?? 500) === 0 &&
                      (company.subscriptionAnnualPrice ?? 1750) === 0
            });
          }

        // Check QuickBooks connection status
        await checkQBStatus(selectedCompanyId);
      } catch (error) {
        console.error('Error loading company data:', error);
      }
    };
    
    loadCompanyData();
  }, [selectedCompanyId, currentUser, qbLastSync]);


  // Track which consultant's companies are currently loaded
  const [loadedConsultantId, setLoadedConsultantId] = useState<string | null>(null);

  // Load companies for consultants
  useEffect(() => {
    const loadConsultantCompanies = async () => {
      if (!currentUser || currentUser.role !== 'consultant' || !currentUser.consultantId) return;
      
      // Only reload if consultant changed (handles site admin viewing as different consultants)
      if (loadedConsultantId === currentUser.consultantId) return;
      
      // CRITICAL: Clear companies immediately to prevent showing wrong consultant's data
      safeSetCompanies([]);
      
      try {
        const { companies: consultantCompanies } = await companiesApi.getAll(currentUser.consultantId);
        safeSetCompanies(consultantCompanies || []);
        setLoadedConsultantId(currentUser.consultantId);
        
        // Load all users and assessment records for all companies
        const allUsers: User[] = [];
        const allAssessments: AssessmentRecord[] = [];
        for (const company of consultantCompanies || []) {
          try {
            // Load users for this company
            const { users: companyUsers } = await usersApi.getByCompany(company.id);
            if (companyUsers) {
              const normalizedUsers = companyUsers.map((u: any) => ({
                ...u,
                role: u.role?.toLowerCase() || 'user',
                userType: u.userType?.toLowerCase() || 'company'
              }));
              allUsers.push(...normalizedUsers);
            }
            
            // Load assessment records for this company
            const { records } = await assessmentsApi.getByCompany(company.id);
            if (records) {
              console.log(`ðŸ“Š Loaded ${records.length} assessment records for company ${company.id} (${company.name}):`, 
                records.map((r: any) => ({ userEmail: r.user?.email, companyId: r.companyId, answersCount: Object.keys(r.responses || {}).length }))
              );
              allAssessments.push(...records);
            }
          } catch (error) {
            console.error(`Error loading data for company ${company.id}:`, error);
          }
        }
        console.log(`? Total loaded: ${allUsers.length} users, ${allAssessments.length} assessment records`);
        console.log(`Assessment users:`, allUsers.filter(u => u.userType === 'assessment').map(u => ({ email: u.email, companyId: u.companyId })));
        setUsers(allUsers);
        setAssessmentRecords(allAssessments);
      } catch (error) {
        console.error('Error loading consultant companies:', error);
      }
    };
    
    loadConsultantCompanies();
  }, [currentUser?.consultantId, currentUser?.role, loadedConsultantId]);

  // Load consultants for site admin
  useEffect(() => {
    const loadConsultants = async () => {
      if (!currentUser || currentUser.role !== 'siteadmin') return;
      
      try {
        const { consultants: loadedConsultants } = await consultantsApi.getAll();
        // Map the user data to consultant level for easier access in the UI
        const mappedConsultants = (loadedConsultants || []).map((c: any) => ({
          ...c,
          email: c.user?.email || c.email || '',
          password: '' // Don't expose passwords
        }));
        setConsultants(mappedConsultants);
        
        // Also load all companies and users for display
        const allCompanies: any[] = [];
        const allUsers: any[] = [];
        for (const consultant of loadedConsultants || []) {
          if (consultant.companies) {
            allCompanies.push(...consultant.companies);
          }
        }
        safeSetCompanies(allCompanies);
      } catch (error) {
        console.error('Error loading consultants:', error);
      }
    };
    
    loadConsultants();
  }, [currentUser]);

  // Load financial data when company is selected
  useEffect(() => {
    const loadFinancialData = async () => {
      if (!selectedCompanyId) {
        setLoadedMonthlyData([]);
        return;
      }
      
      try {
        console.log('Loading financial data for company:', selectedCompanyId);
        const response = await fetch(`/api/financials?companyId=${selectedCompanyId}`);
        
        if (!response.ok) {
          console.log('No financial data found for company');
          setLoadedMonthlyData([]);
          return;
        }
        
        const data = await response.json();
        if (data.records && data.records.length > 0 && data.records[0].monthlyData) {
          const monthlyData = data.records[0].monthlyData;
          
          // Convert API data to the format expected by the app
          const formattedData = monthlyData.map((m: any) => ({
            date: new Date(m.monthDate),
            month: m.month || new Date(m.monthDate).toLocaleDateString('en-US', { month: '2-digit', year: 'numeric' }),
            revenue: m.revenue || 0,
            expense: m.expense || 0,
            // COGS Breakdown - map QB aggregated data to detailed fields for Data Review compatibility
            cogsPayroll: m.cogsPayroll || m.payroll || 0,  // Map payroll to cogsPayroll
            cogsOwnerPay: m.cogsOwnerPay || m.ownerBasePay || 0,  // Map owner pay to cogsOwnerPay
            cogsContractors: m.cogsContractors || m.subcontractors || 0,  // Map subcontractors to contractors
            cogsMaterials: m.cogsMaterials || 0,
            cogsCommissions: m.cogsCommissions || 0,
            cogsOther: m.cogsOther || 0,
            cogsTotal: m.cogsTotal || 0,
            // Operating Expenses - map DB field names to display field names
            payroll: m.payroll || m.payroll || 0,
            ownerBasePay: m.ownerBasePay || m.ownerBasePay || 0,
            ownersRetirement: m.ownersRetirement || 0,
            benefits: m.benefits || 0,
            insurance: m.insurance || 0,
            professionalFees: m.professionalFees || m.professionalFees || 0,
            subcontractors: m.subcontractors || m.subcontractors || 0,
            rent: m.rent || 0,
            taxLicense: m.taxLicense || 0,
            phoneComm: m.phoneComm || 0,
            infrastructure: m.infrastructure || 0,
            autoTravel: m.autoTravel || 0,
            salesExpense: m.salesExpense || 0,
            marketing: m.marketing || m.otherExpense || m.marketing || 0,
            trainingCert: m.trainingCert || 0,
            mealsEntertainment: m.mealsEntertainment || 0,
            interestExpense: m.interestExpense || 0,
            depreciationAmortization: m.depreciationAmortization || m.depreciationAmortization || 0,
            otherExpense: m.otherExpense || 0,
            operatingExpenseTotal: m.operatingExpenseTotal || m.expense || 0,
            nonOperatingIncome: m.nonOperatingIncome || 0,
            extraordinaryItems: m.extraordinaryItems || 0,
            netProfit: m.netProfit || 0,
            // Balance Sheet - Assets
            totalAssets: m.totalAssets || 0,
            cash: m.cash || 0,
            ar: m.ar || 0,
            inventory: m.inventory || 0,
            otherCA: m.otherCA || 0,
            tca: m.tca || 0,
            fixedAssets: m.fixedAssets || 0,
            otherAssets: m.otherAssets || 0,
            // Balance Sheet - Liabilities
            ap: m.ap || 0,
            otherCL: m.otherCL || 0,
            tcl: m.tcl || 0,
            ltd: m.ltd || 0,
            totalLiab: m.totalLiab || 0,
            // Balance Sheet - Equity (detailed)
            ownersCapital: m.ownersCapital || 0,
            ownersDraw: m.ownersDraw || 0,
            commonStock: m.commonStock || 0,
            preferredStock: m.preferredStock || 0,
            retainedEarnings: m.retainedEarnings || 0,
            additionalPaidInCapital: m.additionalPaidInCapital || 0,
            treasuryStock: m.treasuryStock || 0,
            totalEquity: m.totalEquity || 0,
            totalLAndE: m.totalLAndE || 0
          }));
          
          console.log('? Loaded', formattedData.length, 'months of financial data from database');
          console.log('ðŸ“Š RAW from database (sample):', monthlyData[0] ? {
            revenue: monthlyData[0].revenue,
            payroll: monthlyData[0].payroll,
            professionalFees: monthlyData[0].professionalFees,
            rent: monthlyData[0].rent,
            insurance: monthlyData[0].insurance,
            infrastructure: monthlyData[0].infrastructure,
            retainedEarnings: monthlyData[0].retainedEarnings,
            ownersDraw: monthlyData[0].ownersDraw
          } : 'no data');
          console.log('ðŸ“ˆ FORMATTED for display (sample):', formattedData[0] ? {
            revenue: formattedData[0].revenue,
            payroll: formattedData[0].payroll,
            professionalFees: formattedData[0].professionalFees,
            rent: formattedData[0].rent,
            insurance: formattedData[0].insurance,
            utilities: formattedData[0].infrastructure,
            retainedEarnings: formattedData[0].retainedEarnings,
            ownersDraw: formattedData[0].ownersDraw
          } : 'no data');
          setLoadedMonthlyData(formattedData);
        } else {
          console.log('No monthly data in response');
          setLoadedMonthlyData([]);
        }
      } catch (error) {
        console.error('Error loading financial data:', error);
        setLoadedMonthlyData([]);
      }
    };
    
    loadFinancialData();
  }, [selectedCompanyId, qbLastSync]);

  useEffect(() => {
    const saveFinancialData = async () => {
      if (!file || rawRows.length === 0 || !mapping.date || !selectedCompanyId || !currentUser || !isFreshUpload) return;
      
      try {
        console.log('Saving financial data to database...');
        // Use normalizeRows to process the data
        const normalized = normalizeRows(rawRows, mapping);
        
        // Process raw rows to get full data with all fields (same as monthly useMemo)
        const fullMonthlyData = rawRows.map((row, i) => {
          const monthValue = row[mapping.date] || `Month ${i + 1}`;
          // Parse date string to create monthDate
          let monthDate = new Date();
          const monthValueStr = String(monthValue);
          if (monthValue && typeof monthValue === 'string' && monthValue.includes('/')) {
            const [month, day, year] = monthValue.split('/');
            monthDate = new Date(parseInt(year), parseInt(month) - 1, 1);
          } else if (monthValue && typeof monthValue === 'string' && monthValue.includes('-')) {
            monthDate = new Date(monthValue);
          } else if (typeof monthValue === 'number') {
            // Handle Excel serial date numbers
            const excelEpoch = new Date(1899, 11, 30);
            monthDate = new Date(excelEpoch.getTime() + monthValue * 24 * 60 * 60 * 1000);
          }
          
          return {
          month: monthValueStr,
          monthDate: monthDate.toISOString(),
          revenue: parseFloat(row[mapping.revenue!]) || 0,
          expense: parseFloat(row[mapping.expense!]) || 0,
          cogsPayroll: parseFloat(row[mapping.cogsPayroll!]) || 0,
          cogsOwnerPay: parseFloat(row[mapping.cogsOwnerPay!]) || 0,
          cogsContractors: parseFloat(row[mapping.cogsContractors!]) || 0,
          cogsMaterials: parseFloat(row[mapping.cogsMaterials!]) || 0,
          cogsCommissions: parseFloat(row[mapping.cogsCommissions!]) || 0,
          cogsOther: parseFloat(row[mapping.cogsOther!]) || 0,
          cogsTotal: parseFloat(row[mapping.cogsTotal!]) || 0,
          salesExpense: parseFloat(row[mapping.salesExpense!]) || 0,
          rent: parseFloat(row[mapping.rent!]) || 0,
          infrastructure: parseFloat(row[mapping.infrastructure!]) || 0,
          autoTravel: parseFloat(row[mapping.autoTravel!]) || 0,
          professionalFees: parseFloat(row[mapping.professionalFees!]) || 0,
          insurance: parseFloat(row[mapping.insurance!]) || 0,
          marketing: parseFloat(row[mapping.marketing!]) || 0,
          payroll: parseFloat(row[mapping.payroll!]) || 0,
          ownerBasePay: parseFloat(row[mapping.ownerBasePay!]) || 0,
          ownersRetirement: parseFloat(row[mapping.ownersRetirement!]) || 0,
          subcontractors: parseFloat(row[mapping.subcontractors!]) || 0,
          interestExpense: parseFloat(row[mapping.interestExpense!]) || 0,
          depreciationAmortization: parseFloat(row[mapping.depreciationAmortization!]) || 0,
          operatingExpenseTotal: parseFloat(row[mapping.operatingExpenseTotal!]) || 0,
          nonOperatingIncome: parseFloat(row[mapping.nonOperatingIncome!]) || 0,
          extraordinaryItems: parseFloat(row[mapping.extraordinaryItems!]) || 0,
          netProfit: parseFloat(row[mapping.netProfit!]) || 0,
          totalAssets: parseFloat(row[mapping.totalAssets!]) || 0,
          totalLiab: parseFloat(row[mapping.totalLiab!]) || 0,
          cash: parseFloat(row[mapping.cash!]) || 0,
          ar: parseFloat(row[mapping.ar!]) || 0,
          inventory: parseFloat(row[mapping.inventory!]) || 0,
          otherCA: parseFloat(row[mapping.otherCA!]) || 0,
          tca: parseFloat(row[mapping.tca!]) || 0,
          fixedAssets: parseFloat(row[mapping.fixedAssets!]) || 0,
          otherAssets: parseFloat(row[mapping.otherAssets!]) || 0,
          ap: parseFloat(row[mapping.ap!]) || 0,
          otherCL: parseFloat(row[mapping.otherCL!]) || 0,
          tcl: parseFloat(row[mapping.tcl!]) || 0,
          ltd: parseFloat(row[mapping.ltd!]) || 0,
          ownersCapital: parseFloat(row[mapping.ownersCapital!]) || 0,
          ownersDraw: parseFloat(row[mapping.ownersDraw!]) || 0,
          commonStock: parseFloat(row[mapping.commonStock!]) || 0,
          preferredStock: parseFloat(row[mapping.preferredStock!]) || 0,
          retainedEarnings: parseFloat(row[mapping.retainedEarnings!]) || 0,
          additionalPaidInCapital: parseFloat(row[mapping.additionalPaidInCapital!]) || 0,
          treasuryStock: parseFloat(row[mapping.treasuryStock!]) || 0,
          totalEquity: parseFloat(row[mapping.totalEquity!]) || 0,
          totalLAndE: parseFloat(row[mapping.totalLAndE!]) || 0
          };
        });
        
        console.log('ðŸ“¤ Uploading', fullMonthlyData.length, 'months of data for company', selectedCompanyId);
        console.log('ðŸ“Š Sample Excel values from row 0:', { 
          revenue: rawRows[0]?.[mapping.revenue!], 
          expense: rawRows[0]?.[mapping.expense!],
          professionalFees: rawRows[0]?.[mapping.professionalFees!]
        });
        console.log('ðŸ“Š First 3 months PARSED:', fullMonthlyData.slice(0, 3).map(m => ({ 
          month: m.month, 
          revenue: m.revenue, 
          expense: m.expense,
          professionalFees: m.professionalFees
        })));
        
        const result = await financialsApi.upload({
          companyId: selectedCompanyId,
          uploadedByUserId: currentUser.id,
          fileName: file.name,
          rawData: rawRows,
          columnMapping: mapping,
          monthlyData: fullMonthlyData
        });
        
        console.log('Financial data saved successfully:', result);
        setIsFreshUpload(false);
        
        // Immediately set loadedMonthlyData so reports show it
        setLoadedMonthlyData(fullMonthlyData);
        
        alert('Financial data saved successfully! You can now view it in the reports.');
      } catch (error) {
        console.error('Error saving financial data:', error);
        const errorMsg = error instanceof ApiError ? error.message : 'Failed to save financial data';
        setError(errorMsg);
        alert('Error saving financial data: ' + errorMsg);
      }
    };
    
    if (isFreshUpload) {
      saveFinancialData();
    }
  }, [mapping, rawRows, file, selectedCompanyId, currentUser, isFreshUpload]);

  // Auto-map columns
  const autoMapColumns = (columnNames: string[]): Mappings => {
    const mapping: Mappings = { date: '' };
    const normalize = (str: string | number | null | undefined) => String(str ?? '').toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    
    columnNames.forEach(col => {
      const n = normalize(col);
      // Core fields
      if (!mapping.date && (n.includes('date') || n.includes('month') || n.includes('period'))) mapping.date = col;
      if (!mapping.revenue && (n.includes('grossrevenue') || n.includes('totalgrossrevenue') || n.includes('revenue') || n.includes('sales'))) mapping.revenue = col;
      if (!mapping.expense && (n.includes('totalexpense') || (n.includes('expense') && n.includes('total')))) mapping.expense = col;
      
      // COGS
      if (!mapping.cogsPayroll && n.includes('cogs') && n.includes('payroll')) mapping.cogsPayroll = col;
      if (!mapping.cogsOwnerPay && n.includes('cogs') && n.includes('owner')) mapping.cogsOwnerPay = col;
      if (!mapping.cogsContractors && n.includes('cogs') && n.includes('contractor')) mapping.cogsContractors = col;
      if (!mapping.cogsMaterials && n.includes('cogs') && n.includes('material')) mapping.cogsMaterials = col;
      if (!mapping.cogsCommissions && n.includes('cogs') && (n.includes('comsn') || n.includes('commission'))) mapping.cogsCommissions = col;
      if (!mapping.cogsOther && n.includes('cogs') && n.includes('other')) mapping.cogsOther = col;
      if (!mapping.cogsTotal && n.includes('cogs') && n.includes('total')) mapping.cogsTotal = col;
      
      // OPEX
      if (!mapping.salesExpense && ((n.includes('opex') && (n.includes('sales') || n.includes('marketing'))) || (n === 'salesandmarketing' || n === 'salesmarketing'))) mapping.salesExpense = col;
      if (!mapping.rent && (n.includes('rent') || n.includes('lease'))) mapping.rent = col;
      if (!mapping.infrastructure && (n.includes('utilit') || n.includes('equipment') || n.includes('infrastructure'))) mapping.infrastructure = col;
      if (!mapping.autoTravel && n.includes('travel')) mapping.autoTravel = col;
      if (!mapping.professionalFees && n.includes('professional')) mapping.professionalFees = col;
      if (!mapping.insurance && n.includes('insurance')) mapping.insurance = col;
      if (!mapping.marketing && ((n.includes('opex') && n.includes('other')) || n === 'otheropex')) mapping.marketing = col;
      if (!mapping.payroll && ((n.includes('opex') && n.includes('payroll')) || (n === 'payroll' && !n.includes('cogs')))) mapping.payroll = col;
      
      // Owners & Other Expenses
      if (!mapping.ownerBasePay && n.includes('owners') && n.includes('base')) mapping.ownerBasePay = col;
      if (!mapping.ownersRetirement && n.includes('owners') && n.includes('retirement')) mapping.ownersRetirement = col;
      if (!mapping.subcontractors && n.includes('contractors') && n.includes('distribution')) mapping.subcontractors = col;
      if (!mapping.interestExpense && n.includes('interest')) mapping.interestExpense = col;
      if (!mapping.depreciationAmortization && n.includes('depreciation')) mapping.depreciationAmortization = col;
      if (!mapping.operatingExpenseTotal && n.includes('operating') && n.includes('expense') && n.includes('total')) mapping.operatingExpenseTotal = col;
      if (!mapping.nonOperatingIncome && (n.includes('nonoperating') || n.includes('nonoperatng')) && n.includes('income')) mapping.nonOperatingIncome = col;
      if (!mapping.extraordinaryItems && (n.includes('extraordinary') || n.includes('extraordinaryitems'))) mapping.extraordinaryItems = col;
      if (!mapping.netProfit && (n.includes('netprofit') || n.includes('netincome'))) mapping.netProfit = col;
      
      // Assets
      if (!mapping.totalAssets && (n.includes('totalasset') || n === 'totalassets' || n === 'assets')) mapping.totalAssets = col;
      if (!mapping.cash && n === 'cash') mapping.cash = col;
      if (!mapping.ar && (n.includes('accountsreceivable') || n.includes('receivable') || n === 'ar')) mapping.ar = col;
      if (!mapping.inventory && n.includes('inventory')) mapping.inventory = col;
      if (!mapping.otherCA && (n.includes('othercurrentasset') || n === 'othercurrentassets')) mapping.otherCA = col;
      if (!mapping.tca && (n.includes('totalcurrentasset') || n === 'totalcurrentassets' || n === 'currentassets')) mapping.tca = col;
      if (!mapping.fixedAssets && (n.includes('fixedasset') || n === 'fixedassets')) mapping.fixedAssets = col;
      if (!mapping.otherAssets && (n.includes('otherasset') && !n.includes('current'))) mapping.otherAssets = col;
      
      // Liabilities & Equity
      if (!mapping.totalLiab && (n.includes('totalliab') || n === 'totalliabilities' || n === 'liabilities')) mapping.totalLiab = col;
      if (!mapping.ap && (n.includes('accountspayable') || n.includes('payable') || n === 'ap')) mapping.ap = col;
      if (!mapping.otherCL && (n.includes('othercurrentliab') || n === 'othercurrentliabilities')) mapping.otherCL = col;
      if (!mapping.tcl && (n.includes('totalcurrentliab') || n === 'totalcurrentliabilities' || n === 'currentliabilities')) mapping.tcl = col;
      if (!mapping.ltd && (n.includes('longtermdebt') || n.includes('ltd') || n === 'longtermdebt')) mapping.ltd = col;
      
      // Equity Detail
      if (!mapping.ownersCapital && (n.includes('ownerscapital') || n.includes('ownercapital'))) mapping.ownersCapital = col;
      if (!mapping.ownersDraw && (n.includes('ownersdraw') || n.includes('ownerdraw') || n.includes('ownerdistribution'))) mapping.ownersDraw = col;
      if (!mapping.commonStock && (n.includes('commonstock'))) mapping.commonStock = col;
      if (!mapping.preferredStock && (n.includes('preferredstock'))) mapping.preferredStock = col;
      if (!mapping.retainedEarnings && (n.includes('retainedearnings'))) mapping.retainedEarnings = col;
      if (!mapping.additionalPaidInCapital && (n.includes('additionalpaidincapital') || n.includes('paidincapital'))) mapping.additionalPaidInCapital = col;
      if (!mapping.treasuryStock && (n.includes('treasurystock'))) mapping.treasuryStock = col;
      
      if (!mapping.totalEquity && (n.includes('totalequity') || n.includes('equity') || n.includes('networth'))) mapping.totalEquity = col;
      if (!mapping.totalLAndE && (n.includes('liabequity') || n.includes('liabilitiesequity'))) mapping.totalLAndE = col;
    });
    return mapping;
  };

  // Handlers
  const handleLogin = async () => {
    setLoginError('');
    setIsLoading(true);
    
    if (!loginEmail || !loginPassword) {
      setLoginError('Please enter both email and password');
      setIsLoading(false);
      return;
    }
    
    try {
      const { user } = await authApi.login(loginEmail, loginPassword);
      
      // Normalize role and userType to lowercase for frontend compatibility
      const normalizedUser = {
        ...user,
        role: user.role.toLowerCase(),
        userType: user.userType?.toLowerCase(),
        consultantCompanyName: user.consultantCompanyName, // Preserve consultant company name
        consultantType: user.consultantType, // Preserve consultant type
        consultantId: user.consultantId, // Preserve consultant ID
        isPrimaryContact: user.isPrimaryContact // Preserve primary contact status
      };
      
      setCurrentUser(normalizedUser);
      setIsLoggedIn(true);
      
      // Clear assessment data from localStorage for assessment users
      if (normalizedUser.userType === 'assessment') {
        localStorage.removeItem('fs_assessmentResponses');
        localStorage.removeItem('fs_assessmentNotes');
        setAssessmentResponses({});
        setAssessmentNotes({});
      }
      
      // Set appropriate default view based on user type
      if (normalizedUser.role === 'siteadmin') {
        setCurrentView('siteadmin');
      } else if (normalizedUser.role === 'consultant') {
        setCurrentView('admin');
      } else if (normalizedUser.userType === 'assessment') {
        setCurrentView('ma-welcome');
      } else if (normalizedUser.userType === 'company') {
        // Company users see the same dashboard as consultants
        setCurrentView('admin');
      } else {
        setCurrentView('upload');
      }
      
      if (normalizedUser.role !== 'consultant' && normalizedUser.role !== 'siteadmin') {
        setSelectedCompanyId(user.companyId || '');
      }
      
      // Load user's data after login
      if (normalizedUser.role === 'consultant' && user.consultantId) {
        const { companies: loadedCompanies } = await companiesApi.getAll(user.consultantId);
        safeSetCompanies(loadedCompanies || []);
        
        // Check payment for business users (have companyId) OR consultants with companies
        let needsPayment = false;
        
        if (user.companyId && loadedCompanies && loadedCompanies.length > 0) {
          // Business user - check their company's payment
          const userCompany = loadedCompanies.find((c: any) => c.id === user.companyId);
          if (userCompany) {
            setSelectedCompanyId(userCompany.id);
            setExpandedCompanyInfoId(userCompany.id);
            needsPayment = !userCompany.selectedSubscriptionPlan;
          }
        } else if (loadedCompanies && loadedCompanies.length > 0) {
                  // Consultant with companies - check if any company has unpaid status
                  // For now, if they have companies, select the first one
                  // But prioritize company with master data for Goals page testing
                  const companyWithMasterData = loadedCompanies.find((c: any) => c.id === 'cmgmttbfh0004qhgwm6vd9oa5');
                  const companyToSelect = companyWithMasterData || loadedCompanies[0];
                  setSelectedCompanyId(companyToSelect.id);
                  setExpandedCompanyInfoId(companyToSelect.id);
                  needsPayment = !companyToSelect.selectedSubscriptionPlan;
        }
        
        // Always direct to company management on login
        setAdminDashboardTab('company-management');
      }
      
      // Load company data for company users
      if (normalizedUser.userType === 'company' && user.companyId) {
        const response = await fetch(`/api/companies?companyId=${user.companyId}`);
        const data = await response.json();
        if (data.companies && Array.isArray(data.companies) && data.companies.length > 0) {
          safeSetCompanies(data.companies);
        } else {
          safeSetCompanies([]);
        }
        
        // Load consultant data to show consultant's company name in header
        if (normalizedUser.consultantId) {
          try {
            const consultantResponse = await fetch(`/api/consultants?id=${normalizedUser.consultantId}`);
            const consultantData = await consultantResponse.json();
            if (consultantData && consultantData.id) {
              setConsultants([consultantData]);
            }
          } catch (error) {
            console.error('Failed to load consultant data:', error);
          }
        }
      }
      
      setLoginEmail('');
      setLoginPassword('');
      setLoginError('');
    } catch (error) {
      if (error instanceof ApiError) {
        setLoginError(error.message);
      } else {
        setLoginError('Login failed. Please try again.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleRegisterConsultant = async () => {
    setLoginError('');
    setIsLoading(true);
    
    // Validate required fields
    if (!loginName || !loginEmail || !loginPassword || !loginPhone || !loginCompanyName || 
        !loginCompanyAddress1 || !loginCompanyCity || !loginCompanyState || !loginCompanyZip) { 
      setLoginError('Please fill in all required fields');
      setIsLoading(false);
      return; 
    }
    
    try {
      const { user } = await authApi.register({
        name: loginName,
        email: loginEmail,
        password: loginPassword,
        fullName: loginName,
        phone: loginPhone,
        companyName: loginCompanyName,
        companyAddress1: loginCompanyAddress1,
        companyAddress2: loginCompanyAddress2 || undefined,
        companyCity: loginCompanyCity,
        companyState: loginCompanyState,
        companyZip: loginCompanyZip,
        companyWebsite: loginCompanyWebsite || undefined
      });
      
      // Normalize role and userType to lowercase for frontend compatibility
      const normalizedUser = {
        ...user,
        role: user.role.toLowerCase(),
        userType: user.userType?.toLowerCase(),
        consultantType: user.consultantType, // Preserve consultant type
        consultantCompanyName: user.consultantCompanyName, // Preserve consultant company name
        consultantId: user.consultantId // Preserve consultant ID
      };
      
      setCurrentUser(normalizedUser);
      setIsLoggedIn(true);
      setCurrentView('consultant-dashboard');
      
      // Clear any stale company data and load fresh data for the new consultant
      safeSetCompanies([]);
      if (user.consultantId) {
        try {
          const { companies: consultantCompanies } = await companiesApi.getAll(user.consultantId);
          safeSetCompanies(consultantCompanies || []);
        } catch (error) {
          console.error('Failed to load companies after registration:', error);
        }
      }
      
      // Clear all form fields
      setLoginName('');
      setLoginEmail('');
      setLoginPassword('');
      setLoginPhone('');
      setLoginCompanyName('');
      setLoginCompanyAddress1('');
      setLoginCompanyAddress2('');
      setLoginCompanyCity('');
      setLoginCompanyState('');
      setLoginCompanyZip('');
      setLoginCompanyWebsite('');
      setIsRegistering(false);
      setLoginError('');
    } catch (error) {
      if (error instanceof ApiError) {
        if (error.status === 409) {
          setLoginError('This email is already registered. Please login instead.');
        } else {
          setLoginError(error.message);
        }
      } else {
        setLoginError('Registration failed. Please try again.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setIsLoggedIn(false);
    setCurrentView('login');
    setSelectedCompanyId('');
    setRawRows([]);
    setMapping({ date: '' });
    setFile(null);
    setColumns([]);
    localStorage.removeItem('fs_currentUser');
    localStorage.removeItem('fs_selectedCompanyId');
  };

  // Load master data and extract categories for dynamic goals
  const loadMasterDataForGoals = async () => {
    if (!selectedCompanyId) {
      alert('Please select a company first');
      return;
    }

    try {
      console.log('ðŸŽ¯ Loading master data for goals:', selectedCompanyId);
      const response = await fetch(`/api/master-data?companyId=${selectedCompanyId}`);
      const data = await response.json();

      if (!response.ok) {
        alert(`Failed to load master data: ${data.error}`);
        return;
      }

      // Extract categories from master data
      const categories = extractCategoriesFromMasterData(data.monthlyData);
      setMasterDataCategories(categories);

      console.log('âœ… Loaded categories from master data:', categories.length);
      alert(`Loaded ${categories.length} expense categories from master data`);

    } catch (error) {
      console.error('Error loading master data:', error);
      alert('Failed to load master data');
    }
  };

  // Helper function to get nested object values
  const getNestedValue = (obj: any, path: string) => {
    return path.split('.').reduce((current, key) => current?.[key], obj);
  };

  // Extract COGS and expense categories from master data
  const extractCategoriesFromMasterData = (monthlyData: any[]) => {
    const cogsCategories = new Set<string>();
    const expenseCategories = new Set<string>();

    monthlyData.forEach(month => {
      // Extract COGS categories
      if (month.incomeStatement?.cogs) {
        Object.keys(month.incomeStatement.cogs).forEach(key => {
          if (month.incomeStatement.cogs[key] && month.incomeStatement.cogs[key] !== 0) {
            cogsCategories.add(key);
          }
        });
      }

      // Extract operating expense categories
      if (month.incomeStatement?.operatingExpenses) {
        Object.keys(month.incomeStatement.operatingExpenses).forEach(key => {
          if (month.incomeStatement.operatingExpenses[key] && month.incomeStatement.operatingExpenses[key] !== 0) {
            expenseCategories.add(key);
          }
        });
      }
    });

    // Convert to array format expected by goals table
    const categories: any[] = [];

    // Add COGS categories
    Array.from(cogsCategories).sort().forEach(key => {
      categories.push({
        key: `cogs_${key}`,
        label: `COGS - ${key.charAt(0).toUpperCase() + key.slice(1)}`,
        category: 'COGS',
        masterDataKey: key,
        masterDataPath: `incomeStatement.cogs.${key}`
      });
    });

    // Add expense categories
    Array.from(expenseCategories).sort().forEach(key => {
      categories.push({
        key: `expense_${key}`,
        label: `${key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1')}`,
        category: 'Expense',
        masterDataKey: key,
        masterDataPath: `incomeStatement.operatingExpenses.${key}`
      });
    });

    return categories;
  };

  const addCompany = async () => {
    if (!newCompanyName || !currentUser) {
      alert('Please enter a company name');
      return;
    }
    
    if (!currentUser.consultantId) {
      alert('Error: No consultant ID found. Please log out and log back in.');
      console.error('Current user:', currentUser);
      return;
    }
    
    setIsLoading(true);
    try {
      console.log('Creating company:', {
        name: newCompanyName,
        consultantId: currentUser.consultantId,
        affiliateCode: selectedAffiliateCodeForNewCompany || undefined,
        affiliateCodeRaw: selectedAffiliateCodeForNewCompany,
        affiliateCodeUpper: selectedAffiliateCodeForNewCompany?.toUpperCase()
      });
      const { company } = await companiesApi.create({
        name: newCompanyName,
        consultantId: currentUser.consultantId,
        affiliateCode: selectedAffiliateCodeForNewCompany || undefined
      });
      console.log('Company created:', company);
      console.log('Company pricing in response:', {
        monthly: company.subscriptionMonthlyPrice,
        quarterly: company.subscriptionQuarterlyPrice,
        annual: company.subscriptionAnnualPrice,
        hasPricing: !!(company.subscriptionMonthlyPrice || company.subscriptionQuarterlyPrice || company.subscriptionAnnualPrice)
      });
      safeSetCompanies(Array.isArray(companies) ? [...companies, company] : [company]);
      setNewCompanyName('');
      setSelectedAffiliateCodeForNewCompany('');
      
      // Automatically select the newly created company
      setSelectedCompanyId(company.id);

      // Redirect to payments tab for new company setup
      setAdminDashboardTab('payments');

      alert('Company created successfully!');
    } catch (error) {
      console.error('Error creating company:', error);
      alert(error instanceof ApiError ? error.message : 'Failed to create company');
    } finally {
      setIsLoading(false);
    }
  };


  // Team Management Functions
  const fetchTeamMembers = async () => {
    if (!currentUser?.consultantId) return;
    try {
      const response = await fetch(`/api/consultants/team?consultantId=${currentUser.consultantId}`);
      const data = await response.json();
      if (response.ok) {
        setConsultantTeamMembers(data.teamMembers || []);
      } else {
        console.error('Failed to fetch team members:', data.error);
      }
    } catch (error) {
      console.error('Error fetching team members:', error);
    }
  };

  const addTeamMember = async () => {
    if (!newTeamMember.name || !newTeamMember.email || !newTeamMember.password) {
      alert('Please fill in name, email, and password');
      return;
    }
    if (!currentUser?.consultantId) {
      alert('Error: No consultant ID found');
      return;
    }
    
    setIsLoading(true);
    try {
      const response = await fetch('/api/consultants/team', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          consultantId: currentUser.consultantId,
          ...newTeamMember
        })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        setConsultantTeamMembers([...consultantTeamMembers, data.teamMember]);
        setNewTeamMember({name: '', email: '', phone: '', title: '', password: ''});
        setShowAddTeamMemberForm(false);
        alert('Team member added successfully!');
      } else {
        alert(data.error || 'Failed to add team member');
      }
    } catch (error) {
      console.error('Error adding team member:', error);
      alert('Failed to add team member');
    } finally {
      setIsLoading(false);
    }
  };

  const removeTeamMember = async (userId: string, userName: string) => {
    if (!confirm(`Remove ${userName} from your team?`)) return;
    if (!currentUser?.consultantId) return;
    
    setIsLoading(true);
    try {
      const response = await fetch(`/api/consultants/team?userId=${userId}&consultantId=${currentUser.consultantId}`, {
        method: 'DELETE'
      });
      
      const data = await response.json();
      
      if (response.ok) {
        setConsultantTeamMembers(consultantTeamMembers.filter(m => m.id !== userId));
        alert('Team member removed successfully');
      } else {
        alert(data.error || 'Failed to remove team member');
      }
    } catch (error) {
      console.error('Error removing team member:', error);
      alert('Failed to remove team member');
    } finally {
      setIsLoading(false);
    }
  };

  // QuickBooks Functions
  const checkQBStatus = async (companyId: string) => {
    try {
      const response = await fetch(`/api/quickbooks/status?companyId=${companyId}`);
      const data = await response.json();
      
      if (data.connected) {
        setQbConnected(true);
        setQbStatus(data.status);
        // Only update qbLastSync if the timestamp actually changed (prevent infinite loop)
        const newSyncTime = data.lastSyncAt ? new Date(data.lastSyncAt).getTime() : null;
        const currentSyncTime = qbLastSync ? qbLastSync.getTime() : null;
        if (newSyncTime !== currentSyncTime) {
          setQbLastSync(data.lastSyncAt ? new Date(data.lastSyncAt) : null);
        }
        setQbError(data.errorMessage);
      } else {
        setQbConnected(false);
        setQbStatus('NOT_CONNECTED');
        if (qbLastSync !== null) {
          setQbLastSync(null);
        }
        setQbError(null);
      }
    } catch (error) {
      console.error('Failed to check QuickBooks status:', error);
      setQbError('Failed to check connection status');
    }
  };

  const connectQuickBooks = async () => {
    if (!selectedCompanyId) {
      alert('Please select a company first');
      return;
    }

    try {
      const response = await fetch(`/api/quickbooks/auth?companyId=${selectedCompanyId}`);
      const data = await response.json();
      
      if (data.authUri) {
        // Redirect to QuickBooks OAuth page
        window.location.href = data.authUri;
      } else {
        throw new Error('Failed to generate authorization URL');
      }
    } catch (error) {
      console.error('Failed to initiate QuickBooks connection:', error);
      alert('Failed to connect to QuickBooks. Please try again.');
    }
  };

  const syncQuickBooks = async () => {
    if (!selectedCompanyId || !currentUser) {
      alert('Please select a company first');
      return;
    }

    setQbSyncing(true);
    setQbError(null);

    try {
      const response = await fetch('/api/quickbooks/sync', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          companyId: selectedCompanyId,
          userId: currentUser.id
        }),
      });

      const data = await response.json();

      if (response.ok) {
        // Update sync timestamp - this will trigger the useEffect to reload data
        setQbLastSync(new Date());
        
        // Refresh QuickBooks status
        if (selectedCompanyId) {
          await checkQBStatus(selectedCompanyId);
        }
        
        alert(`QuickBooks data synced successfully! ${data.recordsImported || 0} months of financial data imported.`);
      } else {
        // Include detailed error message from API
        const errorMsg = data.details ? `${data.error}: ${data.details}` : (data.error || 'Sync failed');
        throw new Error(errorMsg);
      }
    } catch (error: any) {
      console.error('QuickBooks sync error:', error);
      const errorMessage = error.message || 'Failed to sync data';
      setQbError(errorMessage);
      alert('Failed to sync QuickBooks data:\n\n' + errorMessage);
    } finally {
      setQbSyncing(false);
    }
  };

  const disconnectQuickBooks = async () => {
    if (!selectedCompanyId) return;

    if (!confirm('Are you sure you want to disconnect QuickBooks? You can reconnect anytime.')) {
      return;
    }

    try {
      const response = await fetch('/api/quickbooks/disconnect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ companyId: selectedCompanyId }),
      });

      const data = await response.json();

      if (response.ok) {
        setQbConnected(false);
        setQbStatus('NOT_CONNECTED');
        setQbLastSync(null);
        setQbError(null);
        alert('QuickBooks disconnected successfully');
      } else {
        throw new Error(data.error || 'Disconnect failed');
      }
    } catch (error: any) {
      console.error('QuickBooks disconnect error:', error);
      alert('Failed to disconnect QuickBooks: ' + (error.message || 'Unknown error'));
    }
  };

  const getCompanyUsers = (companyId: string, userType?: 'company' | 'assessment') => {
    if (userType) {
      return users.filter(u => u.companyId === companyId && u.role === 'user' && u.userType === userType);
    }
    return users.filter(u => u.companyId === companyId && u.role === 'user');
  };
  const getCurrentCompany = () => Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined;

  const handleSelectCompany = (companyId: string) => {
    const company = Array.isArray(companies) ? companies.find(c => c.id === companyId) : undefined;
    if (!company) return;
    
    // Select the company
    setSelectedCompanyId(companyId);
    
    // Navigate to Consultant Dashboard to show company details
    setCurrentView('admin');
    
    // Automatically expand this company's section
    setExpandedCompanyInfoId(companyId);
  };

  const saveCompanyDetails = async () => {
    if (!companyIndustrySector) { 
      alert('Please select an industry sector'); 
      return; 
    }
    setIsLoading(true);
    try {
      const { company } = await companiesApi.update(editingCompanyId, {
        addressStreet: companyAddressStreet,
        addressCity: companyAddressCity,
        addressState: companyAddressState,
        addressZip: companyAddressZip,
        addressCountry: companyAddressCountry,
        industrySector: companyIndustrySector as number
      });
      safeSetCompanies(Array.isArray(companies) ? companies.map(c => c.id === editingCompanyId ? { ...c, ...company } : c) : [company]);
      setSelectedCompanyId(editingCompanyId);
      setShowCompanyDetailsModal(false);
      
      // Expand the company that was just saved
      setExpandedCompanyInfoId(editingCompanyId);
      
      setEditingCompanyId('');
      setCompanyAddressStreet('');
      setCompanyAddressCity('');
      setCompanyAddressState('');
      setCompanyAddressZip('');
      setCompanyAddressCountry('USA');
      setCompanyIndustrySector('');
      
      // Stay on Consultant Dashboard
      setCurrentView('admin');
    } catch (error) {
      alert(error instanceof ApiError ? error.message : 'Failed to update company');
    } finally {
      setIsLoading(false);
    }
  };

  const saveSubscriptionPricing = async () => {
    if (!selectedCompanyId) {
      alert('Please select a company first');
      return;
    }
    setIsLoading(true);
    try {
      const { company } = await companiesApi.updatePricing(selectedCompanyId, subscriptionMonthlyPrice || 0, subscriptionQuarterlyPrice || 0, subscriptionAnnualPrice || 0);
      
      console.log('ðŸ’° Subscription pricing saved:', company);
      
      // Update the companies list with the new pricing
      safeSetCompanies(Array.isArray(companies) ? companies.map(c => c.id === selectedCompanyId ? { ...c, ...company } : c) : [company]);
      
      // Reload companies list to ensure fresh data
      if (currentUser?.consultantId) {
        const allCompanies = await companiesApi.getAll(currentUser.consultantId);
        safeSetCompanies(allCompanies);
      }
      
      alert('? Subscription pricing saved successfully!');
    } catch (error) {
      console.error('? Error saving subscription pricing:', error);
      alert(error instanceof ApiError ? error.message : 'Failed to save subscription pricing');
    } finally {
      setIsLoading(false);
    }
  };

  const addUser = async (companyId: string, userType: 'company' | 'assessment' = 'company') => {
    // Get the appropriate state variables based on userType
    const name = userType === 'company' ? newCompanyUserName : newAssessmentUserName;
    const title = userType === 'company' ? newCompanyUserTitle : newAssessmentUserTitle;
    const email = userType === 'company' ? newCompanyUserEmail : newAssessmentUserEmail;
    const phone = userType === 'company' ? newCompanyUserPhone : undefined; // Phone only for company users
    const password = userType === 'company' ? newCompanyUserPassword : newAssessmentUserPassword;
    
    if (!name || !email || !password) { 
      alert('Please fill all required fields (Name, Email, Password)'); 
      return; 
    }
    
    setIsLoading(true);
    try {
      console.log('Creating user:', { name, title, email, phone, companyId, userType: userType.toUpperCase() });
      console.log('Current users in state:', users);
      console.log('Filtered company users:', users.filter(u => u.companyId === companyId && u.userType === 'company'));
      console.log('Filtered assessment users:', users.filter(u => u.companyId === companyId && u.userType === 'assessment'));
      
      const { user } = await usersApi.create({
        name,
        title,
        email,
        phone,
        password,
        companyId: companyId,
        userType: userType.toUpperCase() as 'COMPANY' | 'ASSESSMENT'
      });
      console.log('User created from API:', user);
      
      // Normalize role and userType to lowercase
      const normalizedUser = {
        ...user,
        role: user.role.toLowerCase(),
        userType: user.userType?.toLowerCase()
      };
      console.log('Normalized user:', normalizedUser);
      
      setUsers([...users, normalizedUser]);
      console.log('Users after adding:', [...users, normalizedUser]);
      
      // Clear the appropriate fields based on userType
      if (userType === 'company') {
        setNewCompanyUserName('');
        setNewCompanyUserTitle('');
        setNewCompanyUserEmail('');
        setNewCompanyUserPhone('');
        setNewCompanyUserPassword('');
      } else {
        setNewAssessmentUserName('');
        setNewAssessmentUserTitle('');
        setNewAssessmentUserEmail('');
        setNewAssessmentUserPassword('');
      }
      
      alert(`${userType === 'company' ? 'Company' : 'Assessment'} user created successfully!`);
    } catch (error) {
      console.error('Error creating user:', error);
      if (error instanceof ApiError) {
        if (error.message.includes('already registered')) {
          alert(`âš ï¸ Email already in use\n\n"${email}" is already registered in the system.\n\nPlease use a different email address.`);
        } else if (error.message.includes('Password does not meet requirements')) {
          alert('âš ï¸ Password does not meet requirements:\n\nâ€¢ At least 8 characters\nâ€¢ One uppercase letter (A-Z)\nâ€¢ One lowercase letter (a-z)\nâ€¢ One number (0-9)\nâ€¢ One special character (!@#$%^&*)\n\nPlease create a stronger password.');
        } else {
          alert(error.message);
        }
      } else {
        alert('Failed to add user');
      }
    } finally {
      setIsLoading(false);
    }
  };

  const deleteUser = async (userId: string) => {
    if (!confirm('Delete this user?')) return;
    setIsLoading(true);
    try {
      await usersApi.delete(userId);
      setUsers(users.filter(u => u.id !== userId));
    } catch (error) {
      alert(error instanceof ApiError ? error.message : 'Failed to delete user');
    } finally {
      setIsLoading(false);
    }
  };

  // Consultant CRUD functions
  const addConsultant = async () => {
    if (!newConsultantType || !newConsultantFullName || !newConsultantEmail || !newConsultantPhone || !newConsultantPassword) {
      alert('Please fill all required fields (Type, Contact Person, Email, Phone, Password)');
      return;
    }
    setIsLoading(true);
    try {
      const { consultant } = await consultantsApi.create({
        fullName: newConsultantFullName,
        email: newConsultantEmail,
        password: newConsultantPassword,
        address: newConsultantAddress,
        phone: newConsultantPhone,
        type: newConsultantType,
        companyName: newConsultantCompanyName,
        companyAddress1: newConsultantCompanyAddress1,
        companyAddress2: newConsultantCompanyAddress2,
        companyCity: newConsultantCompanyCity,
        companyState: newConsultantCompanyState,
        companyZip: newConsultantCompanyZip,
        companyWebsite: newConsultantCompanyWebsite
      });
      
      // Add to local state (will be refreshed on next load)
      const newConsultant: Consultant = {
        id: consultant.id,
        type: consultant.type || newConsultantType,
        fullName: consultant.fullName,
        address: consultant.address || newConsultantAddress,
        email: consultant.email,
        phone: consultant.phone || newConsultantPhone,
        password: '', // Don't store password in state
        companyName: consultant.companyName || newConsultantCompanyName,
        companyAddress1: consultant.companyAddress1 || newConsultantCompanyAddress1,
        companyAddress2: consultant.companyAddress2 || newConsultantCompanyAddress2,
        companyCity: consultant.companyCity || newConsultantCompanyCity,
        companyState: consultant.companyState || newConsultantCompanyState,
        companyZip: consultant.companyZip || newConsultantCompanyZip,
        companyWebsite: consultant.companyWebsite || newConsultantCompanyWebsite
      };
      setConsultants([...consultants, newConsultant]);
      
      // Clear form
      setNewConsultantType('');
      setNewConsultantFullName('');
      setNewConsultantAddress('');
      setNewConsultantEmail('');
      setNewConsultantPhone('');
      setNewConsultantPassword('');
      setNewConsultantCompanyName('');
      setNewConsultantCompanyAddress1('');
      setNewConsultantCompanyAddress2('');
      setNewConsultantCompanyCity('');
      setNewConsultantCompanyState('');
      setNewConsultantCompanyZip('');
      setNewConsultantCompanyWebsite('');
    } catch (error) {
      if (error instanceof ApiError && error.message.includes('Password does not meet requirements')) {
        alert('âš ï¸ Password does not meet requirements:\n\nâ€¢ At least 8 characters\nâ€¢ One uppercase letter (A-Z)\nâ€¢ One lowercase letter (a-z)\nâ€¢ One number (0-9)\nâ€¢ One special character (!@#$%^&*)\n\nPlease create a stronger password.');
      } else {
        alert(error instanceof ApiError ? error.message : 'Failed to add consultant');
      }
    } finally {
      setIsLoading(false);
    }
  };

  const updateCompanyPricing = async (companyId: string, pricing: { monthly: number; quarterly: number; annual: number }) => {
    try {
      await companiesApi.updatePricing(companyId, pricing.monthly, pricing.quarterly, pricing.annual);
      
      // Update local state
      safeSetCompanies(Array.isArray(companies) ? companies.map(c => 
        c.id === companyId 
          ? { 
              ...c, 
              subscriptionMonthlyPrice: pricing.monthly,
              subscriptionQuarterlyPrice: pricing.quarterly,
              subscriptionAnnualPrice: pricing.annual,
              selectedSubscriptionPlan: null // Reset selected plan when pricing changes
            } 
          : c
      ) : []);
      
      // Clear editing state
      setEditingPricing((prev) => {
        const newState = { ...prev };
        delete newState[companyId];
        return newState;
      });
      
      alert('? Pricing updated successfully! The business will see the new pricing on their next login or when they refresh.');
    } catch (error) {
      alert(error instanceof ApiError ? error.message : 'Failed to update pricing');
    }
  };

  const updateConsultantInfo = async (consultantId: string, info: { 
    fullName: string; 
    email: string; 
    address: string; 
    phone: string; 
    type: string;
    companyName?: string;
    companyAddress1?: string;
    companyAddress2?: string;
    companyCity?: string;
    companyState?: string;
    companyZip?: string;
    companyWebsite?: string;
    revenueSharePercentage?: number;
  }) => {
    try {
      const response = await consultantsApi.update(consultantId, info);
      
      // Update local state
      setConsultants(consultants.map(c => 
        c.id === consultantId 
          ? { 
              ...c, 
              fullName: info.fullName,
              email: info.email,
              address: info.address,
              phone: info.phone,
              type: info.type,
              companyName: info.companyName,
              companyAddress1: info.companyAddress1,
              companyAddress2: info.companyAddress2,
              companyCity: info.companyCity,
              companyState: info.companyState,
              companyZip: info.companyZip,
              companyWebsite: info.companyWebsite,
              revenueSharePercentage: info.revenueSharePercentage ?? c.revenueSharePercentage
            } 
          : c
      ));
      
      // Clear editing state
      setEditingConsultantInfo((prev) => {
        const newState = { ...prev };
        delete newState[consultantId];
        return newState;
      });
      
      alert('Consultant information updated successfully');
    } catch (error) {
      alert(error instanceof ApiError ? error.message : 'Failed to update consultant information');
    }
  };

  const deleteConsultant = async (consultantId: string) => {
    if (!confirm('Delete this consultant? This will also delete all their companies and users.')) return;
    setIsLoading(true);
    try {
      await consultantsApi.delete(consultantId);
      
      // Update local state
      setConsultants(consultants.filter(c => c.id !== consultantId));
      const consultantCompanies = Array.isArray(companies) ? companies.filter(c => c.consultantId === consultantId) : [];
      const companyIds = consultantCompanies.map(c => c.id);
      safeSetCompanies(Array.isArray(companies) ? companies.filter(c => c.consultantId !== consultantId) : []);
      setUsers(users.filter(u => !companyIds.includes(u.companyId) && u.id !== consultantId));
      setFinancialDataRecords(financialDataRecords.filter(r => !companyIds.includes(r.companyId)));
      setAssessmentRecords(assessmentRecords.filter(r => !companyIds.includes(r.companyId)));
    } catch (error) {
      alert(error instanceof ApiError ? error.message : 'Failed to delete consultant');
    } finally {
      setIsLoading(false);
    }
  };

  const getConsultantCompanies = (consultantId: string) => {
    if (!Array.isArray(companies)) return [];
    return companies.filter(c => c.consultantId === consultantId).sort((a, b) => a.name.localeCompare(b.name));
  };

  const handleFile = async (e: ChangeEvent<HTMLInputElement>) => {
    const f = e.target.files?.[0];
    if (!f) return;
    if (!selectedCompanyId) { alert('Please select a company first'); return; }

    setFile(f);
    setError(null);
    setIsFreshUpload(true);
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { cellDates: false });
    
    // Use Sheet1 if available (transposed format), otherwise use first sheet
    const sheetName = wb.SheetNames.includes('Sheet1') ? 'Sheet1' : wb.SheetNames[0];
    
    const ws = wb.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: null });
    if (json.length < 2) { setError('File appears empty or invalid'); return; }
    
    // Check if this is a transposed format (field names in column A, dates in row 0)
    const firstCell = json[0] && (json[0] as any)[0];
    const isTransposed = firstCell === null || firstCell === '' || (typeof firstCell === 'number' && firstCell > 40000); // Excel date serial numbers
    
    if (isTransposed) {
      // Transposed format: Row 0 has dates, Column A has field names
      console.log('Detected transposed format, converting...');
      const dateRow = json[0] as any[];
      const dates = dateRow.slice(1).filter(d => d !== null && d !== ''); // Skip first column
      
      // Convert Excel serial numbers to dates
      const parsedDates = dates.map(d => {
        if (typeof d === 'number') {
          const excelEpoch = new Date(1899, 11, 30);
          const date = new Date(excelEpoch.getTime() + d * 24 * 60 * 60 * 1000);
          return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
        }
        return d;
      });
      
      // Build normal format: each row is a month
      const rows: any[] = [];
      for (let monthIdx = 0; monthIdx < parsedDates.length; monthIdx++) {
        const monthRow: any = { 'Date': parsedDates[monthIdx] };
        
        // For each field (row in original)
        for (let fieldIdx = 1; fieldIdx < json.length; fieldIdx++) {
          const fieldRow = json[fieldIdx] as any[];
          const fieldName = fieldRow[0];
          const fieldValue = fieldRow[monthIdx + 1]; // +1 because column 0 is field name
          if (fieldName) {
            monthRow[fieldName] = fieldValue;
          }
        }
        rows.push(monthRow);
      }
      
      const header = ['Date', ...json.slice(1).map((r: any) => r[0]).filter(n => n)];
      setRawRows(rows);
      setColumns(header);
      setMapping(autoMapColumns(header));
    } else {
      // Normal format: Row 0 has headers, each row is a month
      const header = json[0] as any[];
      const dataRows = json.slice(1);
      const rows = dataRows.map(row => {
        const obj: any = {};
        header.forEach((h, i) => { obj[h] = (row as any[])[i] == null || (row as any[])[i] === '' ? null : (row as any[])[i]; });
        return obj;
      });
      setRawRows(rows);
      setColumns(header);
      setMapping(autoMapColumns(header));
    }
  };

  // Calculate monthly data
  const monthly = useMemo(() => {
    // If we have loaded monthly data from QuickBooks, use it directly
    if (loadedMonthlyData && loadedMonthlyData.length > 0) {
      return loadedMonthlyData;
    }
    
    // Otherwise, process from CSV rawRows
    if (!rawRows || rawRows.length === 0 || !mapping.date) return [];
    return rawRows.map((row, i) => ({
      month: row[mapping.date] || `Month ${i + 1}`,
      // Income Statement
      revenue: parseFloat(row[mapping.revenue!]) || 0,
      expense: parseFloat(row[mapping.expense!]) || 0,
      cogsPayroll: parseFloat(row[mapping.cogsPayroll!]) || 0,
      cogsOwnerPay: parseFloat(row[mapping.cogsOwnerPay!]) || 0,
      cogsContractors: parseFloat(row[mapping.cogsContractors!]) || 0,
      cogsMaterials: parseFloat(row[mapping.cogsMaterials!]) || 0,
      cogsCommissions: parseFloat(row[mapping.cogsCommissions!]) || 0,
      cogsOther: parseFloat(row[mapping.cogsOther!]) || 0,
      cogsTotal: parseFloat(row[mapping.cogsTotal!]) || 0,
      salesExpense: parseFloat(row[mapping.salesExpense!]) || 0,
      rent: parseFloat(row[mapping.rent!]) || 0,
      infrastructure: parseFloat(row[mapping.infrastructure!]) || 0,
      autoTravel: parseFloat(row[mapping.autoTravel!]) || 0,
      professionalFees: parseFloat(row[mapping.professionalFees!]) || 0,
      insurance: parseFloat(row[mapping.insurance!]) || 0,
      marketing: parseFloat(row[mapping.marketing!]) || 0,
      payroll: parseFloat(row[mapping.payroll!]) || 0,
      ownerBasePay: parseFloat(row[mapping.ownerBasePay!]) || 0,
      ownersRetirement: parseFloat(row[mapping.ownersRetirement!]) || 0,
      subcontractors: parseFloat(row[mapping.subcontractors!]) || 0,
      interestExpense: parseFloat(row[mapping.interestExpense!]) || 0,
      depreciationAmortization: parseFloat(row[mapping.depreciationAmortization!]) || 0,
      operatingExpenseTotal: parseFloat(row[mapping.operatingExpenseTotal!]) || 0,
      nonOperatingIncome: parseFloat(row[mapping.nonOperatingIncome!]) || 0,
      extraordinaryItems: parseFloat(row[mapping.extraordinaryItems!]) || 0,
      netProfit: parseFloat(row[mapping.netProfit!]) || 0,
      // Balance Sheet - Assets (reusing from above if already defined)
      totalAssets: parseFloat(row[mapping.totalAssets!]) || 0,
      totalLiab: parseFloat(row[mapping.totalLiab!]) || 0,
      cash: parseFloat(row[mapping.cash!]) || 0,
      ar: parseFloat(row[mapping.ar!]) || 0,
      inventory: parseFloat(row[mapping.inventory!]) || 0,
      otherCA: parseFloat(row[mapping.otherCA!]) || 0,
      tca: parseFloat(row[mapping.tca!]) || 0,
      fixedAssets: parseFloat(row[mapping.fixedAssets!]) || 0,
      otherAssets: parseFloat(row[mapping.otherAssets!]) || 0,
      ap: parseFloat(row[mapping.ap!]) || 0,
      otherCL: parseFloat(row[mapping.otherCL!]) || 0,
      tcl: parseFloat(row[mapping.tcl!]) || 0,
      ltd: parseFloat(row[mapping.ltd!]) || 0,
      // Balance Sheet - Equity Detail
      ownersCapital: parseFloat(row[mapping.ownersCapital!]) || 0,
      ownersDraw: parseFloat(row[mapping.ownersDraw!]) || 0,
      commonStock: parseFloat(row[mapping.commonStock!]) || 0,
      preferredStock: parseFloat(row[mapping.preferredStock!]) || 0,
      retainedEarnings: parseFloat(row[mapping.retainedEarnings!]) || 0,
      additionalPaidInCapital: parseFloat(row[mapping.additionalPaidInCapital!]) || 0,
      treasuryStock: parseFloat(row[mapping.treasuryStock!]) || 0,
      totalEquity: parseFloat(row[mapping.totalEquity!]) || 0,
      totalLAndE: parseFloat(row[mapping.totalLAndE!]) || 0
    }));
  }, [rawRows, mapping, loadedMonthlyData]).map(m => {
    // Calculate Total Operating Expenses using standard chart of accounts (same as Data Review)
    // Use the SAME calculation as Data Review for Total Operating Expenses
    const opexCategories = [
      'payroll', 'ownerBasePay', 'ownersRetirement', 'professionalFees',
      'rent', 'utilities', 'infrastructure', 'autoTravel', 'insurance',
      'salesExpense', 'subcontractors', 'depreciationAmortization', 'interestExpense',
      'marketing', 'benefits', 'taxLicense', 'phoneComm', 'trainingCert',
      'mealsEntertainment', 'otherExpense'
    ];
    const totalOperatingExpense = opexCategories.reduce((sum, key) => sum + ((m as any)[key] || 0), 0);

    // Always use calculated total operating expenses (matches Data Review)
    const expense = totalOperatingExpense;

    // Calculate Gross Profit, EBIT and EBITDA for each month
    const revenue = m.revenue || 0;
    const cogsTotal = m.cogsTotal || 0;
    const interestExpense = m.interestExpense || 0;
    const depreciationAmortization = m.depreciationAmortization || 0;
    const netProfit = m.netProfit || 0;

    // Gross Profit = Revenue - COGS
    const grossProfit = revenue - cogsTotal;
    // EBIT = Revenue - COGS - Operating Expenses (interest already included in operating expenses)
    const ebit = revenue - cogsTotal - expense;
    // EBITDA = EBIT + Interest Expense + Depreciation + Amortization
    // (Add back interest expense that was included in operating expenses)
    const ebitda = ebit + interestExpense + depreciationAmortization;

    
    return {
      ...m,
      expense, // Use the calculated total operating expense
      grossProfit,
      ebit,
      ebitda
    };
  });

  const ltmRev = monthly.length >= 12 ? monthly.slice(-12).reduce((sum, m) => sum + m.revenue, 0) : 0;
  const ltmExp = monthly.length >= 12 ? monthly.slice(-12).reduce((sum, m) => sum + m.expense, 0) : 0;
  
  const growth_24mo = monthly.length >= 24 ? ((ltmRev - monthly.slice(-24, -12).reduce((sum, m) => sum + m.revenue, 0)) / monthly.slice(-24, -12).reduce((sum, m) => sum + m.revenue, 0)) * 100 : 0;
  const growth_6mo = monthly.length >= 12 ? ((monthly.slice(-6).reduce((sum, m) => sum + m.revenue, 0) - monthly.slice(-12, -6).reduce((sum, m) => sum + m.revenue, 0)) / monthly.slice(-12, -6).reduce((sum, m) => sum + m.revenue, 0)) * 100 : 0;
  const expGrowth_24mo = monthly.length >= 24 ? ((ltmExp - monthly.slice(-24, -12).reduce((sum, m) => sum + m.expense, 0)) / monthly.slice(-24, -12).reduce((sum, m) => sum + m.expense, 0)) * 100 : 0;
  
  let baseRGS = 10;
  if (growth_24mo >= 25) baseRGS = 100;
  else if (growth_24mo >= 15) baseRGS = 80;
  else if (growth_24mo >= 5) baseRGS = 60;
  else if (growth_24mo >= 0) baseRGS = 50;
  else if (growth_24mo >= -5) baseRGS = 40;
  else if (growth_24mo >= -15) baseRGS = 20;
  else baseRGS = 10;
  
  let adjustedRGS = baseRGS;
  if (growth_6mo >= 25) adjustedRGS = clamp(adjustedRGS + 50, 10, 100);
  else if (growth_6mo >= 15) adjustedRGS = clamp(((100 - adjustedRGS) * 0.8) + adjustedRGS, 10, 100);
  else if (growth_6mo >= 5) adjustedRGS = clamp(((100 - adjustedRGS) * 0.6) + adjustedRGS, 10, 100);
  else if (growth_6mo >= 0) adjustedRGS = clamp(((100 - adjustedRGS) * 0.4) + adjustedRGS, 10, 100);
  else if (growth_6mo >= -5) adjustedRGS = clamp(adjustedRGS * 0.9, 10, 100);
  else if (growth_6mo >= -15) adjustedRGS = clamp(adjustedRGS * 0.7, 10, 100);
  else if (growth_6mo >= -25) adjustedRGS = clamp(adjustedRGS * 0.5, 10, 100);
  else adjustedRGS = clamp(adjustedRGS * 0.3, 10, 100);
  
  const revExpSpread = growth_24mo - expGrowth_24mo;
  let expenseAdjustment = 0;
  if (revExpSpread > 10) expenseAdjustment = 30;
  else if (revExpSpread >= 0 && revExpSpread <= 10) expenseAdjustment = 10;
  else if (revExpSpread >= -5 && revExpSpread < 0) expenseAdjustment = -10;
  else if (revExpSpread < -5) expenseAdjustment = -30;
  
  const profitabilityScore = clamp(adjustedRGS + expenseAdjustment, 10, 100);
  
  const alr1 = monthly.length > 0 ? monthly[monthly.length - 1].totalAssets / monthly[monthly.length - 1].totalLiab : 0;
  const alr13 = monthly.length >= 13 ? monthly[monthly.length - 13].totalAssets / monthly[monthly.length - 13].totalLiab : 0;
  const alrGrowth = alr13 !== 0 ? ((alr1 - alr13) / alr13) * 100 : 0;
  
  let adsBase = 10;
  if (alr1 >= 1.5) adsBase = 100;
  else if (alr1 >= 1.2) adsBase = 90;
  else if (alr1 >= 0.8) adsBase = 70;
  else if (alr1 >= 0.6) adsBase = 50;
  else if (alr1 >= 0.4) adsBase = 30;
  else adsBase = 10;
  
  let adsAdj = 0;
  if (alrGrowth >= 50) adsAdj = 20;
  else if (alrGrowth >= 30) adsAdj = 15;
  else if (alrGrowth >= 15) adsAdj = 10;
  else if (alrGrowth >= 5) adsAdj = 5;
  else if (alrGrowth >= -5) adsAdj = 0;
  else if (alrGrowth >= -15) adsAdj = -5;
  else if (alrGrowth >= -30) adsAdj = -10;
  else if (alrGrowth >= -50) adsAdj = -15;
  else adsAdj = -20;
  
  const assetDevScore = clamp(adsBase + adsAdj, 10, 100);
  const finalScore = (profitabilityScore + assetDevScore) / 2;

  // Trend data
  const trendData = useMemo(() => {
    if (monthly.length < 13) return [];
    const trends: any[] = [];
    
    for (let i = 12; i < monthly.length; i++) {
      const window = monthly.slice(i - 11, i + 1);
      const ltmR = window.reduce((s, m) => s + m.revenue, 0);
      const ltmE = window.reduce((s, m) => s + m.expense, 0);
      const prev12R = i >= 23 ? monthly.slice(i - 23, i - 11).reduce((s, m) => s + m.revenue, 0) : 0;
      const prev12E = i >= 23 ? monthly.slice(i - 23, i - 11).reduce((s, m) => s + m.revenue, 0) : 0;
      const g24 = prev12R > 0 ? ((ltmR - prev12R) / prev12R) * 100 : 0;
      const gE24 = prev12E > 0 ? ((ltmE - prev12E) / prev12E) * 100 : 0;
      const recent6R = window.slice(-6).reduce((s, m) => s + m.revenue, 0);
      const prior6R = window.slice(0, 6).reduce((s, m) => s + m.revenue, 0);
      const g6 = prior6R > 0 ? ((recent6R - prior6R) / prior6R) * 100 : 0;
      
      let bRGS = 10;
      if (g24 >= 25) bRGS = 100;
      else if (g24 >= 15) bRGS = 80;
      else if (g24 >= 5) bRGS = 60;
      else if (g24 >= 0) bRGS = 50;
      else if (g24 >= -5) bRGS = 40;
      else if (g24 >= -15) bRGS = 20;
      else bRGS = 10;
      
      let aRGS = bRGS;
      if (g6 >= 25) aRGS = clamp(aRGS + 50, 10, 100);
      else if (g6 >= 15) aRGS = clamp(((100 - aRGS) * 0.8) + aRGS, 10, 100);
      else if (g6 >= 5) aRGS = clamp(((100 - aRGS) * 0.6) + aRGS, 10, 100);
      else if (g6 >= 0) aRGS = clamp(((100 - aRGS) * 0.4) + aRGS, 10, 100);
      else if (g6 >= -5) aRGS = clamp(aRGS * 0.9, 10, 100);
      else if (g6 >= -15) aRGS = clamp(aRGS * 0.7, 10, 100);
      else if (g6 >= -25) aRGS = clamp(aRGS * 0.5, 10, 100);
      else aRGS = clamp(aRGS * 0.3, 10, 100);
      
      const spread = g24 - gE24;
      let eAdj = 0;
      if (spread > 10) eAdj = 30;
      else if (spread >= 0 && spread <= 10) eAdj = 10;
      else if (spread >= -5 && spread < 0) eAdj = -10;
      else if (spread < -5) eAdj = -30;
      
      const pScore = clamp(aRGS + eAdj, 10, 100);
      
      const alr1Val = monthly[i].totalAssets / monthly[i].totalLiab;
      const alr13Val = i >= 12 ? monthly[i - 12].totalAssets / monthly[i - 12].totalLiab : 0;
      const alrGrowthVal = alr13Val !== 0 ? ((alr1Val - alr13Val) / alr13Val) * 100 : 0;
      
      let adsB = 10;
      if (alr1Val >= 1.5) adsB = 100;
      else if (alr1Val >= 1.2) adsB = 90;
      else if (alr1Val >= 0.8) adsB = 70;
      else if (alr1Val >= 0.6) adsB = 50;
      else if (alr1Val >= 0.4) adsB = 30;
      else adsB = 10;
      
      let adsA = 0;
      if (alrGrowthVal >= 50) adsA = 20;
      else if (alrGrowthVal >= 30) adsA = 15;
      else if (alrGrowthVal >= 15) adsA = 10;
      else if (alrGrowthVal >= 5) adsA = 5;
      else if (alrGrowthVal >= -5) adsA = 0;
      else if (alrGrowthVal >= -15) adsA = -5;
      else if (alrGrowthVal >= -30) adsA = -10;
      else if (alrGrowthVal >= -50) adsA = -15;
      else adsA = -20;
      
      const aScore = clamp(adsB + adsA, 10, 100);
      const fScore = (pScore + aScore) / 2;
      
      const cur = monthly[i];
      const currentAssets = cur.tca || ((cur.cash || 0) + (cur.ar || 0) + (cur.inventory || 0) + (cur.otherCA || 0));
      const currentLiab = Math.abs(cur.tcl || ((cur.ap || 0) + (cur.otherCL || 0)));
      const quickAssets = (cur.cash || 0) + (cur.ar || 0);

      const currentRatio = currentLiab > 0 ? currentAssets / currentLiab : 0;
      const quickRatio = currentLiab > 0 ? quickAssets / currentLiab : 0;
      
      const ltmCOGS = window.reduce((s, m) => s + m.cogsTotal, 0);
      const ltmSales = ltmR;
      const avgInv = (cur.inventory + (i >= 12 ? monthly[i-12].inventory : cur.inventory)) / 2;
      const invTurnover = avgInv > 0 ? ltmCOGS / avgInv : 0;
      
      const avgAR = (cur.ar + (i >= 12 ? monthly[i-12].ar : cur.ar)) / 2;
      const arTurnover = avgAR > 0 ? ltmSales / avgAR : 0;
      
      const avgAP = (cur.ap + (i >= 12 ? monthly[i-12].ap : cur.ap)) / 2;
      const apTurnover = avgAP > 0 ? ltmCOGS / avgAP : 0;
      
      const daysInv = invTurnover > 0 ? 365 / invTurnover : 0;
      const daysAR = arTurnover > 0 ? 365 / arTurnover : 0;
      const daysAP = apTurnover > 0 ? 365 / apTurnover : 0;
      
      const workingCap = currentAssets - currentLiab;
      
      // Get prior month for calculations
      const priorMonth = i > 0 ? monthly[i - 1] : cur;
      
      // Sales/Working Capital: Monthly revenue / Average WC (current + prior month)
      const priorMonthCurrentAssets = i > 0 ? (priorMonth.tca || ((priorMonth.cash || 0) + (priorMonth.ar || 0) + (priorMonth.inventory || 0) + (priorMonth.otherCA || 0))) : currentAssets;
      const priorMonthCurrentLiab = i > 0 ? Math.abs(priorMonth.tcl || ((priorMonth.ap || 0) + (priorMonth.otherCL || 0))) : currentLiab;
      const priorMonthWorkingCap = priorMonthCurrentAssets - priorMonthCurrentLiab;
      const avgWorkingCap = (workingCap + priorMonthWorkingCap) / 2;
      const salesWC = avgWorkingCap !== 0 ? (cur.revenue || 0) / avgWorkingCap : 0;
      
      const ltmInterest = ltmE * 0.05;
      const ltmEBIT = ltmR - ltmE;
      const interestCov = ltmInterest > 0 ? ltmEBIT / ltmInterest : 0;
      
      const ltmDebtSvc = cur.ltd * 0.1 + ltmInterest;
      const debtSvcCov = ltmDebtSvc > 0 ? ltmEBIT / ltmDebtSvc : 0;
      
      // Calculate Operating Cash Flow for Cash Flow to Debt ratio
      const ltmNetIncome = ltmR - ltmE;
      const ltmDepreciation = ltmE * 0.05; // Estimated depreciation
      const priorMonth12 = i >= 12 ? monthly[i - 12] : cur;
      const priorWorkingCap12CA = priorMonth12.tca || ((priorMonth12.cash || 0) + (priorMonth12.ar || 0) + (priorMonth12.inventory || 0) + (priorMonth12.otherCA || 0));
      const priorWorkingCap12CL = priorMonth12.tcl || ((priorMonth12.ap || 0) + (priorMonth12.otherCL || 0));
      const priorWorkingCap = priorWorkingCap12CA - priorWorkingCap12CL;
      const changeInWorkingCap = workingCap - priorWorkingCap;
      const ltmOperatingCF = ltmNetIncome + ltmDepreciation - changeInWorkingCap;
      
      // Total Debt = Total Liabilities (more conservative) or Long Term Debt + Current Liabilities
      const totalDebt = cur.totalLiab;
      const cfToDebt = totalDebt > 0 ? ltmOperatingCF / totalDebt : 0;
      
      const debtToNW = cur.totalEquity > 0 ? cur.totalLiab / cur.totalEquity : 0;
      const fixedToNW = cur.totalEquity > 0 ? cur.fixedAssets / cur.totalEquity : 0;
      const leverage = cur.totalEquity > 0 ? cur.totalAssets / cur.totalEquity : 0;
      
      // Monthly ratios: annualize monthly income with average balance sheet values
      const avgTotalAssets = ((cur.totalAssets || 0) + (priorMonth.totalAssets || 0)) / 2;
      
      // Calculate total equity from components if totalEquity field is not populated
      const curEquity = cur.totalEquity || ((cur.ownersCapital || 0) + (cur.ownersDraw || 0) + (cur.commonStock || 0) + (cur.preferredStock || 0) + (cur.retainedEarnings || 0) + (cur.additionalPaidInCapital || 0) + (cur.treasuryStock || 0));
      const priorEquity = priorMonth.totalEquity || ((priorMonth.ownersCapital || 0) + (priorMonth.ownersDraw || 0) + (priorMonth.commonStock || 0) + (priorMonth.preferredStock || 0) + (priorMonth.retainedEarnings || 0) + (priorMonth.additionalPaidInCapital || 0) + (priorMonth.treasuryStock || 0));
      const avgTotalEquity = (curEquity + priorEquity) / 2;
      const monthlyNetIncome = (cur.revenue || 0) - (cur.cogsTotal || 0) - (cur.expense || 0);
      const annualizedNetIncome = monthlyNetIncome * 12;
      
      const totalAssetTO = avgTotalAssets > 0 ? ((cur.revenue || 0) * 12) / avgTotalAssets : 0;
      const roe = avgTotalEquity > 0 ? annualizedNetIncome / avgTotalEquity : 0;
      const roa = avgTotalAssets > 0 ? annualizedNetIncome / avgTotalAssets : 0;
      
      // EBIT and EBITDA Margins: Income statement / Income statement = use current month values
      // EBIT = Earnings Before Interest and Taxes, so add back interest expense
      const currentMonthEBIT = (cur.revenue || 0) - (cur.cogsTotal || 0) - (cur.expense || 0) + (cur.interestExpense || 0);
      const currentMonthEBITDA = currentMonthEBIT + (cur.depreciationAmortization || 0);
      const ebitMargin = (cur.revenue || 0) > 0 ? currentMonthEBIT / cur.revenue : 0;
      const ebitdaMargin = (cur.revenue || 0) > 0 ? currentMonthEBITDA / cur.revenue : 0;
      
      trends.push({
        month: cur.month,
        rgs: bRGS,
        rgsAdj: aRGS,
        expenseAdj: eAdj,
        profitabilityScore: pScore,
        alr1: alr1Val,
        alr13: alr13Val,
        alrGrowth: alrGrowthVal,
        adsScore: aScore,
        financialScore: fScore,
        currentRatio,
        quickRatio,
        invTurnover,
        arTurnover,
        apTurnover,
        daysInv,
        daysAR,
        daysAP,
        salesWC,
        interestCov,
        debtSvcCov,
        cfToDebt,
        debtToNW,
        fixedToNW,
        leverage,
        totalAssetTO,
        roe,
        roa,
        ebitdaMargin,
        ebitMargin,
        ebitda: currentMonthEBITDA,
        ebit: currentMonthEBIT
      });
    }
    
    return trends;
  }, [monthly]);

  // MD&A Analysis
  const mdaAnalysis = useMemo(() => {
    if (!trendData || trendData.length === 0) return { strengths: [], weaknesses: [], insights: [] };
    
    const last = trendData[trendData.length - 1];
    const strengths: string[] = [];
    const weaknesses: string[] = [];
    const insights: string[] = [];
    
    if (finalScore >= 70) strengths.push(`Strong overall financial score of ${finalScore.toFixed(1)}, indicating robust financial health.`);
    else if (finalScore < 50) weaknesses.push(`Financial score of ${finalScore.toFixed(1)} suggests significant areas for improvement.`);
    
    if (profitabilityScore >= 70) strengths.push(`Profitability score of ${profitabilityScore.toFixed(1)} demonstrates solid revenue growth and expense management.`);
    else if (profitabilityScore < 50) weaknesses.push(`Profitability score of ${profitabilityScore.toFixed(1)} indicates challenges in revenue growth or expense control.`);
    
    if (growth_24mo > 10) strengths.push(`24-month revenue growth of ${growth_24mo.toFixed(1)}% shows strong market expansion.`);
    else if (growth_24mo < 0) weaknesses.push(`Negative 24-month revenue growth of ${growth_24mo.toFixed(1)}% requires immediate strategic attention.`);
    
    if (expenseAdjustment > 0) strengths.push(`Expense management is outperforming revenue growth by ${revExpSpread.toFixed(1)}%, adding ${expenseAdjustment} points to profitability.`);
    else if (expenseAdjustment < 0) weaknesses.push(`Expenses are growing faster than revenue by ${Math.abs(revExpSpread).toFixed(1)}%, reducing profitability by ${Math.abs(expenseAdjustment)} points.`);
    
    if (assetDevScore >= 70) strengths.push(`Asset Development Score of ${assetDevScore.toFixed(1)} reflects a healthy asset-to-liability ratio and positive asset growth.`);
    else if (assetDevScore < 50) weaknesses.push(`Asset Development Score of ${assetDevScore.toFixed(1)} suggests concerning leverage and asset composition.`);
    
    if (last.currentRatio >= 1.5) strengths.push(`Current ratio of ${last.currentRatio.toFixed(1)} indicates strong short-term liquidity.`);
    else if (last.currentRatio < 1.0) weaknesses.push(`Current ratio of ${last.currentRatio.toFixed(1)} may indicate potential liquidity challenges.`);
    
    if (last.roe > 0.15) strengths.push(`Return on Equity of ${(last.roe * 100).toFixed(1)}% demonstrates efficient use of shareholder capital.`);
    else if (last.roe < 0) weaknesses.push(`Negative Return on Equity of ${(last.roe * 100).toFixed(1)}% indicates losses relative to equity.`);
    
    // KPI Analysis
    if (last.quickRatio >= 1.0) strengths.push(`Quick ratio of ${last.quickRatio.toFixed(1)} shows strong ability to meet short-term obligations without relying on inventory.`);
    else if (last.quickRatio < 0.5) weaknesses.push(`Quick ratio of ${last.quickRatio.toFixed(1)} suggests potential cash flow challenges.`);
    
    if (last.debtToNW < 1.0) strengths.push(`Debt-to-Net Worth ratio of ${last.debtToNW.toFixed(1)} indicates conservative leverage and strong equity position.`);
    else if (last.debtToNW > 2.0) weaknesses.push(`Debt-to-Net Worth ratio of ${last.debtToNW.toFixed(1)} suggests high leverage that may limit financial flexibility.`);
    
    if (last.interestCov > 3.0) strengths.push(`Interest coverage ratio of ${last.interestCov.toFixed(1)} demonstrates strong ability to service debt obligations.`);
    else if (last.interestCov < 1.5) weaknesses.push(`Interest coverage of ${last.interestCov.toFixed(1)} indicates potential difficulty meeting interest payments.`);
    
    // Projection Analysis - Calculate inline to avoid circular dependency
    if (monthly.length >= 24) {
      // Calculate simple revenue projection
      const last12Months = monthly.slice(-12);
      const prior12Months = monthly.slice(-24, -12);
      const recentRevGrowth = ((last12Months.reduce((s, m) => s + m.revenue, 0) - prior12Months.reduce((s, m) => s + m.revenue, 0)) / prior12Months.reduce((s, m) => s + m.revenue, 0)) * 100;
      
      if (recentRevGrowth > 10) insights.push(`Based on 12-month trends, revenue shows ${recentRevGrowth.toFixed(1)}% growth trajectory with strong expansion potential.`);
      else if (recentRevGrowth < -5) insights.push(`Revenue trends indicate ${Math.abs(recentRevGrowth).toFixed(1)}% decline trajectory - proactive measures recommended.`);
      
      // Projected annual revenue
      const avgMonthlyRev = last12Months.reduce((s, m) => s + m.revenue, 0) / 12;
      const projectedAnnualRev = avgMonthlyRev * 12;
      
      if (recentRevGrowth > 15) insights.push(`Strong growth trajectory projects annual revenue of approximately $${(projectedAnnualRev / 1000).toFixed(0)}K with continued momentum.`);
      else if (recentRevGrowth < 0) insights.push(`Declining revenue trend requires strategic intervention to stabilize and restore growth.`);
      
      // Equity trend analysis
      const currentEquity = monthly[monthly.length - 1].totalEquity;
      const priorEquity = monthly[monthly.length - 13] ? monthly[monthly.length - 13].totalEquity : currentEquity;
      const equityChange = ((currentEquity - priorEquity) / Math.abs(priorEquity)) * 100;
      
      if (equityChange > 10) insights.push(`Equity has strengthened by ${equityChange.toFixed(1)}% over the past year, improving financial stability.`);
      else if (equityChange < -10) weaknesses.push(`Equity has declined by ${Math.abs(equityChange).toFixed(1)}% - monitor profitability and cash management closely.`);
    }
    
    // Trend Analysis Insights
    if (monthly.length >= 24) {
      const recentRevTrend = trendData.slice(-6).map(t => t.rgs).reduce((a, b) => a + b, 0) / 6;
      const priorRevTrend = trendData.slice(-12, -6).map(t => t.rgs).reduce((a, b) => a + b, 0) / 6;
      
      if (recentRevTrend > priorRevTrend + 10) strengths.push(`Revenue growth momentum is accelerating in recent months, indicating improving market position.`);
      else if (recentRevTrend < priorRevTrend - 10) weaknesses.push(`Revenue growth momentum is decelerating - review sales strategies and market positioning.`);
    }
    
    // Working Capital Analysis
    const lastMonth = monthly[monthly.length - 1];
    const currentAssets = lastMonth.tca || ((lastMonth.cash || 0) + (lastMonth.ar || 0) + (lastMonth.inventory || 0) + (lastMonth.otherCA || 0));
    const currentLiab = Math.abs(lastMonth.tcl || ((lastMonth.ap || 0) + (lastMonth.otherCL || 0)));
    const workingCapital = currentAssets - currentLiab;
    const wcRatioMDA = currentLiab > 0 ? currentAssets / currentLiab : 0;
    
    if (workingCapital > 0 && wcRatioMDA >= 1.5) {
      strengths.push(`Positive working capital of $${(workingCapital / 1000).toFixed(1)}K with strong WC ratio of ${wcRatioMDA.toFixed(1)} supports operational flexibility.`);
    } else if (workingCapital < 0) {
      weaknesses.push(`Negative working capital of $${(Math.abs(workingCapital) / 1000).toFixed(1)}K indicates potential short-term funding challenges.`);
    } else if (wcRatioMDA < 1.0) {
      weaknesses.push(`Working capital ratio of ${wcRatioMDA.toFixed(1)} is below optimal levels - consider improving liquidity.`);
    }
    
    // Activity Ratios (Days metrics)
    if (last.daysAR > 0) {
      if (last.daysAR < 45) strengths.push(`Days' receivables of ${last.daysAR.toFixed(0)} days reflects efficient collection practices.`);
      else if (last.daysAR > 90) weaknesses.push(`Days' receivables of ${last.daysAR.toFixed(0)} days suggests slow collection - review credit policies and collection procedures.`);
    }
    
    if (last.daysInv > 0) {
      if (last.daysInv < 60) insights.push(`Inventory turnover of ${last.daysInv.toFixed(0)} days indicates efficient inventory management.`);
      else if (last.daysInv > 120) weaknesses.push(`Days' inventory of ${last.daysInv.toFixed(0)} days may indicate slow-moving stock - consider inventory optimization.`);
    }
    
    if (last.daysAP > 0) {
      if (last.daysAP > 45) insights.push(`Days' payables of ${last.daysAP.toFixed(0)} days provides beneficial supplier financing.`);
      else if (last.daysAP < 20) insights.push(`Days' payables of ${last.daysAP.toFixed(0)} days - consider extending payment terms to improve cash flow.`);
    }
    
    // Cash Conversion Cycle
    const cashConversionCycle = last.daysInv + last.daysAR - last.daysAP;
    if (cashConversionCycle < 30) strengths.push(`Cash conversion cycle of ${cashConversionCycle.toFixed(0)} days demonstrates excellent working capital efficiency.`);
    else if (cashConversionCycle > 90) weaknesses.push(`Cash conversion cycle of ${cashConversionCycle.toFixed(0)} days suggests opportunities to accelerate cash generation.`);
    
    // Asset Efficiency
    if (last.totalAssetTO > 1.5) strengths.push(`Total asset turnover of ${last.totalAssetTO.toFixed(1)} shows effective asset utilization in generating sales.`);
    else if (last.totalAssetTO < 0.5) weaknesses.push(`Total asset turnover of ${last.totalAssetTO.toFixed(1)} indicates underutilized assets - review asset productivity.`);
    
    // Profitability Margins
    if (last.ebitdaMargin > 0.15) strengths.push(`EBITDA margin of ${(last.ebitdaMargin * 100).toFixed(1)}% demonstrates strong operational profitability.`);
    else if (last.ebitdaMargin < 0.05) weaknesses.push(`EBITDA margin of ${(last.ebitdaMargin * 100).toFixed(1)}% requires operational cost optimization.`);
    
    // Cash Flow Analysis (estimated from financial data)
    if (monthly.length >= 13) {
      const currentCash = monthly[monthly.length - 1].cash;
      const priorYearCash = monthly[monthly.length - 13].cash;
      const cashChange = currentCash - priorYearCash;
      
      if (cashChange > ltmRev * 0.1) strengths.push(`Cash position improved by $${(cashChange / 1000).toFixed(1)}K over the past year, strengthening financial resilience.`);
      else if (cashChange < -ltmRev * 0.05) weaknesses.push(`Cash declined by $${(Math.abs(cashChange) / 1000).toFixed(1)}K - monitor cash flow and consider working capital improvements.`);
    }
    
    // Benchmark Comparison (if available)
    if (benchmarks && benchmarks.length > 0) {
      // Helper function to get benchmark value
      const getBenchmark = (metricName: string) => {
        const bm = benchmarks.find(b => b.metricName === metricName);
        return bm ? bm.fiveYearValue : null;
      };
      
      // Current Ratio Benchmark
      const currentRatioBM = getBenchmark('Current Ratio');
      if (currentRatioBM !== null && last.currentRatio) {
        if (last.currentRatio > currentRatioBM * 1.2) {
          strengths.push(`Current ratio of ${last.currentRatio.toFixed(1)} is ${((last.currentRatio / currentRatioBM - 1) * 100).toFixed(0)}% above industry average (${currentRatioBM.toFixed(1)}), demonstrating superior liquidity management.`);
        } else if (last.currentRatio < currentRatioBM * 0.8) {
          weaknesses.push(`Current ratio of ${last.currentRatio.toFixed(1)} is ${((1 - last.currentRatio / currentRatioBM) * 100).toFixed(0)}% below industry average (${currentRatioBM.toFixed(1)}), indicating potential liquidity concerns relative to peers.`);
        }
      }
      
      // Quick Ratio Benchmark
      const quickRatioBM = getBenchmark('Quick Ratio');
      if (quickRatioBM !== null && last.quickRatio) {
        if (last.quickRatio > quickRatioBM * 1.2) {
          strengths.push(`Quick ratio of ${last.quickRatio.toFixed(1)} significantly exceeds industry benchmark (${quickRatioBM.toFixed(1)}), highlighting exceptional short-term financial strength.`);
        } else if (last.quickRatio < quickRatioBM * 0.8) {
          weaknesses.push(`Quick ratio of ${last.quickRatio.toFixed(1)} lags industry average (${quickRatioBM.toFixed(1)}) by ${((1 - last.quickRatio / quickRatioBM) * 100).toFixed(0)}%, suggesting need for improved cash management.`);
        }
      }
      
      // Debt-to-Net Worth Benchmark
      const debtToNWBM = getBenchmark('Total Debt to Net Worth Ratio');
      if (debtToNWBM !== null && last.debtToNW) {
        if (last.debtToNW < debtToNWBM * 0.7) {
          strengths.push(`Debt-to-Net Worth of ${last.debtToNW.toFixed(1)} is well below industry average (${debtToNWBM.toFixed(1)}), indicating conservative leverage and strong balance sheet.`);
        } else if (last.debtToNW > debtToNWBM * 1.3) {
          weaknesses.push(`Debt-to-Net Worth of ${last.debtToNW.toFixed(1)} exceeds industry norm (${debtToNWBM.toFixed(1)}) by ${((last.debtToNW / debtToNWBM - 1) * 100).toFixed(0)}%, suggesting higher financial risk profile.`);
        }
      }
      
      // Gross Profit Margin Benchmark
      const grossProfitBM = getBenchmark('Gross Profit Margin %');
      if (grossProfitBM !== null && last.grossMargin) {
        if (last.grossMargin > grossProfitBM / 100 * 1.1) {
          strengths.push(`Gross profit margin of ${(last.grossMargin * 100).toFixed(1)}% outperforms industry average (${grossProfitBM.toFixed(1)}%), demonstrating strong pricing power and cost management.`);
        } else if (last.grossMargin < grossProfitBM / 100 * 0.9) {
          weaknesses.push(`Gross margin of ${(last.grossMargin * 100).toFixed(1)}% trails industry benchmark (${grossProfitBM.toFixed(1)}%), indicating potential pricing or cost structure challenges.`);
        }
      }
      
      // Return on Assets Benchmark
      const roaBM = getBenchmark('Return on Total Assets %');
      if (roaBM !== null && last.roa) {
        if (last.roa > roaBM / 100 * 1.2) {
          strengths.push(`Return on Assets of ${(last.roa * 100).toFixed(1)}% is ${(((last.roa * 100) / roaBM - 1) * 100).toFixed(0)}% above industry average (${roaBM.toFixed(1)}%), reflecting superior asset productivity.`);
        } else if (last.roa < roaBM / 100 * 0.8) {
          weaknesses.push(`ROA of ${(last.roa * 100).toFixed(1)}% is below industry standard (${roaBM.toFixed(1)}%), suggesting opportunities for improved asset utilization.`);
        }
      }
      
      // Return on Equity Benchmark
      const roeBM = getBenchmark('Return on Net Worth %');
      if (roeBM !== null && last.roe) {
        if (last.roe > roeBM / 100 * 1.2) {
          strengths.push(`Return on Equity of ${(last.roe * 100).toFixed(1)}% substantially exceeds industry benchmark (${roeBM.toFixed(1)}%), indicating exceptional returns for shareholders.`);
        } else if (last.roe < roeBM / 100 * 0.8) {
          weaknesses.push(`ROE of ${(last.roe * 100).toFixed(1)}% underperforms industry average (${roeBM.toFixed(1)}%), suggesting need for profitability improvement.`);
        }
      }
      
      // Days AR Benchmark
      const daysARBM = getBenchmark('Days\' Receivables');
      if (daysARBM !== null && last.daysAR > 0) {
        if (last.daysAR < daysARBM * 0.8) {
          strengths.push(`Days' receivables of ${last.daysAR.toFixed(0)} days is ${((1 - last.daysAR / daysARBM) * 100).toFixed(0)}% faster than industry average (${daysARBM.toFixed(0)} days), demonstrating superior collection efficiency.`);
        } else if (last.daysAR > daysARBM * 1.2) {
          weaknesses.push(`Collection period of ${last.daysAR.toFixed(0)} days exceeds industry norm (${daysARBM.toFixed(0)} days) by ${((last.daysAR / daysARBM - 1) * 100).toFixed(0)}%, indicating room for accounts receivable optimization.`);
        }
      }
      
      // Days Inventory Benchmark
      const daysInvBM = getBenchmark('Days\' Inventory');
      if (daysInvBM !== null && last.daysInv > 0) {
        if (last.daysInv < daysInvBM * 0.8) {
          insights.push(`Inventory turnover (${last.daysInv.toFixed(0)} days) is ${((1 - last.daysInv / daysInvBM) * 100).toFixed(0)}% faster than industry average (${daysInvBM.toFixed(0)} days), indicating lean inventory management.`);
        } else if (last.daysInv > daysInvBM * 1.2) {
          weaknesses.push(`Inventory holding period of ${last.daysInv.toFixed(0)} days is ${((last.daysInv / daysInvBM - 1) * 100).toFixed(0)}% longer than industry benchmark (${daysInvBM.toFixed(0)} days), suggesting potential obsolescence risk.`);
        }
      }
      
      // Days AP Benchmark
      const daysAPBM = getBenchmark('Days\' Payables');
      if (daysAPBM !== null && last.daysAP > 0) {
        if (last.daysAP > daysAPBM * 1.1) {
          insights.push(`Payment terms of ${last.daysAP.toFixed(0)} days exceed industry average (${daysAPBM.toFixed(0)} days), providing favorable cash flow timing and supplier financing.`);
        } else if (last.daysAP < daysAPBM * 0.8) {
          insights.push(`Payment period of ${last.daysAP.toFixed(0)} days is shorter than industry norm (${daysAPBM.toFixed(0)} days) - consider negotiating extended terms to improve cash flow.`);
        }
      }
      
      // Asset Turnover Benchmark
      const assetTOBM = getBenchmark('Total Asset Turnover');
      if (assetTOBM !== null && last.totalAssetTO) {
        if (last.totalAssetTO > assetTOBM * 1.2) {
          strengths.push(`Asset turnover of ${last.totalAssetTO.toFixed(1)} exceeds industry average (${assetTOBM.toFixed(1)}) by ${((last.totalAssetTO / assetTOBM - 1) * 100).toFixed(0)}%, demonstrating efficient capital deployment.`);
        } else if (last.totalAssetTO < assetTOBM * 0.8) {
          weaknesses.push(`Asset turnover of ${last.totalAssetTO.toFixed(1)} trails industry benchmark (${assetTOBM.toFixed(1)}), indicating potential for enhanced revenue generation from existing assets.`);
        }
      }
      
      insights.push(`Industry benchmark analysis shows ${strengths.filter(s => s.includes('industry')).length} areas where performance exceeds peer standards.`);
    }
    
    // Add strategic insights based on comprehensive data
    insights.push(`Monitor the trend in Financial Score over time to identify patterns and early warning signs of performance changes.`);
    insights.push(`Focus improvement initiatives on components with the lowest scores for maximum impact on overall financial health.`);
    
    if (growth_6mo < growth_24mo) {
      insights.push(`Recent 6-month growth (${growth_6mo.toFixed(1)}%) is slower than 24-month trend (${growth_24mo.toFixed(1)}%), suggesting momentum is decelerating - consider market expansion strategies.`);
    } else if (growth_6mo > growth_24mo) {
      insights.push(`Recent 6-month growth (${growth_6mo.toFixed(1)}%) exceeds 24-month trend (${growth_24mo.toFixed(1)}%), indicating accelerating momentum - capitalize on this growth trajectory.`);
    }
    
    // Valuation insights
    if (last.totalAssets > 0) {
      const assetMultiple = last.totalAssets > 0 ? ltmRev / last.totalAssets : 0;
      if (assetMultiple > 1.5) {
        insights.push(`Revenue-to-Assets ratio of ${assetMultiple.toFixed(1)}x indicates efficient capital utilization and strong operational leverage.`);
      } else if (assetMultiple < 0.8) {
        insights.push(`Revenue-to-Assets ratio of ${assetMultiple.toFixed(1)}x suggests opportunities to improve asset productivity through operational optimization.`);
      }
    }
    
    // Cash flow insights
    if (monthly.length >= 12) {
      const recentCashFlow = monthly.slice(-12).reduce((sum, m) => sum + (m.revenue - m.expense), 0);
      const cashFlowMargin = recentCashFlow / ltmRev;
      if (cashFlowMargin > 0.15) {
        strengths.push(`Operating cash flow margin of ${(cashFlowMargin * 100).toFixed(1)}% demonstrates strong cash generation capability and financial sustainability.`);
      } else if (cashFlowMargin < 0.05) {
        weaknesses.push(`Operating cash flow margin of ${(cashFlowMargin * 100).toFixed(1)}% indicates tight cash generation - focus on working capital optimization.`);
      }
    }
    
    return { strengths, weaknesses, insights };
  }, [trendData, finalScore, profitabilityScore, assetDevScore, growth_24mo, growth_6mo, expenseAdjustment, revExpSpread, ltmRev, ltmExp, monthly, benchmarks]);

  // Projections
  const projections = useMemo(() => {
    if (monthly.length < 24) return { mostLikely: [], bestCase: [], worstCase: [] };
    
    // Add computed netIncome field to monthly data
    const monthlyWithNetIncome = monthly.map(m => ({
      ...m,
      netIncome: m.revenue - (m.cogsTotal || 0) - m.expense
    }));
    
    // Holt-Winters Triple Exponential Smoothing
    const holtWinters = (data: number[], seasonalPeriod: number = 12, alpha: number = 0.2, beta: number = 0.1, gamma: number = 0.1) => {
      const n = data.length;
      if (n < seasonalPeriod * 2) return null;
      
      // Initialize components
      const level: number[] = [];
      const trend: number[] = [];
      const seasonal: number[] = new Array(n).fill(1);
      
      // Calculate initial seasonal indices (average of first two complete seasons)
      for (let i = 0; i < seasonalPeriod; i++) {
        let sum = 0;
        let count = 0;
        for (let j = i; j < n; j += seasonalPeriod) {
          if (j < seasonalPeriod * 2) {
            sum += data[j];
            count++;
          }
        }
        const avg = sum / count;
        const overallAvg = data.slice(0, seasonalPeriod * 2).reduce((a, b) => a + b, 0) / (seasonalPeriod * 2);
        seasonal[i] = avg / overallAvg;
      }
      
      // Initialize level and trend
      level[0] = data[0] / seasonal[0];
      trend[0] = (data[seasonalPeriod] - data[0]) / seasonalPeriod;
      
      // Apply Holt-Winters equations
      for (let t = 1; t < n; t++) {
        const prevLevel = level[t - 1];
        const prevTrend = trend[t - 1];
        const seasonalIdx = t % seasonalPeriod;
        const prevSeasonal = seasonal[seasonalIdx];
        
        // Update level
        level[t] = alpha * (data[t] / prevSeasonal) + (1 - alpha) * (prevLevel + prevTrend);
        
        // Update trend
        trend[t] = beta * (level[t] - prevLevel) + (1 - beta) * prevTrend;
        
        // Update seasonal
        seasonal[t] = gamma * (data[t] / level[t]) + (1 - gamma) * prevSeasonal;
      }
      
      return { level: level[n - 1], trend: trend[n - 1], seasonal };
    };
    
    // Apply Holt-Winters to each metric
    const revData = monthlyWithNetIncome.map(m => m.revenue);
    const cogsData = monthlyWithNetIncome.map(m => m.cogsTotal || 0);
    const expData = monthlyWithNetIncome.map(m => m.expense);
    
    const revHW = holtWinters(revData);
    const cogsHW = holtWinters(cogsData);
    const expHW = holtWinters(expData);
    
    // For assets and liabilities, use simple growth
    const last12 = monthlyWithNetIncome.slice(-12);
    const prev12 = monthlyWithNetIncome.slice(-24, -12);
    const avgAssetGrowth = ((last12[last12.length - 1].totalAssets - prev12[prev12.length - 1].totalAssets) / prev12[prev12.length - 1].totalAssets) / 12;
    const avgLiabGrowth = ((last12[last12.length - 1].totalLiab - prev12[prev12.length - 1].totalLiab) / prev12[prev12.length - 1].totalLiab) / 12;
    
    const lastMonth = monthlyWithNetIncome[monthlyWithNetIncome.length - 1];
    const mostLikely: any[] = [];
    const bestCase: any[] = [];
    const worstCase: any[] = [];
    
    // Check if Holt-Winters is available (need 24+ months)
    if (revHW && cogsHW && expHW) {
      const seasonalPeriod = 12;
      const n = monthlyWithNetIncome.length;
      
      for (let i = 1; i <= 12; i++) {
        const monthName = `+${i}mo`;
        const seasonalIdx = (n + i - 1) % seasonalPeriod;
        
        // Most Likely: Standard Holt-Winters forecast
        const mlRev = Math.max(0, (revHW.level + i * revHW.trend) * revHW.seasonal[seasonalIdx]);
        const mlCogs = Math.max(0, (cogsHW.level + i * cogsHW.trend) * cogsHW.seasonal[seasonalIdx]);
        const mlExp = Math.max(0, (expHW.level + i * expHW.trend) * expHW.seasonal[seasonalIdx]);
        const mlAssets = lastMonth.totalAssets * Math.pow(1 + avgAssetGrowth, i);
        const mlLiab = lastMonth.totalLiab * Math.pow(1 + avgLiabGrowth, i);
        const mlEquity = mlAssets - mlLiab;
        
        mostLikely.push({
          month: monthName,
          revenue: mlRev,
          expense: mlExp,
          netIncome: mlRev - mlCogs - mlExp,
          totalAssets: mlAssets,
          totalLiab: mlLiab,
          totalEquity: mlEquity
        });
        
        // Best Case: Amplify trend by 50%
        const bcRev = Math.max(0, (revHW.level + i * revHW.trend * 1.5) * revHW.seasonal[seasonalIdx]);
        const bcCogs = Math.max(0, (cogsHW.level + i * cogsHW.trend * 0.5) * cogsHW.seasonal[seasonalIdx]); // Lower trend is better
        const bcExp = Math.max(0, (expHW.level + i * expHW.trend * 0.5) * expHW.seasonal[seasonalIdx]); // Lower trend is better
        const bcAssets = lastMonth.totalAssets * Math.pow(1 + avgAssetGrowth * 1.2, i);
        const bcLiab = lastMonth.totalLiab * Math.pow(1 + avgLiabGrowth * 0.8, i);
        const bcEquity = bcAssets - bcLiab;
        
        bestCase.push({
          month: monthName,
          revenue: bcRev,
          expense: bcExp,
          netIncome: bcRev - bcCogs - bcExp,
          totalAssets: bcAssets,
          totalLiab: bcLiab,
          totalEquity: bcEquity
        });
        
        // Worst Case: Reduce trend by 50%
        const wcRev = Math.max(0, (revHW.level + i * revHW.trend * 0.5) * revHW.seasonal[seasonalIdx]);
        const wcCogs = Math.max(0, (cogsHW.level + i * cogsHW.trend * 1.5) * cogsHW.seasonal[seasonalIdx]); // Higher trend is worse
        const wcExp = Math.max(0, (expHW.level + i * expHW.trend * 1.5) * expHW.seasonal[seasonalIdx]); // Higher trend is worse
        const wcAssets = lastMonth.totalAssets * Math.pow(1 + avgAssetGrowth * 0.8, i);
        const wcLiab = lastMonth.totalLiab * Math.pow(1 + avgLiabGrowth * 1.2, i);
        const wcEquity = wcAssets - wcLiab;
        
        worstCase.push({
          month: monthName,
          revenue: wcRev,
          expense: wcExp,
          netIncome: wcRev - wcCogs - wcExp,
          totalAssets: wcAssets,
          totalLiab: wcLiab,
          totalEquity: wcEquity
        });
      }
    } else {
      // Fallback to simple projection if not enough data
      const avgRevGrowth = monthlyWithNetIncome.length >= 2 
        ? (lastMonth.revenue - monthlyWithNetIncome[0].revenue) / monthlyWithNetIncome[0].revenue / monthlyWithNetIncome.length
        : 0;
      const avgCogsGrowth = monthlyWithNetIncome.length >= 2 
        ? ((lastMonth.cogsTotal || 0) - (monthlyWithNetIncome[0].cogsTotal || 0)) / (monthlyWithNetIncome[0].cogsTotal || 1) / monthlyWithNetIncome.length
        : 0;
      const avgExpGrowth = monthlyWithNetIncome.length >= 2 
        ? (lastMonth.expense - monthlyWithNetIncome[0].expense) / monthlyWithNetIncome[0].expense / monthlyWithNetIncome.length
        : 0;
      
      for (let i = 1; i <= 12; i++) {
        const monthName = `+${i}mo`;
        
        const mlRev = lastMonth.revenue * Math.pow(1 + avgRevGrowth, i);
        const mlCogs = (lastMonth.cogsTotal || 0) * Math.pow(1 + avgCogsGrowth, i);
        const mlExp = lastMonth.expense * Math.pow(1 + avgExpGrowth, i);
        const mlAssets = lastMonth.totalAssets * Math.pow(1 + avgAssetGrowth, i);
        const mlLiab = lastMonth.totalLiab * Math.pow(1 + avgLiabGrowth, i);
        const mlEquity = mlAssets - mlLiab;
        
        mostLikely.push({
          month: monthName,
          revenue: mlRev,
          expense: mlExp,
          netIncome: mlRev - mlCogs - mlExp,
          totalAssets: mlAssets,
          totalLiab: mlLiab,
          totalEquity: mlEquity
        });
        
        bestCase.push({
          month: monthName,
          revenue: mlRev * 1.1,
          expense: mlExp * 0.9,
          netIncome: (mlRev * 1.1) - (mlCogs * 0.9) - (mlExp * 0.9),
          totalAssets: mlAssets,
          totalLiab: mlLiab,
          totalEquity: mlEquity
        });
        
        worstCase.push({
          month: monthName,
          revenue: mlRev * 0.9,
          expense: mlExp * 1.1,
          netIncome: (mlRev * 0.9) - (mlCogs * 1.1) - (mlExp * 1.1),
          totalAssets: mlAssets,
          totalLiab: mlLiab,
          totalEquity: mlEquity
        });
      }
    }
    
    return { mostLikely, bestCase, worstCase, monthlyWithNetIncome };
  }, [monthly]);

  const renderColumnSelector = (label: string, mappingKey: keyof Mappings) => renderColumnSelectorUtil(label, mappingKey, mapping, setMapping, columns);

  const saveProjectionDefaults = () => saveProjectionDefaultsUtil(
    bestCaseRevMultiplier,
    bestCaseExpMultiplier,
    worstCaseRevMultiplier,
    worstCaseExpMultiplier,
    setDefaultBestCaseRevMult,
    setDefaultBestCaseExpMult,
    setDefaultWorstCaseRevMult,
    setDefaultWorstCaseExpMult,
    setShowDefaultSettings
  );

  // Main Logged-In View with Header
  const company = getCurrentCompany();
  const companyName = company ? company.name : '';

  // Custom Print Package Handler
  const handleGeneratePrintPackage = () => {
    // Check if any items are selected
    const hasSelection = Object.values(printPackageSelections).some(val => val);
    if (!hasSelection) {
      alert('Please select at least one report to include in the print package.');
      return;
    }

    // Build array of print instructions
    const printQueue: any[] = [];
    
    if (printPackageSelections.mda) {
      printQueue.push({ view: 'mda', title: 'MD&A (Management Discussion & Analysis)' });
    }
    if (printPackageSelections.financialScore) {
      printQueue.push({ view: 'fs-score', title: 'Financial Score' });
    }
    if (printPackageSelections.priorityRatios) {
      printQueue.push({ view: 'kpis', tab: 'priority-ratios', title: 'Priority Ratios' });
    }
    if (printPackageSelections.workingCapital) {
      printQueue.push({ view: 'working-capital', title: 'Working Capital' });
    }
    if (printPackageSelections.dashboard) {
      printQueue.push({ view: 'dashboard', title: 'Dashboard' });
    }
    if (printPackageSelections.cashFlow4Quarters) {
      printQueue.push({ view: 'cash-flow', display: 'quarterly', title: 'Cash Flow - Last 4 Quarters' });
    }
    if (printPackageSelections.cashFlow3Years) {
      printQueue.push({ view: 'cash-flow', display: 'annual', title: 'Cash Flow - Last 3 Years' });
    }
    if (printPackageSelections.incomeStatement12MonthsQuarterly) {
      printQueue.push({ 
        view: 'financial-statements', 
        type: 'income-statement', 
        display: 'quarterly',
        title: 'Income Statement - Last 12 Months (Quarterly)' 
      });
    }
    if (printPackageSelections.incomeStatement3YearsAnnual) {
      printQueue.push({ 
        view: 'financial-statements', 
        type: 'income-statement', 
        display: 'annual',
        title: 'Income Statement - Last 3 Years (Annual)' 
      });
    }
    if (printPackageSelections.balanceSheet12MonthsQuarterly) {
      printQueue.push({ 
        view: 'financial-statements', 
        type: 'balance-sheet', 
        display: 'quarterly',
        title: 'Balance Sheet - Last 12 Months (Quarterly)' 
      });
    }
    if (printPackageSelections.balanceSheet3YearsAnnual) {
      printQueue.push({ 
        view: 'financial-statements', 
        type: 'balance-sheet', 
        display: 'annual',
        title: 'Balance Sheet - Last 3 Years (Annual)' 
      });
    }
    if (printPackageSelections.profile) {
      printQueue.push({ view: 'profile', title: 'Company Profile' });
    }

    if (printQueue.length === 0) {
      alert('Please select at least one report to print.');
      return;
    }

    // Show confirmation
    const reportNames = printQueue.map(p => p.title).join('\nâ€¢ ');
    if (!confirm(`You are about to print the following reports in sequence:\n\nâ€¢ ${reportNames}\n\nThis will open ${printQueue.length} print dialog(s). Continue?`)) {
      return;
    }

    // Print each report in sequence with a delay
    let currentIndex = 0;
    const printNext = () => {
      if (currentIndex >= printQueue.length) {
        alert('All reports have been sent to print!');
        return;
      }

      const report = printQueue[currentIndex];
      
      // Set the appropriate view and parameters
      if (report.view === 'financial-statements') {
        setStatementType(report.type as any);
        setStatementDisplay(report.display as any);
        setCurrentView('financial-statements');
      } else if (report.view === 'cash-flow') {
        setCashFlowDisplay(report.display as any);
        setCurrentView('cash-flow');
      } else if (report.view === 'kpis' && report.tab) {
        setKpiDashboardTab(report.tab as any);
        setCurrentView('kpis');
      } else {
        setCurrentView(report.view as any);
      }

      // Wait for render then print
      setTimeout(() => {
        window.print();
        currentIndex++;
        // Wait for print dialog to close before next one
        setTimeout(printNext, 1000);
      }, 500);
    };

    printNext();
  };

  if (!isLoggedIn) {
    return (
      <LoginView
        loginEmail={loginEmail}
        setLoginEmail={setLoginEmail}
        loginPassword={loginPassword}
        setLoginPassword={setLoginPassword}
        loginName={loginName}
        setLoginName={setLoginName}
        loginPhone={loginPhone}
        setLoginPhone={setLoginPhone}
        loginCompanyName={loginCompanyName}
        setLoginCompanyName={setLoginCompanyName}
        loginCompanyAddress1={loginCompanyAddress1}
        setLoginCompanyAddress1={setLoginCompanyAddress1}
        loginCompanyAddress2={loginCompanyAddress2}
        setLoginCompanyAddress2={setLoginCompanyAddress2}
        loginCompanyCity={loginCompanyCity}
        setLoginCompanyCity={setLoginCompanyCity}
        loginCompanyState={loginCompanyState}
        setLoginCompanyState={setLoginCompanyState}
        loginCompanyZip={loginCompanyZip}
        setLoginCompanyZip={setLoginCompanyZip}
        loginCompanyWebsite={loginCompanyWebsite}
        setLoginCompanyWebsite={setLoginCompanyWebsite}
        isRegistering={isRegistering}
        setIsRegistering={setIsRegistering}
        loginError={loginError}
        setLoginError={setLoginError}
        showPassword={showPassword}
        setShowPassword={setShowPassword}
        showForgotPassword={showForgotPassword}
        setShowForgotPassword={setShowForgotPassword}
        resetEmail={resetEmail}
        setResetEmail={setResetEmail}
        resetSuccess={resetSuccess}
        setResetSuccess={setResetSuccess}
        isLoading={isLoading}
        setIsLoading={setIsLoading}
        handleLogin={handleLogin}
        handleRegisterConsultant={handleRegisterConsultant}
      />
    );
  }

  return (
    <div style={{ height: '100vh', background: '#f8fafc', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
      <Toaster />
      <InactivityLogout 
        isLoggedIn={isLoggedIn}
        userEmail={currentUser?.email}
        onLogout={handleLogout}
      />
      <Header
        currentUser={currentUser}
        currentView={currentView}
        setCurrentView={setCurrentView}
        handleLogout={handleLogout}
        handleNavigation={handleNavigation}
      />

      {/* Main Content Area with Sidebar */}
      <div style={{ display: 'flex', overflow: 'hidden', marginTop: '70px', height: 'calc(100vh - 70px)' }}>
        {/* Left Navigation Sidebar - Not for Site Admin */}
        {currentUser?.role !== 'siteadmin' && !(currentUser?.userType === 'assessment') && (
        <aside style={{ 
          width: '280px', 
          background: 'white', 
          borderRight: '2px solid #e2e8f0', 
          padding: '32px 0 24px 0',
          overflowY: 'auto',
          flexShrink: 0,
          boxShadow: '2px 0 8px rgba(0,0,0,0.03)',
          display: 'flex',
          flexDirection: 'column'
        }}>
          {/* Active Company Info at Top - Show for consultants with selected company or company users */}
          {(companyName || (currentUser?.userType === 'company' && currentUser?.companyId)) && (
            <div style={{ padding: '0 24px 24px', borderBottom: '2px solid #e2e8f0' }}>
              <div 
                onClick={() => {
                  setCurrentView('admin');
                  setAdminDashboardTab('company-management');
                }}
                style={{ 
                  padding: '12px', 
                  background: '#f0f9ff', 
                  borderRadius: '8px', 
                  border: '1px solid #bae6fd',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#e0f2fe';
                  e.currentTarget.style.border = '1px solid #7dd3fc';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = '#f0f9ff';
                  e.currentTarget.style.border = '1px solid #bae6fd';
                }}
              >
                <div style={{ fontSize: '11px', fontWeight: '600', color: '#0c4a6e', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Active Company</div>
                <div style={{ fontSize: '14px', fontWeight: '600', color: '#1e40af' }}>
                  {companyName || (currentUser?.userType === 'company' ? (Array.isArray(companies) && companies.find(c => c.id === currentUser?.companyId)?.name) || 'Loading...' : '')}
                </div>
                {/* Show Advisor Name for Company Users */}
                {currentUser?.userType === 'company' && currentUser?.consultantId && (() => {
                  const consultant = consultants.find(c => c.id === currentUser.consultantId);
                  if (consultant?.companyName) {
                    return (
                      <div style={{ fontSize: '12px', color: '#667eea', marginTop: '6px', fontWeight: '500' }}>
                        {consultant.companyName}
                      </div>
                    );
                  }
                  return null;
                })()}
              </div>
            </div>
          )}
          
          <nav style={{ flex: 1, display: 'flex', flexDirection: 'column', paddingTop: '24px' }}>
            {/* Financial Score Section */}
            <div style={{ marginBottom: '1px' }}>
              <h3 
                onClick={() => setIsFinancialScoreExpanded(!isFinancialScoreExpanded)}
                style={{ 
                  fontSize: '14px', 
                  fontWeight: '700', 
                  color: '#1e293b',
                  textTransform: 'uppercase', 
                  letterSpacing: '0.5px',
                  padding: '4px 24px',
                  marginBottom: '1px',
                  cursor: 'pointer',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  transition: 'color 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.color = '#667eea';
                  e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                }}
                onMouseLeave={(e) => e.currentTarget.style.color = '#1e293b'}
              >
                <span>Financial Score</span>
                <span style={{ fontSize: '12px', color: '#667eea' }}>{isFinancialScoreExpanded ? '-' : '+'}</span>
              </h3>
              {isFinancialScoreExpanded && (
                <div style={{ paddingLeft: '28px' }}>
                  <div
                    onClick={() => setCurrentView('fs-intro')}
                    style={{
                      fontSize: '14px',
                      color: currentView === 'fs-intro' ? '#667eea' : '#475569',
                      padding: '4px 12px',
                      cursor: 'pointer',
                      borderRadius: '6px',
                      marginBottom: '4px',
                      background: currentView === 'fs-intro' ? '#ede9fe' : 'transparent',
                      fontWeight: currentView === 'fs-intro' ? '600' : '400',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      if (currentView !== 'fs-intro') {
                        e.currentTarget.style.background = '#f8fafc';
                        e.currentTarget.style.color = '#667eea';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (currentView !== 'fs-intro') {
                        e.currentTarget.style.background = 'transparent';
                        e.currentTarget.style.color = '#475569';
                      }
                    }}
                  >
                    {currentView === 'fs-intro' && 'âœ“ '}Introduction
                  </div>
                  <div
                    onClick={() => setCurrentView('fs-score')}
                    style={{
                      fontSize: '14px',
                      color: currentView === 'fs-score' ? '#667eea' : '#475569',
                      padding: '8px 12px',
                      cursor: 'pointer',
                      borderRadius: '6px',
                      marginBottom: '4px',
                      background: currentView === 'fs-score' ? '#ede9fe' : 'transparent',
                      fontWeight: currentView === 'fs-score' ? '600' : '400',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      if (currentView !== 'fs-score') {
                        e.currentTarget.style.background = '#f8fafc';
                        e.currentTarget.style.color = '#667eea';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (currentView !== 'fs-score') {
                        e.currentTarget.style.background = 'transparent';
                        e.currentTarget.style.color = '#475569';
                      }
                    }}
                  >
                    {currentView === 'fs-score' && 'âœ“ '}Financial Score
                  </div>
                </div>
              )}
            </div>

            {/* Management Assessment Section - For Assessment Users, Company Users, and Consultants */}
            {((currentUser?.role === 'user' && (currentUser?.userType === 'assessment' || currentUser?.userType === 'company')) || currentUser?.role === 'consultant') && (
            <div style={{ marginBottom: '1px' }}>
              <h3 
                onClick={() => setIsManagementAssessmentExpanded(!isManagementAssessmentExpanded)}
                style={{ 
                  fontSize: '14px', 
                  fontWeight: '700', 
                  color: '#1e293b',
                  textTransform: 'uppercase', 
                  letterSpacing: '0.5px',
                  padding: '4px 24px',
                  marginBottom: '1px',
                  cursor: 'pointer',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  transition: 'color 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.color = '#667eea';
                  e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                }}
                onMouseLeave={(e) => e.currentTarget.style.color = '#1e293b'}
              >
                <span>Management Assessment</span>
                <span style={{ fontSize: '12px', color: '#667eea' }}>{isManagementAssessmentExpanded ? '-' : '+'}</span>
              </h3>
              {isManagementAssessmentExpanded && (
                <div style={{ paddingLeft: '28px' }}>
                <div
                  onClick={() => setCurrentView('ma-welcome')}
                  style={{
                    fontSize: '14px',
                    color: currentView === 'ma-welcome' ? '#667eea' : '#475569',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    borderRadius: '6px',
                    marginBottom: '4px',
                    background: currentView === 'ma-welcome' ? '#ede9fe' : 'transparent',
                    fontWeight: currentView === 'ma-welcome' ? '600' : '400',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (currentView !== 'ma-welcome') {
                      e.currentTarget.style.background = '#f8fafc';
                      e.currentTarget.style.color = '#667eea';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentView !== 'ma-welcome') {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.color = '#475569';
                    }
                  }}
                >
                  {currentView === 'ma-welcome' && 'âœ“ '}Welcome
                </div>
                <div
                  onClick={() => setCurrentView('ma-questionnaire')}
                  style={{
                    fontSize: '14px',
                    color: currentView === 'ma-questionnaire' ? '#667eea' : '#475569',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    borderRadius: '6px',
                    marginBottom: '4px',
                    background: currentView === 'ma-questionnaire' ? '#ede9fe' : 'transparent',
                    fontWeight: currentView === 'ma-questionnaire' ? '600' : '400',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (currentView !== 'ma-questionnaire') {
                      e.currentTarget.style.background = '#f8fafc';
                      e.currentTarget.style.color = '#667eea';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentView !== 'ma-questionnaire') {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.color = '#475569';
                    }
                  }}
                >
                  {currentView === 'ma-questionnaire' && 'âœ“ '}Questionnaire
                </div>
                <div
                  onClick={() => setCurrentView('ma-your-results')}
                  style={{
                    fontSize: '14px',
                    color: currentView === 'ma-your-results' ? '#667eea' : '#475569',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    borderRadius: '6px',
                    marginBottom: '4px',
                    background: currentView === 'ma-your-results' ? '#ede9fe' : 'transparent',
                    fontWeight: currentView === 'ma-your-results' ? '600' : '400',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (currentView !== 'ma-your-results') {
                      e.currentTarget.style.background = '#f8fafc';
                      e.currentTarget.style.color = '#667eea';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentView !== 'ma-your-results') {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.color = '#475569';
                    }
                  }}
                >
                  {currentView === 'ma-your-results' && 'âœ“ '}{currentUser?.role === 'consultant' ? 'Results' : 'Your Results'}
                </div>
                <div
                  onClick={() => setCurrentView('ma-scores-summary')}
                  style={{
                    fontSize: '14px',
                    color: currentView === 'ma-scores-summary' ? '#667eea' : '#475569',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    borderRadius: '6px',
                    marginBottom: '4px',
                    background: currentView === 'ma-scores-summary' ? '#ede9fe' : 'transparent',
                    fontWeight: currentView === 'ma-scores-summary' ? '600' : '400',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (currentView !== 'ma-scores-summary') {
                      e.currentTarget.style.background = '#f8fafc';
                      e.currentTarget.style.color = '#667eea';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentView !== 'ma-scores-summary') {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.color = '#475569';
                    }
                  }}
                >
                  {currentView === 'ma-scores-summary' && 'âœ“ '}Scores Summary
                </div>
                <div
                  onClick={() => setCurrentView('ma-scoring-guide')}
                  style={{
                    fontSize: '14px',
                    color: currentView === 'ma-scoring-guide' ? '#667eea' : '#475569',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    borderRadius: '6px',
                    marginBottom: '4px',
                    background: currentView === 'ma-scoring-guide' ? '#ede9fe' : 'transparent',
                    fontWeight: currentView === 'ma-scoring-guide' ? '600' : '400',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (currentView !== 'ma-scoring-guide') {
                      e.currentTarget.style.background = '#f8fafc';
                      e.currentTarget.style.color = '#667eea';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentView !== 'ma-scoring-guide') {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.color = '#475569';
                    }
                  }}
                >
                  {currentView === 'ma-scoring-guide' && 'âœ“ '}Scoring Guide
                </div>
                <div
                  onClick={() => setCurrentView('ma-charts')}
                  style={{
                    fontSize: '14px',
                    color: currentView === 'ma-charts' ? '#667eea' : '#475569',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    borderRadius: '6px',
                    marginBottom: '4px',
                    background: currentView === 'ma-charts' ? '#ede9fe' : 'transparent',
                    fontWeight: currentView === 'ma-charts' ? '600' : '400',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (currentView !== 'ma-charts') {
                      e.currentTarget.style.background = '#f8fafc';
                      e.currentTarget.style.color = '#667eea';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentView !== 'ma-charts') {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.color = '#475569';
                    }
                  }}
                >
                  {currentView === 'ma-charts' && 'âœ“ '}Charts
                </div>
              </div>
              )}
            </div>
            )}

            {/* Digital Presence Analysis  Section */}
            {((currentUser?.role === 'user' && (currentUser?.userType === 'assessment' || currentUser?.userType === 'company')) || currentUser?.role === 'consultant') && (
            <div style={{ marginBottom: '1px' }}>
              <h3 
                onClick={() => {
                  // Navigate to https://www.digi-presence.com
                  window.open('https://www.digi-presence.com', '_blank');
                }}
                style={{ 
                  fontSize: '14px', 
                  fontWeight: '700', 
                  color: '#1e293b',
                  textTransform: 'uppercase', 
                  letterSpacing: '0.5px',
                  padding: '4px 24px',
                  marginBottom: '1px',
                  cursor: 'pointer',
                  transition: 'color 0.2s',
                  borderLeft: '4px solid #f59e0b'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.color = '#667eea';
                  e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                }}
                onMouseLeave={(e) => e.currentTarget.style.color = '#1e293b'}
              >
                Digital Presence Analysis 
              </h3>
            </div>
            )}

            {/* Custom Print Section - For Consultants and Company Users only */}
            {(currentUser?.role === 'consultant' || (currentUser?.role === 'user' && currentUser?.userType === 'company')) && (
              <div style={{ marginBottom: '1px' }}>
                <h3 
                  onClick={() => setCurrentView('custom-print')}
                  style={{ 
                    fontSize: '14px', 
                    fontWeight: '700', 
                    color: currentView === 'custom-print' ? '#667eea' : '#1e293b',
                    textTransform: 'uppercase', 
                    letterSpacing: '0.5px',
                    padding: '8px 24px',
                    marginBottom: '8px',
                    cursor: 'pointer',
                    transition: 'color 0.2s',
                    borderLeft: currentView === 'custom-print' ? '4px solid #667eea' : '4px solid transparent'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.color = '#667eea';
                    e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                  }}
                  onMouseLeave={(e) => e.currentTarget.style.color = currentView === 'custom-print' ? '#667eea' : '#1e293b'}
                >
                  Custom Print
                </h3>
              </div>
            )}

            {/* Consultant Dashboard Section */}
            {currentUser?.role === 'consultant' && (
              <div style={{ marginBottom: '12px' }}>
                <h3 
                  onClick={() => currentUser.role === 'consultant' ? setCurrentView('consultant-dashboard') : setCurrentView('admin')}
                  style={{ 
                    fontSize: '14px', 
                    fontWeight: '700', 
                    color: (currentView === 'admin' || currentView === 'consultant-dashboard') ? '#667eea' : '#1e293b',
                    textTransform: 'uppercase', 
                    letterSpacing: '0.5px',
                    padding: '8px 24px',
                    marginBottom: '8px',
                    cursor: 'pointer',
                    transition: 'color 0.2s',
                    borderLeft: (currentView === 'admin' || currentView === 'consultant-dashboard') ? '4px solid #667eea' : '4px solid transparent'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.color = '#667eea';
                    e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                  }}
                  onMouseLeave={(e) => e.currentTarget.style.color = (currentView === 'admin' || currentView === 'consultant-dashboard') ? '#667eea' : '#1e293b'}
                >
                  {(() => {
                    if (currentUser.consultantType === 'business') {
                      return 'Business Dashboard';
                    }
                    // For company users, show their consultant's company name
                    if (currentUser.role === 'user' && currentUser.userType === 'company' && currentUser.consultantId) {
                      const consultant = consultants.find(c => c.id === currentUser.consultantId);
                      if (consultant && consultant.companyName) {
                        return `Advisor: ${consultant.companyName}`;
                      }
                      return 'Dashboard';
                    }
                    // For consultants, show company name or default
                    return currentUser.consultantCompanyName ? `${currentUser.consultantCompanyName} Dashboard` : 'Consultant Dashboard';
                  })()}
                </h3>
                
                {/* Selected Company Name Display for Business Users */}
                {currentUser.consultantType === 'business' && selectedCompanyId && Array.isArray(companies) && companies.find(c => c.id === selectedCompanyId) && (
                  <div style={{ 
                    paddingLeft: '28px', 
                    marginBottom: '12px',
                    paddingBottom: '12px',
                    borderBottom: '2px solid #e2e8f0'
                  }}>
                    <div 
                      onClick={() => {
                        setCurrentView('admin');
                        setAdminDashboardTab('company-management');
                      }}
                      style={{ 
                        fontSize: '16px', 
                        fontWeight: '600', 
                        color: '#667eea',
                        padding: '8px 12px',
                        background: '#f0f9ff',
                        borderRadius: '8px',
                        border: '2px solid #bfdbfe',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = '#e0f2fe';
                        e.currentTarget.style.border = '2px solid #7dd3fc';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = '#f0f9ff';
                        e.currentTarget.style.border = '2px solid #bfdbfe';
                      }}
                    >
                      {Array.isArray(companies) && companies.find(c => c.id === selectedCompanyId)?.name}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Getting Started & Legal Links Section */}
            <div style={{ marginTop: 'auto', paddingTop: '24px', borderTop: '1px solid #e2e8f0' }}>
              <a
                href="/getting-started"
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                â„¹ï¸ Getting Started
              </a>
              <a
                href="/privacy-policy"
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                ðŸ›¡ï¸ Privacy Policy
              </a>
              <a
                href="/license-agreement"
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                ðŸ“„ License Agreement
              </a>
            </div>

            {/* Contact Support Section */}
            <div style={{ paddingTop: '12px' }}>
              <a
                href="mailto:steve@stevebuck.us"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                ðŸ’¬ Contact Support
              </a>
            </div>
          </nav>
        </aside>
        )}

        {/* Assessment User Sidebar - Only Management Assessment */}
        {currentUser?.userType === 'assessment' && (
        <aside style={{ 
          width: '280px', 
          background: 'white', 
          borderRight: '2px solid #e2e8f0', 
          padding: '24px 0',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <div style={{ padding: '0 24px', marginBottom: '12px' }}>
            <h2 style={{ fontSize: '16px', fontWeight: '700', color: '#1e293b', marginBottom: '8px' }}>Navigation</h2>
            <p style={{ fontSize: '12px', color: '#64748b' }}>Management Assessment</p>
          </div>
          
          <nav style={{ flex: 1, display: 'flex', flexDirection: 'column', paddingTop: '24px' }}>
            {/* Management Assessment Section */}
            <div style={{ marginBottom: '1px' }}>
              <h3 
                onClick={() => setIsManagementAssessmentExpanded(!isManagementAssessmentExpanded)}
                style={{ 
                  fontSize: '14px', 
                  fontWeight: '700', 
                  color: '#1e293b',
                  textTransform: 'uppercase', 
                  letterSpacing: '0.5px',
                  padding: '4px 24px',
                  marginBottom: '1px',
                  cursor: 'pointer',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  transition: 'color 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.color = '#667eea';
                  e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                }}
                onMouseLeave={(e) => e.currentTarget.style.color = '#1e293b'}
              >
                <span>Management Assessment</span>
                <span style={{ fontSize: '12px', color: '#667eea' }}>{isManagementAssessmentExpanded ? '-' : '+'}</span>
              </h3>
              {isManagementAssessmentExpanded && (
                <div style={{ paddingLeft: '28px' }}>
                  <div
                    onClick={() => handleViewChange('ma-welcome')}
                    style={{
                      fontSize: '14px',
                      color: currentView === 'ma-welcome' ? '#667eea' : '#475569',
                      padding: '8px 12px',
                      cursor: 'pointer',
                      borderRadius: '6px',
                      marginBottom: '4px',
                      background: currentView === 'ma-welcome' ? '#ede9fe' : 'transparent',
                      fontWeight: currentView === 'ma-welcome' ? '600' : '400',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      if (currentView !== 'ma-welcome') {
                        e.currentTarget.style.background = '#f8fafc';
                        e.currentTarget.style.color = '#667eea';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (currentView !== 'ma-welcome') {
                        e.currentTarget.style.background = 'transparent';
                        e.currentTarget.style.color = '#475569';
                      }
                    }}
                  >
                    Welcome
                  </div>
                  <div
                    onClick={() => handleViewChange('ma-questionnaire')}
                    style={{
                      fontSize: '14px',
                      color: currentView === 'ma-questionnaire' ? '#667eea' : '#475569',
                      padding: '8px 12px',
                      cursor: 'pointer',
                      borderRadius: '6px',
                      marginBottom: '4px',
                      background: currentView === 'ma-questionnaire' ? '#ede9fe' : 'transparent',
                      fontWeight: currentView === 'ma-questionnaire' ? '600' : '400',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      if (currentView !== 'ma-questionnaire') {
                        e.currentTarget.style.background = '#f8fafc';
                        e.currentTarget.style.color = '#667eea';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (currentView !== 'ma-questionnaire') {
                        e.currentTarget.style.background = 'transparent';
                        e.currentTarget.style.color = '#475569';
                      }
                    }}
                  >
                    Questionnaire
                  </div>
                  <div
                    onClick={() => handleViewChange('ma-your-results')}
                    style={{
                      fontSize: '14px',
                      color: currentView === 'ma-your-results' ? '#667eea' : '#475569',
                      padding: '8px 12px',
                      cursor: 'pointer',
                      borderRadius: '6px',
                      marginBottom: '4px',
                      background: currentView === 'ma-your-results' ? '#ede9fe' : 'transparent',
                      fontWeight: currentView === 'ma-your-results' ? '600' : '400',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      if (currentView !== 'ma-your-results') {
                        e.currentTarget.style.background = '#f8fafc';
                        e.currentTarget.style.color = '#667eea';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (currentView !== 'ma-your-results') {
                        e.currentTarget.style.background = 'transparent';
                        e.currentTarget.style.color = '#475569';
                      }
                    }}
                  >
                    Results
                  </div>
                </div>
              )}
            </div>

            {/* Digital Presence Analysis  Section */}
            <div style={{ marginBottom: '1px' }}>
              <h3 
                onClick={() => {
                  // Navigate to https://www.digi-presence.com
                  window.open('https://www.digi-presence.com', '_blank');
                }}
                style={{ 
                  fontSize: '14px', 
                  fontWeight: '700', 
                  color: '#1e293b',
                  textTransform: 'uppercase', 
                  letterSpacing: '0.5px',
                  padding: '4px 24px',
                  marginBottom: '1px',
                  cursor: 'pointer',
                  transition: 'color 0.2s',
                  borderLeft: '4px solid #f59e0b'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.color = '#667eea';
                  e.currentTarget.title = 'Opens Digital Presence Analysis in new tab';
                }}
                onMouseLeave={(e) => e.currentTarget.style.color = '#1e293b'}
              >
                Digital Presence Analysis 
              </h3>
            </div>

            {/* Getting Started & Legal Links Section */}
            <div style={{ marginTop: 'auto', paddingTop: '24px', borderTop: '1px solid #e2e8f0' }}>
              <a
                href="/getting-started"
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                â„¹ï¸ Getting Started
              </a>
              <a
                href="/privacy-policy"
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                ðŸ›¡ï¸ Privacy Policy
              </a>
              <a
                href="/license-agreement"
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                ðŸ“„ License Agreement
              </a>
            </div>

            {/* Contact Support Section */}
            <div style={{ paddingTop: '12px' }}>
              <a
                href="mailto:steve@stevebuck.us"
                style={{
                  display: 'block',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: '#667eea',
                  textDecoration: 'none',
                  padding: '12px 24px',
                  transition: 'all 0.2s',
                  borderRadius: '6px',
                  margin: '0 12px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#ede9fe';
                  e.currentTarget.style.color = '#4338ca';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#667eea';
                }}
              >
                ðŸ’¬ Contact Support
              </a>
            </div>
          </nav>
        </aside>
        )}

        {/* Main Content Area */}
        <main style={{ flex: 1, overflowY: 'auto', overflowX: 'hidden', paddingTop: '8px' }}>
          {/* Restrict access for assessment users - only show Management Assessment views */}
          {(!(currentUser?.userType === 'assessment') || currentView === 'ma-questionnaire' || currentView === 'ma-your-results' || currentView === 'ma-scores-summary' || currentView === 'ma-charts' || currentView === 'ma-scoring-guide') && (
          <>
          {/* Site Administration */}
          {currentView === 'siteadmin' && currentUser?.role === 'siteadmin' && (
            <SiteAdminDashboard
              siteAdminTab={siteAdminTab}
              setSiteAdminTab={setSiteAdminTab}
              consultants={consultants}
              companies={companies}
              siteAdmins={siteAdmins}
              isLoading={isLoading}
              expandedBusinessIds={expandedBusinessIds}
              setExpandedBusinessIds={setExpandedBusinessIds}
              editingPricing={editingPricing}
              setEditingPricing={setEditingPricing}
              defaultBusinessMonthlyPrice={defaultBusinessMonthlyPrice}
              setDefaultBusinessMonthlyPrice={setDefaultBusinessMonthlyPrice}
              defaultBusinessQuarterlyPrice={defaultBusinessQuarterlyPrice}
              setDefaultBusinessQuarterlyPrice={setDefaultBusinessQuarterlyPrice}
              defaultBusinessAnnualPrice={defaultBusinessAnnualPrice}
              setDefaultBusinessAnnualPrice={setDefaultBusinessAnnualPrice}
              defaultConsultantMonthlyPrice={defaultConsultantMonthlyPrice}
              setDefaultConsultantMonthlyPrice={setDefaultConsultantMonthlyPrice}
              defaultConsultantQuarterlyPrice={defaultConsultantQuarterlyPrice}
              setDefaultConsultantQuarterlyPrice={setDefaultConsultantQuarterlyPrice}
              defaultConsultantAnnualPrice={defaultConsultantAnnualPrice}
              setDefaultConsultantAnnualPrice={setDefaultConsultantAnnualPrice}
              affiliates={affiliates}
              setAffiliates={setAffiliates}
              showAddAffiliateForm={showAddAffiliateForm}
              setShowAddAffiliateForm={setShowAddAffiliateForm}
              editingAffiliate={editingAffiliate}
              setEditingAffiliate={setEditingAffiliate}
              expandedAffiliateId={expandedAffiliateId}
              setExpandedAffiliateId={setExpandedAffiliateId}
              newAffiliateCode={newAffiliateCode}
              setNewAffiliateCode={setNewAffiliateCode}
              editingAffiliateCode={editingAffiliateCode}
              setEditingAffiliateCode={setEditingAffiliateCode}
              editingConsultantInfo={editingConsultantInfo}
              setEditingConsultantInfo={setEditingConsultantInfo}
              users={users}
              getCompanyUsers={getCompanyUsers}
              selectedConsultantId={selectedConsultantId}
              setSelectedConsultantId={setSelectedConsultantId}
              expandedCompanyIds={expandedCompanyIds}
              setExpandedCompanyIds={setExpandedCompanyIds}
              showAddConsultantForm={showAddConsultantForm}
              setShowAddConsultantForm={setShowAddConsultantForm}
              newConsultantType={newConsultantType}
              setNewConsultantType={setNewConsultantType}
              newConsultantFullName={newConsultantFullName}
              setNewConsultantFullName={setNewConsultantFullName}
              newConsultantEmail={newConsultantEmail}
              setNewConsultantEmail={setNewConsultantEmail}
              newConsultantPhone={newConsultantPhone}
              setNewConsultantPhone={setNewConsultantPhone}
              newConsultantPassword={newConsultantPassword}
              setNewConsultantPassword={setNewConsultantPassword}
              newConsultantAddress={newConsultantAddress}
              setNewConsultantAddress={setNewConsultantAddress}
              newConsultantCompanyName={newConsultantCompanyName}
              setNewConsultantCompanyName={setNewConsultantCompanyName}
              newConsultantCompanyAddress1={newConsultantCompanyAddress1}
              setNewConsultantCompanyAddress1={setNewConsultantCompanyAddress1}
              newConsultantCompanyAddress2={newConsultantCompanyAddress2}
              setNewConsultantCompanyAddress2={setNewConsultantCompanyAddress2}
              newConsultantCompanyCity={newConsultantCompanyCity}
              setNewConsultantCompanyCity={setNewConsultantCompanyCity}
              newConsultantCompanyState={newConsultantCompanyState}
              setNewConsultantCompanyState={setNewConsultantCompanyState}
              newConsultantCompanyZip={newConsultantCompanyZip}
              setNewConsultantCompanyZip={setNewConsultantCompanyZip}
              newConsultantCompanyWebsite={newConsultantCompanyWebsite}
              setNewConsultantCompanyWebsite={setNewConsultantCompanyWebsite}
              addConsultant={addConsultant}
              deleteConsultant={deleteConsultant}
              updateConsultantInfo={updateConsultantInfo}
              getConsultantCompanies={getConsultantCompanies}
              setCurrentUser={setCurrentUser}
              setSiteAdminViewingAs={setSiteAdminViewingAs}
              setCurrentView={setCurrentView}
              setLoadedConsultantId={setLoadedConsultantId}
              setCompanies={setCompanies}
              currentUser={currentUser}
              newSiteAdminFirstName={newSiteAdminFirstName}
              setNewSiteAdminFirstName={setNewSiteAdminFirstName}
              newSiteAdminLastName={newSiteAdminLastName}
              setNewSiteAdminLastName={setNewSiteAdminLastName}
              newSiteAdminEmail={newSiteAdminEmail}
              setNewSiteAdminEmail={setNewSiteAdminEmail}
              newSiteAdminPassword={newSiteAdminPassword}
              setNewSiteAdminPassword={setNewSiteAdminPassword}
              showAddSiteAdminForm={showAddSiteAdminForm}
              setShowAddSiteAdminForm={setShowAddSiteAdminForm}
            />
          )}

          {/* Consultant Dashboard */}
          {currentView === 'consultant-dashboard' && currentUser?.role === 'consultant' && (
            <div>
              {/* Exit Preview Mode button (only when site admin is previewing) */}
              {siteAdminViewingAs && (
                <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px 32px 0 32px' }}>
                  <div style={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'center', marginBottom: '0' }}>
                    <button
                      onClick={() => {
                        setCurrentUser(siteAdminViewingAs);
                        setSiteAdminViewingAs(null);
                        setCurrentView('siteadmin');
                        setLoadedConsultantId(null);
                        safeSetCompanies([]); // Clear companies to prevent data leakage
                      }}
                      style={{ 
                        padding: '10px 20px', 
                        background: '#f59e0b', 
                        color: 'white', 
                        border: 'none', 
                        borderRadius: '8px', 
                        fontSize: '14px', 
                        fontWeight: '600', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}
                    >
                      ? Return to Site Admin
                    </button>
                  </div>
                </div>
              )}
              <ConsultantDashboard
                currentUser={currentUser}
                consultantDashboardTab={consultantDashboardTab}
                setConsultantDashboardTab={setConsultantDashboardTab}
                consultantTeamMembers={consultantTeamMembers}
                showAddTeamMemberForm={showAddTeamMemberForm}
                setShowAddTeamMemberForm={setShowAddTeamMemberForm}
                newTeamMember={newTeamMember}
                setNewTeamMember={setNewTeamMember}
                addTeamMember={addTeamMember}
                removeTeamMember={removeTeamMember}
                companies={companies}
                setCurrentView={setCurrentView}
                setSelectedCompanyId={setSelectedCompanyId}
                setAdminDashboardTab={setAdminDashboardTab}
                setCompanyManagementSubTab={setCompanyManagementSubTab}
                setCompanyToDelete={setCompanyToDelete}
                setShowDeleteConfirmation={setShowDeleteConfirmation}
                isLoading={isLoading}
                selectedCompanyId={selectedCompanyId}
                monthly={monthly}
                companyName={companyName}
              />
            </div>
          )}

          {/* Admin Dashboard */}
          {currentView === 'admin' && (currentUser?.role === 'consultant' || (currentUser?.role === 'user' && currentUser?.userType === 'company')) && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          {/* Exit Preview Mode button (only when site admin is previewing) */}
          {siteAdminViewingAs && (
            <div className="dashboard-header-print-hide" style={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'center', marginBottom: '20px' }}>
              <button
                onClick={() => {
                  // Restore admin user
                  setCurrentUser(siteAdminViewingAs);
                  setSiteAdminViewingAs(null);
                  setCurrentView('siteadmin');
                  setLoadedConsultantId(null); // Reset so companies reload for next consultant view
                  safeSetCompanies([]); // Clear companies to prevent data leakage
                }}
                style={{ 
                  padding: '10px 20px', 
                  background: '#f59e0b', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '8px', 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                ? Back to Site Admin
              </button>
            </div>
          )}
          
          {/* Tab Navigation */}
          <div className="dashboard-tabs-print-hide" style={{ display: 'flex', gap: '8px', marginBottom: '12px', borderBottom: '2px solid #e2e8f0' }}>
            <button
              onClick={() => handleAdminTabNavigation('company-management')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'company-management' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'company-management' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'company-management' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Company Management
            </button>
            <button
              onClick={() => handleAdminTabNavigation('payments')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'payments' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'payments' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'payments' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Payments
            </button>
            <button
              onClick={() => handleAdminTabNavigation('api-connections')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'api-connections' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'api-connections' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'api-connections' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Accounting API Connections
            </button>
            <button
              onClick={() => handleAdminTabNavigation('company-settings')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'company-settings' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'company-settings' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'company-settings' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              LOB Settings
            </button>
            <button
              onClick={() => handleAdminTabNavigation('data-mapping')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'data-mapping' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'data-mapping' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'data-mapping' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Data Mapping
            </button>
            <button
              onClick={() => handleAdminTabNavigation('data-review')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'data-review' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'data-review' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'data-review' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Data Review
            </button>
            <button
              onClick={() => handleAdminTabNavigation('covenants')}
              style={{
                padding: '12px 24px',
                background: adminDashboardTab === 'covenants' ? '#667eea' : 'transparent',
                color: adminDashboardTab === 'covenants' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: adminDashboardTab === 'covenants' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Covenants
            </button>
          </div>
          
          {/* Company Management Tab */}
          {adminDashboardTab === 'company-management' && (
            <CompanyManagementTab
              companyManagementSubTab={companyManagementSubTab}
              setCompanyManagementSubTab={setCompanyManagementSubTab}
              currentUser={currentUser}
              selectedCompanyId={selectedCompanyId}
              companies={companies}
              users={users}
              assessmentRecords={assessmentRecords}
              isLoading={isLoading}
              newCompanyName={newCompanyName}
              setNewCompanyName={setNewCompanyName}
              addCompany={addCompany}
              setEditingCompanyId={setEditingCompanyId}
              setCompanyAddressStreet={setCompanyAddressStreet}
              setCompanyAddressCity={setCompanyAddressCity}
              setCompanyAddressState={setCompanyAddressState}
              setCompanyAddressZip={setCompanyAddressZip}
              selectedAffiliateCodeForNewCompany={selectedAffiliateCodeForNewCompany}
              setSelectedAffiliateCodeForNewCompany={setSelectedAffiliateCodeForNewCompany}
              setCompanyAddressCountry={setCompanyAddressCountry}
              setCompanyIndustrySector={setCompanyIndustrySector}
              setShowCompanyDetailsModal={setShowCompanyDetailsModal}
              deleteUser={deleteUser}
              newCompanyUserName={newCompanyUserName}
              setNewCompanyUserName={setNewCompanyUserName}
              newCompanyUserTitle={newCompanyUserTitle}
              setNewCompanyUserTitle={setNewCompanyUserTitle}
              newCompanyUserEmail={newCompanyUserEmail}
              setNewCompanyUserEmail={setNewCompanyUserEmail}
              newCompanyUserPhone={newCompanyUserPhone}
              setNewCompanyUserPhone={setNewCompanyUserPhone}
              newCompanyUserPassword={newCompanyUserPassword}
              setNewCompanyUserPassword={setNewCompanyUserPassword}
              addUser={addUser}
              newAssessmentUserName={newAssessmentUserName}
              setNewAssessmentUserName={setNewAssessmentUserName}
              newAssessmentUserTitle={newAssessmentUserTitle}
              setNewAssessmentUserTitle={setNewAssessmentUserTitle}
              newAssessmentUserEmail={newAssessmentUserEmail}
              setNewAssessmentUserEmail={setNewAssessmentUserEmail}
              newAssessmentUserPassword={newAssessmentUserPassword}
              setNewAssessmentUserPassword={setNewAssessmentUserPassword}
              setSelectedCompanyId={setSelectedCompanyId}
              company={company}
              companyProfiles={companyProfiles}
              setCompanyProfiles={setCompanyProfiles}
              monthly={monthly}
              trendData={trendData}
              setIsLoading={setIsLoading}
            />
          )}

          {/* LOB Settings Tab */}
          {adminDashboardTab === 'company-settings' && selectedCompanyId && (
            <CompanySettingsTab
              selectedCompanyId={selectedCompanyId}
              companies={companies}
              onLOBChange={(lobData: LOBData[]) => {
                setLinesOfBusiness(lobData);
              }}
              initialLOBs={linesOfBusiness}
            />
          )}

          {/* Import Financials Tab */}
          {adminDashboardTab === 'import-financials' && selectedCompanyId && (
            <>
              {/* QuickBooks Data Verification Section */}
              {loadedMonthlyData && loadedMonthlyData.length > 0 && qbRawData && (
                <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #10b981' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>? QuickBooks Data Verification</h2>
                  <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '12px' }}>
                    âœ… Imported from QuickBooks - {loadedMonthlyData.length} months of data verified
                  </p>

                  {/* Summary Stats */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '12px' }}>
                    <div style={{ background: '#f0fdf4', borderRadius: '8px', padding: '16px', border: '1px solid #86efac' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#065f46', marginBottom: '4px' }}>MONTHS IMPORTED</div>
                      <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>{loadedMonthlyData.length}</div>
                    </div>
                    <div style={{ background: '#ede9fe', borderRadius: '8px', padding: '16px', border: '1px solid #c4b5fd' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#5b21b6', marginBottom: '4px' }}>DATE RANGE</div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#7c3aed' }}>
                        {new Date(loadedMonthlyData[0].date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - {new Date(loadedMonthlyData[loadedMonthlyData.length - 1].date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                      </div>
                    </div>
                    <div style={{ background: '#dbeafe', borderRadius: '8px', padding: '16px', border: '1px solid #93c5fd' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#1e40af', marginBottom: '4px' }}>TOTAL REVENUE</div>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#2563eb' }}>
                        ${(loadedMonthlyData.reduce((sum, m) => sum + (m.revenue || 0), 0) / 1000).toFixed(0)}K
                      </div>
                    </div>
                    <div style={{ background: '#fef3c7', borderRadius: '8px', padding: '16px', border: '1px solid #fcd34d' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#92400e', marginBottom: '4px' }}>TOTAL ASSETS</div>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#d97706' }}>
                        ${(loadedMonthlyData[loadedMonthlyData.length - 1].totalAssets / 1000).toFixed(0)}K
                      </div>
                    </div>
                  </div>

                  {/* Sample Data Tables */}
                  <div style={{ marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Sample Income Statement Data (Last 6 Months)</h3>
                    <div style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', fontSize: '13px', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: '#f8fafc', borderBottom: '2px solid #e2e8f0' }}>
                            <th style={{ padding: '8px', textAlign: 'left', fontWeight: '600', color: '#475569' }}>Month</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Revenue</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Expense</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>COGS Total</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Net Income</th>
                          </tr>
                        </thead>
                        <tbody>
                          {loadedMonthlyData.slice(-6).map((m, idx) => (
                            <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                              <td style={{ padding: '8px', color: '#1e293b' }}>{new Date(m.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#10b981', fontWeight: '600' }}>${m.revenue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#ef4444', fontWeight: '600' }}>${m.expense.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#f59e0b' }}>${m.cogsTotal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: (m.revenue - m.expense - m.cogsTotal) >= 0 ? '#10b981' : '#ef4444', fontWeight: '600' }}>
                                ${(m.revenue - m.expense - m.cogsTotal).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div style={{ marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Sample Balance Sheet Data (Last 6 Months)</h3>
                    <div style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', fontSize: '13px', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: '#f8fafc', borderBottom: '2px solid #e2e8f0' }}>
                            <th style={{ padding: '8px', textAlign: 'left', fontWeight: '600', color: '#475569' }}>Month</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Cash</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>A/R</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>A/P</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Total Assets</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Total Equity</th>
                          </tr>
                        </thead>
                        <tbody>
                          {loadedMonthlyData.slice(-6).map((m, idx) => (
                            <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                              <td style={{ padding: '8px', color: '#1e293b' }}>{new Date(m.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#10b981', fontWeight: '600' }}>${m.cash.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#3b82f6' }}>${m.ar.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#f59e0b' }}>${m.ap.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#8b5cf6', fontWeight: '600' }}>${m.totalAssets.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#ec4899', fontWeight: '600' }}>${m.totalEquity.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div style={{ background: '#f0fdf4', borderRadius: '8px', padding: '16px', border: '1px solid #86efac' }}>
                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '8px' }}>? Data Quality Check</div>
                    <div style={{ fontSize: '13px', color: '#059669' }}>
                      â€¢ All {loadedMonthlyData.length} months have complete data<br/>
                      â€¢ Income Statement fields populated: Revenue, Expenses, COGS<br/>
                      â€¢ Balance Sheet fields populated: Assets, Liabilities, Equity<br/>
                      â€¢ Ready for AI-assisted mapping
                    </div>
                  </div>
                </div>
              )}

              <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Excel Import</h2>
                
                <div style={{ background: '#f0f9ff', border: '1px solid #bae6fd', borderRadius: '8px', padding: '16px', marginBottom: '20px' }}>
                  <p style={{ fontSize: '14px', color: '#0c4a6e', lineHeight: '1.6', margin: 0 }}>
                    To use spreadsheet uploads <a href="mailto:steve@stevebuck.us" style={{ color: '#0284c7', fontWeight: '600', textDecoration: 'none' }}>Email Us</a> for a spreadsheet format. For best results include 36 months of historical data.
                  </p>
                </div>

                <div style={{ marginBottom: '20px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px' }}>Upload Financial Data</h3>
                  <input type="file" accept=".xlsx,.xls,.csv" onChange={handleFile} style={{ marginBottom: '16px', padding: '12px', border: '2px dashed #cbd5e1', borderRadius: '8px', width: '100%', cursor: 'pointer' }} />
                  {error && <div style={{ padding: '12px', background: '#fee2e2', color: '#991b1b', borderRadius: '8px', marginBottom: '16px' }}>{error}</div>}
                  {file && <div style={{ fontSize: '14px', color: '#10b981', fontWeight: '600' }}>? Loaded: {file.name}</div>}
                </div>

              {file && columns.length > 0 && (
                <div>
                  <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px' }}>Column Mapping</h3>
                  <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '20px' }}>Verify or adjust the column mappings below. Columns have been auto-detected.</p>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px' }}>
                    <div>
                      <h4 style={{ fontSize: '15px', fontWeight: '600', color: '#475569', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '8px' }}>Required Fields</h4>
                      {renderColumnSelector('Date/Period', 'date')}
                      {renderColumnSelector('Total Revenue', 'revenue')}
                      {renderColumnSelector('Total Expenses', 'expense')}
                      {renderColumnSelector('Total Assets', 'totalAssets')}
                      {renderColumnSelector('Total Liabilities', 'totalLiab')}
                      {renderColumnSelector('Total Equity', 'totalEquity')}
                    </div>
                    
                    <div>
                      <h4 style={{ fontSize: '15px', fontWeight: '600', color: '#475569', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '8px' }}>Cost of Goods Sold</h4>
                      {renderColumnSelector('COGS Payroll', 'cogsPayroll')}
                      {renderColumnSelector('COGS Owner Pay', 'cogsOwnerPay')}
                      {renderColumnSelector('COGS Contractors', 'cogsContractors')}
                      {renderColumnSelector('COGS Materials', 'cogsMaterials')}
                      {renderColumnSelector('COGS Commissions', 'cogsCommissions')}
                      {renderColumnSelector('COGS Other', 'cogsOther')}
                      {renderColumnSelector('COGS Total', 'cogsTotal')}
                    </div>
                    
                    <div>
                      <h4 style={{ fontSize: '15px', fontWeight: '600', color: '#475569', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '8px' }}>Operating Expenses</h4>
                      {renderColumnSelector('Sales & Marketing', 'salesExpense')}
                      {renderColumnSelector('Rent/Lease', 'rent')}
                      {renderColumnSelector('Infrastructure/Utilities', 'infrastructure')}
                      {renderColumnSelector('Auto & Travel', 'autoTravel')}
                      {renderColumnSelector('Professional Services', 'professionalFees')}
                      {renderColumnSelector('Insurance', 'insurance')}
                      {renderColumnSelector('OPEX Other', 'marketing')}
                    </div>
                    
                    <div>
                      <h4 style={{ fontSize: '15px', fontWeight: '600', color: '#475569', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '8px' }}>Payroll & Owners</h4>
                      {renderColumnSelector('OPEX Payroll', 'payroll')}
                      {renderColumnSelector('Owners Base Pay', 'ownerBasePay')}
                      {renderColumnSelector('Owners Retirement', 'ownersRetirement')}
                      {renderColumnSelector('Contractors/Distribution', 'subcontractors')}
                      {renderColumnSelector('Interest Expense', 'interestExpense')}
                      {renderColumnSelector('Depreciation Expense', 'depreciationAmortization')}
                      {renderColumnSelector('Operating Expense Total', 'operatingExpenseTotal')}
                      {renderColumnSelector('Non-Operating Income', 'nonOperatingIncome')}
                      {renderColumnSelector('Extraordinary Items', 'extraordinaryItems')}
                      {renderColumnSelector('Net Profit', 'netProfit')}
                    </div>
                    
                    <div>
                      <h4 style={{ fontSize: '15px', fontWeight: '600', color: '#475569', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '8px' }}>Assets</h4>
                      {renderColumnSelector('Cash', 'cash')}
                      {renderColumnSelector('Accounts Receivable', 'ar')}
                      {renderColumnSelector('Inventory', 'inventory')}
                      {renderColumnSelector('Other Current Assets', 'otherCA')}
                      {renderColumnSelector('Total Current Assets', 'tca')}
                      {renderColumnSelector('Fixed Assets', 'fixedAssets')}
                      {renderColumnSelector('Other Assets', 'otherAssets')}
                    </div>
                    
                    <div>
                      <h4 style={{ fontSize: '15px', fontWeight: '600', color: '#475569', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '8px' }}>Liabilities & Other</h4>
                      {renderColumnSelector('Accounts Payable', 'ap')}
                      {renderColumnSelector('Other Current Liabilities', 'otherCL')}
                      {renderColumnSelector('Total Current Liabilities', 'tcl')}
                      {renderColumnSelector('Long Term Debt', 'ltd')}
                      {renderColumnSelector('Total Liabilities & Equity', 'totalLAndE')}
                    </div>
                  </div>
                  
                  <div style={{ marginTop: '20px', padding: '12px', background: '#f0f9ff', border: '1px solid #bae6fd', borderRadius: '8px' }}>
                    <p style={{ fontSize: '13px', color: '#0c4a6e', margin: 0 }}>
                      <strong>Tip:</strong> At minimum, map Date, Total Revenue, Total Expenses, Total Assets, and Total Liabilities for basic analysis. 
                      Map detailed P&L and balance sheet items for comprehensive analysis and reporting.
                    </p>
                  </div>
                </div>
              )}
            </div>

              {/* Trial Balance Import Section */}
              <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>ðŸ“Š Trial Balance Import</h2>
                
                <div style={{ background: '#f0fdf4', border: '1px solid #86efac', borderRadius: '8px', padding: '16px', marginBottom: '20px' }}>
                  <p style={{ fontSize: '14px', color: '#065f46', lineHeight: '1.6', margin: 0 }}>
                    <strong>Trial Balance Format:</strong> Upload a CSV with columns: Acct Type, Acct ID, Description, then date columns (e.g., 12/31/2022, 1/31/2023, ...).
                    This format supports QuickBooks-style account types and routes through Data Mapping for precise account classification.
                  </p>
                </div>

                <div style={{ marginBottom: '20px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px' }}>Upload Trial Balance CSV</h3>
                  <input 
                    type="file" 
                    accept=".csv" 
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      
                      try {
                        const text = await file.text();
                        const parsed = parseTrialBalanceCSV(text, selectedCompanyId);
                        const csvData = {
                          ...parsed,
                          _companyId: selectedCompanyId,
                          fileName: file.name,
                        };
                        setCsvTrialBalanceData(csvData);
                        // Save to localStorage for persistence across sessions
                        localStorage.setItem(`csvTrialBalance_${selectedCompanyId}`, JSON.stringify(csvData));
                        setError(null);
                        alert(`? Parsed ${parsed.accounts.length} accounts across ${parsed.dates.length} periods. Go to Data Mapping tab to map accounts.`);
                      } catch (err: any) {
                        setError(`Failed to parse Trial Balance CSV: ${err.message}`);
                        setCsvTrialBalanceData(null);
                      }
                    }} 
                    style={{ marginBottom: '16px', padding: '12px', border: '2px dashed #10b981', borderRadius: '8px', width: '100%', cursor: 'pointer', background: '#f0fdf4' }} 
                  />
                  {error && error.includes('Trial Balance') && (
                    <div style={{ padding: '12px', background: '#fee2e2', color: '#991b1b', borderRadius: '8px', marginBottom: '16px' }}>{error}</div>
                  )}
                </div>

                {csvTrialBalanceData && csvTrialBalanceData._companyId === selectedCompanyId && (
                  <div style={{ background: '#f0fdf4', border: '2px solid #10b981', borderRadius: '8px', padding: '16px' }}>
                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '12px' }}>
                      ? Trial Balance Loaded: {csvTrialBalanceData.fileName}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '12px', marginBottom: '16px' }}>
                      <div style={{ background: 'white', padding: '12px', borderRadius: '6px', textAlign: 'center' }}>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>{csvTrialBalanceData.accounts?.length || 0}</div>
                        <div style={{ fontSize: '12px', color: '#065f46' }}>Accounts</div>
                      </div>
                      <div style={{ background: 'white', padding: '12px', borderRadius: '6px', textAlign: 'center' }}>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#667eea' }}>{csvTrialBalanceData.dates?.length || 0}</div>
                        <div style={{ fontSize: '12px', color: '#3730a3' }}>Periods</div>
                      </div>
                      <div style={{ background: 'white', padding: '12px', borderRadius: '6px', textAlign: 'center' }}>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#f59e0b' }}>{Object.keys(csvTrialBalanceData.accountsByType || {}).length}</div>
                        <div style={{ fontSize: '12px', color: '#92400e' }}>Account Types</div>
                      </div>
                    </div>
                    
                    {/* Account Types Summary */}
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ fontSize: '13px', fontWeight: '600', color: '#065f46', marginBottom: '8px' }}>Account Types Found:</div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                        {Object.entries(csvTrialBalanceData.accountsByType || {}).map(([type, accounts]: [string, any]) => (
                          <span key={type} style={{ 
                            padding: '4px 10px', 
                            background: 'white', 
                            borderRadius: '12px', 
                            fontSize: '12px', 
                            color: '#065f46',
                            border: '1px solid #86efac'
                          }}>
                            {type}: {accounts.length}
                          </span>
                        ))}
                      </div>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '12px' }}>
                      <button
                        onClick={() => setAdminDashboardTab('data-mapping')}
                        style={{
                          padding: '12px 24px',
                          background: '#667eea',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          boxShadow: '0 2px 6px rgba(102, 126, 234, 0.3)'
                        }}
                      >
                        ? Go to Data Mapping
                      </button>
                      <button
                        onClick={() => {
                          setCsvTrialBalanceData(null);
                          localStorage.removeItem(`csvTrialBalance_${selectedCompanyId}`);
                        }}
                        style={{
                          padding: '12px 24px',
                          background: 'white',
                          color: '#64748b',
                          border: '1px solid #cbd5e1',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: 'pointer'
                        }}
                      >
                        Clear
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </>
          )}
          
          {!selectedCompanyId && adminDashboardTab === 'import-financials' && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '48px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center' }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>No Company Selected</div>
              <p style={{ fontSize: '14px', color: '#94a3b8' }}>Please select a company from the sidebar to import Excel files.</p>
            </div>
          )}

          {/* Accounting API Connections Tab */}
          {adminDashboardTab === 'api-connections' && selectedCompanyId && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Accounting API Connections</h2>
              <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '12px' }}>
                Connect to accounting platforms to automatically import financial data for {companyName || 'your company'}.
              </p>

              {/* QuickBooks Connection */}
              <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', marginBottom: '20px', border: '2px solid #e2e8f0' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                  <div style={{ width: '60px', height: '60px', background: 'white', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px solid #e2e8f0' }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#2ca01c' }}>QB</div>
                  </div>
                  <div>
                    <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>QuickBooks Online</h3>
                    <p style={{ fontSize: '13px', color: '#64748b', margin: 0 }}>Intuit QuickBooks Online</p>
                  </div>
                </div>
                
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                  <div style={{ 
                    flex: 1, 
                    padding: '12px', 
                    background: qbConnected && qbStatus === 'ACTIVE' ? '#d1fae5' : qbStatus === 'ERROR' ? '#fee2e2' : qbStatus === 'EXPIRED' ? '#fed7aa' : '#fef3c7', 
                    borderRadius: '8px', 
                    border: `1px solid ${qbConnected && qbStatus === 'ACTIVE' ? '#10b981' : qbStatus === 'ERROR' ? '#ef4444' : qbStatus === 'EXPIRED' ? '#f97316' : '#fbbf24'}` 
                  }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: qbConnected && qbStatus === 'ACTIVE' ? '#065f46' : qbStatus === 'ERROR' ? '#991b1b' : qbStatus === 'EXPIRED' ? '#9a3412' : '#92400e', marginBottom: '4px' }}>
                      {qbConnected && qbStatus === 'ACTIVE' ? 'âœ… Connected' : qbStatus === 'ERROR' ? 'âŒ Error' : qbStatus === 'EXPIRED' ? 'âš ï¸ Token Expired' : 'âš ï¸ Status: Not Connected'}
                    </div>
                    <div style={{ fontSize: '12px', color: qbConnected && qbStatus === 'ACTIVE' ? '#065f46' : qbStatus === 'ERROR' ? '#991b1b' : qbStatus === 'EXPIRED' ? '#9a3412' : '#92400e' }}>
                      {qbError || (qbConnected && qbStatus === 'ACTIVE' ? (qbLastSync ? `Last synced: ${qbLastSync.toLocaleString()}` : 'Ready to sync') : qbStatus === 'EXPIRED' ? 'Please reconnect' : 'Ready to connect')}
                    </div>
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  {!qbConnected || qbStatus === 'EXPIRED' || qbStatus === 'ERROR' ? (
                    <button
                      onClick={connectQuickBooks}
                      style={{
                        padding: '12px 24px',
                        background: '#2ca01c',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#239017'}
                      onMouseLeave={(e) => e.currentTarget.style.background = '#2ca01c'}
                    >
                      {qbConnected ? 'Reconnect' : 'Connect'} to QuickBooks
                    </button>
                  ) : (
                    <>
                      <button
                        onClick={syncQuickBooks}
                        disabled={qbSyncing}
                        style={{
                          padding: '12px 24px',
                          background: qbSyncing ? '#94a3b8' : '#667eea',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: qbSyncing ? 'not-allowed' : 'pointer',
                          transition: 'background 0.2s',
                          opacity: qbSyncing ? 0.7 : 1
                        }}
                        onMouseEnter={(e) => !qbSyncing && (e.currentTarget.style.background = '#5568d3')}
                        onMouseLeave={(e) => !qbSyncing && (e.currentTarget.style.background = '#667eea')}
                      >
                        {qbSyncing ? 'Syncing...' : 'Sync Data'}
                      </button>
                      <button
                        onClick={disconnectQuickBooks}
                        disabled={qbSyncing}
                        style={{
                          padding: '12px 24px',
                          background: 'white',
                          color: '#ef4444',
                          border: '2px solid #ef4444',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: qbSyncing ? 'not-allowed' : 'pointer',
                          transition: 'all 0.2s',
                          opacity: qbSyncing ? 0.7 : 1
                        }}
                        onMouseEnter={(e) => !qbSyncing && (e.currentTarget.style.background = '#fef2f2')}
                        onMouseLeave={(e) => !qbSyncing && (e.currentTarget.style.background = 'white')}
                      >
                        Disconnect
                      </button>
                    </>
                  )}
                </div>
              </div>

              {/* QuickBooks Data Verification */}
              {loadedMonthlyData && loadedMonthlyData.length > 0 && qbRawData && (
                <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #10b981' }}>
                  <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>? QuickBooks Data Verification</h3>
                  <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '12px' }}>
                    âœ… Synced successfully - {loadedMonthlyData.length} months of data imported
                  </p>

                  {/* Summary Stats */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '12px' }}>
                    <div style={{ background: '#f0fdf4', borderRadius: '8px', padding: '16px', border: '1px solid #86efac' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#065f46', marginBottom: '4px' }}>MONTHS IMPORTED</div>
                      <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>{loadedMonthlyData.length}</div>
                    </div>
                    <div style={{ background: '#ede9fe', borderRadius: '8px', padding: '16px', border: '1px solid #c4b5fd' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#5b21b6', marginBottom: '4px' }}>DATE RANGE</div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#7c3aed' }}>
                        {new Date(loadedMonthlyData[0].date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - {new Date(loadedMonthlyData[loadedMonthlyData.length - 1].date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                      </div>
                    </div>
                    <div style={{ background: '#dbeafe', borderRadius: '8px', padding: '16px', border: '1px solid #93c5fd' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#1e40af', marginBottom: '4px' }}>TOTAL REVENUE</div>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#2563eb' }}>
                        ${(loadedMonthlyData.reduce((sum, m) => sum + (m.revenue || 0), 0) / 1000).toFixed(0)}K
                      </div>
                    </div>
                    <div style={{ background: '#fef3c7', borderRadius: '8px', padding: '16px', border: '1px solid #fcd34d' }}>
                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#92400e', marginBottom: '4px' }}>TOTAL ASSETS</div>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#d97706' }}>
                        ${(loadedMonthlyData[loadedMonthlyData.length - 1].totalAssets / 1000).toFixed(0)}K
                      </div>
                    </div>
                  </div>

                  {/* Sample Data Tables - Show Individual Accounts */}
                  <div style={{ marginBottom: '20px' }}>
                    <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Sample Income & Expense Accounts (Last 3 Months)</h4>
                    <div style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: '#f8fafc', borderBottom: '2px solid #e2e8f0' }}>
                            <th style={{ padding: '8px', textAlign: 'left', fontWeight: '600', color: '#475569' }}>Account</th>
                            {loadedMonthlyData.slice(-3).map((m, idx) => (
                              <th key={idx} style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>
                                {new Date(m.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {(() => {
                            // Extract individual accounts from qbRawData
                            const extractRows = (data: any, type: 'data' | 'total' = 'data'): any[] => {
                              const result: any[] = [];
                              if (!data || !data.Rows || !data.Rows.Row) return result;
                              const rows = Array.isArray(data.Rows.Row) ? data.Rows.Row : [data.Rows.Row];
                              
                              const processRows = (rows: any[], parentSection: string = ''): void => {
                                for (const row of rows) {
                                  if (row.type === 'Section') {
                                    const sectionName = row.Header?.ColData?.[0]?.value || '';
                                    if (row.Rows && row.Rows.Row) {
                                      const nested = Array.isArray(row.Rows.Row) ? row.Rows.Row : [row.Rows.Row];
                                      processRows(nested, sectionName);
                                    }
                                    if (type === 'total' && row.Summary?.ColData) {
                                      const name = row.Summary.ColData[0]?.value || '';
                                      if (name) {
                                        result.push({ name, section: parentSection, colData: row.Summary.ColData });
                                      }
                                    }
                                  } else if (row.type === 'Data' && row.ColData && type === 'data') {
                                    const name = row.ColData[0]?.value || '';
                                    if (name && !name.toLowerCase().includes('total')) {
                                      result.push({ name, section: parentSection, colData: row.ColData });
                                    }
                                  }
                                }
                              };
                              
                              processRows(rows);
                              return result;
                            };

                            // Get income and expense accounts
                            const allAccounts = extractRows(qbRawData?.profitAndLoss);
                            const incomeAccounts = allAccounts.filter(a => 
                              (a.section || '').toLowerCase().includes('income') || 
                              (a.section || '').toLowerCase().includes('revenue') ||
                              (a.section || '').toLowerCase().includes('service')
                            ).slice(0, 5);
                            const expenseAccounts = allAccounts.filter(a => 
                              (a.section || '').toLowerCase().includes('expense') || 
                              (a.section || '').toLowerCase().includes('cost')
                            ).slice(0, 5);

                            const displayAccounts = [...incomeAccounts, ...expenseAccounts].slice(0, 10);
                            
                            return displayAccounts.map((account, idx) => {
                              // Get values for last 3 months
                              const columnCount = qbRawData.profitAndLoss?.Columns?.Column?.length || 0;
                              const lastThreeMonths = Array.from({length: 3}, (_, i) => {
                                const colIndex = columnCount - 4 - (2 - i); // Skip the "Total" column
                                const value = account.colData[colIndex]?.value;
                                return parseFloat(value || '0');
                              });

                              const isIncome = incomeAccounts.includes(account);
                              
                              return (
                                <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                  <td style={{ padding: '8px', color: '#1e293b' }}>
                                    <span style={{ fontSize: '10px', color: '#94a3b8', marginRight: '8px' }}>
                                      {isIncome ? 'ðŸ“ˆ' : 'ðŸ“‰'}
                                    </span>
                                    {account.name}
                                  </td>
                                  {lastThreeMonths.map((val, midx) => (
                                    <td key={midx} style={{ 
                                      padding: '8px', 
                                      textAlign: 'right', 
                                      color: isIncome ? '#10b981' : '#ef4444', 
                                      fontWeight: val !== 0 ? '600' : '400' 
                                    }}>
                                      ${val.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </td>
                                  ))}
                                </tr>
                              );
                            });
                          })()}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div style={{ marginBottom: '20px' }}>
                    <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Sample Balance Sheet Data (Last 6 Months)</h4>
                    <div style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', fontSize: '13px', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{ background: '#f8fafc', borderBottom: '2px solid #e2e8f0' }}>
                            <th style={{ padding: '8px', textAlign: 'left', fontWeight: '600', color: '#475569' }}>Month</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Cash</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>A/R</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>A/P</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Total Assets</th>
                            <th style={{ padding: '8px', textAlign: 'right', fontWeight: '600', color: '#475569' }}>Total Equity</th>
                          </tr>
                        </thead>
                        <tbody>
                          {loadedMonthlyData.slice(-6).map((m, idx) => (
                            <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                              <td style={{ padding: '8px', color: '#1e293b' }}>{new Date(m.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#10b981', fontWeight: '600' }}>${m.cash.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#3b82f6' }}>${m.ar.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#f59e0b' }}>${m.ap.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#8b5cf6', fontWeight: '600' }}>${m.totalAssets.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                              <td style={{ padding: '8px', textAlign: 'right', color: '#ec4899', fontWeight: '600' }}>${m.totalEquity.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div style={{ background: '#f0fdf4', borderRadius: '8px', padding: '16px', border: '1px solid #86efac', marginBottom: '16px' }}>
                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '8px' }}>? Data Quality Check</div>
                    <div style={{ fontSize: '13px', color: '#059669' }}>
                      â€¢ All {loadedMonthlyData.length} months have complete data<br/>
                      â€¢ Income Statement: Revenue, Expenses, COGS populated<br/>
                      â€¢ Balance Sheet: Assets, Liabilities, Equity populated<br/>
                      â€¢ Ready for AI-assisted account mapping
                    </div>
                  </div>

                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button
                      onClick={() => {
                        // Navigate to Data Mapping tab
                        setAdminDashboardTab('data-mapping');
                      }}
                      style={{
                        padding: '12px 24px',
                        background: '#667eea',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'background 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#5568d3'}
                      onMouseLeave={(e) => e.currentTarget.style.background = '#667eea'}
                    >
                      <span>ðŸ¤–</span>
                      <span>Proceed to AI Account Mapping ?</span>
                    </button>
                  </div>
                </div>
              )}


              {/* Sage Connection */}
              <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', marginBottom: '20px', border: '2px solid #e2e8f0', opacity: 0.6 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                  <div style={{ width: '60px', height: '60px', background: 'white', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px solid #e2e8f0' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#00a851' }}>S</div>
                  </div>
                  <div>
                    <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>Sage</h3>
                    <p style={{ fontSize: '13px', color: '#64748b', margin: 0 }}>Sage Business Cloud Accounting</p>
                  </div>
                </div>
                <div style={{ padding: '12px', background: '#e2e8f0', borderRadius: '8px', fontSize: '13px', color: '#64748b', fontWeight: '600' }}>
                  Coming Soon
                </div>
              </div>

              {/* NetSuite Connection */}
              <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', marginBottom: '20px', border: '2px solid #e2e8f0', opacity: 0.6 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                  <div style={{ width: '60px', height: '60px', background: 'white', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px solid #e2e8f0' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#E91C24' }}>NS</div>
                  </div>
                  <div>
                    <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>NetSuite</h3>
                    <p style={{ fontSize: '13px', color: '#64748b', margin: 0 }}>Oracle NetSuite ERP</p>
                  </div>
                </div>
                <div style={{ padding: '12px', background: '#e2e8f0', borderRadius: '8px', fontSize: '13px', color: '#64748b', fontWeight: '600' }}>
                  Coming Soon
                </div>
              </div>

              {/* Dynamics Connection */}
              <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', border: '2px solid #e2e8f0', opacity: 0.6 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                  <div style={{ width: '60px', height: '60px', background: 'white', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px solid #e2e8f0' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#0078D4' }}>D</div>
                  </div>
                  <div>
                    <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>Microsoft Dynamics 365</h3>
                    <p style={{ fontSize: '13px', color: '#64748b', margin: 0 }}>Microsoft Dynamics 365 Finance</p>
                  </div>
                </div>
                <div style={{ padding: '12px', background: '#e2e8f0', borderRadius: '8px', fontSize: '13px', color: '#64748b', fontWeight: '600' }}>
                  Coming Soon
                </div>
              </div>

              <div style={{ marginTop: '24px', padding: '16px', background: '#f0f9ff', border: '1px solid #bae6fd', borderRadius: '8px' }}>
                <p style={{ fontSize: '13px', color: '#0c4a6e', margin: 0, lineHeight: '1.6' }}>
                  <strong>Note:</strong> API connections allow automatic synchronization of financial data. Once connected, 
                  you can schedule automatic imports or manually trigger data pulls. All connections use OAuth 2.0 for 
                  secure authentication and are encrypted in transit and at rest.
                </p>
              </div>
            </div>
          )}

          {!selectedCompanyId && adminDashboardTab === 'api-connections' && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '48px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center' }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>No Company Selected</div>
              <p style={{ fontSize: '14px', color: '#94a3b8' }}>Please select a company from the sidebar to manage API connections.</p>
            </div>
          )}

          {!selectedCompanyId && adminDashboardTab === 'data-review' && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '48px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center' }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>No Company Selected</div>
              <p style={{ fontSize: '14px', color: '#94a3b8' }}>Please select a company from the sidebar to review financial data.</p>
            </div>
          )}

          {/* Payments Tab */}
          {adminDashboardTab === 'payments' && selectedCompanyId && (
            <PaymentsTab
              selectedCompany={Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined}
              selectedSubscriptionPlan={selectedSubscriptionPlan}
              setSelectedSubscriptionPlan={setSelectedSubscriptionPlan}
              activeSubscription={activeSubscription}
              setActiveSubscription={setActiveSubscription}
              loadingSubscription={loadingSubscription}
              setShowCheckoutModal={setShowCheckoutModal}
              setShowUpdatePaymentModal={setShowUpdatePaymentModal}
              selectedCompanyId={selectedCompanyId}
              subscriptionMonthlyPrice={subscriptionMonthlyPrice}
              subscriptionQuarterlyPrice={subscriptionQuarterlyPrice}
              subscriptionAnnualPrice={subscriptionAnnualPrice}
            />
          )}

          {!selectedCompanyId && adminDashboardTab === 'payments' && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '48px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center' }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>No Company Selected</div>
              <p style={{ fontSize: '14px', color: '#94a3b8' }}>Please select a company from the sidebar to manage subscription and payments.</p>
            </div>
          )}

          {/* Covenants Tab */}
          {(adminDashboardTab === 'covenants' && currentView === 'admin') &&
           selectedCompanyId && CovenantsTab && (
            <CovenantsTab
              selectedCompanyId={selectedCompanyId}
              currentUser={currentUser}
              monthly={monthly}
              companyName={companyName}
            />
          )}

          {!selectedCompanyId && (
            (adminDashboardTab === 'covenants' && currentView === 'admin') ||
            (consultantDashboardTab === 'covenants' && currentView === 'consultant-dashboard')
          ) && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '48px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center' }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>No Company Selected</div>
              <p style={{ fontSize: '14px', color: '#94a3b8' }}>Please select a company from the sidebar to manage covenants.</p>
            </div>
          )}

          {/* Checkout Modal */}
          {showCheckoutModal && selectedSubscriptionPlan && (() => {
            const planPrice = selectedSubscriptionPlan === 'monthly' ? (subscriptionMonthlyPrice ?? 0) :
                             selectedSubscriptionPlan === 'quarterly' ? (subscriptionQuarterlyPrice ?? 0) :
                             (subscriptionAnnualPrice ?? 0);
            const planPeriod = selectedSubscriptionPlan === 'monthly' ? '/month' :
                              selectedSubscriptionPlan === 'quarterly' ? '/quarter' : '/year';

            return (
              <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999 }}>
                <div style={{ background: 'white', borderRadius: '12px', padding: '32px', maxWidth: '600px', width: '90%', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Complete Your Purchase</h2>
                    <button
                      onClick={() => setShowCheckoutModal(false)}
                      style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#64748b', padding: '0', lineHeight: '1' }}
                    >
                      Ã—
                    </button>
                  </div>

                  {/* Selected Plan Summary */}
                  <div style={{ background: '#f0f9ff', border: '2px solid #667eea', borderRadius: '8px', padding: '16px', marginBottom: '24px' }}>
                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>Selected Plan</div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#1e293b', textTransform: 'capitalize' }}>{selectedSubscriptionPlan} Plan</div>
                        <div style={{ fontSize: '13px', color: '#64748b' }}>Billed {selectedSubscriptionPlan}</div>
                      </div>
                      <div style={{ fontSize: '28px', fontWeight: '700', color: '#667eea' }}>
                        ${planPrice.toFixed(2)}
                        <span style={{ fontSize: '14px', fontWeight: '500', color: '#64748b' }}>{planPeriod}</span>
                      </div>
                    </div>
                  </div>

                  {/* USAePay Payment Form */}
                  <div style={{ marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '16px' }}>ðŸ’³ Payment Information</h3>
                    
                    {/* Payment Form */}
                    <form onSubmit={async (e) => {
                      e.preventDefault();
                      const formData = new FormData(e.currentTarget);
                      
                      try {
                        const response = await fetch('/api/payments', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            amount: planPrice,
                            companyId: selectedCompanyId,
                            subscriptionPlan: `${selectedSubscriptionPlan} Plan`,
                            billingPeriod: selectedSubscriptionPlan || '',
                            cardNumber: formData.get('cardNumber'),
                            cardholderName: formData.get('cardholderName'),
                            expirationMonth: formData.get('expMonth'),
                            expirationYear: formData.get('expYear'),
                            cvv: formData.get('cvv'),
                            billingAddress: {
                              street: formData.get('street') as string,
                              city: formData.get('city') as string,
                              state: formData.get('state') as string,
                              zip: formData.get('zip') as string,
                            },
                          }),
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                          alert(`? Payment successful!\n\nTransaction ID: ${result.transactionId}\n\nThe subscription has been activated.`);
                          setShowCheckoutModal(false);
                          setSelectedSubscriptionPlan(null);
                          // Refresh companies to show updated subscription
                          loadAllCompanies();
                        } else {
                          alert(`? Payment failed\n\n${result.error || 'Please try again or contact support.'}`);
                        }
                      } catch (error) {
                        console.error('Payment error:', error);
                        alert('? An error occurred while processing your payment. Please try again.');
                      }
                    }}>
                      {/* Card Information Section */}
                      <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', marginBottom: '20px', border: '1px solid #e2e8f0' }}>
                        <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                          ðŸ’³ Card Details
                        </h4>
                        
                        <div style={{ marginBottom: '12px' }}>
                          <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Card Number</label>
                          <input
                            type="text"
                            name="cardNumber"
                            autoComplete="cc-number"
                            placeholder="1234 5678 9012 3456"
                            maxLength={19}
                            required
                            style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', background: 'white', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                          />
                        </div>
                        
                        <div style={{ marginBottom: '12px' }}>
                          <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Cardholder Name</label>
                          <input
                            type="text"
                            name="cardholderName"
                            autoComplete="cc-name"
                            placeholder="John Doe"
                            required
                            style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', background: 'white', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                          />
                        </div>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px' }}>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Exp Month</label>
                            <select name="expMonth" autoComplete="cc-exp-month" required style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', background: 'white', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}>
                              <option value="">MM</option>
                              {Array.from({length: 12}, (_, i) => i + 1).map(m => (
                                <option key={m} value={m.toString().padStart(2, '0')}>{m.toString().padStart(2, '0')}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Exp Year</label>
                            <select name="expYear" autoComplete="cc-exp-year" required style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', background: 'white', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}>
                              <option value="">YYYY</option>
                              {Array.from({length: 15}, (_, i) => new Date().getFullYear() + i).map(y => (
                                <option key={y} value={y}>{y}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>CVV</label>
                            <input
                              type="text"
                              name="cvv"
                              autoComplete="cc-csc"
                              placeholder="123"
                              maxLength={4}
                              required
                              style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', background: 'white', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                            />
                          </div>
                        </div>
                      </div>
                      
                      {/* Billing Address Section */}
                      <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '20px', marginBottom: '20px', border: '1px solid #e2e8f0' }}>
                        <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>ðŸ“ Billing Address</h4>
                        
                        <div style={{ marginBottom: '12px' }}>
                          <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Street Address</label>
                          <input
                            type="text"
                            name="street"
                            autoComplete="billing street-address"
                            placeholder="123 Main St"
                            required
                            style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                          />
                        </div>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>City</label>
                            <input
                              type="text"
                              name="city"
                              autoComplete="billing address-level2"
                              placeholder="City"
                              required
                              style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                            />
                          </div>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>State</label>
                            <input
                              type="text"
                              name="state"
                              autoComplete="billing address-level1"
                              placeholder="CA"
                              maxLength={2}
                              required
                              style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                            />
                          </div>
                        </div>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>ZIP Code</label>
                            <input
                              type="text"
                              name="zip"
                              autoComplete="billing postal-code"
                              placeholder="12345"
                              maxLength={10}
                              required
                              style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}
                            />
                          </div>
                          <div>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Country</label>
                            <select required style={{ width: '100%', padding: '10px 12px', borderRadius: '8px', border: '1px solid #cbd5e1', fontSize: '14px', outline: 'none' }}>
                              <option value="US">United States</option>
                              <option value="CA">Canada</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      
                      {/* Payment Summary */}
                      <div style={{ background: '#eff6ff', border: '2px solid #3b82f6', borderRadius: '12px', padding: '16px', marginBottom: '20px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Total Amount:</span>
                          <span style={{ fontSize: '28px', fontWeight: '700', color: '#2563eb' }}>${planPrice.toFixed(2)}</span>
                        </div>
                        <p style={{ fontSize: '12px', color: '#64748b', marginTop: '4px', marginBottom: 0 }}>
                          {selectedSubscriptionPlan} plan - Billed {planPeriod}
                        </p>
                      </div>
                      
                      {/* Action Buttons */}
                      <div style={{ display: 'flex', gap: '12px' }}>
                        <button
                          type="button"
                          onClick={() => setShowCheckoutModal(false)}
                          style={{
                            flex: 1,
                            padding: '12px 24px',
                            background: 'white',
                            color: '#64748b',
                            border: '1px solid #cbd5e1',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '600',
                            cursor: 'pointer'
                          }}
                        >
                          Cancel
                        </button>
                        <button
                          type="submit"
                          style={{
                            flex: 1.5,
                            padding: '12px 32px',
                            background: '#10b981',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            boxShadow: '0 4px 6px rgba(16, 185, 129, 0.3)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px'
                          }}
                        >
                          ðŸ’³ Complete Payment - ${planPrice.toFixed(2)}
                        </button>
                      </div>
                    </form>
                    
                    {/* Security Notice */}
                    <div style={{ marginTop: '16px', padding: '12px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #86efac', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <span style={{ fontSize: '16px' }}>ðŸ”’</span>
                      <span style={{ fontSize: '12px', fontWeight: '500', color: '#059669' }}>
                        Secured by USAePay - Your payment information is encrypted
                      </span>
                    </div>
                  </div>

                  {/* Security Notice */}
                  <div style={{ marginTop: '16px', padding: '12px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #86efac' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <span style={{ fontSize: '16px' }}>ðŸ”’</span>
                      <span style={{ fontSize: '13px', fontWeight: '500', color: '#059669' }}>
                        Secure payment processing via USAePay. Your card data is encrypted and never stored on our servers.
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            );
          })()}


          {/* Update Payment Method Modal */}
          {showUpdatePaymentModal && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999 }}>
              <div style={{ background: 'white', borderRadius: '12px', padding: '32px', maxWidth: '600px', width: '90%', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Update Payment Method</h2>
                  <button
                    onClick={() => setShowUpdatePaymentModal(false)}
                    style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#64748b', padding: '0', lineHeight: '1' }}
                  >
                    Ã—
                  </button>
                </div>

                <form onSubmit={handleUpdatePaymentMethod}>
                  {/* Card Information Section */}
                  <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', marginBottom: '20px', border: '1px solid #e2e8f0' }}>
                    <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      ðŸ’³ Card Details
                    </h4>
                    
                    <div style={{ marginBottom: '12px' }}>
                      <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Card Number</label>
                      <input
                        type="text"
                        value={updatePaymentData.cardNumber}
                        onChange={(e) => {
                          const formatted = e.target.value.replace(/\s/g, '').replace(/(\d{4})/g, '$1 ').trim();
                          setUpdatePaymentData({...updatePaymentData, cardNumber: formatted});
                        }}
                        placeholder="1234 5678 9012 3456"
                        maxLength={19}
                        required
                        style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                      />
                    </div>

                    <div style={{ marginBottom: '12px' }}>
                      <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Cardholder Name</label>
                      <input
                        type="text"
                        value={updatePaymentData.cardholderName}
                        onChange={(e) => setUpdatePaymentData({...updatePaymentData, cardholderName: e.target.value})}
                        placeholder="John Doe"
                        required
                        style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                      />
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                      <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Exp Month</label>
                        <input
                          type="text"
                          value={updatePaymentData.expirationMonth}
                          onChange={(e) => setUpdatePaymentData({...updatePaymentData, expirationMonth: e.target.value})}
                          placeholder="MM"
                          maxLength={2}
                          required
                          style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                        />
                      </div>
                      <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Exp Year</label>
                        <input
                          type="text"
                          value={updatePaymentData.expirationYear}
                          onChange={(e) => setUpdatePaymentData({...updatePaymentData, expirationYear: e.target.value})}
                          placeholder="YYYY"
                          maxLength={4}
                          required
                          style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                        />
                      </div>
                      <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>CVV</label>
                        <input
                          type="text"
                          value={updatePaymentData.cvv}
                          onChange={(e) => setUpdatePaymentData({...updatePaymentData, cvv: e.target.value})}
                          placeholder="123"
                          maxLength={4}
                          required
                          style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Billing Address Section */}
                  <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', marginBottom: '20px', border: '1px solid #e2e8f0' }}>
                    <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>
                      ðŸ“ Billing Address
                    </h4>

                    <div style={{ marginBottom: '12px' }}>
                      <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>Street Address</label>
                      <input
                        type="text"
                        value={updatePaymentData.billingStreet}
                        onChange={(e) => setUpdatePaymentData({...updatePaymentData, billingStreet: e.target.value})}
                        placeholder="123 Main St"
                        required
                        style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                      />
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                      <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>City</label>
                        <input
                          type="text"
                          value={updatePaymentData.billingCity}
                          onChange={(e) => setUpdatePaymentData({...updatePaymentData, billingCity: e.target.value})}
                          placeholder="City"
                          required
                          style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                        />
                      </div>
                      <div>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>State</label>
                        <input
                          type="text"
                          value={updatePaymentData.billingState}
                          onChange={(e) => setUpdatePaymentData({...updatePaymentData, billingState: e.target.value.toUpperCase()})}
                          placeholder="State"
                          maxLength={2}
                          required
                          style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                        />
                      </div>
                    </div>

                    <div style={{ marginBottom: '12px' }}>
                      <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#475569', marginBottom: '6px' }}>ZIP Code</label>
                      <input
                        type="text"
                        value={updatePaymentData.billingZip}
                        onChange={(e) => setUpdatePaymentData({...updatePaymentData, billingZip: e.target.value})}
                        placeholder="12345"
                        maxLength={10}
                        required
                        style={{ width: '100%', padding: '10px 12px', border: '1px solid #cbd5e1', borderRadius: '8px', fontSize: '14px' }}
                      />
                    </div>
                  </div>

                  {/* Security Notice */}
                  <div style={{ background: '#d1fae5', border: '1px solid #a7f3d0', borderRadius: '8px', padding: '12px', marginBottom: '20px', display: 'flex', alignItems: 'start', gap: '8px' }}>
                    <span style={{ fontSize: '18px' }}>ðŸ”’</span>
                    <span style={{ fontSize: '13px', color: '#065f46', lineHeight: '1.5' }}>
                      Secure payment processing via USAePay. Your card data is encrypted and never stored on our servers.
                    </span>
                  </div>

                  {/* Action Buttons */}
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button
                      type="button"
                      onClick={() => setShowUpdatePaymentModal(false)}
                      disabled={updatingPayment}
                      style={{
                        flex: 1,
                        padding: '12px 24px',
                        background: 'white',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#64748b',
                        cursor: updatingPayment ? 'not-allowed' : 'pointer',
                        opacity: updatingPayment ? 0.5 : 1
                      }}
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      disabled={updatingPayment}
                      style={{
                        flex: 1,
                        padding: '12px 24px',
                        background: updatingPayment ? '#94a3b8' : '#667eea',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: 'white',
                        cursor: updatingPayment ? 'not-allowed' : 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px'
                      }}
                    >
                      {updatingPayment ? (
                        <>
                          <span style={{ display: 'inline-block', width: '16px', height: '16px', border: '2px solid white', borderTopColor: 'transparent', borderRadius: '50%', animation: 'spin 1s linear infinite' }}></span>
                          Updating...
                        </>
                      ) : (
                        'ðŸ’³ Update Payment Method'
                      )}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Data Mapping Tab - Content rendered through Financial Statements conditional below */}

          {!selectedCompanyId && adminDashboardTab === 'data-mapping' && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '48px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', textAlign: 'center' }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>No Company Selected</div>
              <p style={{ fontSize: '14px', color: '#94a3b8' }}>Please select a company from the sidebar to map QuickBooks accounts.</p>
            </div>
          )}

          {adminDashboardTab === 'data-mapping' && selectedCompanyId && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '32px 24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>No Financial Data to Map</div>
                <p style={{ fontSize: '14px', color: '#94a3b8' }}>Sync QuickBooks data or upload a Trial Balance CSV to map accounts.</p>
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px', maxWidth: '800px', margin: '0 auto' }}>
                {/* QuickBooks Option */}
                <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '24px', border: '2px solid #e2e8f0', textAlign: 'center' }}>
                  <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ’»</div>
                  <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>QuickBooks API</div>
                  <p style={{ fontSize: '13px', color: '#64748b', marginBottom: '16px' }}>Connect to QuickBooks Online to sync your financial data automatically.</p>
                  <button
                    onClick={() => setAdminDashboardTab('api-connections')}
                    style={{
                      padding: '10px 20px',
                      background: '#667eea',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer'
                    }}
                  >
                    Connect QuickBooks
                  </button>
                </div>
                
                {/* Trial Balance Upload Option */}
                <div style={{ background: '#f0fdf4', borderRadius: '12px', padding: '24px', border: '2px solid #86efac' }}>
                  <div style={{ fontSize: '32px', marginBottom: '12px', textAlign: 'center' }}>ðŸ“Š</div>
                  <div style={{ fontSize: '16px', fontWeight: '600', color: '#065f46', marginBottom: '8px', textAlign: 'center' }}>Trial Balance CSV</div>
                  <p style={{ fontSize: '13px', color: '#047857', marginBottom: '16px', textAlign: 'center' }}>Upload a CSV with Acct Type, Acct ID, Description, and date columns.</p>
                  <input 
                    type="file" 
                    accept=".csv" 
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      
                      try {
                        const text = await file.text();
                        const parsed = parseTrialBalanceCSV(text, selectedCompanyId);
                        const csvData = {
                          ...parsed,
                          _companyId: selectedCompanyId,
                          fileName: file.name,
                        };
                        setCsvTrialBalanceData(csvData);
                        // Save to localStorage for persistence across sessions
                        localStorage.setItem(`csvTrialBalance_${selectedCompanyId}`, JSON.stringify(csvData));
                        setError(null);
                      } catch (err: any) {
                        setError(`Failed to parse Trial Balance CSV: ${err.message}`);
                        setCsvTrialBalanceData(null);
                      }
                    }} 
                    style={{ 
                      padding: '12px', 
                      border: '2px dashed #10b981', 
                      borderRadius: '8px', 
                      width: '100%', 
                      cursor: 'pointer', 
                      background: 'white',
                      fontSize: '13px'
                    }} 
                  />
                  {error && error.includes('Trial Balance') && (
                    <div style={{ padding: '8px', background: '#fee2e2', color: '#991b1b', borderRadius: '6px', marginTop: '12px', fontSize: '12px' }}>{error}</div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Company Details Modal */}
      <CompanyDetailsModal
        show={showCompanyDetailsModal}
        onClose={() => setShowCompanyDetailsModal(false)}
        companyAddressStreet={companyAddressStreet}
        setCompanyAddressStreet={setCompanyAddressStreet}
        companyAddressCity={companyAddressCity}
        setCompanyAddressCity={setCompanyAddressCity}
        companyAddressState={companyAddressState}
        setCompanyAddressState={setCompanyAddressState}
        companyAddressZip={companyAddressZip}
        setCompanyAddressZip={setCompanyAddressZip}
        companyAddressCountry={companyAddressCountry}
        setCompanyAddressCountry={setCompanyAddressCountry}
        companyIndustrySector={companyIndustrySector}
        setCompanyIndustrySector={setCompanyIndustrySector}
        onSave={saveCompanyDetails}
      />

      {/* Content Area - Requires Company Selection */}
      {!selectedCompanyId && currentView !== 'admin' && currentView !== 'consultant-dashboard' && currentView !== 'siteadmin' && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '64px 32px', textAlign: 'center' }}>
          <h2 style={{ fontSize: '28px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>No Company Selected</h2>
          <p style={{ fontSize: '16px', color: '#64748b', marginBottom: '12px' }}>Please select a company from the {currentUser?.consultantCompanyName ? `${currentUser.consultantCompanyName} Dashboard` : 'Consultant Dashboard'} to continue.</p>
          {currentUser?.role === 'consultant' && (
            <button onClick={() => setCurrentView('consultant-dashboard')} style={{ padding: '12px 24px', background: '#667eea', color: 'white', border: 'none', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer' }}>Go to {currentUser?.consultantCompanyName ? `${currentUser.consultantCompanyName} Dashboard` : 'Consultant Dashboard'}</button>
          )}
        </div>
      )}

      {/* Data Review Tab */}
      {currentView === 'admin' && adminDashboardTab === 'data-review' && selectedCompanyId && (
        <DataReviewTab selectedCompanyId={selectedCompanyId} companyName={companyName} accountMappings={aiMappings} />
      )}

      {/* Trend Analysis View */}
      {currentView === 'trend-analysis' && selectedCompanyId && monthly.length > 0 && (
        <TrendAnalysisView
          selectedCompanyId={selectedCompanyId}
          companyName={companyName}
          monthly={monthly}
          expenseGoals={expenseGoals}
          selectedExpenseItems={selectedExpenseItems}
          setSelectedExpenseItems={setSelectedExpenseItems}
          selectedItemTrends={selectedTrendItems}
          setSelectedItemTrends={setSelectedTrendItems}
        />
      )}
      */}

      {/* Financial Score - Introduction View */}
      {currentView === 'fs-intro' && (
        <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px' }}>
          <div style={{ background: 'white', borderRadius: '12px', padding: '40px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <h1 style={{ fontSize: '36px', fontWeight: '700', color: '#1e293b', marginBottom: '32px', textAlign: 'center' }}>Introduction to the Corelytics Financial Score</h1>
            
            <div style={{ fontSize: '16px', color: '#475569', lineHeight: '1.8', maxWidth: '900px', margin: '0 auto' }}>
              <p style={{ marginBottom: '20px' }}>
                We would like to introduce to you the emerging standard score for small and medium businesses. It is called the <strong>Corelytics Financial Score (CFS)</strong>. On a scale of 1 to 100, 100 indicates a company that is firing on all cylinders and building value at a steady clip; a score of zero indicates no operations. The scores in between have a lot to say about the general health of any company being measured.
              </p>
              
              <p style={{ marginBottom: '32px' }}>
                The score tells a lot about a company's financial stability and their potential value in the market regardless of specific industry.
              </p>
              
              <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '32px', marginBottom: '32px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Approximate Interpretation of Corelytics Financial Scores:</h2>
                
                <div style={{ display: 'grid', gap: '20px' }}>
                  <div style={{ background: '#d1fae5', borderRadius: '8px', padding: '20px', border: '2px solid #10b981' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#065f46', marginBottom: '12px' }}>80 â€“ 100: Strong Financial Performance</div>
                    <ul style={{ margin: 0, paddingLeft: '20px', color: '#064e3b', fontSize: '15px', lineHeight: '1.6' }}>
                      <li>Good growth and good balance</li>
                      <li>In a good position for considering an M&A transaction</li>
                      <li>Excellent time to expand offerings and invest in R&D</li>
                    </ul>
                  </div>
                  
                  <div style={{ background: '#dbeafe', borderRadius: '8px', padding: '20px', border: '2px solid #3b82f6' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#1e40af', marginBottom: '12px' }}>50 â€“ 80: Good Fundamentals</div>
                    <ul style={{ margin: 0, paddingLeft: '20px', color: '#1e3a8a', fontSize: '15px', lineHeight: '1.6' }}>
                      <li>In a good position for revenue growth</li>
                      <li>Needs to focus on bringing costs down as volume grows</li>
                    </ul>
                  </div>
                  
                  <div style={{ background: '#fef3c7', borderRadius: '8px', padding: '20px', border: '2px solid #f59e0b' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#92400e', marginBottom: '12px' }}>30 â€“ 50: Basic Problems</div>
                    <ul style={{ margin: 0, paddingLeft: '20px', color: '#78350f', fontSize: '15px', lineHeight: '1.6' }}>
                      <li>Cost structure issues; not in a position to grow</li>
                      <li>Improvements needed in operations and process controls</li>
                      <li>Growth without operating improvements could do significant harm</li>
                    </ul>
                  </div>
                  
                  <div style={{ background: '#fee2e2', borderRadius: '8px', padding: '20px', border: '2px solid #ef4444' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: '#991b1b', marginBottom: '12px' }}>0 â€“ 30: Serious Performance Problems</div>
                    <ul style={{ margin: 0, paddingLeft: '20px', color: '#7f1d1d', fontSize: '15px', lineHeight: '1.6' }}>
                      <li>Problems exist which may not be correctable</li>
                      <li>Some form of major restructuring or liquidation may be best</li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <p style={{ marginBottom: '20px' }}>
                These scores are both <strong>diagnostic</strong> and <strong>prescriptive</strong>. They are diagnostic in that they identify a fundamental level of performance and related potential problems; prescriptive in that they point to specific actions that should be taken to remedy identified problems or take advantage of opportunities.
              </p>
              
              <div style={{ background: '#ede9fe', borderRadius: '12px', padding: '24px', marginTop: '32px' }}>
                <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#5b21b6', marginBottom: '16px' }}>The Overall Score is Based On:</h3>
                <ul style={{ margin: 0, paddingLeft: '20px', color: '#6b21a8', fontSize: '15px', lineHeight: '1.8' }}>
                  <li>Long-term and short-term trends in revenue growth and expense growth</li>
                  <li>Trends in asset and liability growth</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Financial Score Trends View */}
      {currentView === 'fs-score' && selectedCompanyId && trendData.length > 0 && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <style>{`
            @media print {
              @page {
                size: portrait;
                margin: 0.3in;
              }
              
              /* Hide navigation and UI elements */
              .no-print,
              header,
              nav,
              aside,
              [role="navigation"],
              button {
                display: none !important;
              }
              
              /* Remove backgrounds and shadows for print */
              * {
                box-shadow: none !important;
              }
              
              /* Compress title and header */
              .fs-header h1 {
                font-size: 18px !important;
                margin-bottom: 8px !important;
              }
              
              .fs-header > div {
                font-size: 16px !important;
              }
              
              /* Compress main score cards */
              .fs-score-cards {
                margin-bottom: 12px !important;
                gap: 10px !important;
              }
              
              .fs-score-cards > div {
                padding: 10px !important;
                border-radius: 6px !important;
              }
              
              .fs-score-cards > div > div:first-child {
                font-size: 9px !important;
                margin-bottom: 4px !important;
              }
              
              .fs-score-cards > div > div:nth-child(2) {
                font-size: 22px !important;
              }
              
              /* Compress detail cards */
              .fs-detail-cards {
                gap: 8px !important;
                margin-bottom: 12px !important;
              }
              
              .fs-detail-cards > div {
                padding: 8px !important;
              }
              
              .fs-detail-cards > div > div:first-child {
                font-size: 8px !important;
              }
              
              .fs-detail-cards > div > div:nth-child(2) {
                font-size: 14px !important;
              }
              
              .fs-detail-cards > div > div:last-child {
                font-size: 7px !important;
              }
              
              /* Compress chart grid */
              .fs-charts-grid {
                gap: 8px !important;
              }
              
              .fs-charts-grid > div {
                transform: scale(0.65);
                transform-origin: top left;
                width: 153.85%;
                height: 250px;
                margin-bottom: -69px;
              }
              
              /* Force page break after row 2 (after 4th chart) */
              .fs-charts-grid > div:nth-child(4) {
                page-break-after: always;
                break-after: page;
              }
              
              /* Show page 2 header only on print */
              .page-2-header {
                display: block !important;
                margin-top: 72px !important;
                padding-bottom: 72px !important;
              }
              
              h2 {
                font-size: 12px !important;
                margin-bottom: 8px !important;
              }
            }
          `}</style>
          
          <div className="fs-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Financial Score Trends</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
              <button 
                className="no-print"
                onClick={() => window.print()} 
                style={{ 
                  padding: '12px 24px', 
                  background: '#667eea', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '8px', 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  cursor: 'pointer',
                  boxShadow: '0 2px 8px rgba(102, 126, 234, 0.3)'
                }}>
                ðŸ–¨ï¸ Print
              </button>
            </div>
          </div>
          
          {monthly.length >= 24 && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '12px' }}>Financial Score Analysis</h2>
              
              <div className="fs-score-cards" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '32px', maxWidth: '900px' }}>
                <div style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', borderRadius: '12px', padding: '20px', color: 'white', boxShadow: '0 4px 12px rgba(102,126,234,0.3)' }}>
                  <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', opacity: 0.9 }}>Corelytics Financial Score</div>
                  <div style={{ fontSize: '42px', fontWeight: '700' }}>{finalScore.toFixed(2)}</div>
                </div>
                <div style={{ background: '#f0fdf4', borderRadius: '12px', padding: '20px', border: '2px solid #86efac' }}>
                  <div style={{ fontSize: '14px', fontWeight: '600', color: '#166534', marginBottom: '8px' }}>Profitability Score</div>
                  <div style={{ fontSize: '42px', fontWeight: '700', color: '#10b981' }}>{profitabilityScore.toFixed(2)}</div>
                </div>
                <div style={{ background: '#ede9fe', borderRadius: '12px', padding: '20px', border: '2px solid #c4b5fd' }}>
                  <div style={{ fontSize: '14px', fontWeight: '600', color: '#5b21b6', marginBottom: '8px' }}>Asset Development Score</div>
                  <div style={{ fontSize: '42px', fontWeight: '700', color: '#8b5cf6' }}>{assetDevScore.toFixed(2)}</div>
                </div>
              </div>

              <div className="fs-detail-cards" style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px' }}>
                <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Base RGS (24mo)</div>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b' }}>{baseRGS.toFixed(0)}</div>
                  <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>Growth: {growth_24mo.toFixed(1)}%</div>
                </div>
                <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Adjusted RGS (6mo)</div>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b' }}>{adjustedRGS.toFixed(1)}</div>
                  <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>Growth: {growth_6mo.toFixed(1)}%</div>
                </div>
                <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Expense Adjustment</div>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: expenseAdjustment >= 0 ? '#10b981' : '#ef4444' }}>
                    {expenseAdjustment >= 0 ? '+' : ''}{expenseAdjustment}
                  </div>
                  <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>
                    {expenseAdjustment > 0 ? '? BONUS' : expenseAdjustment < 0 ? '? PENALTY' : 'NEUTRAL'}
                  </div>
                </div>
                <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>ALR-1 (Current)</div>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b' }}>{typeof alr1 === 'number' ? alr1.toFixed(2) : alr1}</div>
                </div>
                <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>ALR Growth %</div>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: alrGrowth >= 0 ? '#10b981' : '#ef4444' }}>
                    {alrGrowth >= 0 ? '+' : ''}{alrGrowth.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>
          )}
          
          <div className="fs-charts-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '24px' }}>
            <LineChart title="Financial Score Trend" data={trendData} valueKey="financialScore" color="#667eea" compact />
            <LineChart title="Profitability Score Trend" data={trendData} valueKey="profitabilityScore" color="#10b981" compact />
            <LineChart title="Revenue Growth Score (RGS)" data={trendData} valueKey="rgs" color="#f59e0b" compact />
            <LineChart title="RGS with 6-Month Adjustment" data={trendData} valueKey="rgsAdj" color="#3b82f6" compact />
            
            {/* Page 2 Header - only visible in print */}
            <div className="page-2-header" style={{ display: 'none', gridColumn: '1 / -1', paddingBottom: '72px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <h1 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Financial Score Trends (cont)</h1>
                {companyName && <div style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
              </div>
            </div>
            
            <LineChart title="Expense Adjustment" data={trendData} valueKey="expenseAdj" color="#8b5cf6" compact />
            <LineChart title="Asset Development Score (ADS)" data={trendData} valueKey="adsScore" color="#ec4899" compact />
            <LineChart title="ALR-1 (Asset-Liability Ratio)" data={trendData} valueKey="alr1" color="#14b8a6" compact />
            <LineChart title="ALR Growth %" data={trendData} valueKey="alrGrowth" color="#f97316" compact />
          </div>
        </div>
      )}

      {/* Formula Popup Modal */}
      {showFormulaPopup && KPI_FORMULAS[showFormulaPopup] && (
        <div 
          style={{ 
            position: 'fixed', 
            top: 0, 
            left: 0, 
            right: 0, 
            bottom: 0, 
            background: 'rgba(0, 0, 0, 0.5)', 
            zIndex: 9999, 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            padding: '20px'
          }}
          onClick={() => setShowFormulaPopup(null)}
        >
          <div 
            style={{ 
              background: 'white', 
              borderRadius: '16px', 
              padding: '32px', 
              maxWidth: '600px', 
              width: '100%',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
              maxHeight: '90vh',
              overflowY: 'auto'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
              <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', margin: 0 }}>{showFormulaPopup}</h2>
              <button
                onClick={() => setShowFormulaPopup(null)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#94a3b8',
                  padding: '0',
                  lineHeight: 1
                }}
              >
                Ã—
              </button>
            </div>
            
            <div style={{ marginBottom: '20px' }}>
              <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Formula</h3>
              <div style={{ 
                background: '#f8fafc', 
                padding: '16px', 
                borderRadius: '8px', 
                fontSize: '18px', 
                fontWeight: '600', 
                color: '#1e293b',
                fontFamily: 'monospace',
                border: '2px solid #e2e8f0'
              }}>
                {KPI_FORMULAS[showFormulaPopup].formula}
              </div>
            </div>
            
            <div style={{ marginBottom: '20px' }}>
              <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Period Used</h3>
              <div style={{ 
                background: '#ede9fe', 
                padding: '12px 16px', 
                borderRadius: '8px', 
                fontSize: '15px', 
                color: '#5b21b6',
                fontWeight: '600',
                border: '1px solid #d8b4fe'
              }}>
                {KPI_FORMULAS[showFormulaPopup].period}
              </div>
            </div>
            
            <div>
              <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Description</h3>
              <p style={{ fontSize: '15px', lineHeight: '1.7', color: '#475569', margin: 0 }}>
                {KPI_FORMULAS[showFormulaPopup].description}
              </p>
            </div>
            
            <div style={{ marginTop: '24px', paddingTop: '20px', borderTop: '1px solid #e2e8f0' }}>
              <button
                onClick={() => setShowFormulaPopup(null)}
                style={{
                  width: '100%',
                  padding: '12px',
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => e.currentTarget.style.background = '#4f46e5'}
                onMouseOut={(e) => e.currentTarget.style.background = '#667eea'}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Custom Dashboard View */}
      {currentView === 'dashboard' && selectedCompanyId && trendData.length > 0 && (
        <div className="dashboard-container" style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <style>{`
            @media print {
              @page {
                size: landscape;
                margin: 0.2in 0.4in 0.3in 0.4in;
              }
              
              /* Hide navigation and UI elements */
              .no-print,
              header,
              nav,
              aside,
              [role="navigation"],
              button {
                display: none !important;
              }
              
              /* Remove background colors and shadows */
              * {
                box-shadow: none !important;
                background: white !important;
              }
              
              /* Remove all padding from body and containers */
              body {
                padding: 0 !important;
                margin: 0 !important;
              }
              
              body > div {
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                overflow: visible !important;
              }
              
              body > div > div {
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                overflow: visible !important;
              }
              
              /* Dashboard container */
              .dashboard-container {
                padding: 0 !important;
                margin: 0 !important;
              }
              
              /* Dashboard title */
              h1 {
                font-size: 18px !important;
                margin: 0 !important;
                padding: 0 0 6px 0 !important;
                page-break-after: avoid;
              }
              
              /* Optimize grid for printing */
              .dashboard-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                margin: 0 !important;
                padding: 0 !important;
              }
              
              /* Prevent page breaks inside charts and remove all spacing */
              .dashboard-grid > div {
                page-break-inside: avoid;
                margin: 0 !important;
                padding: 8px !important;
              }
              
              /* Compact chart styling */
              .recharts-wrapper {
                max-height: 200px !important;
              }
              
              .recharts-surface {
                max-height: 180px !important;
              }
              
              /* Working Capital and Valuation containers */
              .dashboard-grid > div[style*="gridColumn"] {
                grid-column: 1 / -1 !important;
                page-break-before: auto;
                page-break-after: auto;
                padding: 8px !important;
                margin: 0 !important;
              }
              
              /* Reduce chart title size */
              .dashboard-grid h3 {
                font-size: 11px !important;
                margin: 0 0 2px 0 !important;
                padding: 0 !important;
              }
              
              /* Reduce chart text size */
              .recharts-text {
                font-size: 9px !important;
              }
            }
          `}</style>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>
              Dashboard: {companyName || 'My Dashboard'}
            </h1>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button
                className="no-print"
                onClick={() => window.print()}
                style={{
                  background: '#10b981',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)',
                  transition: 'all 0.3s'
                }}
                onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
              >
                ðŸ–¨ï¸ Print Dashboard
              </button>
              <button
                className="no-print"
                onClick={() => setShowDashboardCustomizer(!showDashboardCustomizer)}
                style={{
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)',
                  transition: 'all 0.3s'
                }}
                onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
              >
                {showDashboardCustomizer ? 'Done Customizing' : 'âš™ï¸ Customize Dashboard'}
              </button>
            </div>
          </div>

          {/* Dashboard Customizer */}
          {showDashboardCustomizer && (
            <div style={{ 
              background: 'white', 
              borderRadius: '16px', 
              padding: '32px', 
              marginBottom: '32px',
              boxShadow: '0 4px 20px rgba(0,0,0,0.08)',
              border: '2px solid #667eea'
            }}>
              <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '8px' }}>
                ðŸ”¨ Build Your Custom Dashboard
              </h2>
              <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '24px' }}>
                Select the metrics and charts you want to see. Click on any item to add or remove it from your dashboard. Items will appear in the order selected.
              </p>

              {/* Widget Categories */}
              <div style={{ display: 'grid', gap: '24px' }}>
                
              {/* Ratios Section */}
              <div>
                <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  ðŸ“Š Financial Ratios
                </h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px' }}>
                  {/* Liquidity Ratios */}
                  <div>
                    <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                      Liquidity Ratios
                    </label>
                    <select
                      onChange={(e) => {
                        const value = e.target.value;
                        if (value && !selectedDashboardWidgets.includes(value)) {
                          setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                        }
                        e.target.value = '';
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        cursor: 'pointer',
                        color: '#1e293b'
                      }}
                    >
                      <option value="">Select a ratio...</option>
                      <option value="Current Ratio">Current Ratio</option>
                      <option value="Quick Ratio">Quick Ratio</option>
                    </select>
                  </div>

                  {/* Activity Ratios */}
                  <div>
                    <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                      Activity Ratios
                    </label>
                    <select
                      onChange={(e) => {
                        const value = e.target.value;
                        if (value && !selectedDashboardWidgets.includes(value)) {
                          setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                        }
                        e.target.value = '';
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        cursor: 'pointer',
                        color: '#1e293b'
                      }}
                    >
                      <option value="">Select a ratio...</option>
                      <option value="Days Receivables">Days' Receivables</option>
                      <option value="Days Inventory">Days' Inventory</option>
                      <option value="Days Payables">Days' Payables</option>
                      <option value="Inventory Turnover">Inventory Turnover</option>
                      <option value="Receivables Turnover">Receivables Turnover</option>
                      <option value="Payables Turnover">Payables Turnover</option>
                      <option value="Sales/Working Capital">Sales/Working Capital</option>
                    </select>
                  </div>

                  {/* Coverage Ratios */}
                  <div>
                    <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                      Coverage Ratios
                    </label>
                    <select
                      onChange={(e) => {
                        const value = e.target.value;
                        if (value && !selectedDashboardWidgets.includes(value)) {
                          setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                        }
                        e.target.value = '';
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        cursor: 'pointer',
                        color: '#1e293b'
                      }}
                    >
                      <option value="">Select a ratio...</option>
                      <option value="Interest Coverage">Interest Coverage</option>
                      <option value="Debt Service Coverage">Debt Service Coverage</option>
                      <option value="Cash Flow to Debt">Cash Flow to Debt</option>
                    </select>
                  </div>

                  {/* Leverage Ratios */}
                  <div>
                    <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                      Leverage Ratios
                    </label>
                    <select
                      onChange={(e) => {
                        const value = e.target.value;
                        if (value && !selectedDashboardWidgets.includes(value)) {
                          setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                        }
                        e.target.value = '';
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        cursor: 'pointer',
                        color: '#1e293b'
                      }}
                    >
                      <option value="">Select a ratio...</option>
                      <option value="Debt/Net Worth">Debt/Net Worth</option>
                      <option value="Fixed Assets/Net Worth">Fixed Assets/Net Worth</option>
                      <option value="Leverage Ratio">Leverage Ratio</option>
                    </select>
                  </div>

                  {/* Operating Ratios */}
                  <div>
                    <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                      Operating Ratios
                    </label>
                    <select
                      onChange={(e) => {
                        const value = e.target.value;
                        if (value && !selectedDashboardWidgets.includes(value)) {
                          setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                        }
                        e.target.value = '';
                      }}
                      style={{
                        width: '100%',
                        padding: '10px 12px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        cursor: 'pointer',
                        color: '#1e293b'
                      }}
                    >
                      <option value="">Select a ratio...</option>
                      <option value="ROA">Return on Assets (ROA)</option>
                      <option value="ROE">Return on Equity (ROE)</option>
                      <option value="Total Asset Turnover">Total Asset Turnover</option>
                      <option value="EBITDA Margin">EBITDA Margin</option>
                      <option value="EBIT Margin">EBIT Margin</option>
                    </select>
                  </div>
                </div>

                {/* Display selected ratios */}
                {selectedDashboardWidgets.filter(w => 
                  ['Current Ratio', 'Quick Ratio', 'Days Receivables', 'Days Inventory', 'Days Payables', 'Inventory Turnover', 'Receivables Turnover', 'Payables Turnover', 'Sales/Working Capital', 'Interest Coverage', 'Debt Service Coverage', 'Cash Flow to Debt', 'Debt/Net Worth', 'Fixed Assets/Net Worth', 'Leverage Ratio', 'ROA', 'ROE', 'Total Asset Turnover', 'EBITDA Margin', 'EBIT Margin'].includes(w)
                ).length > 0 && (
                  <div style={{ marginTop: '16px' }}>
                    <p style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>Selected Ratios:</p>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                      {selectedDashboardWidgets.filter(w => 
                        ['Current Ratio', 'Quick Ratio', 'Days Receivables', 'Days Inventory', 'Days Payables', 'Inventory Turnover', 'Receivables Turnover', 'Payables Turnover', 'Sales/Working Capital', 'Interest Coverage', 'Debt Service Coverage', 'Cash Flow to Debt', 'Debt/Net Worth', 'Fixed Assets/Net Worth', 'Leverage Ratio', 'ROA', 'ROE', 'Total Asset Turnover', 'EBITDA Margin', 'EBIT Margin'].includes(w)
                      ).map(widget => (
                        <div
                          key={widget}
                          style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            padding: '8px 12px',
                            borderRadius: '6px',
                            fontSize: '13px',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                        >
                          <span>{widget}</span>
                          <button
                            onClick={() => setSelectedDashboardWidgets(selectedDashboardWidgets.filter(w => w !== widget))}
                            style={{
                              background: 'rgba(255,255,255,0.2)',
                              border: 'none',
                              color: 'white',
                              cursor: 'pointer',
                              borderRadius: '50%',
                              width: '18px',
                              height: '18px',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              padding: 0
                            }}
                          >
                            Ã—
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

                {/* Trend Analysis Section */}
                <div>
                  <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    ðŸ“ˆ Trend Analysis
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px' }}>
                    {/* Item Trends Dropdown */}
                    <div>
                      <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                        Item Trends
                      </label>
                      <select
                        onChange={(e) => {
                          const value = e.target.value;
                          if (value && !selectedDashboardWidgets.includes(value)) {
                            setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                          }
                          e.target.value = '';
                        }}
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          border: '2px solid #e2e8f0',
                          borderRadius: '8px',
                          fontSize: '14px',
                          background: 'white',
                          cursor: 'pointer',
                          color: '#1e293b'
                        }}
                      >
                        <option value="">Select an item...</option>
                        <optgroup label="Income Statement">
                          <option value="revenue">Total Revenue</option>
                          <option value="expense">Total Expenses</option>
                          <option value="cogsTotal">COGS Total</option>
                          <option value="cogsPayroll">COGS Payroll</option>
                          <option value="cogsOwnerPay">COGS Owner Pay</option>
                          <option value="cogsContractors">COGS Contractors</option>
                          <option value="cogsMaterials">COGS Materials</option>
                          <option value="cogsCommissions">COGS Commissions</option>
                          <option value="cogsOther">COGS Other</option>
                          <option value="salesExpense">Sales & Marketing</option>
                          <option value="rent">Rent/Lease</option>
                          <option value="infrastructure">Infrastructure/Utilities</option>
                          <option value="autoTravel">Auto & Travel</option>
                          <option value="professionalFees">Professional Services</option>
                          <option value="insurance">Insurance</option>
                          <option value="marketing">OPEX Other</option>
                          <option value="payroll">OPEX Payroll</option>
                          <option value="ownerBasePay">Owners Base Pay</option>
                          <option value="ownersRetirement">Owners Retirement</option>
                          <option value="subcontractors">Contractors/Distribution</option>
                          <option value="interestExpense">Interest Expense</option>
                          <option value="depreciationAmortization">Depreciation Expense</option>
                          <option value="operatingExpenseTotal">Operating Expense Total</option>
                          <option value="nonOperatingIncome">Non-Operating Income</option>
                          <option value="extraordinaryItems">Extraordinary Items</option>
                          <option value="netProfit">Net Profit</option>
                        </optgroup>
                        <optgroup label="Balance Sheet - Assets">
                          <option value="totalAssets">Total Assets</option>
                          <option value="cash">Cash</option>
                          <option value="ar">Accounts Receivable</option>
                          <option value="inventory">Inventory</option>
                          <option value="otherCA">Other Current Assets</option>
                          <option value="tca">Total Current Assets</option>
                          <option value="fixedAssets">Fixed Assets</option>
                          <option value="otherAssets">Other Assets</option>
                        </optgroup>
                        <optgroup label="Balance Sheet - Liabilities">
                          <option value="totalLiab">Total Liabilities</option>
                          <option value="ap">Accounts Payable</option>
                          <option value="otherCL">Other Current Liabilities</option>
                          <option value="tcl">Total Current Liabilities</option>
                          <option value="ltd">Long Term Debt</option>
                        </optgroup>
                        <optgroup label="Balance Sheet - Equity">
                          <option value="ownersCapital">Owner's Capital</option>
                          <option value="ownersDraw">Owner's Draw</option>
                          <option value="commonStock">Common Stock</option>
                          <option value="preferredStock">Preferred Stock</option>
                          <option value="retainedEarnings">Retained Earnings</option>
                          <option value="additionalPaidInCapital">Additional Paid-In Capital</option>
                          <option value="treasuryStock">Treasury Stock</option>
                          <option value="totalEquity">Total Equity</option>
                        </optgroup>
                      </select>
                    </div>

                    {/* Expense Analysis Dropdown */}
                    <div>
                      <label style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px', display: 'block' }}>
                        Expense Analysis (% of Revenue)
                      </label>
                      <select
                        onChange={(e) => {
                          const value = e.target.value;
                          if (value && !selectedDashboardWidgets.includes(value)) {
                            setSelectedDashboardWidgets([...selectedDashboardWidgets, value]);
                          }
                          e.target.value = '';
                        }}
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          border: '2px solid #e2e8f0',
                          borderRadius: '8px',
                          fontSize: '14px',
                          background: 'white',
                          cursor: 'pointer',
                          color: '#1e293b'
                        }}
                      >
                        <option value="">Select an expense...</option>
                        <option value="Expense % - Total Expenses">Total Expenses</option>
                        <option value="Expense % - COGS Total">COGS Total</option>
                        <option value="Expense % - OPEX Payroll">OPEX Payroll</option>
                        <option value="Expense % - Owners Base Pay">Owners Base Pay</option>
                        <option value="Expense % - Contractors">Contractors/Distribution</option>
                        <option value="Expense % - Professional Services">Professional Services</option>
                        <option value="Expense % - Insurance">Insurance</option>
                        <option value="Expense % - Rent/Lease">Rent/Lease</option>
                        <option value="Expense % - Infrastructure">Infrastructure/Utilities</option>
                        <option value="Expense % - Auto & Travel">Auto & Travel</option>
                        <option value="Expense % - Sales & Marketing">Sales & Marketing</option>
                        <option value="Expense % - Other">Other Expenses</option>
                        <option value="Expense % - Depreciation">Depreciation</option>
                        <option value="Expense % - Interest">Interest</option>
                      </select>
                    </div>
                  </div>

                  {/* Display selected trend analysis items */}
                  {selectedDashboardWidgets.filter(w => 
                    ['revenue', 'expense', 'cogsTotal', 'cogsPayroll', 'cogsOwnerPay', 'cogsContractors', 'cogsMaterials', 'cogsCommissions', 'cogsOther', 
                     'salesExpense', 'rent', 'infrastructure', 'autoTravel', 'professionalFees', 'insurance', 'marketing', 
                     'payroll', 'ownerBasePay', 'ownersRetirement', 'subcontractors', 'interestExpense', 'depreciationAmortization', 
                     'operatingExpenseTotal', 'nonOperatingIncome', 'extraordinaryItems', 'netProfit', 'totalAssets', 'cash', 'ar', 'inventory', 
                     'otherCA', 'tca', 'fixedAssets', 'otherAssets', 'totalLiab', 'ap', 'otherCL', 'tcl', 'ltd', 'totalEquity'].includes(w) ||
                     w.startsWith('Expense % - ')
                  ).length > 0 && (
                    <div style={{ marginTop: '16px' }}>
                      <p style={{ fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>Selected Trend Items:</p>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                        {selectedDashboardWidgets.filter(w => 
                          ['revenue', 'expense', 'cogsTotal', 'cogsPayroll', 'cogsOwnerPay', 'cogsContractors', 'cogsMaterials', 'cogsCommissions', 'cogsOther', 
                           'salesExpense', 'rent', 'infrastructure', 'autoTravel', 'professionalFees', 'insurance', 'marketing', 
                           'payroll', 'ownerBasePay', 'ownersRetirement', 'subcontractors', 'interestExpense', 'depreciationAmortization', 
                           'operatingExpenseTotal', 'nonOperatingIncome', 'extraordinaryItems', 'netProfit', 'totalAssets', 'cash', 'ar', 'inventory', 
                           'otherCA', 'tca', 'fixedAssets', 'otherAssets', 'totalLiab', 'ap', 'otherCL', 'tcl', 'ltd', 'totalEquity'].includes(w) ||
                           w.startsWith('Expense % - ')
                        ).map(widget => (
                          <div
                            key={widget}
                            style={{
                              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                              color: 'white',
                              padding: '8px 12px',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                          display: 'flex',
                          alignItems: 'center',
                              gap: '8px'
                            }}
                          >
                            <span>{widget.startsWith('Expense % - ') ? widget : getTrendItemDisplayName(widget)}</span>
                            <button
                              onClick={() => setSelectedDashboardWidgets(selectedDashboardWidgets.filter(w => w !== widget))}
                              style={{
                                background: 'none',
                                border: 'none',
                                color: 'white',
                                cursor: 'pointer',
                                fontSize: '16px',
                                padding: '0',
                                lineHeight: '1'
                              }}
                            >
                              Ã—
                            </button>
                      </div>
                    ))}
                  </div>
                    </div>
                  )}
                </div>

                {/* Working Capital Metrics */}
                <div>
                  <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    ðŸ’¼ Working Capital Metrics
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '12px' }}>
                    {['Current Working Capital', 'Working Capital Ratio', 'Days Working Capital', 'Cash Conversion Cycle', 'Working Capital Trend'].map(widget => (
                      <div
                        key={widget}
                        onClick={() => {
                          if (selectedDashboardWidgets.includes(widget)) {
                            setSelectedDashboardWidgets(selectedDashboardWidgets.filter(w => w !== widget));
                          } else {
                            setSelectedDashboardWidgets([...selectedDashboardWidgets, widget]);
                          }
                        }}
                        style={{
                          background: selectedDashboardWidgets.includes(widget) ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f8fafc',
                          color: selectedDashboardWidgets.includes(widget) ? 'white' : '#1e293b',
                          padding: '16px',
                          borderRadius: '12px',
                          cursor: 'pointer',
                          border: selectedDashboardWidgets.includes(widget) ? '2px solid #667eea' : '2px solid #e2e8f0',
                          transition: 'all 0.3s',
                          fontWeight: '600',
                          fontSize: '14px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between'
                        }}
                      >
                        <span>{widget}</span>
                        <span>{selectedDashboardWidgets.includes(widget) ? '?' : '+'}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Cash Flow Metrics */}
                <div>
                  <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    ðŸ’° Cash Flow
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '12px' }}>
                    {['Operating Cash Flow', 'Free Cash Flow', 'Cash Position'].map(widget => (
                      <div
                        key={widget}
                        onClick={() => {
                          if (selectedDashboardWidgets.includes(widget)) {
                            setSelectedDashboardWidgets(selectedDashboardWidgets.filter(w => w !== widget));
                          } else {
                            setSelectedDashboardWidgets([...selectedDashboardWidgets, widget]);
                          }
                        }}
                        style={{
                          background: selectedDashboardWidgets.includes(widget) ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f8fafc',
                          color: selectedDashboardWidgets.includes(widget) ? 'white' : '#1e293b',
                          padding: '16px',
                          borderRadius: '12px',
                          cursor: 'pointer',
                          border: selectedDashboardWidgets.includes(widget) ? '2px solid #667eea' : '2px solid #e2e8f0',
                          transition: 'all 0.3s',
                          fontWeight: '600',
                          fontSize: '14px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between'
                        }}
                      >
                        <span>{widget}</span>
                        <span>{selectedDashboardWidgets.includes(widget) ? '?' : '+'}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Valuation Metrics */}
                <div>
                  <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    ðŸ’Ž Valuation Metrics
                  </h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '12px' }}>
                    {['SDE Valuation', 'EBITDA Valuation', 'DCF Valuation'].map(widget => (
                      <div
                        key={widget}
                        onClick={() => {
                          if (selectedDashboardWidgets.includes(widget)) {
                            setSelectedDashboardWidgets(selectedDashboardWidgets.filter(w => w !== widget));
                          } else {
                            setSelectedDashboardWidgets([...selectedDashboardWidgets, widget]);
                          }
                        }}
                        style={{
                          background: selectedDashboardWidgets.includes(widget) ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f8fafc',
                          color: selectedDashboardWidgets.includes(widget) ? 'white' : '#1e293b',
                          padding: '16px',
                          borderRadius: '12px',
                          cursor: 'pointer',
                          border: selectedDashboardWidgets.includes(widget) ? '2px solid #667eea' : '2px solid #e2e8f0',
                          transition: 'all 0.3s',
                          fontWeight: '600',
                          fontSize: '14px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between'
                        }}
                      >
                        <span>{widget}</span>
                        <span>{selectedDashboardWidgets.includes(widget) ? '?' : '+'}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div style={{ marginTop: '24px', textAlign: 'center' }}>
                <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '12px' }}>
                  {selectedDashboardWidgets.length === 0 ? 'No widgets selected. Click items above to add them.' : `${selectedDashboardWidgets.length} widget${selectedDashboardWidgets.length === 1 ? '' : 's'} selected`}
                </p>
                {selectedDashboardWidgets.length > 0 && (
                  <button
                    onClick={() => setSelectedDashboardWidgets([])}
                    style={{
                      background: 'white',
                      color: '#ef4444',
                      border: '2px solid #ef4444',
                      padding: '10px 20px',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      transition: 'all 0.3s'
                    }}
                  >
                    Clear All
                  </button>
                )}
              </div>
            </div>
          )}

          {/* Display Selected Widgets */}
          {selectedDashboardWidgets.length === 0 && !showDashboardCustomizer ? (
            <div style={{
              background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
              borderRadius: '16px',
              padding: '80px 32px',
              textAlign: 'center',
              border: '2px dashed #cbd5e1'
            }}>
              <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ“Š</div>
              <h3 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '12px' }}>
                Your Dashboard is Empty
              </h3>
              <p style={{ fontSize: '16px', color: '#64748b', marginBottom: '24px', maxWidth: '500px', margin: '0 auto 24px' }}>
                Click the "Customize Dashboard" button above to select metrics and charts you'd like to track.
              </p>
              <button
                onClick={() => setShowDashboardCustomizer(true)}
                style={{
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  padding: '14px 32px',
                  borderRadius: '8px',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)'
                }}
              >
                Get Started
              </button>
            </div>
          ) : (
            <div className="dashboard-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
              {/* Render widgets in user-selected order */}
              {(() => {
                const renderedWCWidgets = new Set();
                const renderedValuationWidgets = new Set();
                const wcWidgetsList = ['Current Working Capital', 'Working Capital Ratio', 'Days Working Capital', 'Cash Conversion Cycle'];
                const valuationWidgetsList = ['SDE Valuation', 'EBITDA Valuation', 'DCF Valuation'];
                
          const renderedWidgets = selectedDashboardWidgets.map((widget, index) => {
                  
                  // Check if this is a Working Capital widget
                  if (wcWidgetsList.includes(widget)) {
                    // If we've already rendered WC widgets, skip
                    if (renderedWCWidgets.size > 0) {
                      return null;
                    }
                    
                    // Mark all WC widgets as rendered
                    wcWidgetsList.forEach(w => renderedWCWidgets.add(w));
                    
                    // Get all selected WC widgets
                    const wcWidgets = selectedDashboardWidgets.filter(w => wcWidgetsList.includes(w));
                    
                  // Calculate working capital data
                  const wcData = monthly.map(m => {
                    const ca = m.tca || ((m.cash || 0) + (m.ar || 0) + (m.inventory || 0) + (m.otherCA || 0));
                    const cl = m.tcl || ((m.ap || 0) + (m.otherCL || 0));
                    return {
                      month: m.month,
                      currentAssets: ca,
                      currentLiabilities: cl,
                      workingCapital: ca - cl,
                      revenue: m.revenue
                    };
                  });
                  
                  const current = wcData[wcData.length - 1];
                  const prior = wcData.length >= 13 ? wcData[wcData.length - 13] : wcData[0];
                  const currentWC = current.workingCapital;
                  const wcRatio = current.currentLiabilities !== 0 ? current.currentAssets / current.currentLiabilities : 0;
                  const wcChange = currentWC - prior.workingCapital;
                  const wcChangePercent = prior.workingCapital !== 0 ? (wcChange / Math.abs(prior.workingCapital)) * 100 : 0;
                  
                  const last12Months = monthly.slice(-12);
                  const annualRevenue = last12Months.reduce((sum, m) => sum + m.revenue, 0);
                  const dailyRevenue = annualRevenue / 365;
                  const daysWC = dailyRevenue !== 0 ? currentWC / dailyRevenue : 0;
                  
                  const daysAR = current.revenue !== 0 ? (current.currentAssets * 0.4 / (current.revenue * 12)) * 365 : 0;
                  const daysAP = current.revenue !== 0 ? (current.currentLiabilities * 0.6 / (current.revenue * 12 * 0.7)) * 365 : 0;
                  const daysInventory = current.revenue !== 0 ? (current.currentAssets * 0.2 / (current.revenue * 12 * 0.7)) * 365 : 0;
                  const cashConversionCycle = daysAR + daysInventory - daysAP;
                  
                  return (
                    <div key="wc-metrics" style={{ gridColumn: '1 / -1', display: 'flex', gap: '12px', justifyContent: 'flex-start' }}>
                      {wcWidgets.includes('Current Working Capital') && (
                        <div style={{ background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea', minWidth: '200px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '6px' }}>Current Working Capital</h3>
                          <div style={{ fontSize: '24px', fontWeight: '700', color: '#667eea', marginBottom: '4px' }}>
                            ${(currentWC / 1000).toFixed(0)}K
                          </div>
                          <div style={{ fontSize: '11px', color: wcChange >= 0 ? '#10b981' : '#ef4444', fontWeight: '600' }}>
                            {wcChange >= 0 ? '?' : '?'} ${Math.abs(wcChange / 1000).toFixed(0)}K ({wcChangePercent >= 0 ? '+' : ''}{wcChangePercent.toFixed(1)}%)
                          </div>
                        </div>
                      )}
                      
                      {wcWidgets.includes('Working Capital Ratio') && (
                        <div style={{ background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea', minWidth: '200px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '6px' }}>Working Capital Ratio</h3>
                          <div style={{ fontSize: '24px', fontWeight: '700', color: wcRatio >= 1.5 ? '#10b981' : wcRatio >= 1.0 ? '#f59e0b' : '#ef4444', marginBottom: '4px' }}>
                            {wcRatio.toFixed(2)}
                          </div>
                          <div style={{ fontSize: '11px', color: '#64748b' }}>
                            {wcRatio >= 1.5 ? 'Strong' : wcRatio >= 1.0 ? 'Adequate' : 'Needs Attention'}
                          </div>
                        </div>
                      )}
                      
                      {wcWidgets.includes('Days Working Capital') && (
                        <div style={{ background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea', minWidth: '200px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '6px' }}>Days Working Capital</h3>
                          <div style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>
                            {daysWC.toFixed(0)}
                          </div>
                          <div style={{ fontSize: '11px', color: '#64748b' }}>
                            Days of revenue covered
                          </div>
                        </div>
                      )}
                      
                      {wcWidgets.includes('Cash Conversion Cycle') && (
                        <div style={{ background: 'white', borderRadius: '12px', padding: '16px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea', minWidth: '200px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '6px' }}>Cash Conversion Cycle</h3>
                          <div style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>
                            {cashConversionCycle.toFixed(0)}
                          </div>
                          <div style={{ fontSize: '11px', color: '#64748b' }}>
                            Days (estimated)
                          </div>
                        </div>
                      )}
                    </div>
                  );
                }
                  
                  // Check if this is a Valuation widget
                  if (valuationWidgetsList.includes(widget)) {
                    // If we've already rendered valuation widgets, skip
                    if (renderedValuationWidgets.size > 0) {
                return null;
                    }
                    
                    // Mark all valuation widgets as rendered
                    valuationWidgetsList.forEach(w => renderedValuationWidgets.add(w));
                    
                    // Get all selected valuation widgets
                    const selectedValuationWidgets = selectedDashboardWidgets.filter(w => valuationWidgetsList.includes(w));
                    
                    // Calculate all valuations
                    const last12 = monthly.slice(-12);
                    const ttmRevenue = last12.reduce((sum, m) => sum + (m.revenue || 0), 0);
                    const ttmCOGS = last12.reduce((sum, m) => sum + (m.cogsTotal || 0), 0);
                    const ttmExpense = last12.reduce((sum, m) => sum + (m.expense || 0), 0);
                    const ttmDepreciation = last12.reduce((sum, m) => sum + (m.depreciationAmortization || 0), 0);
                    const ttmInterest = last12.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                    const ttmNetIncome = ttmRevenue - ttmCOGS - ttmExpense;
                    const ttmEBITDA = ttmNetIncome + ttmDepreciation + ttmInterest;
                    const ttmOwnerBasePay = last12.reduce((sum, m) => sum + (m.ownerBasePay || 0), 0);
                    const ttmSDE = ttmEBITDA + ttmOwnerBasePay;
                    const sdeValuation = ttmSDE * sdeMultiplier;
                    const ebitdaValuation = ttmEBITDA * ebitdaMultiplier;
                    
                    // DCF calculation
                    const currentMonth = monthly[monthly.length - 1];
                    const month12Ago = monthly.length >= 13 ? monthly[monthly.length - 13] : monthly[0];
                    const currentWC_val = ((currentMonth.cash || 0) + (currentMonth.ar || 0) + (currentMonth.inventory || 0)) - ((currentMonth.ap || 0) + (currentMonth.otherCL || 0));
                    const priorWC = ((month12Ago.cash || 0) + (month12Ago.ar || 0) + (month12Ago.inventory || 0)) - ((month12Ago.ap || 0) + (month12Ago.otherCL || 0));
                    const changeInWC = currentWC_val - priorWC;
                    const changeInFixedAssets = (currentMonth.fixedAssets || 0) - (month12Ago.fixedAssets || 0);
                    const ttmCapEx = Math.max(0, changeInFixedAssets + ttmDepreciation);
                    const ttmFreeCashFlow = ttmNetIncome + ttmDepreciation - changeInWC - ttmCapEx;
                    const growthRate = growth_24mo / 100;
                    const discountRate = dcfDiscountRate / 100;
                    const terminalGrowthRate = dcfTerminalGrowth / 100;
                    let dcfValue = 0;
                    for (let year = 1; year <= 5; year++) {
                      const projectedFCF = ttmFreeCashFlow * Math.pow(1 + growthRate, year);
                      dcfValue += projectedFCF / Math.pow(1 + discountRate, year);
                    }
                    const terminalValue = (ttmFreeCashFlow * Math.pow(1 + growthRate, 5) * (1 + terminalGrowthRate)) / (discountRate - terminalGrowthRate);
                    dcfValue += terminalValue / Math.pow(1 + discountRate, 5);
                    
                    // Render container with all selected valuation widgets
                    return (
                      <div key="valuation-container" style={{ 
                        background: 'white', 
                        borderRadius: '12px', 
                        padding: '20px', 
                        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                        gridColumn: '1 / -1'
                      }}>
                        <div style={{ display: 'grid', gridTemplateColumns: `repeat(${selectedValuationWidgets.length}, 1fr)`, gap: '16px' }}>
                          {selectedValuationWidgets.includes('SDE Valuation') && (
                            <div style={{ padding: '20px', borderRadius: '8px', border: '2px solid #10b981' }}>
                              <h3 style={{ fontSize: '13px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>SDE Valuation</h3>
                              <div style={{ fontSize: '32px', fontWeight: '700', color: '#10b981', marginBottom: '8px' }}>
                                ${(sdeValuation / 1000000).toFixed(2)}M
                              </div>
                              <div style={{ fontSize: '12px', color: '#64748b' }}>
                                SDE: ${(ttmSDE / 1000).toFixed(0)}K Ã— {sdeMultiplier.toFixed(1)}x
                              </div>
                            </div>
                          )}
                          
                          {selectedValuationWidgets.includes('EBITDA Valuation') && (
                            <div style={{ padding: '20px', borderRadius: '8px', border: '2px solid #06b6d4' }}>
                              <h3 style={{ fontSize: '13px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>EBITDA Valuation</h3>
                              <div style={{ fontSize: '32px', fontWeight: '700', color: '#06b6d4', marginBottom: '8px' }}>
                                ${(ebitdaValuation / 1000000).toFixed(2)}M
                              </div>
                              <div style={{ fontSize: '12px', color: '#64748b' }}>
                                EBITDA: ${(ttmEBITDA / 1000).toFixed(0)}K Ã— {ebitdaMultiplier.toFixed(1)}x
                              </div>
                            </div>
                          )}
                          
                          {selectedValuationWidgets.includes('DCF Valuation') && (
                            <div style={{ padding: '20px', borderRadius: '8px', border: '2px solid #8b5cf6' }}>
                              <h3 style={{ fontSize: '13px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>DCF Valuation</h3>
                              <div style={{ fontSize: '32px', fontWeight: '700', color: '#8b5cf6', marginBottom: '8px' }}>
                                ${(dcfValue / 1000000).toFixed(2)}M
                              </div>
                              <div style={{ fontSize: '12px', color: '#64748b' }}>
                                5-year projection at {dcfDiscountRate}% discount
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  }
                  
                  // Render all other widgets normally
                  return (() => {
                // Render appropriate chart based on widget name
                if (widget === 'Current Ratio') {
                  return <LineChart key={widget} title="Current Ratio" data={trendData} valueKey="currentRatio" color="#10b981" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Current Ratio')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Quick Ratio') {
                  return <LineChart key={widget} title="Quick Ratio" data={trendData} valueKey="quickRatio" color="#14b8a6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Quick Ratio')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Debt/Net Worth') {
                  return <LineChart key={widget} title="Debt/Net Worth" data={trendData} valueKey="debtToNW" color="#ec4899" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Debt/Net Worth')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'ROA') {
                  return <LineChart key={widget} title="Return on Assets (ROA)" data={trendData} valueKey="roa" color="#93c5fd" compact benchmarkValue={getBenchmarkValue(benchmarks, 'ROA')} formatter={(v) => (v * 100).toFixed(1) + '%'} />;
                }
                if (widget === 'ROE') {
                  return <LineChart key={widget} title="Return on Equity (ROE)" data={trendData} valueKey="roe" color="#60a5fa" compact benchmarkValue={getBenchmarkValue(benchmarks, 'ROE')} formatter={(v) => (v * 100).toFixed(1) + '%'} />;
                }
                if (widget === 'Interest Coverage') {
                  return <LineChart key={widget} title="Interest Coverage" data={trendData} valueKey="interestCov" color="#8b5cf6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Interest Coverage')} formatter={(v) => v.toFixed(1)} />;
                }
                // Additional Activity Ratios
                if (widget === 'Inventory Turnover') {
                  return <LineChart key={widget} title="Inventory Turnover" data={trendData} valueKey="invTurnover" color="#f59e0b" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Inventory Turnover')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Receivables Turnover') {
                  return <LineChart key={widget} title="Receivables Turnover" data={trendData} valueKey="arTurnover" color="#f97316" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Receivables Turnover')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Payables Turnover') {
                  return <LineChart key={widget} title="Payables Turnover" data={trendData} valueKey="apTurnover" color="#ef4444" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Payables Turnover')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Sales/Working Capital') {
                  return <LineChart key={widget} title="Sales/Working Capital" data={trendData} valueKey="salesWC" color="#06b6d4" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Sales/Working Capital')} formatter={(v) => v.toFixed(1)} />;
                }
                // Additional Coverage Ratios
                if (widget === 'Debt Service Coverage') {
                  return <LineChart key={widget} title="Debt Service Coverage" data={trendData} valueKey="debtSvcCov" color="#a78bfa" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Debt Service Coverage')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Cash Flow to Debt') {
                  return <LineChart key={widget} title="Cash Flow to Debt" data={trendData} valueKey="cfToDebt" color="#c4b5fd" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Cash Flow to Debt')} formatter={(v) => v.toFixed(1)} />;
                }
                // Additional Leverage Ratios
                if (widget === 'Fixed Assets/Net Worth') {
                  return <LineChart key={widget} title="Fixed Assets/Net Worth" data={trendData} valueKey="fixedToNW" color="#f472b6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Fixed Assets/Net Worth')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'Leverage Ratio') {
                  return <LineChart key={widget} title="Leverage Ratio" data={trendData} valueKey="leverage" color="#f9a8d4" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Leverage Ratio')} formatter={(v) => v.toFixed(1)} />;
                }
                // Additional Operating Ratios
                if (widget === 'Total Asset Turnover') {
                  return <LineChart key={widget} title="Total Asset Turnover" data={trendData} valueKey="totalAssetTO" color="#3b82f6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Total Asset Turnover')} formatter={(v) => v.toFixed(1)} />;
                }
                if (widget === 'EBITDA Margin') {
                  const ebitdaBM = getBenchmarkValue(benchmarks, 'EBITDA/Revenue');
                  return <LineChart key={widget} title="EBITDA Margin" data={trendData} valueKey="ebitdaMargin" color="#2563eb" compact yMax={0.5} benchmarkValue={ebitdaBM !== null ? ebitdaBM / 100 : null} formatter={(v) => (v * 100).toFixed(1) + '%'} />;
                }
                if (widget === 'EBIT Margin') {
                  const ebitBM = getBenchmarkValue(benchmarks, 'EBIT/Revenue');
                  return <LineChart key={widget} title="EBIT Margin" data={trendData} valueKey="ebitMargin" color="#1e40af" compact yMax={0.5} benchmarkValue={ebitBM !== null ? ebitBM / 100 : null} formatter={(v) => (v * 100).toFixed(1) + '%'} />;
                }
                // Note: Revenue Trend, Expense Trend, Net Profit Trend, and Gross Margin Trend widgets
                // have been replaced with the Trend Analysis dropdown selections
                
                // Handle Item Trends from dropdown (specific financial metrics)
                const itemTrendFields = ['revenue', 'expense', 'cogsTotal', 'cogsPayroll', 'cogsOwnerPay', 'cogsContractors', 
                  'cogsMaterials', 'cogsCommissions', 'cogsOther', 'salesExpense', 'rent', 'utilities', 'equipment', 
                  'travel', 'professionalFees', 'insurance', 'marketing', 'payroll', 'ownerBasePay', 'ownersRetirement', 
                  'subcontractors', 'interestExpense', 'depreciationAmortization', 'operatingExpenseTotal', 'nonOperatingIncome', 
                  'extraordinaryItems', 'netProfit', 'totalAssets', 'cash', 'ar', 'inventory', 'otherCA', 'tca', 'fixedAssets', 
                  'otherAssets', 'totalLiab', 'ap', 'otherCL', 'tcl', 'ltd', 'totalEquity'];
                
                if (itemTrendFields.includes(widget)) {
                  const title = getTrendItemDisplayName(widget);
                  const isCurrency = !['totalEquity', 'totalLiab', 'totalAssets'].includes(widget) || widget.includes('revenue') || widget.includes('expense') || widget.includes('profit');
                  return (
                    <LineChart 
                      key={widget} 
                      title={title} 
                      data={monthly.map(m => ({ month: m.month, value: m[widget as keyof typeof m] as number || 0 }))} 
                      color="#667eea" 
                      compact 
                      formatter={(v) => isCurrency ? '$' + (v / 1000).toFixed(0) + 'k' : v.toFixed(0)} 
                    />
                  );
                }
                
                // Handle Expense Analysis (% of Revenue) from dropdown
                if (widget.startsWith('Expense % - ')) {
                  const expenseName = widget.replace('Expense % - ', '');
                  const expenseFieldMap: {[key: string]: string} = {
                    'Total Expenses': 'expense',
                    'COGS Total': 'cogsTotal',
                    'OPEX Payroll': 'payroll',
                    'Owners Base Pay': 'ownerBasePay',
                    'Contractors': 'subcontractors',
                    'Professional Services': 'professionalFees',
                    'Insurance': 'insurance',
                    'Rent/Lease': 'rent',
                    'Utilities': 'utilities',
                    'Equipment': 'equipment',
                    'Travel': 'travel',
                    'Sales & Marketing': 'salesExpense',
                    'Other': 'marketing',
                    'Depreciation': 'depreciationAmortization',
                    'Interest': 'interestExpense'
                  };
                  
                  const fieldKey = expenseFieldMap[expenseName];
                  if (fieldKey) {
                    const expensePercentData = monthly.map(m => ({
                      month: m.month,
                      value: m.revenue > 0 ? ((m[fieldKey as keyof typeof m] as number || 0) / m.revenue * 100) : 0
                    }));
                    
                    // Get goal line data if available
                    const goalLineData = expenseGoals[fieldKey] ? monthly.map(() => expenseGoals[fieldKey]) : undefined;
                    
                    return (
                      <LineChart 
                        key={widget} 
                        title={`${expenseName} (% of Revenue)`}
                        data={expensePercentData} 
                        color="#ef4444" 
                        compact 
                        formatter={(v) => v.toFixed(1) + '%'}
                        goalLineData={goalLineData}
                      />
                    );
                  }
                }
                
                if (widget === 'Days Receivables') {
                  return <LineChart key={widget} title="Days' Receivables" data={trendData} valueKey="daysAR" color="#fb923c" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Days Receivables')} formatter={(v) => v.toFixed(0)} />;
                }
                if (widget === 'Days Inventory') {
                  return <LineChart key={widget} title="Days' Inventory" data={trendData} valueKey="daysInv" color="#fbbf24" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Days Inventory')} formatter={(v) => v.toFixed(0)} />;
                }
                if (widget === 'Days Payables') {
                  return <LineChart key={widget} title="Days' Payables" data={trendData} valueKey="daysAP" color="#f87171" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Days Payables')} formatter={(v) => v.toFixed(0)} />;
                }
                if (widget === 'Operating Cash Flow') {
                  return <LineChart key={widget} title="Operating Cash Flow" data={monthly} valueKey="netProfit" color="#10b981" compact formatter={(v) => '$' + (v / 1000).toFixed(0) + 'k'} />;
                }
                if (widget === 'Free Cash Flow') {
                  const fcfData = monthly.map(d => ({
                    month: d.month,
                    value: d.netProfit - (d.fixedAssets > 0 ? d.fixedAssets * 0.1 : 0) // Simplified FCF
                  }));
                  return <LineChart key={widget} title="Free Cash Flow" data={fcfData} color="#06b6d4" compact formatter={(v) => '$' + (v / 1000).toFixed(0) + 'k'} />;
                }
                if (widget === 'Cash Position') {
                  return <LineChart key={widget} title="Cash Position" data={monthly} valueKey="cash" color="#f59e0b" compact formatter={(v) => '$' + (v / 1000).toFixed(0) + 'k'} />;
                }
                if (widget === 'Working Capital Trend') {
                  // Holt-Winters Exponential Smoothing with Seasonality
                  const holtWintersProjection = (data: number[], seasons: number = 12, periods: number = 12) => {
                    if (data.length < seasons * 2) return [];
                    
                    // Initialize parameters
                    const alpha = 0.3; // Level smoothing
                    const beta = 0.1;  // Trend smoothing
                    const gamma = 0.3; // Seasonal smoothing
                    
                    // Initial values
                    let level = data.slice(0, seasons).reduce((a, b) => a + b) / seasons;
                    let trend = 0;
                    const seasonal: number[] = [];
                    
                    // Initialize seasonal factors
                    for (let i = 0; i < seasons; i++) {
                      seasonal[i] = data[i] / level;
                    }
                    
                    // Fit the model
                    for (let i = seasons; i < data.length; i++) {
                      const oldLevel = level;
                      const seasonalIndex = i % seasons;
                      
                      level = alpha * (data[i] / seasonal[seasonalIndex]) + (1 - alpha) * (oldLevel + trend);
                      trend = beta * (level - oldLevel) + (1 - beta) * trend;
                      seasonal[seasonalIndex] = gamma * (data[i] / level) + (1 - gamma) * seasonal[seasonalIndex];
                    }
                    
                    // Generate forecasts
                    const forecasts: number[] = [];
                    for (let i = 0; i < periods; i++) {
                      const seasonalIndex = (data.length + i) % seasons;
                      forecasts.push((level + (i + 1) * trend) * seasonal[seasonalIndex]);
                    }
                    
                    return forecasts;
                  };
                  
                  // Calculate historical working capital
                  const wcHistorical = monthly.map(m => {
                    const ca = m.tca || ((m.cash || 0) + (m.ar || 0) + (m.inventory || 0) + (m.otherCA || 0));
                    const cl = m.tcl || ((m.ap || 0) + (m.otherCL || 0));
                    return {
                      month: m.month,
                      value: ca - cl,
                      tca: ca,
                      tcl: cl
                    };
                  });
                  
                  // Use last 36 months (3 years) for projection if available
                  const historicalData = wcHistorical.slice(-36);
                  
                  // Extract TCA and TCL arrays
                  const tcaValues = historicalData.map(d => d.tca);
                  const tclValues = historicalData.map(d => d.tcl);
                  
                  // Project TCA and TCL separately
                  const tcaProjections = holtWintersProjection(tcaValues, 12, 12);
                  const tclProjections = holtWintersProjection(tclValues, 12, 12);
                  
                  // Calculate projected working capital
                  const wcProjections = tcaProjections.map((tca, i) => tca - tclProjections[i]);
                  
                  // Generate month labels for projections
                  const lastMonth = new Date(historicalData[historicalData.length - 1].month);
                  const projectedMonths = Array.from({ length: 12 }, (_, i) => {
                    const date = new Date(lastMonth);
                    date.setMonth(date.getMonth() + i + 1);
                    return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
                  });
                  
                  const projectedData = projectedMonths.map((month, i) => ({
                    month,
                    value: wcProjections[i]
                  }));
                  
                  return (
                    <div key={widget} style={{ gridColumn: '1 / -1' }}>
                      <ProjectionChart 
                        title="Working Capital Trend & 12-Month Projection" 
                        historicalData={wcHistorical}
                        projectedData={{
                          mostLikely: projectedData,
                          bestCase: projectedData.map(d => ({ ...d, value: d.value * 1.1 })),
                          worstCase: projectedData.map(d => ({ ...d, value: d.value * 0.9 }))
                        }}
                        valueKey="value"
                        formatValue={(v) => '$' + (v / 1000).toFixed(0) + 'k'}
                      />
                    </div>
                  );
                }
                
                return null;
                  })();
                });
                
                return renderedWidgets;
              })()}
            </div>
          )}
        </div>
      )}

      {/* KPI Dashboard View */}
      {currentView === 'kpis' && selectedCompanyId && trendData.length > 0 && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <style>{`
            @media print {
              @page {
                size: letter;
                margin: 0.375in 0.375in 0.75in 0.375in;
              }
              
              /* Hide navigation and UI elements */
              .no-print,
              header,
              nav,
              aside,
              [role="navigation"],
              button {
                display: none !important;
              }
              
              /* Show print header */
              .print-header {
                display: block !important;
              }
              
              /* Scale down charts proportionally and adjust spacing */
              .priority-ratios-print-content > div:last-child {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0px !important;
                row-gap: 0px !important;
              }
              
              .priority-ratios-print-content > div:last-child > div {
                transform: scale(0.75);
                transform-origin: top left;
                width: 133%;
                height: 265px;
                overflow: visible;
              }
              
              /* First row */
              .priority-ratios-print-content > div:last-child > div:nth-child(1),
              .priority-ratios-print-content > div:last-child > div:nth-child(2) {
                margin-bottom: 0px;
              }
              
              /* Second row */
              .priority-ratios-print-content > div:last-child > div:nth-child(3),
              .priority-ratios-print-content > div:last-child > div:nth-child(4) {
                margin-bottom: 0px;
              }
              
              /* Third row */
              .priority-ratios-print-content > div:last-child > div:nth-child(5),
              .priority-ratios-print-content > div:last-child > div:nth-child(6) {
                margin-bottom: 0;
              }
            }
            
            .print-header {
              display: none;
            }
          `}</style>
          <div className="no-print" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Ratios</h1>
            {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
          </div>
          
          {/* Benchmark Status Indicator */}
          {benchmarks.length > 0 ? (
            <div className="no-print" style={{ background: '#d1fae5', border: '1px solid #10b981', borderRadius: '8px', padding: '12px', marginBottom: '12px', fontSize: '13px', color: '#065f46' }}>
              ? Industry benchmarks loaded: {benchmarks.length} metrics for {benchmarks[0]?.industryName || 'Unknown Industry'} ({benchmarks[0]?.assetSizeCategory || 'N/A'})
            </div>
          ) : (
            <div className="no-print" style={{ background: '#fef2f2', border: '1px solid #ef4444', borderRadius: '8px', padding: '12px', marginBottom: '12px', fontSize: '13px', color: '#991b1b' }}>
              âš ï¸ No industry benchmarks loaded. {!getCurrentCompany()?.industrySector ? 'Please set the industry sector in Company Details.' : 'Benchmarks may not be available for this industry.'}
            </div>
          )}

          {/* Tab Navigation */}
          <div className="no-print" style={{ display: 'flex', gap: '8px', marginBottom: '32px', borderBottom: '2px solid #e2e8f0' }}>
            <button
              onClick={() => setKpiDashboardTab('all-ratios')}
              style={{
                padding: '12px 24px',
                background: kpiDashboardTab === 'all-ratios' ? '#667eea' : 'transparent',
                color: kpiDashboardTab === 'all-ratios' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: kpiDashboardTab === 'all-ratios' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Ratio Graphs
            </button>
            <button
              onClick={() => setKpiDashboardTab('priority-ratios')}
              style={{
                padding: '12px 24px',
                background: kpiDashboardTab === 'priority-ratios' ? '#667eea' : 'transparent',
                color: kpiDashboardTab === 'priority-ratios' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: kpiDashboardTab === 'priority-ratios' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Priority Ratios
            </button>
            <button
              onClick={() => setKpiDashboardTab('monthly-ratios')}
              style={{
                padding: '12px 24px',
                background: kpiDashboardTab === 'monthly-ratios' ? '#667eea' : 'transparent',
                color: kpiDashboardTab === 'monthly-ratios' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: kpiDashboardTab === 'monthly-ratios' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Monthly Ratios by Category
            </button>
          </div>

          {/* Ratio Graphs Tab */}
          {kpiDashboardTab === 'all-ratios' && (
            <>
              <div style={{ marginBottom: '32px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Liquidity Ratios</h2>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                  <LineChart title="Current Ratio" data={trendData} valueKey="currentRatio" color="#10b981" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Current Ratio')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Current Ratio')} />
                  <LineChart title="Quick Ratio" data={trendData} valueKey="quickRatio" color="#14b8a6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Quick Ratio')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Quick Ratio')} />
                </div>
              </div>

              <div style={{ marginBottom: '32px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Activity Ratios</h2>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                  <LineChart title="Inventory Turnover" data={trendData} valueKey="invTurnover" color="#f59e0b" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Inventory Turnover')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Inventory Turnover')} />
                  <LineChart title="Receivables Turnover" data={trendData} valueKey="arTurnover" color="#f97316" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Receivables Turnover')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Receivables Turnover')} />
                  <LineChart title="Payables Turnover" data={trendData} valueKey="apTurnover" color="#ef4444" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Payables Turnover')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Payables Turnover')} />
                  <LineChart title="Days' Inventory" data={trendData} valueKey="daysInv" color="#fbbf24" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Days Inventory')} formatter={(v) => v.toFixed(0)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Days\' Inventory')} />
                  <LineChart title="Days' Receivables" data={trendData} valueKey="daysAR" color="#fb923c" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Days Receivables')} formatter={(v) => v.toFixed(0)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Days\' Receivables')} />
                  <LineChart title="Days' Payables" data={trendData} valueKey="daysAP" color="#f87171" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Days Payables')} formatter={(v) => v.toFixed(0)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Days\' Payables')} />
                  <LineChart title="Sales/Working Capital" data={trendData} valueKey="salesWC" color="#06b6d4" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Sales/Working Capital')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Sales/Working Capital')} />
                </div>
              </div>

              <div style={{ marginBottom: '32px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Coverage Ratios</h2>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                  <LineChart title="Interest Coverage" data={trendData} valueKey="interestCov" color="#8b5cf6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Interest Coverage')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Interest Coverage')} />
                  <LineChart title="Debt Service Coverage" data={trendData} valueKey="debtSvcCov" color="#a78bfa" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Debt Service Coverage')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Debt Service Coverage')} />
                  <LineChart title="Cash Flow to Debt" data={trendData} valueKey="cfToDebt" color="#c4b5fd" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Cash Flow to Debt')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Cash Flow to Debt')} />
                </div>
              </div>

              <div style={{ marginBottom: '32px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Leverage Ratios</h2>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                  <LineChart title="Debt/Net Worth" data={trendData} valueKey="debtToNW" color="#ec4899" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Debt/Net Worth')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Debt/Net Worth')} />
                  <LineChart title="Fixed Assets/Net Worth" data={trendData} valueKey="fixedToNW" color="#f472b6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Fixed Assets/Net Worth')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Fixed Assets/Net Worth')} />
                  <LineChart title="Leverage Ratio" data={trendData} valueKey="leverage" color="#f9a8d4" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Leverage Ratio')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Leverage Ratio')} />
                </div>
              </div>

              <div style={{ marginBottom: '32px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>Operating Ratios</h2>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                  <LineChart title="Total Asset Turnover" data={trendData} valueKey="totalAssetTO" color="#3b82f6" compact benchmarkValue={getBenchmarkValue(benchmarks, 'Total Asset Turnover')} formatter={(v) => v.toFixed(1)} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Total Asset Turnover')} />
                  <LineChart title="Return on Equity (ROE)" data={trendData} valueKey="roe" color="#60a5fa" compact benchmarkValue={getBenchmarkValue(benchmarks, 'ROE')} formatter={(v) => (v * 100).toFixed(1) + '%'} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Return on Equity (ROE)')} />
                  <LineChart title="Return on Assets (ROA)" data={trendData} valueKey="roa" color="#93c5fd" compact benchmarkValue={getBenchmarkValue(benchmarks, 'ROA')} formatter={(v) => (v * 100).toFixed(1) + '%'} showFormulaButton onFormulaClick={() => setShowFormulaPopup('Return on Assets (ROA)')} />
                  <LineChart title="EBITDA Margin" data={trendData} valueKey="ebitdaMargin" color="#2563eb" compact yMax={0.5} benchmarkValue={(() => { const bm = getBenchmarkValue(benchmarks, 'EBITDA/Revenue'); return bm !== null ? bm / 100 : null; })()} formatter={(v) => (v * 100).toFixed(1) + '%'} showFormulaButton onFormulaClick={() => setShowFormulaPopup('EBITDA Margin')} />
                  <LineChart title="EBIT Margin" data={trendData} valueKey="ebitMargin" color="#1e40af" compact yMax={0.5} benchmarkValue={(() => { const bm = getBenchmarkValue(benchmarks, 'EBIT/Revenue'); return bm !== null ? bm / 100 : null; })()} formatter={(v) => (v * 100).toFixed(1) + '%'} showFormulaButton onFormulaClick={() => setShowFormulaPopup('EBIT Margin')} />
                </div>
              </div>
            </>
          )}

          {/* Priority Ratios Tab */}
          {kpiDashboardTab === 'priority-ratios' && (
            <div>
              <div className="no-print" style={{ marginBottom: '12px', padding: '20px', background: '#f8fafc', borderRadius: '12px', border: '1px solid #e2e8f0' }}>
                <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Customize Your Priority Ratios</h3>
                <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '16px' }}>
                  Select up to 6 ratios to track as your priority KPIs. These selections will be saved and persist across sessions.
                </p>
                {/* Updated layout - more compact and horizontal */}
                
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px', marginBottom: '16px' }}>
                  {Object.entries(ratioCategories).map(([category, ratios]) => (
                    <div key={category} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <label style={{ fontSize: '12px', fontWeight: '600', color: '#374151', whiteSpace: 'nowrap' }}>
                        {category}:
                      </label>
                      <select
                        value={priorityRatios.find(ratio => ratios.includes(ratio)) || ''}
                        onChange={(e) => {
                          const newRatio = e.target.value;
                          if (newRatio) {
                            const currentRatioFromCategory = priorityRatios.find(ratio => ratios.includes(ratio));
                            if (currentRatioFromCategory) {
                              // Replace existing ratio from this category
                              setPriorityRatios(prev => prev.map(ratio => 
                                ratio === currentRatioFromCategory ? newRatio : ratio
                              ));
                            } else if (priorityRatios.length < 6) {
                              // Add new ratio if under limit
                              setPriorityRatios(prev => [...prev, newRatio]);
                            } else {
                              alert('Maximum of 6 priority ratios allowed. Please remove one first.');
                            }
                          }
                        }}
                        style={{
                          padding: '6px 8px',
                          border: '1px solid #d1d5db',
                          borderRadius: '4px',
                          fontSize: '12px',
                          background: 'white',
                          minWidth: '140px'
                        }}
                      >
                        <option value="">Select...</option>
                        {ratios.map(ratio => (
                          <option key={ratio} value={ratio}>
                            {ratio}
                          </option>
                        ))}
                      </select>
                    </div>
                  ))}
                </div>

                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div style={{ fontSize: '12px', color: '#64748b' }}>
                    Selected: {priorityRatios.length}/6 ratios
                  </div>
                  <button
                    onClick={savePriorityRatios}
                    style={{
                      padding: '6px 12px',
                      background: '#667eea',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      fontSize: '12px',
                      fontWeight: '600',
                      cursor: 'pointer'
                    }}
                  >
                    Save
                  </button>
                </div>
              </div>

              {/* Display Selected Priority Ratios */}
              {priorityRatios.length > 0 && (
                <div>
                  <div className="no-print" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', margin: 0 }}>
                      Your Priority Ratios ({priorityRatios.length}/6)
                    </h3>
                    <button
                      onClick={() => window.print()}
                      style={{
                        padding: '10px 20px',
                        background: '#10b981',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}
                    >
                      ðŸ–¨ï¸ Print Priority Ratios
                    </button>
                  </div>
                  <div className="priority-ratios-print-content">
                    <div className="print-header" style={{ display: 'none' }}>
                      <h1 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '12px', marginTop: '0', textAlign: 'center' }}>
                        Priority Ratios {companyName && `- ${companyName}`}
                      </h1>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                    {priorityRatios.map((ratio, index) => (
                      <div key={ratio} style={{ position: 'relative' }}>
                        <LineChart
                          title={ratio}
                          data={trendData}
                          valueKey={getRatioValueKey(ratio)}
                          color={getRatioColor(ratio)}
                          compact
                          benchmarkValue={getBenchmarkValue(benchmarks, ratio)}
                          formatter={getRatioFormatter(ratio)}
                          showFormulaButton
                          onFormulaClick={() => setShowFormulaPopup(ratio)}
                        />
                        <button
                          onClick={() => setPriorityRatios(prev => prev.filter((_, i) => i !== index))}
                          className="no-print"
                          style={{
                            position: 'absolute',
                            top: '8px',
                            right: '8px',
                            background: '#ef4444',
                            color: 'white',
                            border: 'none',
                            borderRadius: '50%',
                            width: '24px',
                            height: '24px',
                            fontSize: '12px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                          }}
                        >
                          Ã—
                        </button>
                      </div>
                    ))}
                    </div>
                  </div>
                </div>
              )}

              {priorityRatios.length === 0 && (
                <div style={{ textAlign: 'center', padding: '60px', color: '#64748b' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>ðŸ“Š</div>
                  <h3 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '8px' }}>No Priority Ratios Selected</h3>
                  <p>Select ratios from the dropdowns above to create your custom KPI dashboard.</p>
                </div>
              )}
            </div>
          )}

          {/* Monthly Ratios by Category Tab */}
          {kpiDashboardTab === 'monthly-ratios' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '12px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', margin: 0 }}>
                  Financial Ratios Overview
                </h2>
                <button
                  onClick={() => exportMonthlyRatiosToExcel(trendData, companyName)}
                  style={{
                    background: '#10b981',
                    color: 'white',
                    border: 'none',
                    padding: '10px 20px',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    transition: 'all 0.2s'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.background = '#059669'}
                  onMouseOut={(e) => e.currentTarget.style.background = '#10b981'}
                >
                  ðŸ“Š Export to Excel
                </button>
              </div>
              
              {/* Liquidity Ratios */}
              <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px', marginTop: '24px' }}>Liquidity Ratios</h3>
              <div style={{ overflowX: 'auto', marginBottom: '12px' }}>
                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                      <th style={{ textAlign: 'left', padding: '8px', fontSize: '12px', fontWeight: '600', color: '#64748b', minWidth: '120px' }}>Ratio</th>
                      {trendData.slice(-12).map((data, i) => (
                        <th key={i} style={{ textAlign: 'right', padding: '8px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '60px' }}>
                          {data.month.substring(0, data.month.lastIndexOf('/'))}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Current Ratio</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.currentRatio !== undefined ? data.currentRatio.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Quick Ratio</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.quickRatio !== undefined ? data.quickRatio.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* Activity Ratios */}
              <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px', marginTop: '24px' }}>Activity Ratios</h3>
              <div style={{ overflowX: 'auto', marginBottom: '12px' }}>
                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                      <th style={{ textAlign: 'left', padding: '8px', fontSize: '12px', fontWeight: '600', color: '#64748b', minWidth: '120px' }}>Ratio</th>
                      {trendData.slice(-12).map((data, i) => (
                        <th key={i} style={{ textAlign: 'right', padding: '8px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '60px' }}>
                          {data.month.substring(0, data.month.lastIndexOf('/'))}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Inventory Turnover</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.invTurnover !== undefined ? data.invTurnover.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Receivables Turnover</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.arTurnover !== undefined ? data.arTurnover.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Payables Turnover</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.apTurnover !== undefined ? data.apTurnover.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Days Inventory</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.daysInv !== undefined ? data.daysInv.toFixed(0) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Days Receivables</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.daysAR !== undefined ? data.daysAR.toFixed(0) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Days Payables</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.daysAP !== undefined ? data.daysAP.toFixed(0) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Sales/Working Capital</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.salesWC !== undefined ? data.salesWC.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* Coverage Ratios */}
              <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px', marginTop: '24px' }}>Coverage Ratios</h3>
              <div style={{ overflowX: 'auto', marginBottom: '12px' }}>
                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                      <th style={{ textAlign: 'left', padding: '8px', fontSize: '12px', fontWeight: '600', color: '#64748b', minWidth: '120px' }}>Ratio</th>
                      {trendData.slice(-12).map((data, i) => (
                        <th key={i} style={{ textAlign: 'right', padding: '8px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '60px' }}>
                          {data.month.substring(0, data.month.lastIndexOf('/'))}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Interest Coverage</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.interestCov !== undefined ? data.interestCov.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Debt Service Coverage</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.debtSvcCov !== undefined ? data.debtSvcCov.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Cash Flow to Debt</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.cfToDebt !== undefined ? data.cfToDebt.toFixed(2) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* Leverage Ratios */}
              <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px', marginTop: '24px' }}>Leverage Ratios</h3>
              <div style={{ overflowX: 'auto', marginBottom: '12px' }}>
                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                      <th style={{ textAlign: 'left', padding: '8px', fontSize: '12px', fontWeight: '600', color: '#64748b', minWidth: '120px' }}>Ratio</th>
                      {trendData.slice(-12).map((data, i) => (
                        <th key={i} style={{ textAlign: 'right', padding: '8px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '60px' }}>
                          {data.month.substring(0, data.month.lastIndexOf('/'))}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Debt/Net Worth</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.debtToNW !== undefined ? data.debtToNW.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Fixed Assets/Net Worth</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.fixedToNW !== undefined ? data.fixedToNW.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Leverage Ratio</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.leverage !== undefined ? data.leverage.toFixed(1) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* Operating Ratios */}
              <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#475569', marginBottom: '12px', marginTop: '24px' }}>Operating Ratios</h3>
              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                      <th style={{ textAlign: 'left', padding: '8px', fontSize: '12px', fontWeight: '600', color: '#64748b', minWidth: '120px' }}>Ratio</th>
                      {trendData.slice(-12).map((data, i) => (
                        <th key={i} style={{ textAlign: 'right', padding: '8px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '60px' }}>
                          {data.month.substring(0, data.month.lastIndexOf('/'))}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>Total Asset Turnover</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.totalAssetTO !== undefined ? data.totalAssetTO.toFixed(2) : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>ROE</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.roe !== undefined ? `${(data.roe * 100).toFixed(1)}%` : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>ROA</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.roa !== undefined ? `${(data.roa * 100).toFixed(1)}%` : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>EBITDA Margin</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.ebitdaMargin !== undefined ? `${(data.ebitdaMargin * 100).toFixed(1)}%` : 'N/A'}
                        </td>
                      ))}
                    </tr>
                    <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px', fontSize: '12px', color: '#475569' }}>EBIT Margin</td>
                      {trendData.slice(-12).map((data, i) => (
                        <td key={i} style={{ padding: '8px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                          {data?.ebitMargin !== undefined ? `${(data.ebitMargin * 100).toFixed(1)}%` : 'N/A'}
                        </td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      )}

      {/* MD&A View */}
      {currentView === 'mda' && selectedCompanyId && trendData.length > 0 && (
        <div className="mda-container" style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <div className="mda-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <div>
              <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: '0 0 8px 0' }}>Management Discussion & Analysis</h1>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button 
                className="no-print"
                onClick={() => {
                  // Force re-render by navigating away and back
                  const currentCompany = selectedCompanyId;
                  setCurrentView('dashboard');
                  setTimeout(() => {
                    setSelectedCompanyId(currentCompany);
                    setCurrentView('mda');
                  }, 10);
                }} 
                style={{ 
                  padding: '12px 24px', 
                  background: '#10b981', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '8px', 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  cursor: 'pointer',
                  boxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#059669'}
                onMouseLeave={(e) => e.currentTarget.style.background = '#10b981'}
              >
                ðŸ”„ Refresh Analysis
              </button>
              <button
                className="no-print"
                onClick={handleExportMdaToWord}
                style={{
                  padding: '12px 24px',
                  background: '#0ea5e9',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  boxShadow: '0 2px 8px rgba(14, 165, 233, 0.3)',
                }}
              >
                ?? Export to Word
              </button>
              <button 
                className="no-print"
                onClick={() => window.print()} 
                style={{ 
                  padding: '12px 24px', 
                  background: '#667eea', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '8px', 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  cursor: 'pointer',
                  boxShadow: '0 2px 8px rgba(102, 126, 234, 0.3)'
                }}>
                ðŸ–¨ï¸ Print
              </button>
              <TextToSpeech 
                targetElementId={
                  mdaTab === 'executive-summary' ? 'mda-executive-summary-container' :
                  mdaTab === 'strengths-insights' ? 'mda-strengths-insights-container' :
                  'mda-key-metrics-container'
                }
                buttonLabel="Listen"
                variant="primary"
                style={{
                  padding: '12px 24px',
                  boxShadow: '0 2px 8px rgba(139, 92, 246, 0.3)'
                }}
              />
            </div>
          </div>
          
          <style>{`
            @media print {
              @page {
                size: portrait;
                margin: 0.5in;
              }
              
              /* Hide navigation and UI elements */
              .no-print,
              header,
              nav,
              aside,
              [role="navigation"] {
                display: none !important;
              }
              
              /* Hide tab navigation buttons */
              button[onclick*="setMdaTab"] {
                display: none !important;
              }
              
              /* Remove box shadows and backgrounds */
              * {
                box-shadow: none !important;
              }
              
              /* Ensure text is readable */
              body, p, li, div {
                color: #000 !important;
              }
              
              h1, h2, h3 {
                page-break-after: avoid;
              }
              
              /* Avoid breaking inside sections */
              div[style*="background: white"] {
                page-break-inside: avoid;
              }
            }
          `}</style>
          
          {/* Tab Navigation */}
          <div className="no-print" style={{ display: 'flex', gap: '8px', marginBottom: '12px', borderBottom: '2px solid #e2e8f0' }}>
            <button
              onClick={() => setMdaTab('executive-summary')}
              style={{
                padding: '12px 24px',
                background: mdaTab === 'executive-summary' ? '#667eea' : 'transparent',
                color: mdaTab === 'executive-summary' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: mdaTab === 'executive-summary' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Executive Summary
            </button>
            <button
              onClick={() => setMdaTab('strengths-insights')}
              style={{
                padding: '12px 24px',
                background: mdaTab === 'strengths-insights' ? '#667eea' : 'transparent',
                color: mdaTab === 'strengths-insights' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: mdaTab === 'strengths-insights' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Strengths and Insights
            </button>
            <button
              onClick={() => setMdaTab('key-metrics')}
              style={{
                padding: '12px 24px',
                background: mdaTab === 'key-metrics' ? '#667eea' : 'transparent',
                color: mdaTab === 'key-metrics' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: mdaTab === 'key-metrics' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Critical Review Items
            </button>
          </div>

          {/* Executive Summary Tab */}
          {mdaTab === 'executive-summary' && (
          <div
            id="mda-executive-summary-container"
            style={{ background: 'white', borderRadius: '12px', padding: '32px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}
          >
            <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '24px', borderBottom: '2px solid #e2e8f0', paddingBottom: '12px' }}>Executive Summary</h2>

            {/* Comprehensive Analysis Narrative */}
            <div style={{ marginBottom: '28px' }}>
              <div style={{ fontSize: '15px', lineHeight: '1.8', color: '#475569', background: '#f8fafc', padding: '20px', borderRadius: '8px', borderLeft: '4px solid #667eea' }}>
                <p style={{ margin: '0 0 12px 0' }}>
                  {(() => {
                    if (monthly.length < 12) return 'Requires 12+ months of data for year-over-year comparisons.';
                    
                    // Current quarter vs 4 quarters ago
                    const currentQ = monthly.slice(-3);
                    const fourQAgo = monthly.length >= 15 ? monthly.slice(-15, -12) : monthly.slice(-6, -3);
                    const currentQRev = currentQ.reduce((sum, m) => sum + m.revenue, 0);
                    const currentQExp = currentQ.reduce((sum, m) => sum + m.expense, 0);
                    const fourQAgoRev = fourQAgo.reduce((sum, m) => sum + m.revenue, 0);
                    const fourQAgoExp = fourQAgo.reduce((sum, m) => sum + m.expense, 0);
                    const qRevChange = fourQAgoRev > 0 ? ((currentQRev - fourQAgoRev) / fourQAgoRev * 100) : 0;
                    const qExpChange = fourQAgoExp > 0 ? ((currentQExp - fourQAgoExp) / fourQAgoExp * 100) : 0;
                    const currentQMargin = currentQRev > 0 ? ((currentQRev - currentQExp) / currentQRev * 100) : 0;
                    const fourQAgoMargin = fourQAgoRev > 0 ? ((fourQAgoRev - fourQAgoExp) / fourQAgoRev * 100) : 0;
                    const qMarginChange = currentQMargin - fourQAgoMargin;
                    
                    // TTM vs prior TTM
                    const last12 = monthly.slice(-12);
                    const prior12 = monthly.length >= 24 ? monthly.slice(-24, -12) : monthly.slice(0, 12);
                    const ttmRev = last12.reduce((sum, m) => sum + m.revenue, 0);
                    const ttmExp = last12.reduce((sum, m) => sum + m.expense, 0);
                    const priorTTMRev = prior12.reduce((sum, m) => sum + m.revenue, 0);
                    const priorTTMExp = prior12.reduce((sum, m) => sum + m.expense, 0);
                    const ttmRevChange = priorTTMRev > 0 ? ((ttmRev - priorTTMRev) / priorTTMRev * 100) : 0;
                    const ttmExpChange = priorTTMExp > 0 ? ((ttmExp - priorTTMExp) / priorTTMExp * 100) : 0;
                    const ttmMargin = ttmRev > 0 ? ((ttmRev - ttmExp) / ttmRev * 100) : 0;
                    const priorTTMMargin = priorTTMRev > 0 ? ((priorTTMRev - priorTTMExp) / priorTTMRev * 100) : 0;
                    const ttmMarginChange = ttmMargin - priorTTMMargin;
                    
                    return (
                      <>
                        <strong>Current quarter</strong> revenue of <strong>{formatDollar(currentQRev)}</strong> represents a {qRevChange > 0 ? 'increase' : 'decrease'} of <strong style={{ color: qRevChange > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(qRevChange).toFixed(1)}%</strong> compared to four quarters ago ({formatDollar(fourQAgoRev)}), 
                        while total expenses of <strong>{formatDollar(currentQExp)}</strong> {qExpChange > 0 ? 'increased' : 'decreased'} by <strong style={{ color: Math.abs(qExpChange) < Math.abs(qRevChange) ? '#10b981' : '#ef4444' }}>{Math.abs(qExpChange).toFixed(1)}%</strong> from {formatDollar(fourQAgoExp)}.
                        Quarterly profit margin {qMarginChange > 0 ? 'expanded' : 'contracted'} by <strong style={{ color: qMarginChange > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(qMarginChange).toFixed(1)}</strong> percentage points to <strong>{currentQMargin.toFixed(1)}%</strong>
                        {qMarginChange > 5 ? <span style={{ color: '#10b981' }}>, reflecting significant margin expansion and improving profitability</span> :
                         qMarginChange > 0 ? <span style={{ color: '#10b981' }}>, indicating positive margin trajectory</span> :
                         qMarginChange > -5 ? <span style={{ color: '#64748b' }}>, maintaining relatively stable profitability</span> :
                         <span style={{ color: '#ef4444' }}>, signaling substantial margin pressure requiring immediate management attention</span>}.
                        {' '}<strong>Trailing twelve months (TTM)</strong> revenue of <strong>{formatDollar(ttmRev)}</strong> shows {ttmRevChange > 0 ? 'growth' : 'decline'} of <strong style={{ color: ttmRevChange > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(ttmRevChange).toFixed(1)}%</strong> compared to the prior twelve-month period ({formatDollar(priorTTMRev)}), 
                        with total expenses of <strong>{formatDollar(ttmExp)}</strong> {ttmExpChange > 0 ? 'growing' : 'declining'} by <strong style={{ color: Math.abs(ttmExpChange) < Math.abs(ttmRevChange) ? '#10b981' : '#ef4444' }}>{Math.abs(ttmExpChange).toFixed(1)}%</strong> from {formatDollar(priorTTMExp)}.
                        Annual profit margin {ttmMarginChange > 0 ? 'improved' : 'deteriorated'} by <strong style={{ color: ttmMarginChange > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(ttmMarginChange).toFixed(1)}</strong> percentage points to <strong>{ttmMargin.toFixed(1)}%</strong>
                        {ttmExpChange < ttmRevChange ? <span style={{ color: '#10b981' }}>, with excellent operational leverage as expense growth is controlled relative to revenue expansion</span> :
                         ttmExpChange > ttmRevChange + 5 ? <span style={{ color: '#ef4444' }}>, indicating concerning expense growth outpacing revenue that requires cost management initiatives</span> :
                         ', maintaining operational efficiency'}.
                      </>
                    );
                  })()}
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Financial Ratios</strong> analysis provides insight into operational performance and financial health:
                  {(() => {
                    const ratioAnalysis = [];
                    
                    // Current Ratio
                    const currentRatioBM = benchmarks.find(b => b.metricName === 'Current Ratio')?.fiveYearValue;
                    if (currentRatioBM && trendData[trendData.length - 1]?.currentRatio) {
                      const actual = trendData[trendData.length - 1].currentRatio;
                      const diff = ((actual / currentRatioBM - 1) * 100);
                      if (Math.abs(diff) > 20) {
                        ratioAnalysis.push(
                          <span key="current-ratio">
                            <strong> Current Ratio</strong> of {actual.toFixed(2)} is <strong style={{ color: diff > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'above' : 'below'}</strong> the industry average of {currentRatioBM.toFixed(2)}
                            {diff > 0 ? ', indicating strong short-term liquidity with ample current assets to cover current liabilities, providing cushion for operational needs' : 
                             ', suggesting potential liquidity constraints that may limit flexibility in meeting short-term obligations'}.
                          </span>
                        );
                      }
                    }
                    
                    // Quick Ratio
                    const quickRatioBM = benchmarks.find(b => b.metricName === 'Quick Ratio')?.fiveYearValue;
                    if (quickRatioBM && trendData[trendData.length - 1]?.quickRatio) {
                      const actual = trendData[trendData.length - 1].quickRatio;
                      const diff = ((actual / quickRatioBM - 1) * 100);
                      if (Math.abs(diff) > 20) {
                        ratioAnalysis.push(
                          <span key="quick-ratio">
                            <strong> Quick Ratio</strong> of {actual.toFixed(2)} stands <strong style={{ color: diff > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'above' : 'below'}</strong> industry norms of {quickRatioBM.toFixed(2)}
                            {diff > 0 ? ', demonstrating excellent immediate liquidity with liquid assets readily available to meet urgent obligations without relying on inventory conversion' :
                             ', indicating the company may face challenges meeting immediate obligations from liquid assets alone, potentially requiring inventory liquidation or external financing'}.
                          </span>
                        );
                      }
                    }
                    
                    // Debt to Net Worth
                    const debtToNWBM = benchmarks.find(b => b.metricName === 'Total Debt to Net Worth Ratio')?.fiveYearValue;
                    if (debtToNWBM && trendData[trendData.length - 1]?.debtToNW) {
                      const actual = trendData[trendData.length - 1].debtToNW;
                      const diff = ((actual / debtToNWBM - 1) * 100);
                      if (Math.abs(diff) > 30) {
                        ratioAnalysis.push(
                          <span key="debt-nw">
                            <strong> Debt-to-Net Worth</strong> ratio of {actual.toFixed(2)} is <strong style={{ color: diff < 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'above' : 'below'}</strong> industry average of {debtToNWBM.toFixed(2)}
                            {diff < 0 ? ', reflecting conservative capital structure with lower financial leverage, which reduces financial risk but may indicate underutilization of debt financing opportunities' :
                             ', indicating aggressive leverage that increases financial risk, amplifies return volatility, and may constrain future borrowing capacity or increase financing costs'}.
                          </span>
                        );
                      }
                    }
                    
                    // ROE
                    const roeBM = benchmarks.find(b => b.metricName === 'Return on Net Worth %')?.fiveYearValue;
                    if (roeBM && trendData[trendData.length - 1]?.roe) {
                      const actualROE = trendData[trendData.length - 1].roe * 100;
                      const diff = ((actualROE / roeBM - 1) * 100);
                      if (Math.abs(diff) > 20) {
                        ratioAnalysis.push(
                          <span key="roe">
                            <strong> Return on Equity</strong> of {actualROE.toFixed(1)}% is <strong style={{ color: diff > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'above' : 'below'}</strong> industry benchmark of {roeBM.toFixed(1)}%
                            {diff > 0 ? ', demonstrating superior profitability and efficient use of shareholder capital, suggesting strong competitive positioning and effective management execution' :
                             ', indicating below-average returns on equity investment, which may signal operational inefficiencies, margin pressures, or suboptimal capital deployment'}.
                          </span>
                        );
                      }
                    }
                    
                    // ROA
                    const roaBM = benchmarks.find(b => b.metricName === 'Return on Total Assets %')?.fiveYearValue;
                    if (roaBM && trendData[trendData.length - 1]?.roa) {
                      const actualROA = trendData[trendData.length - 1].roa * 100;
                      const diff = ((actualROA / roaBM - 1) * 100);
                      if (Math.abs(diff) > 20) {
                        ratioAnalysis.push(
                          <span key="roa">
                            <strong> Return on Assets</strong> of {actualROA.toFixed(1)}% is <strong style={{ color: diff > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'above' : 'below'}</strong> industry norm of {roaBM.toFixed(1)}%
                            {diff > 0 ? ', reflecting efficient asset utilization and strong operational performance in converting invested capital into profits' :
                             ', suggesting assets are generating below-average returns, potentially indicating overcapitalization, underutilized capacity, or operational inefficiencies'}.
                          </span>
                        );
                      }
                    }
                    
                    // Asset Turnover
                    const assetTOBM = benchmarks.find(b => b.metricName === 'Total Asset Turnover')?.fiveYearValue;
                    if (assetTOBM && trendData[trendData.length - 1]?.totalAssetTO) {
                      const actual = trendData[trendData.length - 1].totalAssetTO;
                      const diff = ((actual / assetTOBM - 1) * 100);
                      if (Math.abs(diff) > 20) {
                        ratioAnalysis.push(
                          <span key="asset-to">
                            <strong> Asset Turnover</strong> of {actual.toFixed(2)} is <strong style={{ color: diff > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'higher than' : 'lower than'}</strong> industry average of {assetTOBM.toFixed(2)}
                            {diff > 0 ? ', indicating efficient revenue generation per dollar of assets, suggesting effective asset management and strong sales productivity' :
                             ', reflecting lower revenue generation efficiency, which may indicate excess asset investments, idle capacity, or need for improved asset utilization strategies'}.
                          </span>
                        );
                      }
                    }
                    
                    // Days Receivables
                    const daysARBM = benchmarks.find(b => b.metricName === "Days' Receivables")?.fiveYearValue;
                    if (daysARBM && trendData[trendData.length - 1]?.daysAR > 0) {
                      const actual = trendData[trendData.length - 1].daysAR;
                      const diff = ((actual / daysARBM - 1) * 100);
                      if (Math.abs(diff) > 20) {
                        ratioAnalysis.push(
                          <span key="days-ar">
                            <strong> Days Receivables</strong> of {actual.toFixed(0)} days is <strong style={{ color: diff < 0 ? '#10b981' : '#ef4444' }}>{Math.abs(diff).toFixed(0)}% {diff > 0 ? 'slower' : 'faster'}</strong> than industry average of {daysARBM.toFixed(0)} days
                            {diff < 0 ? ', demonstrating strong collections processes and efficient working capital management, freeing up cash for operations' :
                             ', indicating collection challenges that tie up working capital, potentially reflecting lenient credit terms, weak collection procedures, or customer payment difficulties'}.
                          </span>
                        );
                      }
                    }
                    
                    if (ratioAnalysis.length === 0) {
                      return <span> The company's key financial ratios are generally in line with industry benchmarks, indicating balanced financial performance across liquidity, leverage, profitability, and efficiency metrics.</span>;
                    }
                    
                    return ratioAnalysis;
                  })()}.
                  {benchmarks.length > 0 ? (() => {
                    const comparisons = [];
                    let aboveCount = 0;
                    let belowCount = 0;
                    
                    // Check Current Ratio
                    const currentRatioBM = benchmarks.find(b => b.metricName === 'Current Ratio')?.fiveYearValue;
                    if (currentRatioBM && trendData[trendData.length - 1]?.currentRatio) {
                      if (trendData[trendData.length - 1].currentRatio > currentRatioBM * 1.2) aboveCount++;
                      else if (trendData[trendData.length - 1].currentRatio < currentRatioBM * 0.8) belowCount++;
                    }
                    
                    // Check Quick Ratio
                    const quickRatioBM = benchmarks.find(b => b.metricName === 'Quick Ratio')?.fiveYearValue;
                    if (quickRatioBM && trendData[trendData.length - 1]?.quickRatio) {
                      if (trendData[trendData.length - 1].quickRatio > quickRatioBM * 1.2) aboveCount++;
                      else if (trendData[trendData.length - 1].quickRatio < quickRatioBM * 0.8) belowCount++;
                    }
                    
                    // Check Debt-to-NW (lower is better)
                    const debtToNWBM = benchmarks.find(b => b.metricName === 'Total Debt to Net Worth Ratio')?.fiveYearValue;
                    if (debtToNWBM && trendData[trendData.length - 1]?.debtToNW) {
                      if (trendData[trendData.length - 1].debtToNW < debtToNWBM * 0.7) aboveCount++;
                      else if (trendData[trendData.length - 1].debtToNW > debtToNWBM * 1.3) belowCount++;
                    }
                    
                    // Check ROE
                    const roeBM = benchmarks.find(b => b.metricName === 'Return on Net Worth %')?.fiveYearValue;
                    if (roeBM && trendData[trendData.length - 1]?.roe) {
                      if ((trendData[trendData.length - 1].roe * 100) > roeBM * 1.2) aboveCount++;
                      else if ((trendData[trendData.length - 1].roe * 100) < roeBM * 0.8) belowCount++;
                    }
                    
                    // Check ROA
                    const roaBM = benchmarks.find(b => b.metricName === 'Return on Total Assets %')?.fiveYearValue;
                    if (roaBM && trendData[trendData.length - 1]?.roa) {
                      if ((trendData[trendData.length - 1].roa * 100) > roaBM * 1.2) aboveCount++;
                      else if ((trendData[trendData.length - 1].roa * 100) < roaBM * 0.8) belowCount++;
                    }
                    
                    const totalCompared = aboveCount + belowCount;
                    if (totalCompared > 0) {
                      return <span> Overall, the company {aboveCount > belowCount ? <strong style={{ color: '#10b981' }}>outperforms</strong> : aboveCount < belowCount ? <strong style={{ color: '#ef4444' }}>underperforms</strong> : 'performs comparably to'} industry benchmarks in {aboveCount} of the key ratios shown above{belowCount > 0 ? `, with ${belowCount} areas below industry standards requiring attention` : ', demonstrating strong financial management'}.</span>;
                    }
                    return ` Industry benchmarks from ${benchmarks.length} metrics provide context for performance assessment.`;
                  })() : ''}
                  {trendData.length >= 12 && (() => {
                    // Analyze ALL ratio trends over time with 5% threshold
                    const currentRatios = trendData[trendData.length - 1];
                    const year1AgoIdx = trendData.length >= 13 ? trendData.length - 13 : 0;
                    const ratios1YrAgo = trendData[year1AgoIdx];
                    
                    const trendInsights = [];
                    let decliningCount = 0;
                    let improvingCount = 0;
                    
                    // Helper function to analyze ratio trends
                    const analyzeRatio = (ratioName: string, currentVal: number | undefined, priorVal: number | undefined, config: {
                      isPercentage?: boolean,
                      lowerIsBetter?: boolean,
                      declineVerb?: string,
                      improveVerb?: string,
                      declineContext?: string,
                      improveContext?: string
                    }) => {
                      if (!currentVal || !priorVal || priorVal === 0) return;
                      
                const change = ((currentVal - priorVal) / Math.abs(priorVal)) * 100;
                if (Math.abs(change) <= 5) return; // Only flag changes > 5%
                      
                      const isImproving = config.lowerIsBetter ? (change < 0) : (change > 0);
                      const direction = config.lowerIsBetter ? 
                        (change < 0 ? (config.improveVerb || 'decreased') : (config.declineVerb || 'increased')) :
                        (change > 0 ? (config.improveVerb || 'improved') : (config.declineVerb || 'declined'));
                      const color = isImproving ? '#10b981' : '#ef4444';
                      const context = isImproving ? (config.improveContext || '') : (config.declineContext || '');
                      
                      if (isImproving) improvingCount++;
                      else decliningCount++;
                      
                      const displayCurrent = config.isPercentage ? `${(currentVal * 100).toFixed(1)}%` : currentVal.toFixed(2);
                      const displayPrior = config.isPercentage ? `${(priorVal * 100).toFixed(1)}%` : priorVal.toFixed(2);
                      
                      trendInsights.push(
                        <span key={ratioName}>
                          <strong> {ratioName}</strong> has <strong style={{ color }}>{direction}</strong> by <strong style={{ color }}>{Math.abs(change).toFixed(1)}%</strong> year-over-year from {displayPrior} to {displayCurrent}{context}.
                        </span>
                      );
                    };
                    
                    // Analyze all available ratios
                    analyzeRatio('Current Ratio', currentRatios?.currentRatio, ratios1YrAgo?.currentRatio, {
                      improveVerb: 'increased',
                      declineVerb: 'declined',
                      declineContext: ' (suggesting either decreasing current assets or increasing current liabilities, which may indicate tightening liquidity or growing short-term obligations)',
                      improveContext: ' (indicating improving short-term liquidity position with strengthening ability to meet current obligations)'
                    });
                    
                    analyzeRatio('Quick Ratio', currentRatios?.quickRatio, ratios1YrAgo?.quickRatio, {
                      improveVerb: 'improved',
                      declineVerb: 'deteriorated',
                      declineContext: ' (indicating potential challenges in immediate liquidity, cash position, or receivables collection)',
                      improveContext: ' (demonstrating stronger immediate liquidity and cash management)'
                    });
                    
                    analyzeRatio('Debt-to-Net Worth', currentRatios?.debtToNW, ratios1YrAgo?.debtToNW, {
                      lowerIsBetter: true,
                      improveVerb: 'decreased',
                      declineVerb: 'increased',
                      declineContext: ' (reflecting higher leverage and increased financial risk)',
                      improveContext: ' (demonstrating deleveraging and improved financial stability)'
                    });
                    
                    analyzeRatio('Return on Equity', currentRatios?.roe, ratios1YrAgo?.roe, {
                      isPercentage: true,
                      improveVerb: 'improved',
                      declineVerb: 'declined',
                      declineContext: ' (indicating reduced profitability relative to equity base)',
                      improveContext: ' (showing stronger returns on equity investment)'
                    });
                    
                    analyzeRatio('Return on Assets', currentRatios?.roa, ratios1YrAgo?.roa, {
                      isPercentage: true,
                      improveVerb: 'strengthened',
                      declineVerb: 'weakened',
                      declineContext: ' (suggesting declining asset efficiency or profitability)',
                      improveContext: ' (indicating improved asset utilization and profitability)'
                    });
                    
                    analyzeRatio('Asset Turnover', currentRatios?.totalAssetTO, ratios1YrAgo?.totalAssetTO, {
                      improveVerb: 'increased',
                      declineVerb: 'decreased',
                      declineContext: ' (indicating assets are generating less revenue, possibly due to overcapitalization or declining sales efficiency)',
                      improveContext: ' (showing improved revenue generation per dollar of assets)'
                    });
                    
                    analyzeRatio('Inventory Turnover', currentRatios?.invTO, ratios1YrAgo?.invTO, {
                      improveVerb: 'accelerated',
                      declineVerb: 'slowed',
                      declineContext: ' (suggesting slower inventory movement, potential obsolescence, or overstocking)',
                      improveContext: ' (indicating more efficient inventory management and faster product movement)'
                    });
                    
                    analyzeRatio('Receivables Turnover', currentRatios?.arTO, ratios1YrAgo?.arTO, {
                      improveVerb: 'accelerated',
                      declineVerb: 'slowed',
                      declineContext: ' (indicating slower collections or customer payment challenges)',
                      improveContext: ' (demonstrating improved collection efficiency)'
                    });
                    
                    analyzeRatio('Days Receivables', currentRatios?.daysAR, ratios1YrAgo?.daysAR, {
                      lowerIsBetter: true,
                      improveVerb: 'decreased',
                      declineVerb: 'increased',
                      declineContext: ' (reflecting slower collection cycle and working capital tied up in receivables)',
                      improveContext: ' (indicating faster collections and more efficient working capital management)'
                    });
                    
                    analyzeRatio('Days Inventory', currentRatios?.daysInv, ratios1YrAgo?.daysInv, {
                      lowerIsBetter: true,
                      improveVerb: 'decreased',
                      declineVerb: 'increased',
                      declineContext: ' (suggesting inventory is sitting longer before sale)',
                      improveContext: ' (indicating faster inventory turnover)'
                    });
                    
                    analyzeRatio('Days Payables', currentRatios?.daysAP, ratios1YrAgo?.daysAP, {
                      improveVerb: 'increased',
                      declineVerb: 'decreased',
                      declineContext: ' (indicating paying suppliers faster, which may strain cash but could reflect liquidity concerns or discount opportunities)',
                      improveContext: ' (suggesting extended payment terms that improve short-term cash flow)'
                    });
                    
                    analyzeRatio('Interest Coverage', currentRatios?.interestCoverage, ratios1YrAgo?.interestCoverage, {
                      improveVerb: 'strengthened',
                      declineVerb: 'weakened',
                      declineContext: ' (indicating reduced capacity to service debt from operating earnings)',
                      improveContext: ' (demonstrating enhanced ability to cover interest obligations)'
                    });
                    
                    analyzeRatio('EBITDA Margin', currentRatios?.ebitdaMargin, ratios1YrAgo?.ebitdaMargin, {
                      isPercentage: true,
                      improveVerb: 'expanded',
                      declineVerb: 'contracted',
                      declineContext: ' (reflecting margin pressure or declining operational efficiency)',
                      improveContext: ' (indicating improving operational profitability)'
                    });
                    
                    analyzeRatio('Gross Margin', currentRatios?.grossMargin, ratios1YrAgo?.grossMargin, {
                      isPercentage: true,
                      improveVerb: 'expanded',
                      declineVerb: 'contracted',
                      declineContext: ' (suggesting pricing pressure, rising input costs, or unfavorable product mix)',
                      improveContext: ' (indicating improved pricing power or cost management)'
                    });
                    
                    if (trendInsights.length > 0) {
                      return (
                        <span>
                          <strong> Ratio trend analysis</strong> over the past 12 months reveals {trendInsights.length} significant ratio {trendInsights.length === 1 ? 'change' : 'changes'}:
                          {trendInsights}
                          {decliningCount >= 3 && (
                            <span style={{ color: '#ef4444' }}>
                              <strong> Warning:</strong> {decliningCount} ratios are declining, which warrants immediate management attention to investigate underlying causes and implement corrective measures before financial position weakens further.
                            </span>
                          )}
                          {decliningCount >= 2 && decliningCount < 3 && (
                            <span style={{ color: '#f59e0b' }}>
                              <strong> Caution:</strong> Multiple declining ratios suggest potential challenges that merit management focus to prevent further deterioration.
                            </span>
                          )}
                          {improvingCount >= 3 && decliningCount < 2 && (
                            <span style={{ color: '#10b981' }}>
                              <strong> Positive momentum:</strong> Multiple improving ratios indicate strengthening financial performance and operational execution.
                            </span>
                          )}
                        </span>
                      );
                    }
                    return null;
                  })()}
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Trend Analysis</strong> tracking {monthly.length} months reveals:
                  {(() => {
                    // Calculate recent vs historical trends
                    const last6Mo = monthly.slice(-6);
                    const prev6Mo = monthly.slice(-12, -6);
                    const revRecent = last6Mo.reduce((s, m) => s + m.revenue, 0);
                    const revPrior = prev6Mo.reduce((s, m) => s + m.revenue, 0);
                    const revTrend = prev6Mo.length > 0 ? ((revRecent - revPrior) / revPrior * 100) : 0;
                    
                    const expRecent = last6Mo.reduce((s, m) => s + m.expense, 0);
                    const expPrior = prev6Mo.reduce((s, m) => s + m.expense, 0);
                    const expTrend = prev6Mo.length > 0 ? ((expRecent - expPrior) / expPrior * 100) : 0;
                    
                    // Calculate margin trends
                    const recentMargin = revRecent > 0 ? ((revRecent - expRecent) / revRecent * 100) : 0;
                    const priorMargin = revPrior > 0 ? ((revPrior - expPrior) / revPrior * 100) : 0;
                    const marginChange = recentMargin - priorMargin;
                    
                    // Asset trends
                    const currentAssets = monthly[monthly.length - 1]?.totalAssets || 0;
                    const priorAssets = monthly[monthly.length - 13] ? monthly[monthly.length - 13].totalAssets : currentAssets;
                    const assetGrowth = priorAssets > 0 ? ((currentAssets - priorAssets) / priorAssets * 100) : 0;
                    
                    return (
                      <>
                        <strong> Revenue</strong> {revTrend > 0 ? 'increased' : 'decreased'} by <strong style={{ color: revTrend > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(revTrend).toFixed(1)}%</strong> in the most recent 6 months compared to the prior 6 months
                        {revTrend > 15 ? <span style={{ color: '#10b981' }}>, demonstrating strong accelerating growth momentum</span> : 
                         revTrend > 5 ? <span style={{ color: '#10b981' }}>, showing healthy expansion</span> :
                         revTrend > -5 ? <span style={{ color: '#64748b' }}>, indicating stable performance</span> :
                         revTrend > -15 ? <span style={{ color: '#f59e0b' }}>, suggesting slowing momentum requiring attention</span> :
                         <span style={{ color: '#ef4444' }}>, indicating significant contraction requiring strategic intervention</span>}.
                        <strong> Expense</strong> trends show {expTrend > 0 ? 'growth' : 'reduction'} of <strong style={{ color: Math.abs(expTrend) < Math.abs(revTrend) ? '#10b981' : '#ef4444' }}>{Math.abs(expTrend).toFixed(1)}%</strong> over the same period
                        {expTrend < revTrend ? <span style={{ color: '#10b981' }}>, with expenses growing {revTrend - expTrend > 10 ? 'significantly ' : ''}slower than revenue - excellent operational leverage</span> :
                         expTrend === revTrend ? ', matching revenue growth pace' :
                         <span style={{ color: '#ef4444' }}>, outpacing revenue growth by {(expTrend - revTrend).toFixed(1)} percentage points - margin compression risk</span>}.
                        <strong> Net margin</strong> {marginChange > 0 ? 'expanded' : 'contracted'} by <strong style={{ color: marginChange > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(marginChange).toFixed(1)}</strong> percentage points to <strong>{recentMargin.toFixed(1)}%</strong>
                        {marginChange > 3 ? <span style={{ color: '#10b981' }}>, reflecting improving profitability and strong operational efficiency</span> :
                         marginChange > 0 ? <span style={{ color: '#10b981' }}>, indicating positive margin trajectory</span> :
                         marginChange > -3 ? <span style={{ color: '#64748b' }}>, maintaining relatively stable profitability</span> :
                         <span style={{ color: '#ef4444' }}>, signaling margin pressure requiring cost management focus</span>}.
                        {assetGrowth !== 0 && (
                          <>
                            <strong> Asset base</strong> {assetGrowth > 0 ? 'grew' : 'declined'} by <strong style={{ color: assetGrowth > 0 ? '#667eea' : '#f59e0b' }}>{Math.abs(assetGrowth).toFixed(1)}%</strong> year-over-year
                            {assetGrowth > revTrend + 10 ? <span style={{ color: '#f59e0b' }}>, growing faster than revenue - monitor asset efficiency and ROA</span> :
                             assetGrowth > 5 ? ', supporting business expansion' :
                             assetGrowth > -5 ? ', remaining relatively stable' :
                             <span style={{ color: '#64748b' }}>, contracting which may improve asset turnover ratios</span>}.
                          </>
                        )}
                        {/* Analyze Dashboard-selected income statement items */}
                        {monthly.length >= 13 && (() => {
                          const incomeStatementItems = ['cogsTotal', 'cogsPayroll', 'cogsOwnerPay', 'cogsContractors', 'cogsMaterials', 'cogsCommissions', 'cogsOther', 
                            'salesExpense', 'rent', 'infrastructure', 'autoTravel', 'professionalFees', 'insurance', 'marketing', 'payroll', 
                            'ownerBasePay', 'ownersRetirement', 'subcontractors', 'interestExpense', 'depreciationAmortization', 'operatingExpenseTotal', 
                            'nonOperatingIncome', 'extraordinaryItems', 'netProfit'];
                          
                          const dashboardIncomeItems = selectedDashboardWidgets.filter(w => incomeStatementItems.includes(w));
                          if (dashboardIncomeItems.length === 0) return null;
                          
                          const itemAnalysis = [];
                          const current = monthly[monthly.length - 1];
                          const prior = monthly[monthly.length - 13];
                          
                          dashboardIncomeItems.forEach(item => {
                            const currentVal = current[item as keyof typeof current] as number;
                            const priorVal = prior[item as keyof typeof prior] as number;
                            
                            if (currentVal !== undefined && priorVal !== undefined && priorVal !== 0) {
                              const change = ((currentVal - priorVal) / Math.abs(priorVal)) * 100;
                              if (Math.abs(change) > 5) {
                                const displayName = getTrendItemDisplayName(item);
                                const isExpense = !['revenue', 'nonOperatingIncome'].includes(item);
                                const isGoodChange = isExpense ? (change < 0) : (change > 0);
                                
                                itemAnalysis.push(
                                  <span key={item}>
                                    <strong> {displayName}</strong> {change > 0 ? 'increased' : 'decreased'} by <strong style={{ color: isGoodChange ? '#10b981' : '#ef4444' }}>{Math.abs(change).toFixed(1)}%</strong> year-over-year 
                                    from ${(Math.abs(priorVal) / 1000).toFixed(1)}K to ${(Math.abs(currentVal) / 1000).toFixed(1)}K
                                    {isExpense ? (
                                      change < -10 ? <span style={{ color: '#10b981' }}>, reflecting strong cost controls and operational efficiency improvements</span> :
                                      change < 0 ? <span style={{ color: '#10b981' }}>, showing positive cost management</span> :
                                      change > 10 ? <span style={{ color: '#ef4444' }}>, indicating significant cost pressures requiring management attention</span> :
                                      <span style={{ color: '#f59e0b' }}>, warranting monitoring to ensure costs remain aligned with revenue growth</span>
                                    ) : (
                                      change > 10 ? <span style={{ color: '#10b981' }}>, demonstrating strong growth momentum</span> :
                                      change > 0 ? <span style={{ color: '#10b981' }}>, showing positive trajectory</span> :
                                      change < -10 ? <span style={{ color: '#ef4444' }}>, indicating concerning decline requiring strategic intervention</span> :
                                      <span style={{ color: '#f59e0b' }}>, suggesting need for revenue enhancement initiatives</span>
                                    )}.
                                  </span>
                                );
                              }
                            }
                          });
                          
                          return itemAnalysis.length > 0 ? itemAnalysis : null;
                        })()}
                      </>
                    );
                  })()}
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Projections</strong> based on historical patterns forecast {monthly.length >= 24 ? (() => {
                    // Calculate historical growth rates
                    const last12 = monthly.slice(-12);
                    const prev12 = monthly.slice(-24, -12);
                    const annualRevGrowth = ((last12.reduce((s, m) => s + m.revenue, 0) - prev12.reduce((s, m) => s + m.revenue, 0)) / prev12.reduce((s, m) => s + m.revenue, 0)) * 100;
                    const annualExpGrowth = ((last12.reduce((s, m) => s + m.expense, 0) - prev12.reduce((s, m) => s + m.expense, 0)) / prev12.reduce((s, m) => s + m.expense, 0)) * 100;
                    
                    // Calculate scenario growth rates
                    const mostLikelyRevGrowth = annualRevGrowth;
                    const mostLikelyExpGrowth = annualExpGrowth;
                    const bestCaseRevGrowth = annualRevGrowth * bestCaseRevMultiplier;
                    const bestCaseExpGrowth = annualExpGrowth * bestCaseExpMultiplier;
                    const worstCaseRevGrowth = annualRevGrowth * worstCaseRevMultiplier;
                    const worstCaseExpGrowth = annualExpGrowth * worstCaseExpMultiplier;
                    
                    return (
                      <>
                        three scenarios for the next 12 months: <strong>Most Likely</strong> projects revenue growing at <strong style={{ color: '#667eea' }}>{mostLikelyRevGrowth.toFixed(1)}%</strong> annually 
                        with expenses at <strong style={{ color: '#667eea' }}>{mostLikelyExpGrowth.toFixed(1)}%</strong> (continuing historical trends); 
                        <strong> Best Case</strong> models revenue accelerating to <strong style={{ color: '#10b981' }}>{bestCaseRevGrowth.toFixed(1)}%</strong> growth 
                        while controlling expenses to <strong style={{ color: '#10b981' }}>{bestCaseExpGrowth.toFixed(1)}%</strong> growth 
                        {bestCaseRevGrowth > bestCaseExpGrowth + 10 ? ', creating significant margin expansion potential' : 
                         bestCaseRevGrowth > bestCaseExpGrowth ? ', supporting improved profitability' : ''};
                        <strong> Worst Case</strong> assumes revenue slowing to <strong style={{ color: '#ef4444' }}>{worstCaseRevGrowth.toFixed(1)}%</strong> 
                        with expenses rising to <strong style={{ color: '#ef4444' }}>{worstCaseExpGrowth.toFixed(1)}%</strong>
                        {worstCaseExpGrowth > worstCaseRevGrowth ? ', potentially compressing margins and requiring cost management focus' : ''}.
                        These scenarios model corresponding balance sheet evolution with sensitivity analysis for asset deployment, working capital needs, and capital structure implications
                      </>
                    );
                  })() : 'forward-looking scenarios once sufficient historical data (24+ months) is available'}.
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Working Capital</strong> analysis reveals critical insights into liquidity management and operational efficiency:
                  {(() => {
                    const current = monthly[monthly.length - 1];
                    const prior = monthly.length >= 13 ? monthly[monthly.length - 13] : monthly[0];
                    const prior6Mo = monthly.length >= 7 ? monthly[monthly.length - 7] : monthly[0];
                    
                    // Current period working capital components
                    const currentCash = current?.cash || 0;
                    const currentAR = current?.ar || 0;
                    const currentInv = current?.inventory || 0;
                    const currentOtherCA = current?.otherCA || 0;
                    const currentAP = current?.ap || 0;
                    const currentOtherCL = current?.otherCL || 0;
                    
                    const totalCA = current?.tca || (currentCash + currentAR + currentInv + currentOtherCA);
                    const totalCL = current?.tcl || (currentAP + currentOtherCL);
                    const currentWC = totalCA - totalCL;
                    const currentRevenue = current?.revenue || 1;
                    
                    // Prior period working capital
                    const priorCA = prior?.tca || ((prior?.cash || 0) + (prior?.ar || 0) + (prior?.inventory || 0) + (prior?.otherCA || 0));
                    const priorCL = prior?.tcl || ((prior?.ap || 0) + (prior?.otherCL || 0));
                    const priorWC = priorCA - priorCL;
                    
                    // 6 months ago working capital
                    const prior6MoCA = prior6Mo?.tca || ((prior6Mo?.cash || 0) + (prior6Mo?.ar || 0) + (prior6Mo?.inventory || 0) + (prior6Mo?.otherCA || 0));
                    const prior6MoCL = prior6Mo?.tcl || ((prior6Mo?.ap || 0) + (prior6Mo?.otherCL || 0));
                    const prior6MoWC = prior6MoCA - prior6MoCL;
                    
                    // Calculate changes
                    const wcChange12Mo = priorWC !== 0 ? ((currentWC - priorWC) / Math.abs(priorWC)) * 100 : 0;
                    const wcChange6Mo = prior6MoWC !== 0 ? ((currentWC - prior6MoWC) / Math.abs(prior6MoWC)) * 100 : 0;
                    const wcAbsChange = currentWC - priorWC;
                    
                    // Component changes
                    const cashChange = currentCash - (prior?.cash || 0);
                    const arChange = currentAR - (prior?.ar || 0);
                    const invChange = currentInv - (prior?.inventory || 0);
                    const apChange = currentAP - (prior?.ap || 0);
                    
                    // Working capital ratios
                    const wcRatio = totalCL > 0 ? totalCA / totalCL : 0;
                    const priorWCRatio = priorCL > 0 ? priorCA / priorCL : 0;
                    const wcRatioChange = priorWCRatio > 0 ? ((wcRatio - priorWCRatio) / priorWCRatio) * 100 : 0;
                    
                    // Working capital as % of revenue (last 12 months)
                    const last12Revenue = monthly.slice(-12).reduce((sum, m) => sum + (m.revenue || 0), 0);
                    const wcPctRevenue = last12Revenue > 0 ? (currentWC / last12Revenue) * 100 : 0;
                    
                    // Cash Conversion Cycle
                    const ccc = (trendData[trendData.length - 1]?.daysInv || 0) + (trendData[trendData.length - 1]?.daysAR || 0) - (trendData[trendData.length - 1]?.daysAP || 0);
                    const priorIdx = trendData.length >= 13 ? trendData.length - 13 : 0;
                    const priorCCC = (trendData[priorIdx]?.daysInv || 0) + (trendData[priorIdx]?.daysAR || 0) - (trendData[priorIdx]?.daysAP || 0);
                    const cccChange = priorCCC !== 0 ? ccc - priorCCC : 0;
                    
                    // Days inventory, AR, AP changes
                    const daysARChange = (trendData[trendData.length - 1]?.daysAR || 0) - (trendData[priorIdx]?.daysAR || 0);
                    const daysInvChange = (trendData[trendData.length - 1]?.daysInv || 0) - (trendData[priorIdx]?.daysInv || 0);
                    const daysAPChange = (trendData[trendData.length - 1]?.daysAP || 0) - (trendData[priorIdx]?.daysAP || 0);
                    
                    return (
                      <>
                        <strong> Current position</strong> shows working capital of <strong style={{ color: currentWC > 0 ? '#10b981' : '#ef4444' }}>{formatDollar(currentWC)}</strong> ({currentWC > 0 ? 'positive' : 'negative'}), 
                        representing <strong>{wcPctRevenue.toFixed(1)}%</strong> of trailing twelve-month revenue
                        {wcPctRevenue > 20 ? <span style={{ color: '#10b981' }}>, indicating strong liquidity cushion and operational flexibility</span> :
                         wcPctRevenue > 10 ? <span style={{ color: '#64748b' }}>, providing adequate working capital for normal operations</span> :
                         wcPctRevenue > 0 ? <span style={{ color: '#f59e0b' }}>, suggesting limited liquidity buffer that may constrain operational flexibility</span> :
                         <span style={{ color: '#ef4444' }}>, indicating negative working capital position requiring immediate attention and potential financing needs</span>}.
                        The working capital ratio of <strong>{wcRatio.toFixed(2)}</strong> has {wcRatioChange > 0 ? 'improved' : wcRatioChange < 0 ? 'declined' : 'remained stable'} 
                        {Math.abs(wcRatioChange) > 5 ? <span> by <strong style={{ color: wcRatioChange > 0 ? '#10b981' : '#ef4444' }}>{Math.abs(wcRatioChange).toFixed(1)}%</strong> from {priorWCRatio.toFixed(2)} a year ago</span> : ' over the past year'}
                        {wcRatio < 1.0 ? <span style={{ color: '#ef4444' }}>, indicating current liabilities exceed current assets - a concerning liquidity position</span> :
                         wcRatio < 1.5 ? <span style={{ color: '#f59e0b' }}>, suggesting tight liquidity that may limit operational flexibility</span> :
                         wcRatio > 3.0 ? <span style={{ color: '#10b981' }}>, reflecting exceptionally strong liquidity, though potentially excess capital that could be deployed more productively</span> :
                         ', indicating adequate short-term liquidity'}.
                        
                        <strong> Component analysis</strong> reveals current assets totaling <strong>{formatDollar(totalCA)}</strong>, comprised of 
                        cash <strong>{formatDollar(currentCash)}</strong> ({((currentCash / totalCA) * 100).toFixed(0)}%), 
                        receivables <strong>{formatDollar(currentAR)}</strong> ({((currentAR / totalCA) * 100).toFixed(0)}%), 
                        inventory <strong>{formatDollar(currentInv)}</strong> ({((currentInv / totalCA) * 100).toFixed(0)}%), 
                        and other current assets <strong>{formatDollar(currentOtherCA)}</strong> ({((currentOtherCA / totalCA) * 100).toFixed(0)}%), 
                        against current liabilities of <strong>{formatDollar(totalCL)}</strong> including 
                        payables <strong>{formatDollar(currentAP)}</strong> ({((currentAP / totalCL) * 100).toFixed(0)}%) 
                        and other current liabilities <strong>{formatDollar(currentOtherCL)}</strong> ({((currentOtherCL / totalCL) * 100).toFixed(0)}%)
                        {(currentCash / totalCA) > 0.4 ? <span style={{ color: '#10b981' }}>, with high cash composition providing excellent immediate liquidity</span> :
                         (currentCash / totalCA) < 0.15 ? <span style={{ color: '#f59e0b' }}>, with limited cash representing potential liquidity risk if receivables or inventory cannot be quickly converted</span> : ''}.
                        
                        {monthly.length >= 13 && (
                          <>
                            <strong> Trend analysis</strong> shows working capital has {currentWC > priorWC ? 'increased' : 'decreased'} by <strong style={{ color: currentWC > priorWC ? '#10b981' : '#ef4444' }}>{formatDollar(wcAbsChange)}</strong> ({Math.abs(wcChange12Mo).toFixed(0)}%) 
                            over the past 12 months from {formatDollar(priorWC)} to {formatDollar(currentWC)}
                            {Math.abs(wcChange12Mo) > 30 && currentWC < priorWC ? <span style={{ color: '#ef4444' }}>, representing significant deterioration that requires management attention</span> :
                             Math.abs(wcChange12Mo) > 30 && currentWC > priorWC ? <span style={{ color: '#10b981' }}>, demonstrating substantial strengthening of the liquidity position</span> :
                             Math.abs(wcChange12Mo) > 15 ? <span style={{ color: currentWC > priorWC ? '#10b981' : '#f59e0b' }}>, indicating {currentWC > priorWC ? 'improving' : 'tightening'} liquidity trends</span> :
                             ', maintaining relatively stable working capital levels'}.
                            Key drivers include: 
                            cash {cashChange > 0 ? 'increased' : 'decreased'} by <strong style={{ color: cashChange > 0 ? '#10b981' : '#ef4444' }}>{formatDollar(cashChange)}</strong>
                            {Math.abs(cashChange) > Math.abs(wcAbsChange) * 0.5 ? ' (primary driver)' : ''}, 
                            receivables {arChange > 0 ? 'grew' : 'decreased'} by <strong style={{ color: arChange < 0 ? '#10b981' : '#64748b' }}>{formatDollar(arChange)}</strong>
                            {arChange > last12Revenue * 0.1 ? <span style={{ color: '#f59e0b' }}> (significant increase tying up working capital)</span> : ''}, 
                            inventory {invChange > 0 ? 'increased' : 'decreased'} by <strong style={{ color: invChange < 0 ? '#10b981' : '#64748b' }}>{formatDollar(invChange)}</strong>
                            {invChange > last12Revenue * 0.08 ? <span style={{ color: '#f59e0b' }}> (substantial buildup requiring attention)</span> : ''}, 
                            and payables {apChange > 0 ? 'increased' : 'decreased'} by <strong style={{ color: apChange > 0 ? '#10b981' : '#64748b' }}>{formatDollar(apChange)}</strong>
                            {apChange > 0 && Math.abs(apChange) > Math.abs(wcAbsChange) * 0.3 ? ' (improving working capital through extended payables)' : ''}.
                          </>
                        )}
                        
                        <strong> Cash Conversion Cycle</strong> of <strong style={{ color: ccc < 30 ? '#10b981' : ccc < 60 ? '#64748b' : ccc < 90 ? '#f59e0b' : '#ef4444' }}>{ccc.toFixed(0)} days</strong>
                        {monthly.length >= 13 && Math.abs(cccChange) > 5 && (
                          <span> has {cccChange > 0 ? 'lengthened' : 'shortened'} by <strong style={{ color: cccChange < 0 ? '#10b981' : '#ef4444' }}>{Math.abs(cccChange).toFixed(0)} days</strong> year-over-year</span>
                        )}
                        {ccc < 0 ? <span style={{ color: '#10b981' }}>, indicating the business receives payment before paying suppliers - an exceptionally favorable working capital dynamic generating float</span> :
                         ccc < 30 ? <span style={{ color: '#10b981' }}>, demonstrating highly efficient working capital management with rapid cash generation cycles</span> :
                         ccc < 60 ? ', reflecting reasonable working capital efficiency' :
                         ccc < 90 ? <span style={{ color: '#f59e0b' }}>, suggesting extended working capital cycle that ties up significant cash in operations</span> :
                         <span style={{ color: '#ef4444' }}>, indicating excessive working capital requirements that strain liquidity and may require external financing</span>}
                        {' '}comprises Days Inventory <strong>{(trendData[trendData.length - 1]?.daysInv || 0).toFixed(0)} days</strong>
                        {monthly.length >= 13 && Math.abs(daysInvChange) > 5 && (
                          <span> ({daysInvChange > 0 ? 'up' : 'down'} <strong style={{ color: daysInvChange < 0 ? '#10b981' : '#ef4444' }}>{Math.abs(daysInvChange).toFixed(0)}</strong> days YoY{daysInvChange > 10 ? ', suggesting inventory buildup or slower turnover' : daysInvChange < -10 ? ', indicating improved inventory management' : ''})</span>
                        )}, Days Receivables <strong>{(trendData[trendData.length - 1]?.daysAR || 0).toFixed(0)} days</strong>
                        {monthly.length >= 13 && Math.abs(daysARChange) > 5 && (
                          <span> ({daysARChange > 0 ? 'up' : 'down'} <strong style={{ color: daysARChange < 0 ? '#10b981' : '#ef4444' }}>{Math.abs(daysARChange).toFixed(0)}</strong> days YoY{daysARChange > 10 ? ', reflecting slower collections' : daysARChange < -10 ? ', demonstrating improved collection efficiency' : ''})</span>
                        )}, less Days Payables <strong>{(trendData[trendData.length - 1]?.daysAP || 0).toFixed(0)} days</strong>
                        {monthly.length >= 13 && Math.abs(daysAPChange) > 5 && (
                          <span> ({daysAPChange > 0 ? 'up' : 'down'} <strong style={{ color: daysAPChange > 0 ? '#10b981' : '#64748b' }}>{Math.abs(daysAPChange).toFixed(0)}</strong> days YoY{daysAPChange > 10 ? ', extending payment terms to preserve cash' : daysAPChange < -10 ? ', paying suppliers faster' : ''})</span>
                        )}.
                        {monthly.length >= 13 && cccChange > 15 && (
                          <span style={{ color: '#ef4444' }}>
                            <strong> The lengthening cash conversion cycle</strong> indicates deteriorating working capital efficiency, potentially driven by 
                            {daysARChange > 5 && daysInvChange > 5 ? 'both slower collections and inventory buildup' :
                             daysARChange > 5 ? 'slower customer collections' :
                             daysInvChange > 5 ? 'inventory accumulation' :
                             daysAPChange < -5 ? 'faster supplier payments' : 'multiple operational factors'}, 
                            requiring management focus to prevent further cash flow strain.
                          </span>
                        )}
                        {monthly.length >= 13 && cccChange < -15 && (
                          <span style={{ color: '#10b981' }}>
                            <strong> The improving cash conversion cycle</strong> reflects strengthening working capital management through 
                            {daysARChange < -5 && daysInvChange < -5 ? 'both faster collections and improved inventory turnover' :
                             daysARChange < -5 ? 'accelerated customer collections' :
                             daysInvChange < -5 ? 'more efficient inventory management' :
                             daysAPChange > 5 ? 'extended supplier payment terms' : 'enhanced operational efficiency'}, 
                            freeing up cash for growth initiatives and strengthening financial flexibility.
                          </span>
                        )}
                        {/* Analyze Dashboard-selected balance sheet items */}
                        {monthly.length >= 13 && (() => {
                          const balanceSheetItems = ['cash', 'ar', 'inventory', 'otherCA', 'tca', 'fixedAssets', 'otherAssets', 'totalAssets', 
                            'ap', 'otherCL', 'tcl', 'ltd', 'totalLiab', 'totalEquity'];
                          
                          const dashboardBalanceItems = selectedDashboardWidgets.filter(w => balanceSheetItems.includes(w));
                          if (dashboardBalanceItems.length === 0) return null;
                          
                          const itemAnalysis = [];
                          const current = monthly[monthly.length - 1];
                          const prior = monthly[monthly.length - 13];
                          
                          dashboardBalanceItems.forEach(item => {
                            const currentVal = current[item as keyof typeof current] as number;
                            const priorVal = prior[item as keyof typeof prior] as number;
                            
                            if (currentVal !== undefined && priorVal !== undefined && priorVal !== 0) {
                              const change = ((currentVal - priorVal) / Math.abs(priorVal)) * 100;
                              if (Math.abs(change) > 5) {
                                const displayName = getTrendItemDisplayName(item);
                                const isAsset = ['cash', 'ar', 'inventory', 'otherCA', 'tca', 'fixedAssets', 'otherAssets', 'totalAssets', 'totalEquity'].includes(item);
                                const isLiability = ['ap', 'otherCL', 'tcl', 'ltd', 'totalLiab'].includes(item);
                                
                                // Determine if change is good or bad
                                let isGoodChange = false;
                                if (item === 'cash') isGoodChange = change > 0;
                                else if (item === 'ar') isGoodChange = change < 0; // Lower AR is generally better
                                else if (item === 'inventory') isGoodChange = Math.abs(change) < 15; // Moderate inventory changes are good
                                else if (isLiability) isGoodChange = change < 0; // Lower liabilities are better
                                else if (isAsset) isGoodChange = change > 0; // Higher assets are generally better
                                
                                itemAnalysis.push(
                                  <span key={item}>
                                    <strong> {displayName}</strong> {change > 0 ? 'increased' : 'decreased'} by <strong style={{ color: isGoodChange ? '#10b981' : change > 10 || change < -10 ? '#ef4444' : '#f59e0b' }}>{Math.abs(change).toFixed(1)}%</strong> year-over-year 
                                    from ${(Math.abs(priorVal) / 1000).toFixed(1)}K to ${(Math.abs(currentVal) / 1000).toFixed(1)}K
                                    {item === 'cash' ? (
                                      change > 20 ? <span style={{ color: '#10b981' }}>, significantly strengthening liquidity position and operational flexibility</span> :
                                      change > 0 ? <span style={{ color: '#10b981' }}>, improving cash reserves and financial cushion</span> :
                                      change < -20 ? <span style={{ color: '#ef4444' }}>, materially reducing liquidity and potentially constraining operations</span> :
                                      <span style={{ color: '#f59e0b' }}>, decreasing cash reserves which warrants monitoring</span>
                                    ) : item === 'ar' ? (
                                      change > 15 ? <span style={{ color: '#ef4444' }}>, suggesting potential collection challenges or extended payment terms that tie up working capital</span> :
                                      change > 0 ? <span style={{ color: '#f59e0b' }}>, increasing receivables which should be monitored relative to revenue growth</span> :
                                      change < -10 ? <span style={{ color: '#10b981' }}>, reflecting improved collections and working capital efficiency</span> :
                                      <span style={{ color: '#10b981' }}>, showing slight improvement in receivables management</span>
                                    ) : item === 'inventory' ? (
                                      change > 20 ? <span style={{ color: '#ef4444' }}>, indicating potential overstocking or slow-moving inventory requiring attention</span> :
                                      change < -20 ? <span style={{ color: '#ef4444' }}>, suggesting possible stock-outs risk or aggressive inventory reduction</span> :
                                      <span style={{ color: '#10b981' }}>, maintaining appropriate inventory levels aligned with business needs</span>
                                    ) : isLiability ? (
                                      change > 15 ? <span style={{ color: '#ef4444' }}>, increasing financial leverage and potential risk requiring monitoring</span> :
                                      change > 0 ? <span style={{ color: '#f59e0b' }}>, rising which should be tracked against revenue growth</span> :
                                      change < -10 ? <span style={{ color: '#10b981' }}>, reducing financial obligations and improving balance sheet strength</span> :
                                      <span style={{ color: '#10b981' }}>, decreasing which strengthens financial position</span>
                                    ) : (
                                      change > 15 ? <span style={{ color: '#10b981' }}>, demonstrating strong asset growth supporting business expansion</span> :
                                      change > 0 ? <span style={{ color: '#10b981' }}>, showing healthy asset base development</span> :
                                      change < -10 ? <span style={{ color: '#f59e0b' }}>, declining which may impact operational capacity</span> :
                                      <span style={{ color: '#64748b' }}>, experiencing minor fluctuation</span>
                                    )}.
                                  </span>
                                );
                              }
                            }
                          });
                          
                          return itemAnalysis.length > 0 ? itemAnalysis : null;
                        })()}
                      </>
                    );
                  })()}
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Cash Flow</strong> analysis provides comprehensive insight into cash generation and deployment across three key categories:
                  {(() => {
                    if (monthly.length < 6) return ' (requires additional months of data for detailed analysis)';
                    
                    // Calculate last 12 months cash flow
                    const last12 = monthly.slice(-12);
                    const prior = monthly.length > 12 ? monthly[monthly.length - 13] : last12[0];
                    
                    // Operating Cash Flow
                    const ltmNetIncome = last12.reduce((sum, m) => sum + (m.revenue - m.expense), 0);
                    const ltmDepreciation = last12.reduce((sum, m) => sum + (m.depreciationAmortization || 0), 0);
                    const changeInAR = last12[last12.length - 1].ar - prior.ar;
                    const changeInInv = last12[last12.length - 1].inventory - prior.inventory;
                    const changeInAP = last12[last12.length - 1].ap - prior.ap;
                    const changeInWC = -(changeInAR + changeInInv - changeInAP);
                    const operatingCF = ltmNetIncome + ltmDepreciation + changeInWC;
                    const opCFMargin = ltmRev > 0 ? (operatingCF / ltmRev * 100) : 0;
                    
                    // Investing Cash Flow
                    const changeInFA = last12[last12.length - 1].fixedAssets - prior.fixedAssets;
                    const capEx = changeInFA + ltmDepreciation;
                    const investingCF = -capEx;
                    
                    // Financing Cash Flow
                    const changeInDebt = last12[last12.length - 1].ltd - prior.ltd;
                    const changeInEquity = last12[last12.length - 1].totalEquity - prior.totalEquity - ltmNetIncome;
                    const financingCF = changeInDebt + changeInEquity;
                    
                    // Free Cash Flow
                    const freeCF = operatingCF - Math.max(0, capEx);
                    
                    // Cash change
                    const cashChange = last12[last12.length - 1].cash - prior.cash;
                    
                    return (
                      <>
                        <strong> Operating activities</strong> generated <strong style={{ color: operatingCF > 0 ? '#10b981' : '#ef4444' }}>{formatDollar(operatingCF)}</strong> over the past 12 months, 
                        representing an operating cash flow margin of <strong style={{ color: opCFMargin > 15 ? '#10b981' : opCFMargin > 5 ? '#64748b' : '#ef4444' }}>{opCFMargin.toFixed(1)}%</strong>
                        {opCFMargin > 15 ? <span style={{ color: '#10b981' }}>, demonstrating excellent cash conversion from operations</span> :
                         opCFMargin > 5 ? ', indicating healthy cash generation' :
                         opCFMargin > 0 ? <span style={{ color: '#f59e0b' }}>, suggesting opportunities to improve working capital efficiency</span> :
                         <span style={{ color: '#ef4444' }}>, indicating cash outflow from operations requiring immediate attention</span>}.
                        Working capital changes {changeInWC > 0 ? 'contributed' : 'consumed'} <strong>{formatDollar(changeInWC)}</strong>
                        {changeInWC < -ltmNetIncome * 0.5 ? <span style={{ color: '#ef4444' }}>, representing significant cash tied up in working capital - review receivables and inventory management</span> :
                         changeInWC > ltmNetIncome * 0.3 ? <span style={{ color: '#10b981' }}>, with efficient working capital management releasing cash for other uses</span> :
                         ''}.
                        <strong> Investing activities</strong> {investingCF < 0 ? 'deployed' : 'generated'} <strong style={{ color: '#667eea' }}>{formatDollar(investingCF)}</strong>
                        {capEx > operatingCF * 0.5 ? <span style={{ color: '#f59e0b' }}>, with capital expenditures representing {(capEx / operatingCF * 100).toFixed(0)}% of operating cash flow - monitor return on invested capital</span> :
                         capEx > 0 ? ', supporting maintenance and growth of the asset base' :
                         ', with minimal capital investment in fixed assets'}.
                        <strong> Financing activities</strong> {financingCF > 0 ? 'provided' : 'consumed'} <strong style={{ color: financingCF > 0 ? '#667eea' : '#64748b' }}>{formatDollar(financingCF)}</strong>
                        {changeInDebt > ltmNetIncome && changeInDebt > 0 ? <span style={{ color: '#f59e0b' }}>, with significant debt increase of {formatDollar(changeInDebt)} - monitor leverage ratios</span> :
                         changeInDebt < -ltmNetIncome * 0.3 ? <span style={{ color: '#10b981' }}>, reducing debt by {formatDollar(changeInDebt)} and strengthening the balance sheet</span> :
                         ''}.
                        <strong> Free cash flow</strong> of <strong style={{ color: freeCF > 0 ? '#10b981' : '#ef4444' }}>{formatDollar(freeCF)}</strong>
                        {freeCF > ltmNetIncome * 1.2 ? <span style={{ color: '#10b981' }}> (exceeding net income) provides strong financial flexibility for growth, debt reduction, or distributions</span> :
                         freeCF > 0 ? ' provides resources for strategic initiatives beyond operational requirements' :
                         <span style={{ color: '#ef4444' }}> indicates operations are not generating sufficient cash to cover capital needs</span>}.
                        Net cash {cashChange > 0 ? 'increased' : 'decreased'} by <strong style={{ color: cashChange > 0 ? '#10b981' : '#f59e0b' }}>{formatDollar(cashChange)}</strong> to <strong>{formatDollar(last12[last12.length - 1].cash)}</strong>
                        {cashChange / ltmRev > 0.15 ? <span style={{ color: '#10b981' }}>, building substantial cash reserves and financial resilience</span> :
                         cashChange < -ltmRev * 0.1 ? <span style={{ color: '#f59e0b' }}>, drawing down reserves - monitor cash runway and funding needs</span> :
                         ''}.
                      </>
                    );
                  })()}
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Goals</strong> tracking enables comparison of actual expense performance against management targets:
                  {(() => {
                    if (monthly.length < 3) return ' (requires at least 3 months of data for quarterly goals analysis)';
                    
                    // Major expense categories to analyze
                    const majorCategories = [
                      { key: 'payroll', label: 'Payroll' },
                      { key: 'ownerBasePay', label: 'Owner Compensation' },
                      { key: 'rent', label: 'Rent/Lease' },
                      { key: 'professionalFees', label: 'Professional Services' },
                      { key: 'salesExpense', label: 'Sales & Marketing' },
                      { key: 'insurance', label: 'Insurance' }
                    ];
                    
                    // Calculate last quarter (3 months) totals for each category
                    const lastQuarter = monthly.slice(-3);
                    const categoryAnalysis = majorCategories.map(cat => {
                      // Sum total revenue and total expense for the quarter
                      const totals = lastQuarter.reduce((acc, m) => {
                        acc.totalRevenue += m.revenue || 0;
                        acc.totalExpense += (m as any)[cat.key] || 0;
                        return acc;
                      }, { totalRevenue: 0, totalExpense: 0 });
                      
                      // Calculate actual percentage as (total expense / total revenue)
                      const actualPct = totals.totalRevenue > 0 ? (totals.totalExpense / totals.totalRevenue * 100) : 0;
                      const goalPct = expenseGoals[cat.key];
                      
                      return {
                        label: cat.label,
                        actual: actualPct,
                        goal: goalPct,
                        hasGoal: goalPct && goalPct > 0,
                        variance: goalPct ? actualPct - goalPct : 0,
                        metGoal: goalPct ? actualPct <= goalPct : null
                      };
                    });
                    
                    // Check if ANY goals are set at all
                    const anyGoalsSet = categoryAnalysis.some(c => c.hasGoal);
                    if (!anyGoalsSet) {
                      return ' Management has not yet established expense goals for tracking and variance analysis. Setting goals for major expense categories enables proactive cost management and performance monitoring.';
                    }
                    
                    // Filter to only show categories with goals and meaningful spend (>0.5% of revenue)
                    const categoriesWithGoalsAndSpend = categoryAnalysis.filter(c => c.hasGoal && c.actual > 0.5);
                    
                    if (categoriesWithGoalsAndSpend.length === 0) {
                      return ' Expense goals have been established, but the tracked categories currently show minimal spending activity. Continue monitoring as business activity increases.';
                    }
                    
                    // Define threshold for "significant" deviation (1.5 percentage points)
                    const SIGNIFICANT_THRESHOLD = 1.5;
                    
                    // Categorize based on significance
                    const significantlyUnder = categoriesWithGoalsAndSpend.filter(c => c.metGoal && c.variance < -SIGNIFICANT_THRESHOLD);
                    const onTarget = categoriesWithGoalsAndSpend.filter(c => Math.abs(c.variance) <= SIGNIFICANT_THRESHOLD);
                    const significantlyOver = categoriesWithGoalsAndSpend.filter(c => !c.metGoal && c.variance > SIGNIFICANT_THRESHOLD);
                    
                    const hasSignificantDeviations = significantlyUnder.length > 0 || significantlyOver.length > 0;
                    
                    return (
                      <>
                        {!hasSignificantDeviations && (
                          <span> All tracked expense categories are performing on target with no significant deviations from established goals, demonstrating effective expense management and strong financial discipline.</span>
                        )}
                        
                        {significantlyUnder.length > 0 && (
                          <>
                            <strong style={{ color: '#10b981' }}> Significantly below target:</strong>
                            {significantlyUnder.map((cat, idx) => (
                              <span key={idx}>
                                {idx > 0 && (idx === significantlyUnder.length - 1 ? ' and ' : ', ')}
                                <strong style={{ color: '#10b981' }}>{cat.label}</strong> at {cat.actual.toFixed(1)}% of revenue (goal: {cat.goal.toFixed(1)}%, <strong>{Math.abs(cat.variance).toFixed(1)}pp under</strong>)
                              </span>
                            ))}
                            {significantlyOver.length > 0 ? '.' : ', demonstrating exceptional expense discipline and effective cost management.'}
                          </>
                        )}
                        
                        {significantlyOver.length > 0 && (
                          <>
                            {significantlyUnder.length > 0 && <strong style={{ color: '#ef4444' }}> Significantly over target:</strong>}
                            {significantlyUnder.length === 0 && <strong style={{ color: '#ef4444' }}> Significant variances requiring attention:</strong>}
                            {significantlyOver.map((cat, idx) => (
                              <span key={idx}>
                                {idx > 0 && (idx === significantlyOver.length - 1 ? ' and ' : ', ')}
                                <strong style={{ color: '#ef4444' }}>{cat.label}</strong> at {cat.actual.toFixed(1)}% (goal: {cat.goal.toFixed(1)}%, <strong>{cat.variance.toFixed(1)}pp over</strong>)
                              </span>
                            ))}
                            {significantlyOver.length === 1 ? ', requiring immediate management attention to identify root causes and implement corrective actions' : 
                             significantlyOver.length === categoriesWithGoalsAndSpend.length ? ', indicating need for comprehensive cost reduction initiatives across all expense categories with urgent management focus' :
                             ', requiring targeted cost management initiatives to bring spending in line with established targets'}.
                          </>
                        )}
                        
                        {onTarget.length > 0 && hasSignificantDeviations && (
                          <span> {onTarget.length} {onTarget.length === 1 ? 'category is' : 'categories are'} performing on target with no significant variances.</span>
                        )}
                      </>
                    );
                  })()}
                </p>
                <p style={{ margin: '12px 0' }}>
                  <strong style={{ color: '#667eea' }}>Valuation</strong> analysis employs three complementary methodologies to assess enterprise value:
                  {(() => {
                    if (monthly.length < 12) return ' (requires 12+ months of data for comprehensive valuation analysis)';
                    
                    // Calculate TTM metrics
                    const last12 = monthly.slice(-12);
                    const ttmRevenue = last12.reduce((sum, m) => sum + (m.revenue || 0), 0);
                    const ttmCOGS = last12.reduce((sum, m) => sum + (m.cogsTotal || 0), 0);
                    const ttmExpense = last12.reduce((sum, m) => sum + (m.expense || 0), 0);
                    const ttmDepreciation = last12.reduce((sum, m) => sum + (m.depreciationAmortization || 0), 0);
                    const ttmInterest = last12.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                    const ttmNetIncome = ttmRevenue - ttmCOGS - ttmExpense;
                    const ttmEBITDA = ttmNetIncome + ttmDepreciation + ttmInterest;
                    const ttmOwnerBasePay = last12.reduce((sum, m) => sum + (m.ownerBasePay || 0), 0);
                    const ttmSDE = ttmEBITDA + ttmOwnerBasePay;
                    
                    // Valuation calculations
                    const sdeVal = ttmSDE * sdeMultiplier;
                    const ebitdaVal = ttmEBITDA * ebitdaMultiplier;
                    
                    // DCF calculation
                    const currentMonth = monthly[monthly.length - 1];
                    const month12Ago = monthly.length >= 13 ? monthly[monthly.length - 13] : monthly[0];
                    const currentWC_val = ((currentMonth.cash || 0) + (currentMonth.ar || 0) + (currentMonth.inventory || 0)) - ((currentMonth.ap || 0) + (currentMonth.otherCL || 0));
                    const priorWC = ((month12Ago.cash || 0) + (month12Ago.ar || 0) + (month12Ago.inventory || 0)) - ((month12Ago.ap || 0) + (month12Ago.otherCL || 0));
                    const changeInWC = currentWC_val - priorWC;
                    const changeInFixedAssets = (currentMonth.fixedAssets || 0) - (month12Ago.fixedAssets || 0);
                    const ttmCapEx = Math.max(0, changeInFixedAssets + ttmDepreciation);
                    const ttmFreeCashFlow = ttmNetIncome + ttmDepreciation - changeInWC - ttmCapEx;
                    const growthRate = growth_24mo / 100;
                    const discountRate = dcfDiscountRate / 100;
                    const terminalGrowthRate = dcfTerminalGrowth / 100;
                    let dcfVal = 0;
                    for (let year = 1; year <= 5; year++) {
                      const projectedFCF = ttmFreeCashFlow * Math.pow(1 + growthRate, year);
                      dcfVal += projectedFCF / Math.pow(1 + discountRate, year);
                    }
                    const terminalValue = (ttmFreeCashFlow * Math.pow(1 + growthRate, 5) * (1 + terminalGrowthRate)) / (discountRate - terminalGrowthRate);
                    dcfVal += terminalValue / Math.pow(1 + discountRate, 5);
                    
                    const avgValuation = (sdeVal + ebitdaVal + dcfVal) / 3;
                    const minValuation = Math.min(sdeVal, ebitdaVal, dcfVal);
                    const maxValuation = Math.max(sdeVal, ebitdaVal, dcfVal);
                    
                    return (
                      <>
                        <strong> SDE (Seller's Discretionary Earnings)</strong> method values the business at <strong style={{ color: '#10b981' }}>${(sdeVal / 1000000).toFixed(2)}M</strong>, 
                        applying a {sdeMultiplier.toFixed(1)}x multiple to trailing twelve-month SDE of ${(ttmSDE / 1000).toFixed(1)}K
                        {ttmSDE > 0 ? ', appropriate for owner-operated businesses and capturing total economic benefit to a single owner-operator' : ''}.
                        <strong> EBITDA multiple</strong> approach indicates a value of <strong style={{ color: '#667eea' }}>${(ebitdaVal / 1000000).toFixed(2)}M</strong>, 
                        using a {ebitdaMultiplier.toFixed(1)}x multiple on EBITDA of ${(ttmEBITDA / 1000).toFixed(1)}K
                        {ttmEBITDA > 0 ? ', commonly used in strategic acquisitions and private equity transactions' : ''}.
                        <strong> Discounted Cash Flow (DCF)</strong> analysis projects an enterprise value of <strong style={{ color: '#8b5cf6' }}>${(dcfVal / 1000000).toFixed(2)}M</strong>, 
                        discounting 5-year free cash flow projections at {dcfDiscountRate.toFixed(1)}% with {dcfTerminalGrowth.toFixed(1)}% terminal growth
                        {ttmFreeCashFlow > 0 ? ', reflecting the present value of future cash generation capability' : ', though limited by current cash flow generation'}.
                        The valuation range of <strong>${(minValuation / 1000000).toFixed(2)}M - ${(maxValuation / 1000000).toFixed(2)}M</strong> (average: ${(avgValuation / 1000000).toFixed(2)}M) 
                        provides a comprehensive perspective 
                        {(maxValuation - minValuation) / avgValuation > 0.5 ? <span style={{ color: '#f59e0b' }}> with significant variance across methods, suggesting need for additional due diligence and multiple validation</span> :
                         ', with reasonable consistency across methodologies supporting valuation confidence'}, 
                        useful for M&A discussions, financing negotiations, equity planning, and strategic decision-making.
                      </>
                    );
                  })()}
                </p>
                <p style={{ margin: '12px 0 0 0' }}>
                  The overall Financial Score of <strong>{finalScore.toFixed(1)}</strong>
                  {finalScore >= 80 ? <span style={{ color: '#10b981' }}> (Strong Financial Performance)</span> :
                   finalScore >= 50 ? <span style={{ color: '#3b82f6' }}> (Good Fundamentals - in a good position for revenue growth; needs to focus on bringing costs down as volume grows)</span> :
                   finalScore >= 30 ? <span style={{ color: '#f59e0b' }}> (Financial Stress)</span> :
                   <span style={{ color: '#ef4444' }}> (Critical Situation)</span>}.
                </p>
              </div>
            </div>
            
            <div style={{ marginBottom: '12px' }}>
              <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#10b981', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '20px' }}>?</span> Key Strengths & Competitive Advantages
              </h3>
              <div style={{ fontSize: '15px', lineHeight: '1.8', color: '#1e293b' }}>
                {mdaAnalysis.strengths.length > 0 ? (
                  <ul style={{ margin: 0, paddingLeft: '24px' }}>
                    {mdaAnalysis.strengths.map((str: string, idx: number) => (
                      <li key={idx} style={{ marginBottom: '8px' }}>{str}</li>
                    ))}
                  </ul>
                ) : (
                  <p style={{ margin: 0, color: '#64748b' }}>The company is showing stable financial performance across key metrics. Continued monitoring will help identify emerging strengths.</p>
                )}
              </div>
            </div>

            <div style={{ marginBottom: '12px' }}>
              <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#ef4444', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '20px' }}>âš ï¸</span> Areas Requiring Management Attention
              </h3>
              <div style={{ fontSize: '15px', lineHeight: '1.8', color: '#1e293b' }}>
                {mdaAnalysis.weaknesses.length > 0 ? (
                  <ul style={{ margin: 0, paddingLeft: '24px' }}>
                    {mdaAnalysis.weaknesses.map((weak: string, idx: number) => (
                      <li key={idx} style={{ marginBottom: '8px' }}>{weak}</li>
                    ))}
                  </ul>
                ) : (
                  <p style={{ margin: 0, color: '#64748b' }}>Continue monitoring key financial indicators to maintain current performance levels and identify potential challenges early.</p>
                )}
              </div>
            </div>

            <div>
              <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#667eea', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '20px' }}>ðŸ’¡</span> Strategic Recommendations & Action Items
              </h3>
              <div style={{ fontSize: '15px', lineHeight: '1.8', color: '#1e293b' }}>
                {mdaAnalysis.insights.length > 0 ? (
                  <ul style={{ margin: 0, paddingLeft: '24px' }}>
                    {mdaAnalysis.insights.map((ins: string, idx: number) => (
                      <li key={idx} style={{ marginBottom: '8px' }}>{ins}</li>
                    ))}
                  </ul>
                ) : (
                  <p style={{ margin: 0, color: '#64748b' }}>Regular review of financial metrics and strategic planning will support continued growth and financial stability.</p>
                )}
              </div>
            </div>
          </div>
          )}

          {/* Strengths and Insights Tab */}
          {mdaTab === 'strengths-insights' && (
          <div id="mda-strengths-insights-container" style={{ display: 'grid', gap: '24px' }}>
            {mdaAnalysis.strengths.length > 0 && (
              <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#10b981', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '24px' }}>?</span> Strengths
                </h3>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                  {mdaAnalysis.strengths.map((str, idx) => (
                    <li key={idx} style={{ padding: '12px 16px', background: '#f0fdf4', borderRadius: '8px', marginBottom: '8px', borderLeft: '4px solid #10b981', fontSize: '14px', color: '#166534' }}>{str}</li>
                  ))}
                </ul>
              </div>
            )}

            {mdaAnalysis.weaknesses.length > 0 && (
              <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#ef4444', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '24px' }}>?</span> Areas for Improvement
                </h3>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                  {mdaAnalysis.weaknesses.map((weak, idx) => (
                    <li key={idx} style={{ padding: '12px 16px', background: '#fef2f2', borderRadius: '8px', marginBottom: '8px', borderLeft: '4px solid #ef4444', fontSize: '14px', color: '#991b1b' }}>{weak}</li>
                  ))}
                </ul>
              </div>
            )}

            {mdaAnalysis.insights.length > 0 && (
              <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#667eea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '24px' }}>ðŸ”</span> Strategic Insights
                </h3>
                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                  {mdaAnalysis.insights.map((ins, idx) => (
                    <li key={idx} style={{ padding: '12px 16px', background: '#ede9fe', borderRadius: '8px', marginBottom: '8px', borderLeft: '4px solid #667eea', fontSize: '14px', color: '#5b21b6' }}>{ins}</li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          )}

          {/* Critical Review Items Tab */}
          {mdaTab === 'key-metrics' && monthly.length >= 12 && (
          <div id="mda-key-metrics-container" style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <h2 style={{ fontSize: '28px', fontWeight: '700', color: '#1e293b', marginBottom: '12px', borderBottom: '3px solid #ef4444', paddingBottom: '12px' }}>
              âš ï¸ Critical Review Items
            </h2>
            
            <p style={{ fontSize: '15px', color: '#64748b', marginBottom: '32px', lineHeight: '1.6' }}>
              This analysis reviews all financial data across Trend Analysis, KPI Dashboard, Working Capital, and Cash Flow to identify issues requiring immediate attention.
            </p>

            {(() => {
              const issues: { category: string; severity: 'high' | 'medium' | 'low'; title: string; description: string; metric?: string }[] = [];
              const last = monthly[monthly.length - 1];
              const prev = monthly.length >= 2 ? monthly[monthly.length - 2] : last;
              const last12 = monthly.slice(-12);
              const prev12 = monthly.length >= 24 ? monthly.slice(-24, -12) : last12;

              // === REVENUE TREND ANALYSIS ===
              const revenueGrowth12mo = prev12.length > 0 ? 
                ((last12.reduce((s, m) => s + m.revenue, 0) - prev12.reduce((s, m) => s + m.revenue, 0)) / prev12.reduce((s, m) => s + m.revenue, 0)) * 100 : 0;
              
              if (revenueGrowth12mo < -5) {
                issues.push({
                  category: 'Revenue Trends',
                  severity: 'high',
                  title: 'Declining Revenue',
                  description: `Revenue has declined by ${Math.abs(revenueGrowth12mo).toFixed(1)}% over the past 12 months. This indicates potential market share loss, pricing pressure, or customer attrition.`,
                  metric: `${revenueGrowth12mo.toFixed(1)}%`
                });
              }

              // Check revenue volatility
              const revenueStdDev = (() => {
                const mean = last12.reduce((s, m) => s + m.revenue, 0) / last12.length;
                const variance = last12.reduce((s, m) => s + Math.pow(m.revenue - mean, 2), 0) / last12.length;
                return Math.sqrt(variance);
              })();
              const revenueCV = (revenueStdDev / (last12.reduce((s, m) => s + m.revenue, 0) / last12.length)) * 100;
              
              if (revenueCV > 25) {
                issues.push({
                  category: 'Revenue Trends',
                  severity: 'medium',
                  title: 'High Revenue Volatility',
                  description: `Revenue shows high volatility (${revenueCV.toFixed(1)}% coefficient of variation). This indicates inconsistent sales performance and unpredictable cash flow.`,
                  metric: `${revenueCV.toFixed(1)}% CV`
                });
              }

              // === EXPENSE ANALYSIS ===
              const expenseGrowth12mo = prev12.length > 0 ?
                ((last12.reduce((s, m) => s + m.expense, 0) - prev12.reduce((s, m) => s + m.expense, 0)) / prev12.reduce((s, m) => s + m.expense, 0)) * 100 : 0;
              
              if (expenseGrowth12mo > revenueGrowth12mo + 5) {
                issues.push({
                  category: 'Expense Control',
                  severity: 'high',
                  title: 'Expenses Growing Faster Than Revenue',
                  description: `Expenses have grown ${expenseGrowth12mo.toFixed(1)}% while revenue grew ${revenueGrowth12mo.toFixed(1)}%. This margin compression threatens profitability and requires immediate cost control measures.`,
                  metric: `${(expenseGrowth12mo - revenueGrowth12mo).toFixed(1)}% gap`
                });
              }

              // Expense as % of revenue trending
              const expenseRatio = (last.expense / last.revenue) * 100;
              const prevExpenseRatio = prev12.length > 0 ? (prev12.reduce((s, m) => s + m.expense, 0) / prev12.reduce((s, m) => s + m.revenue, 0)) * 100 : expenseRatio;
              
              if (expenseRatio > 90) {
                issues.push({
                  category: 'Expense Control',
                  severity: 'high',
                  title: 'Extremely High Expense Ratio',
                  description: `Total expenses represent ${expenseRatio.toFixed(1)}% of revenue, leaving minimal profit margin. The business is operating near break-even or at a loss.`,
                  metric: `${expenseRatio.toFixed(1)}%`
                });
              } else if (expenseRatio - prevExpenseRatio > 5) {
                issues.push({
                  category: 'Expense Control',
                  severity: 'medium',
                  title: 'Rising Expense Ratio',
                  description: `Expenses as a percentage of revenue have increased from ${prevExpenseRatio.toFixed(1)}% to ${expenseRatio.toFixed(1)}%, indicating deteriorating operational efficiency.`,
                  metric: `+${(expenseRatio - prevExpenseRatio).toFixed(1)}%`
                });
              }

              // === LIQUIDITY & RATIOS ===
              if (last.currentRatio < 1.0) {
                issues.push({
                  category: 'Liquidity',
                  severity: 'high',
                  title: 'Critical Liquidity Position',
                  description: `Current ratio of ${last.currentRatio.toFixed(2)} indicates current liabilities exceed current assets. The company may struggle to meet short-term obligations.`,
                  metric: `${last.currentRatio.toFixed(2)}`
                });
              } else if (last.currentRatio < 1.2) {
                issues.push({
                  category: 'Liquidity',
                  severity: 'medium',
                  title: 'Weak Liquidity Position',
                  description: `Current ratio of ${last.currentRatio.toFixed(2)} is below the healthy threshold of 1.5, indicating potential difficulty covering short-term obligations.`,
                  metric: `${last.currentRatio.toFixed(2)}`
                });
              }

              // Quick ratio
              if (last.quickRatio < 0.8) {
                issues.push({
                  category: 'Liquidity',
                  severity: last.quickRatio < 0.5 ? 'high' : 'medium',
                  title: 'Poor Quick Ratio',
                  description: `Quick ratio of ${last.quickRatio.toFixed(2)} shows the company cannot cover current liabilities with liquid assets. Heavy reliance on inventory or other less liquid assets.`,
                  metric: `${last.quickRatio.toFixed(2)}`
                });
              }

              // Debt ratios
              const debtToEquity = last.totalEquity > 0 ? last.totalLiab / last.totalEquity : 999;
              if (debtToEquity > 2.0) {
                issues.push({
                  category: 'Leverage',
                  severity: 'high',
                  title: 'High Debt Leverage',
                  description: `Debt-to-equity ratio of ${debtToEquity.toFixed(2)} indicates the company is heavily leveraged. High debt levels increase financial risk and interest expenses.`,
                  metric: `${debtToEquity.toFixed(2)}x`
                });
              }

              const debtRatio = last.totalAssets > 0 ? (last.totalLiab / last.totalAssets) * 100 : 0;
              if (debtRatio > 70) {
                issues.push({
                  category: 'Leverage',
                  severity: 'medium',
                  title: 'High Debt Ratio',
                  description: `${debtRatio.toFixed(1)}% of assets are financed by debt, indicating high financial leverage and potential vulnerability to economic downturns.`,
                  metric: `${debtRatio.toFixed(1)}%`
                });
              }

              // === PROFITABILITY ===
              const netMargin = last.revenue > 0 ? ((last.revenue - last.expense) / last.revenue) * 100 : 0;
              if (netMargin < 0) {
                issues.push({
                  category: 'Profitability',
                  severity: 'high',
                  title: 'Operating at a Loss',
                  description: `Net margin of ${netMargin.toFixed(1)}% indicates the company is losing money on operations. Immediate action required to restore profitability.`,
                  metric: `${netMargin.toFixed(1)}%`
                });
              } else if (netMargin < 5) {
                issues.push({
                  category: 'Profitability',
                  severity: 'medium',
                  title: 'Thin Profit Margins',
                  description: `Net margin of ${netMargin.toFixed(1)}% provides little buffer for unexpected costs or revenue shortfalls. Margin improvement strategies should be prioritized.`,
                  metric: `${netMargin.toFixed(1)}%`
                });
              }

              // ROE
              if (last.roe < 0) {
                issues.push({
                  category: 'Profitability',
                  severity: 'high',
                  title: 'Negative Return on Equity',
                  description: `ROE of ${(last.roe * 100).toFixed(1)}% indicates the company is destroying shareholder value. Equity holders are receiving negative returns.`,
                  metric: `${(last.roe * 100).toFixed(1)}%`
                });
              } else if (last.roe < 0.05) {
                issues.push({
                  category: 'Profitability',
                  severity: 'medium',
                  title: 'Low Return on Equity',
                  description: `ROE of ${(last.roe * 100).toFixed(1)}% is below typical market returns. Shareholders could achieve better returns elsewhere.`,
                  metric: `${(last.roe * 100).toFixed(1)}%`
                });
              }

              // === WORKING CAPITAL ===
              const workingCapital = last.tca - last.tcl;
              const wcRatio = last.revenue > 0 ? (workingCapital / (last.revenue / 12)) * 100 : 0;
              
              if (workingCapital < 0) {
                issues.push({
                  category: 'Working Capital',
                  severity: 'high',
                  title: 'Negative Working Capital',
                  description: `Working capital of $${workingCapital.toLocaleString()} indicates current liabilities exceed current assets. This creates immediate cash flow pressure and operational constraints.`,
                  metric: `$${workingCapital.toLocaleString()}`
                });
              }

              // Days Sales Outstanding - using LTM revenue
              const ltmRevenue = last12.reduce((s, m) => s + m.revenue, 0);
              const dso = ltmRevenue > 0 ? (last.ar / (ltmRevenue / 365)) : 0;
              if (dso > 60) {
                issues.push({
                  category: 'Working Capital',
                  severity: 'medium',
                  title: 'Slow Accounts Receivable Collection',
                  description: `Days Sales Outstanding of ${dso.toFixed(0)} days indicates slow customer payments. This ties up cash and may signal credit quality issues.`,
                  metric: `${dso.toFixed(0)} days`
                });
              }

              // Days Payable Outstanding - using LTM COGS
              const ltmCOGS = last12.reduce((s, m) => s + m.cogsTotal, 0);
              const dpo = ltmCOGS > 0 ? (last.ap / (ltmCOGS / 365)) : 0;
              if (dpo > 90) {
                issues.push({
                  category: 'Working Capital',
                  severity: 'medium',
                  title: 'Extended Payment Terms to Suppliers',
                  description: `Days Payable Outstanding of ${dpo.toFixed(0)} days may indicate cash flow stress, causing the company to delay supplier payments.`,
                  metric: `${dpo.toFixed(0)} days`
                });
              }

              // === CASH FLOW (if we have the data) ===
              const netIncome = last.revenue - last.expense;
              const workingCapitalChange = monthly.length >= 2 ? (last.tca - last.tcl) - (prev.tca - prev.tcl) : 0;
              const estimatedOCF = netIncome - workingCapitalChange;
              
              if (estimatedOCF < 0 && netIncome > 0) {
                issues.push({
                  category: 'Cash Flow',
                  severity: 'high',
                  title: 'Negative Operating Cash Flow Despite Profits',
                  description: `While showing accounting profits, the company is consuming cash in operations (estimated -$${Math.abs(estimatedOCF).toLocaleString()}). This often results from working capital build-up or non-cash revenue.`,
                  metric: `-$${Math.abs(estimatedOCF).toLocaleString()}`
                });
              }

              // Cash position declining
              if (monthly.length >= 6) {
                const cashTrend = last.cash - monthly[monthly.length - 6].cash;
                const cashTrendPct = monthly[monthly.length - 6].cash > 0 ? (cashTrend / monthly[monthly.length - 6].cash) * 100 : 0;
                if (cashTrendPct < -20) {
                  issues.push({
                    category: 'Cash Flow',
                    severity: 'high',
                    title: 'Rapid Cash Depletion',
                    description: `Cash has declined ${Math.abs(cashTrendPct).toFixed(1)}% over the past 6 months. At this burn rate, cash reserves may be exhausted quickly without corrective action.`,
                    metric: `${cashTrendPct.toFixed(1)}%`
                  });
                }
              }

              // === ASSET EFFICIENCY ===
              const assetTurnover = last.totalAssets > 0 ? (last.revenue * 12) / last.totalAssets : 0;
              if (assetTurnover < 0.5) {
                issues.push({
                  category: 'Asset Efficiency',
                  severity: 'low',
                  title: 'Low Asset Turnover',
                  description: `Asset turnover of ${assetTurnover.toFixed(2)}x indicates assets are not being utilized efficiently to generate revenue. Consider asset optimization or divestiture.`,
                  metric: `${assetTurnover.toFixed(2)}x`
                });
              }

              // === EXPENSE CATEGORY ANALYSIS (% of Revenue) ===
              const expenseCategories = [
                { key: 'cogsTotal', name: 'COGS Total', threshold: 70 },
                { key: 'cogsPayroll', name: 'COGS Payroll', threshold: 35 },
                { key: 'operatingExpenseTotal', name: 'Operating Expenses', threshold: 40 },
                { key: 'payroll', name: 'OPEX Payroll', threshold: 25 },
                { key: 'salesExpense', name: 'Sales & Marketing', threshold: 15 },
                { key: 'rent', name: 'Rent/Lease', threshold: 10 },
                { key: 'professionalFees', name: 'Professional Services', threshold: 8 }
              ];

              expenseCategories.forEach(cat => {
                if (mapping[cat.key as keyof typeof mapping] && last[cat.key as keyof typeof last]) {
                  const currentPct = last.revenue > 0 ? ((last[cat.key as keyof typeof last] as number) / last.revenue) * 100 : 0;
                  
                  // Check if expense category is too high
                  if (currentPct > cat.threshold) {
                    issues.push({
                      category: 'Expense Control',
                      severity: currentPct > cat.threshold * 1.3 ? 'high' : 'medium',
                      title: `High ${cat.name} Expense`,
                      description: `${cat.name} represents ${currentPct.toFixed(1)}% of revenue, which is above the recommended threshold of ${cat.threshold}%. This indicates potential inefficiencies or cost control issues in this area.`,
                      metric: `${currentPct.toFixed(1)}%`
                    });
                  }

                  // Check if trending upward
                  if (monthly.length >= 6) {
                    const sixMonthsAgo = monthly[monthly.length - 6];
                    const prevPct = sixMonthsAgo.revenue > 0 ? ((sixMonthsAgo[cat.key as keyof typeof sixMonthsAgo] as number || 0) / sixMonthsAgo.revenue) * 100 : 0;
                    const pctChange = currentPct - prevPct;
                    
                    if (pctChange > 3) {
                      issues.push({
                        category: 'Expense Trends',
                        severity: pctChange > 5 ? 'medium' : 'low',
                        title: `Rising ${cat.name} as % of Revenue`,
                        description: `${cat.name} has increased from ${prevPct.toFixed(1)}% to ${currentPct.toFixed(1)}% of revenue over the past 6 months. This trend indicates deteriorating cost control or operational inefficiency.`,
                        metric: `+${pctChange.toFixed(1)}%`
                      });
                    }
                  }
                }
              });

              // === BENCHMARK COMPARISON ===
              if (benchmarks && benchmarks.length > 0) {
                // Current Ratio vs Benchmark
                const currentRatioBM = benchmarks.find(b => b.metric === 'Current Ratio');
                if (currentRatioBM && last.currentRatio < currentRatioBM.p25) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'medium',
                    title: 'Current Ratio Below Industry Benchmark',
                    description: `Current ratio of ${last.currentRatio.toFixed(2)} is below the industry 25th percentile of ${currentRatioBM.p25.toFixed(2)}. This indicates weaker liquidity compared to industry peers.`,
                    metric: `${last.currentRatio.toFixed(2)} vs ${currentRatioBM.p25.toFixed(2)}`
                  });
                }

                // Quick Ratio vs Benchmark
                const quickRatioBM = benchmarks.find(b => b.metric === 'Quick Ratio');
                if (quickRatioBM && last.quickRatio < quickRatioBM.p25) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'medium',
                    title: 'Quick Ratio Below Industry Benchmark',
                    description: `Quick ratio of ${last.quickRatio.toFixed(2)} is below the industry 25th percentile of ${quickRatioBM.p25.toFixed(2)}. This suggests inadequate liquid assets compared to peers.`,
                    metric: `${last.quickRatio.toFixed(2)} vs ${quickRatioBM.p25.toFixed(2)}`
                  });
                }

                // Debt to Equity vs Benchmark
                const debtToEquityBM = benchmarks.find(b => b.metric === 'Debt to Equity');
                if (debtToEquityBM && debtToEquity < 900 && debtToEquity > debtToEquityBM.p75) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'medium',
                    title: 'Debt-to-Equity Above Industry Benchmark',
                    description: `Debt-to-equity ratio of ${debtToEquity.toFixed(2)} exceeds the industry 75th percentile of ${debtToEquityBM.p75.toFixed(2)}. The company is more leveraged than most peers.`,
                    metric: `${debtToEquity.toFixed(2)} vs ${debtToEquityBM.p75.toFixed(2)}`
                  });
                }

                // ROE vs Benchmark
                const roeBM = benchmarks.find(b => b.metric === 'Return on Equity (ROE)');
                if (roeBM && last.roe < roeBM.p25) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'medium',
                    title: 'ROE Below Industry Benchmark',
                    description: `Return on Equity of ${(last.roe * 100).toFixed(1)}% is below the industry 25th percentile of ${(roeBM.p25 * 100).toFixed(1)}%. The company is generating lower returns than most competitors.`,
                    metric: `${(last.roe * 100).toFixed(1)}% vs ${(roeBM.p25 * 100).toFixed(1)}%`
                  });
                }

                // ROA vs Benchmark
                const roaBM = benchmarks.find(b => b.metric === 'Return on Assets (ROA)');
                if (roaBM && last.roa < roaBM.p25) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'low',
                    title: 'ROA Below Industry Benchmark',
                    description: `Return on Assets of ${(last.roa * 100).toFixed(1)}% is below the industry 25th percentile of ${(roaBM.p25 * 100).toFixed(1)}%. Asset utilization is weaker than industry peers.`,
                    metric: `${(last.roa * 100).toFixed(1)}% vs ${(roaBM.p25 * 100).toFixed(1)}%`
                  });
                }

                // Profit Margin vs Benchmark
                const profitMarginBM = benchmarks.find(b => b.metric === 'Profit Margin');
                if (profitMarginBM && netMargin < profitMarginBM.p25) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: netMargin < 0 ? 'high' : 'medium',
                    title: 'Profit Margin Below Industry Benchmark',
                    description: `Net profit margin of ${netMargin.toFixed(1)}% is below the industry 25th percentile of ${profitMarginBM.p25.toFixed(1)}%. Profitability is weaker than most competitors.`,
                    metric: `${netMargin.toFixed(1)}% vs ${profitMarginBM.p25.toFixed(1)}%`
                  });
                }

                // Asset Turnover vs Benchmark
                const assetTurnoverBM = benchmarks.find(b => b.metric === 'Asset Turnover');
                if (assetTurnoverBM && assetTurnover < assetTurnoverBM.p25) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'low',
                    title: 'Asset Turnover Below Industry Benchmark',
                    description: `Asset turnover of ${assetTurnover.toFixed(2)}x is below the industry 25th percentile of ${assetTurnoverBM.p25.toFixed(2)}x. Assets are being used less efficiently than peers.`,
                    metric: `${assetTurnover.toFixed(2)}x vs ${assetTurnoverBM.p25.toFixed(2)}x`
                  });
                }

                // DSO vs Benchmark  
                const dsoBM = benchmarks.find(b => b.metric === 'Days Sales Outstanding (DSO)');
                if (dsoBM && dso > dsoBM.p75) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'medium',
                    title: 'DSO Above Industry Benchmark',
                    description: `Days Sales Outstanding of ${dso.toFixed(0)} days exceeds the industry 75th percentile of ${dsoBM.p75.toFixed(0)} days. Collections are slower than most competitors.`,
                    metric: `${dso.toFixed(0)} vs ${dsoBM.p75.toFixed(0)} days`
                  });
                }

                // Expense Ratio vs Benchmark
                const expenseRatioBM = benchmarks.find(b => b.metric === 'Expense Ratio');
                if (expenseRatioBM && expenseRatio > expenseRatioBM.p75) {
                  issues.push({
                    category: 'Benchmarks',
                    severity: 'medium',
                    title: 'Expense Ratio Above Industry Benchmark',
                    description: `Total expense ratio of ${expenseRatio.toFixed(1)}% exceeds the industry 75th percentile of ${expenseRatioBM.p75.toFixed(1)}%. Operating costs are higher than most competitors.`,
                    metric: `${expenseRatio.toFixed(1)}% vs ${expenseRatioBM.p75.toFixed(1)}%`
                  });
                }
              }

              // === FINANCIAL SCORE ANALYSIS ===
              // Check overall Financial Score
              if (finalScore < 40) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'high',
                  title: 'Critical Financial Score',
                  description: `Overall Financial Score of ${finalScore.toFixed(1)} is critically low, indicating severe financial distress. Both profitability and asset development require immediate attention.`,
                  metric: `${finalScore.toFixed(1)}/100`
                });
              } else if (finalScore < 60) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'medium',
                  title: 'Below Average Financial Score',
                  description: `Financial Score of ${finalScore.toFixed(1)} is below industry standards. The company needs to improve both revenue growth/profitability and asset management.`,
                  metric: `${finalScore.toFixed(1)}/100`
                });
              } else if (finalScore < 70) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'low',
                  title: 'Moderate Financial Score',
                  description: `Financial Score of ${finalScore.toFixed(1)} shows room for improvement. Consider strategies to enhance profitability and strengthen the balance sheet.`,
                  metric: `${finalScore.toFixed(1)}/100`
                });
              }

              // Check Profitability Score component
              if (profitabilityScore < 40) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'high',
                  title: 'Critical Profitability Score',
                  description: `Profitability Score of ${profitabilityScore.toFixed(1)} indicates severe issues with revenue growth and expense management. Revenue may be declining or expenses growing faster than revenue.`,
                  metric: `${profitabilityScore.toFixed(1)}/100`
                });
              } else if (profitabilityScore < 60) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'medium',
                  title: 'Weak Profitability Score',
                  description: `Profitability Score of ${profitabilityScore.toFixed(1)} suggests underperformance in revenue growth or expense control. Review pricing strategies, cost structure, and market positioning.`,
                  metric: `${profitabilityScore.toFixed(1)}/100`
                });
              }

              // Check Asset Development Score component
              if (assetDevScore < 40) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'high',
                  title: 'Critical Asset Development Score',
                  description: `Asset Development Score of ${assetDevScore.toFixed(1)} indicates a weak balance sheet with assets barely exceeding liabilities. Asset-to-Liability ratio of ${alr1.toFixed(2)}:1 suggests potential solvency issues.`,
                  metric: `${assetDevScore.toFixed(1)}/100 (ALR: ${alr1.toFixed(2)})`
                });
              } else if (assetDevScore < 60) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'medium',
                  title: 'Weak Asset Development Score',
                  description: `Asset Development Score of ${assetDevScore.toFixed(1)} indicates limited asset growth relative to liabilities. Asset-to-Liability ratio of ${alr1.toFixed(2)}:1 could be stronger to support future growth.`,
                  metric: `${assetDevScore.toFixed(1)}/100 (ALR: ${alr1.toFixed(2)})`
                });
              }

              // Check Asset-to-Liability Ratio trend
              if (alr1 < 1.0) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'high',
                  title: 'Liabilities Exceed Assets',
                  description: `Asset-to-Liability ratio of ${alr1.toFixed(2)}:1 means liabilities exceed assets, indicating the company is technically insolvent on paper. This requires immediate financial restructuring or capital injection.`,
                  metric: `${alr1.toFixed(2)}:1`
                });
              } else if (alr1 < 1.2 && alrGrowth < -10) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'high',
                  title: 'Deteriorating Asset-to-Liability Ratio',
                  description: `Asset-to-Liability ratio has declined by ${Math.abs(alrGrowth).toFixed(1)}% to ${alr1.toFixed(2)}:1. The balance sheet is weakening, with liabilities growing faster than assets.`,
                  metric: `${alr1.toFixed(2)}:1 (${alrGrowth.toFixed(1)}%)`
                });
              } else if (alrGrowth < -5) {
                issues.push({
                  category: 'Financial Score',
                  severity: 'medium',
                  title: 'Declining Asset Quality',
                  description: `Asset-to-Liability ratio decreased by ${Math.abs(alrGrowth).toFixed(1)}%, suggesting assets are not growing as fast as liabilities. Monitor debt levels and asset utilization.`,
                  metric: `${alrGrowth.toFixed(1)}% decline`
                });
              }

              // Check Financial Score trend if we have historical data
              if (trendData && trendData.length >= 6) {
                const currentFinScore = trendData[trendData.length - 1].financialScore;
                const sixMonthsAgoFinScore = trendData[trendData.length - 6].financialScore;
                const finScoreChange = currentFinScore - sixMonthsAgoFinScore;
                
                if (finScoreChange < -15) {
                  issues.push({
                    category: 'Financial Score',
                    severity: 'high',
                    title: 'Rapidly Declining Financial Score',
                    description: `Financial Score has dropped ${Math.abs(finScoreChange).toFixed(1)} points over the past 6 months, from ${sixMonthsAgoFinScore.toFixed(1)} to ${currentFinScore.toFixed(1)}. This rapid deterioration requires immediate management attention.`,
                    metric: `${finScoreChange.toFixed(1)} pts`
                  });
                } else if (finScoreChange < -10) {
                  issues.push({
                    category: 'Financial Score',
                    severity: 'medium',
                    title: 'Declining Financial Score Trend',
                    description: `Financial Score has decreased by ${Math.abs(finScoreChange).toFixed(1)} points over the past 6 months. The company's financial health is trending in the wrong direction.`,
                    metric: `${finScoreChange.toFixed(1)} pts`
                  });
                }

                // Check Profitability Score trend
                const currentProfScore = trendData[trendData.length - 1].profitabilityScore;
                const sixMonthsAgoProfScore = trendData[trendData.length - 6].profitabilityScore;
                const profScoreChange = currentProfScore - sixMonthsAgoProfScore;
                
                if (profScoreChange < -15) {
                  issues.push({
                    category: 'Financial Score',
                    severity: 'medium',
                    title: 'Deteriorating Profitability Trend',
                    description: `Profitability Score has fallen ${Math.abs(profScoreChange).toFixed(1)} points over 6 months, indicating worsening revenue growth and/or expense control.`,
                    metric: `${profScoreChange.toFixed(1)} pts`
                  });
                }

                // Check Asset Development Score trend
                const currentAdsScore = trendData[trendData.length - 1].adsScore;
                const sixMonthsAgoAdsScore = trendData[trendData.length - 6].adsScore;
                const adsScoreChange = currentAdsScore - sixMonthsAgoAdsScore;
                
                if (adsScoreChange < -15) {
                  issues.push({
                    category: 'Financial Score',
                    severity: 'medium',
                    title: 'Weakening Balance Sheet Trend',
                    description: `Asset Development Score has dropped ${Math.abs(adsScoreChange).toFixed(1)} points over 6 months, indicating the balance sheet is deteriorating relative to historical levels.`,
                    metric: `${adsScoreChange.toFixed(1)} pts`
                  });
                }
              }

              // Sort by severity
              const severityOrder = { high: 0, medium: 1, low: 2 };
              issues.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);

              return (
                <div>
                  {/* Summary Stats */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '32px' }}>
                    <div style={{ background: '#fee2e2', borderRadius: '12px', padding: '20px', border: '2px solid #ef4444' }}>
                      <div style={{ fontSize: '32px', fontWeight: '700', color: '#991b1b', marginBottom: '8px' }}>
                        {issues.filter(i => i.severity === 'high').length}
                      </div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#7f1d1d' }}>High Priority Issues</div>
                    </div>
                    <div style={{ background: '#fef3c7', borderRadius: '12px', padding: '20px', border: '2px solid #f59e0b' }}>
                      <div style={{ fontSize: '32px', fontWeight: '700', color: '#92400e', marginBottom: '8px' }}>
                        {issues.filter(i => i.severity === 'medium').length}
                      </div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#78350f' }}>Medium Priority Issues</div>
                    </div>
                    <div style={{ background: '#dbeafe', borderRadius: '12px', padding: '20px', border: '2px solid #3b82f6' }}>
                      <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e40af', marginBottom: '8px' }}>
                        {issues.filter(i => i.severity === 'low').length}
                      </div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#1e3a8a' }}>Low Priority Issues</div>
                    </div>
                  </div>

                  {/* Issues List */}
                  {issues.length === 0 ? (
                    <div style={{ background: '#d1fae5', borderRadius: '12px', padding: '32px', textAlign: 'center', border: '2px solid #10b981' }}>
                      <div style={{ fontSize: '48px', marginBottom: '16px' }}>?</div>
                      <h3 style={{ fontSize: '20px', fontWeight: '700', color: '#065f46', marginBottom: '12px' }}>No Critical Issues Detected</h3>
                      <p style={{ fontSize: '15px', color: '#047857', margin: 0 }}>
                        All analyzed metrics are within acceptable ranges. Continue monitoring for any changes.
                      </p>
                    </div>
                  ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                      {issues.map((issue, idx) => {
                        const bgColor = issue.severity === 'high' ? '#fee2e2' : issue.severity === 'medium' ? '#fef3c7' : '#dbeafe';
                        const borderColor = issue.severity === 'high' ? '#ef4444' : issue.severity === 'medium' ? '#f59e0b' : '#3b82f6';
                        const textColor = issue.severity === 'high' ? '#991b1b' : issue.severity === 'medium' ? '#92400e' : '#1e40af';
                        const icon = issue.severity === 'high' ? 'ðŸ”´' : issue.severity === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢';
                        
                        return (
                          <div key={idx} style={{ background: bgColor, borderRadius: '12px', padding: '20px', border: `2px solid ${borderColor}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                              <div style={{ flex: 1 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                  <span style={{ fontSize: '18px' }}>{icon}</span>
                                  <span style={{ fontSize: '11px', fontWeight: '700', color: textColor, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                    {issue.category}
                                  </span>
                                </div>
                                <h3 style={{ fontSize: '18px', fontWeight: '700', color: textColor, marginBottom: '8px', margin: 0 }}>
                                  {issue.title}
                                </h3>
                              </div>
                              {issue.metric && (
                                <div style={{ background: 'white', borderRadius: '8px', padding: '8px 16px', border: `1px solid ${borderColor}` }}>
                                  <div style={{ fontSize: '18px', fontWeight: '700', color: textColor }}>{issue.metric}</div>
                                </div>
                              )}
                            </div>
                            <p style={{ fontSize: '14px', color: textColor, margin: 0, lineHeight: '1.6' }}>
                              {issue.description}
                            </p>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {/* Action Items */}
                  {issues.filter(i => i.severity === 'high').length > 0 && (
                    <div style={{ marginTop: '32px', background: '#f8fafc', borderRadius: '12px', padding: '24px', border: '2px solid #667eea' }}>
                      <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px' }}>âœ… Recommended Actions</h3>
                      <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '14px', color: '#475569', lineHeight: '1.8' }}>
                        {issues.filter(i => i.severity === 'high').length > 0 && (
                          <li><strong>Immediate attention required:</strong> Address all high-priority issues within the next 30 days</li>
                        )}
                        {issues.some(i => i.category === 'Liquidity') && (
                          <li><strong>Improve liquidity:</strong> Focus on accelerating collections, managing payables, and securing additional working capital if needed</li>
                        )}
                        {issues.some(i => i.category === 'Expense Control') && (
                          <li><strong>Cost reduction:</strong> Conduct detailed expense review to identify cost-saving opportunities without impacting revenue</li>
                        )}
                        {issues.some(i => i.category === 'Revenue Trends') && (
                          <li><strong>Revenue growth:</strong> Develop strategies to stabilize and grow revenue through new markets, products, or customer acquisition</li>
                        )}
                        {issues.some(i => i.category === 'Cash Flow') && (
                          <li><strong>Cash management:</strong> Implement cash flow forecasting and monitoring to prevent liquidity crises</li>
                        )}
                        <li><strong>Regular monitoring:</strong> Review these metrics weekly until trends improve</li>
                      </ul>
                    </div>
                  )}
                </div>
              );
            })()}
          </div>
          )}
        </div>
      )}

      {/* Projections View */}
      {currentView === 'projections' && selectedCompanyId && projections.mostLikely.length > 0 && (
        <div style={{ maxWidth: '100%', padding: '32px 32px 32px 16px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Financial Projections</h1>
            {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
          </div>

          <div style={{ display: 'grid', gap: '32px' }}>
            <ProjectionChart title="Revenue Projection" historicalData={projections.monthlyWithNetIncome || monthly} projectedData={projections} valueKey="revenue" formatValue={(v) => `$${(v / 1000).toFixed(0)}K`} />
            <ProjectionChart title="Expense Projection" historicalData={projections.monthlyWithNetIncome || monthly} projectedData={projections} valueKey="expense" formatValue={(v) => `$${(v / 1000).toFixed(0)}K`} />
            <ProjectionChart title="Net Income Projection" historicalData={projections.monthlyWithNetIncome || monthly} projectedData={projections} valueKey="netIncome" formatValue={(v) => `$${(v / 1000).toFixed(0)}K`} />
            <ProjectionChart title="Total Assets Projection" historicalData={monthly} projectedData={projections} valueKey="totalAssets" formatValue={(v) => `$${(v / 1000).toFixed(0)}K`} />
            <ProjectionChart title="Total Liabilities Projection" historicalData={monthly} projectedData={projections} valueKey="totalLiab" formatValue={(v) => `$${(v / 1000).toFixed(0)}K`} />
            <ProjectionChart title="Equity Projection" historicalData={monthly} projectedData={projections} valueKey="totalEquity" formatValue={(v) => `$${(v / 1000).toFixed(0)}K`} />
          </div>
        </div>
      )}

      {/* Goals View */}
      {currentView === 'goals' && selectedCompanyId && monthly.length >= 6 && (
        <GoalsView
          selectedCompanyId={selectedCompanyId}
          companyName={companyName}
          monthly={monthly}
          expenseGoals={expenseGoals}
          setExpenseGoals={setExpenseGoals}
          masterDataCategories={masterDataCategories}
          setMasterDataCategories={setMasterDataCategories}
        />
      )}

      {/* Working Capital View */}
      {currentView === 'working-capital' && selectedCompanyId && monthly.length > 0 && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <style>{`
            @media print {
              @page {
                size: portrait;
                margin: 0.3in;
              }

              /* Hide navigation and UI elements */
              .no-print,
              .dashboard-header-print-hide {
                display: none !important;
              }
            }
          `}</style>

          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <div>
              <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: '0 0 8px 0' }}>Working Capital Analysis</h1>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <button
                onClick={() => window.print()}
                style={{
                  padding: '12px 24px',
                  background: '#10b981',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                ðŸ–¨ï¸ Print Report
              </button>
            </div>
          </div>

          {/* Working Capital Overview */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '24px', marginBottom: '32px' }}>
            {(() => {
              const lastMonth = monthly[monthly.length - 1];
              const currentAssets = lastMonth.tca || ((lastMonth.cash || 0) + (lastMonth.ar || 0) + (lastMonth.inventory || 0) + (lastMonth.otherCA || 0));
              const currentLiab = Math.abs(lastMonth.tcl || ((lastMonth.ap || 0) + (lastMonth.otherCL || 0)));
              const workingCapital = currentAssets - currentLiab;
              const wcRatio = currentLiab > 0 ? currentAssets / currentLiab : 0;

              // Calculate trend (compare to previous month)
              const prevMonth = monthly.length > 1 ? monthly[monthly.length - 2] : null;
              const prevWC = prevMonth ? (prevMonth.tca || ((prevMonth.cash || 0) + (prevMonth.ar || 0) + (prevMonth.inventory || 0) + (prevMonth.otherCA || 0))) - Math.abs(prevMonth.tcl || ((prevMonth.ap || 0) + (prevMonth.otherCL || 0))) : workingCapital;
              const wcChange = workingCapital - prevWC;
              const wcChangePercent = prevWC !== 0 ? (wcChange / Math.abs(prevWC)) * 100 : 0;

              return (
                <>
                  <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea' }}>
                    <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px' }}>ðŸ’¼ Current Working Capital</h3>
                    <div style={{ fontSize: '36px', fontWeight: '700', color: '#1e293b', marginBottom: '8px' }}>
                      ${(workingCapital / 1000).toFixed(0)}K
                    </div>
                    <div style={{ fontSize: '14px', color: wcChange >= 0 ? '#10b981' : '#ef4444', fontWeight: '600', marginBottom: '16px' }}>
                      {wcChange >= 0 ? 'â†—ï¸ +' : 'â†˜ï¸ '}${Math.abs(wcChange / 1000).toFixed(0)}K ({wcChangePercent >= 0 ? '+' : ''}{wcChangePercent.toFixed(1)}%)
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '12px' }}>
                      <div>
                        <div style={{ color: '#64748b', marginBottom: '4px' }}>Current Assets</div>
                        <div style={{ fontWeight: '600', color: '#1e293b' }}>${(currentAssets / 1000).toFixed(0)}K</div>
                      </div>
                      <div>
                        <div style={{ color: '#64748b', marginBottom: '4px' }}>Current Liabilities</div>
                        <div style={{ fontWeight: '600', color: '#1e293b' }}>${(currentLiab / 1000).toFixed(0)}K</div>
                      </div>
                    </div>
                  </div>

                  <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea' }}>
                    <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px' }}>ðŸ“Š Working Capital Ratio</h3>
                    <div style={{ fontSize: '36px', fontWeight: '700', color: wcRatio >= 1.5 ? '#10b981' : wcRatio >= 1.0 ? '#f59e0b' : '#ef4444', marginBottom: '8px' }}>
                      {wcRatio.toFixed(2)}
                    </div>
                    <div style={{ fontSize: '14px', color: '#64748b', marginBottom: '16px' }}>
                      {wcRatio >= 1.5 ? 'ðŸ’ª Strong liquidity position' : wcRatio >= 1.0 ? 'âš ï¸ Adequate liquidity' : 'ðŸš¨ Needs attention'}
                    </div>
                    <div style={{ fontSize: '12px', color: '#64748b' }}>
                      Industry standard: 1.2 - 2.0
                    </div>
                  </div>

                  <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea' }}>
                    <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#667eea', marginBottom: '16px' }}>â±ï¸ Days Working Capital</h3>
                    <div style={{ fontSize: '36px', fontWeight: '700', color: '#1e293b', marginBottom: '8px' }}>
                      {(() => {
                        const avgRevenue = monthly.slice(-12).reduce((sum, m) => sum + (m.revenue || 0), 0) / Math.max(monthly.slice(-12).length, 1);
                        const daysWC = workingCapital > 0 && avgRevenue > 0 ? (workingCapital / avgRevenue) * 365 : 0;
                        return daysWC.toFixed(0);
                      })()}
                    </div>
                    <div style={{ fontSize: '14px', color: '#64748b', marginBottom: '16px' }}>
                      Days of revenue covered by working capital
                    </div>
                    <div style={{ fontSize: '12px', color: '#64748b' }}>
                      Benchmark: 30-90 days
                    </div>
                  </div>
                </>
              );
            })()}
          </div>

          {/* Working Capital Components Analysis */}
          <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', marginBottom: '24px' }}>
            <h3 style={{ fontSize: '20px', fontWeight: '700', color: '#1e293b', marginBottom: '20px' }}>Working Capital Components</h3>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '16px' }}>
              {(() => {
                const lastMonth = monthly[monthly.length - 1];
                const components = [
                  {
                    name: 'Cash',
                    value: lastMonth.cash || 0,
                    category: 'Current Assets',
                    color: '#10b981'
                  },
                  {
                    name: 'Accounts Receivable',
                    value: lastMonth.ar || 0,
                    category: 'Current Assets',
                    color: '#3b82f6'
                  },
                  {
                    name: 'Inventory',
                    value: lastMonth.inventory || 0,
                    category: 'Current Assets',
                    color: '#8b5cf6'
                  },
                  {
                    name: 'Other Current Assets',
                    value: lastMonth.otherCA || 0,
                    category: 'Current Assets',
                    color: '#06b6d4'
                  },
                  {
                    name: 'Accounts Payable',
                    value: Math.abs(lastMonth.ap || 0),
                    category: 'Current Liabilities',
                    color: '#ef4444'
                  },
                  {
                    name: 'Other Current Liabilities',
                    value: Math.abs(lastMonth.otherCL || 0),
                    category: 'Current Liabilities',
                    color: '#f59e0b'
                  }
                ];

                return components.map((component, index) => (
                  <div key={index} style={{
                    padding: '16px',
                    border: '1px solid #e2e8f0',
                    borderRadius: '8px',
                    background: 'linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%)'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                      <span style={{ fontSize: '14px', fontWeight: '600', color: '#374151' }}>{component.name}</span>
                      <span style={{ fontSize: '12px', color: '#6b7280', background: component.color + '20', padding: '2px 8px', borderRadius: '12px' }}>
                        {component.category}
                      </span>
                    </div>
                    <div style={{ fontSize: '18px', fontWeight: '700', color: component.color }}>
                      ${(component.value / 1000).toFixed(1)}K
                    </div>
                  </div>
                ));
              })()}
            </div>
          </div>

          {/* Working Capital Trend Analysis */}
          <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <h3 style={{ fontSize: '20px', fontWeight: '700', color: '#1e293b', marginBottom: '20px' }}>Working Capital Trend (Last 12 Months)</h3>

            <div style={{ height: '300px', position: 'relative' }}>
              <SimpleChart
                data={monthly.slice(-12).map((month, index) => {
                  const currentAssets = month.tca || ((month.cash || 0) + (month.ar || 0) + (month.inventory || 0) + (month.otherCA || 0));
                  const currentLiab = Math.abs(month.tcl || ((month.ap || 0) + (month.otherCL || 0)));
                  const wc = currentAssets - currentLiab;

                  return {
                    month: month.month ? new Date(month.month).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) : `M${index + 1}`,
                    workingCapital: wc / 1000, // Convert to thousands
                    currentAssets: currentAssets / 1000,
                    currentLiabilities: currentLiab / 1000
                  };
                })}
                valueKey="workingCapital"
                title=""
                formatValue={(v) => `$${v.toFixed(0)}K`}
                showGrid={true}
                showLegend={false}
                color="#667eea"
              />
            </div>

            <div style={{ marginTop: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
              <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Key Insights</h4>
              <ul style={{ fontSize: '14px', color: '#64748b', lineHeight: '1.6', margin: 0, paddingLeft: '20px' }}>
                <li>Working capital represents the funds available for day-to-day operations</li>
                <li>A ratio above 1.0 indicates positive working capital (assets &gt; liabilities)</li>
                <li>Consistent positive trends suggest improving liquidity position</li>
                <li>Monitor accounts receivable and payable cycles for optimization opportunities</li>
              </ul>
            </div>
          </div>
        </div>
      )}

      {/* Valuation View */}
      {currentView === 'valuation' && selectedCompanyId && monthly.length > 0 && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Business Valuation</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <button
                onClick={async () => {
                  console.log('?? Saving valuation settings for company:', selectedCompanyId);
                  setValuationSaveStatus('saving');
                  try {
                    const response = await fetch('/api/valuation-settings', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        companyId: selectedCompanyId,
                        sdeMultiplier,
                        ebitdaMultiplier,
                        dcfDiscountRate,
                        dcfTerminalGrowth
                      })
                    });
                    const result = await response.json();
                    console.log('?? Save response:', result);
                    if (response.ok) {
                      setValuationSaveStatus('saved');
                      setTimeout(() => setValuationSaveStatus('idle'), 3000);
                    } else {
                      console.error('? Failed to save valuation settings:', result);
                      setValuationSaveStatus('error');
                      setTimeout(() => setValuationSaveStatus('idle'), 3000);
                    }
                  } catch (error) {
                    console.error('? Error saving valuation settings:', error);
                    setValuationSaveStatus('error');
                    setTimeout(() => setValuationSaveStatus('idle'), 3000);
                  }
                }}
                disabled={valuationSaveStatus === 'saving'}
                style={{
                  padding: '12px 32px',
                  background: valuationSaveStatus === 'saved' ? '#10b981' : valuationSaveStatus === 'error' ? '#ef4444' : valuationSaveStatus === 'saving' ? '#94a3b8' : '#667eea',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: valuationSaveStatus === 'saving' ? 'not-allowed' : 'pointer',
                  whiteSpace: 'nowrap',
                  transition: 'all 0.3s ease'
                }}
              >
                {valuationSaveStatus === 'saving' ? '?? Saving...' : valuationSaveStatus === 'saved' ? '? Saved!' : valuationSaveStatus === 'error' ? '? Error' : 'Save Settings'}
              </button>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
            </div>
          </div>
          
          {(() => {
            // Calculate trailing 12 months values
            const last12 = monthly.slice(-12);
            const ttmRevenue = last12.reduce((sum, m) => sum + (m.revenue || 0), 0);
            const ttmCOGS = last12.reduce((sum, m) => sum + (m.cogsTotal || 0), 0);
            const ttmExpense = last12.reduce((sum, m) => sum + (m.expense || 0), 0);
            const ttmDepreciation = last12.reduce((sum, m) => sum + (m.depreciationAmortization || 0), 0);
            const ttmInterest = last12.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
            
            // Calculate Net Income correctly: Revenue - COGS - Operating Expenses
            const ttmGrossProfit = ttmRevenue - ttmCOGS;
            const ttmNetIncome = ttmRevenue - ttmCOGS - ttmExpense;
            
            // Calculate EBITDA: Net Income + Interest + Taxes + Depreciation + Amortization
            const ttmEBITDA = ttmNetIncome + ttmDepreciation + ttmInterest;
            // Note: We don't have a separate tax field, so this is technically EBIT if taxes are in 'expense'
            
            // Calculate SDE using ACTUAL Owner Base Pay from income statement
            const ttmOwnerBasePay = last12.reduce((sum, m) => sum + (m.ownerBasePay || 0), 0);
            const ttmSDE = ttmEBITDA + ttmOwnerBasePay;
            
            // Calculate valuations
            const sdeValuation = ttmSDE * sdeMultiplier;
            const ebitdaValuation = ttmEBITDA * ebitdaMultiplier;
            
            // Calculate Free Cash Flow (FCF) for DCF
            // FCF = Net Income + Depreciation - Changes in Working Capital - CapEx
            const currentMonth = monthly[monthly.length - 1];
            const month12Ago = monthly.length >= 13 ? monthly[monthly.length - 13] : monthly[0];
            
            // Working capital change over last 12 months
            const currentWC = ((currentMonth.cash || 0) + (currentMonth.ar || 0) + (currentMonth.inventory || 0)) - ((currentMonth.ap || 0) + (currentMonth.otherCL || 0));
            const priorWC = ((month12Ago.cash || 0) + (month12Ago.ar || 0) + (month12Ago.inventory || 0)) - ((month12Ago.ap || 0) + (month12Ago.otherCL || 0));
            const changeInWC = currentWC - priorWC;
            
            // Capital expenditures (change in fixed assets + depreciation)
            const changeInFixedAssets = (currentMonth.fixedAssets || 0) - (month12Ago.fixedAssets || 0);
            const ttmCapEx = Math.max(0, changeInFixedAssets + ttmDepreciation);
            
            // Free Cash Flow using ACTUAL depreciation
            const ttmFreeCashFlow = ttmNetIncome + ttmDepreciation - changeInWC - ttmCapEx;
            
            // DCF calculation with adjustable parameters using FCF
            const growthRate = growth_24mo / 100;
            const discountRate = dcfDiscountRate / 100;
            const terminalGrowthRate = dcfTerminalGrowth / 100;
            let dcfValue = 0;
            for (let year = 1; year <= 5; year++) {
              const projectedFCF = ttmFreeCashFlow * Math.pow(1 + growthRate, year);
              dcfValue += projectedFCF / Math.pow(1 + discountRate, year);
            }
            const terminalValue = (ttmFreeCashFlow * Math.pow(1 + growthRate, 5) * (1 + terminalGrowthRate)) / (discountRate - terminalGrowthRate);
            dcfValue += terminalValue / Math.pow(1 + discountRate, 5);
            
            return (
              <>
                {/* Overview Cards */}
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '32px' }}>
                  <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #10b981' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>SDE Valuation</h3>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981', marginBottom: '8px' }}>
                      ${Math.round(sdeValuation).toLocaleString()}
                    </div>
                    <div style={{ fontSize: '13px', color: '#64748b' }}>
                      TTM SDE: ${(ttmSDE / 1000).toFixed(0)}K Ã— {sdeMultiplier}x
                    </div>
                  </div>
                  
                  <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>EBITDA Valuation</h3>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#667eea', marginBottom: '8px' }}>
                      ${Math.round(ebitdaValuation).toLocaleString()}
                    </div>
                    <div style={{ fontSize: '13px', color: '#64748b' }}>
                      TTM EBITDA: ${(ttmEBITDA / 1000).toFixed(0)}K Ã— {ebitdaMultiplier}x
                    </div>
                  </div>
                  
                  <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #f59e0b' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>DCF Valuation</h3>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#f59e0b', marginBottom: '8px' }}>
                      ${Math.round(dcfValue).toLocaleString()}
                    </div>
                    <div style={{ fontSize: '13px', color: '#64748b' }}>
                      5-year @ {dcfDiscountRate.toFixed(1)}% discount, {dcfTerminalGrowth.toFixed(1)}% terminal
                    </div>
                  </div>
                </div>
                
                {/* SDE Method */}
                <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '20px' }}>
                    Seller's Discretionary Earnings (SDE) Method
                  </h2>
                  
                  <div style={{ background: '#f0fdf4', borderRadius: '8px', padding: '20px', marginBottom: '20px' }}>
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ fontSize: '14px', color: '#64748b', marginBottom: '4px' }}>Trailing 12 Months SDE</div>
                      <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>${(ttmSDE / 1000).toFixed(0)}K</div>
                    </div>
                    
                    <div style={{ fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                      <strong>Calculation:</strong> EBITDA + Owner Base Pay + Discretionary Expenses
                      <br/>
                      = ${(ttmEBITDA / 1000).toFixed(0)}K + ${(ttmOwnerBasePay / 1000).toFixed(0)}K
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                      SDE Multiple: {sdeMultiplier.toFixed(1)}x
                    </label>
                    <input 
                      type="range" 
                      min="1" 
                      max="5" 
                      step="0.1" 
                      value={sdeMultiplier} 
                      onChange={(e) => setSdeMultiplier(parseFloat(e.target.value))} 
                      style={{ width: '100%', marginBottom: '8px' }} 
                    />
                    <div style={{ fontSize: '12px', color: '#64748b', display: 'flex', justifyContent: 'space-between' }}>
                      <span>Typical Range: 1.5x - 4.0x</span>
                      <span>Industry Average: 2.5x</span>
                    </div>
                  </div>
                  
                  <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>
                      Estimated Business Value (SDE)
                    </div>
                    <div style={{ fontSize: '36px', fontWeight: '700', color: '#10b981' }}>
                      ${Math.round(sdeValuation).toLocaleString()}
                    </div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>
                      Range: ${Math.round(ttmSDE * 1.5).toLocaleString()} - ${Math.round(ttmSDE * 4.0).toLocaleString()}
                    </div>
                  </div>
                </div>
                
                {/* EBITDA Method */}
                <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '20px' }}>
                    EBITDA Multiple Method
                  </h2>
                  
                  <div style={{ background: '#ede9fe', borderRadius: '8px', padding: '20px', marginBottom: '20px' }}>
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ fontSize: '14px', color: '#64748b', marginBottom: '4px' }}>Trailing 12 Months EBITDA</div>
                      <div style={{ fontSize: '28px', fontWeight: '700', color: '#667eea' }}>${(ttmEBITDA / 1000).toFixed(0)}K</div>
                    </div>
                    
                    <div style={{ fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                      <strong>Calculation:</strong> Net Income + Interest + Depreciation & Amortization
                      <br/>
                      = ${(ttmNetIncome / 1000).toFixed(0)}K + ${(ttmInterest / 1000).toFixed(0)}K + ${(ttmDepreciation / 1000).toFixed(0)}K
                      <br/>
                      <em style={{ fontSize: '12px', color: '#64748b' }}>Note: D&A and Interest are added back to Net Income</em>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                      EBITDA Multiple: {ebitdaMultiplier.toFixed(1)}x
                    </label>
                    <input 
                      type="range" 
                      min="2" 
                      max="10" 
                      step="0.1" 
                      value={ebitdaMultiplier} 
                      onChange={(e) => setEbitdaMultiplier(parseFloat(e.target.value))} 
                      style={{ width: '100%', marginBottom: '8px' }} 
                    />
                    <div style={{ fontSize: '12px', color: '#64748b', display: 'flex', justifyContent: 'space-between' }}>
                      <span>Typical Range: 3.0x - 8.0x</span>
                      <span>Industry Average: 5.0x</span>
                    </div>
                  </div>
                  
                  <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>
                      Estimated Business Value (EBITDA)
                    </div>
                    <div style={{ fontSize: '36px', fontWeight: '700', color: '#667eea' }}>
                      ${Math.round(ebitdaValuation).toLocaleString()}
                    </div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>
                      Range: ${Math.round(ttmEBITDA * 3.0).toLocaleString()} - ${Math.round(ttmEBITDA * 8.0).toLocaleString()}
                    </div>
                  </div>
                </div>
                
                {/* DCF Method */}
                <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '20px' }}>
                    Discounted Cash Flow (DCF) Method
                  </h2>
                  
                  <div style={{ background: '#fef3c7', borderRadius: '8px', padding: '20px', marginBottom: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '16px' }}>
                      <div>
                        <div style={{ fontSize: '12px', color: '#92400e', marginBottom: '4px' }}>Historical Growth Rate</div>
                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#f59e0b' }}>{growth_24mo.toFixed(1)}%</div>
                        <div style={{ fontSize: '11px', color: '#92400e', marginTop: '2px' }}>Used for 5-year projection</div>
                      </div>
                      <div>
                        <div style={{ fontSize: '12px', color: '#92400e', marginBottom: '4px' }}>Discount Rate</div>
                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#f59e0b' }}>{dcfDiscountRate.toFixed(1)}%</div>
                        <div style={{ fontSize: '11px', color: '#92400e', marginTop: '2px' }}>Risk-adjusted rate</div>
                      </div>
                      <div>
                        <div style={{ fontSize: '12px', color: '#92400e', marginBottom: '4px' }}>Terminal Growth</div>
                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#f59e0b' }}>{dcfTerminalGrowth.toFixed(1)}%</div>
                        <div style={{ fontSize: '11px', color: '#92400e', marginTop: '2px' }}>Perpetuity growth</div>
                      </div>
                    </div>
                    
                    <div style={{ fontSize: '13px', color: '#78350f', lineHeight: '1.6', marginBottom: '16px' }}>
                      5-year free cash flow projection based on historical growth rate, discounted to present value. Includes terminal value calculation for perpetuity beyond forecast period.
                    </div>
                  </div>
                  
                  {/* Free Cash Flow Calculation */}
                  <div style={{ background: '#fef3c7', borderRadius: '8px', padding: '20px', marginBottom: '20px', border: '1px solid #fcd34d' }}>
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ fontSize: '14px', color: '#92400e', marginBottom: '8px', fontWeight: '600' }}>Trailing 12 Months Free Cash Flow</div>
                      <div style={{ fontSize: '28px', fontWeight: '700', color: '#f59e0b' }}>${(ttmFreeCashFlow / 1000).toFixed(0)}K</div>
                    </div>
                    
                    <div style={{ fontSize: '13px', color: '#78350f', lineHeight: '1.8' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                        <span>TTM Revenue</span>
                        <span style={{ fontWeight: '600' }}>${(ttmRevenue / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                        <span>- COGS</span>
                        <span style={{ fontWeight: '600' }}>${(ttmCOGS / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                        <span>- Operating Expenses</span>
                        <span style={{ fontWeight: '600' }}>${(ttmExpense / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px', paddingBottom: '6px', borderBottom: '1px solid #fcd34d' }}>
                        <span style={{ fontWeight: '600' }}>= Net Income</span>
                        <span style={{ fontWeight: '600' }}>${(ttmNetIncome / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                        <span>+ Depreciation/Amortization</span>
                        <span style={{ fontWeight: '600' }}>${(ttmDepreciation / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                        <span>- Change in Working Capital</span>
                        <span style={{ fontWeight: '600' }}>${(changeInWC / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px', paddingBottom: '6px', borderBottom: '1px solid #fcd34d' }}>
                        <span>- Capital Expenditures</span>
                        <span style={{ fontWeight: '600' }}>${(ttmCapEx / 1000).toFixed(0)}K</span>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '8px' }}>
                        <span style={{ fontWeight: '700' }}>= Free Cash Flow</span>
                        <span style={{ fontWeight: '700', color: '#f59e0b' }}>${(ttmFreeCashFlow / 1000).toFixed(0)}K</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Adjustable Parameters */}
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                      Discount Rate (WACC): {dcfDiscountRate.toFixed(1)}%
                    </label>
                    <input 
                      type="range" 
                      min="5" 
                      max="20" 
                      step="0.5" 
                      value={dcfDiscountRate} 
                      onChange={(e) => setDcfDiscountRate(parseFloat(e.target.value))} 
                      style={{ width: '100%', marginBottom: '8px' }} 
                    />
                    <div style={{ fontSize: '12px', color: '#64748b', display: 'flex', justifyContent: 'space-between' }}>
                      <span>Lower Risk: 5-8%</span>
                      <span>Typical: 10-12%</span>
                      <span>Higher Risk: 15-20%</span>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                      Terminal Growth Rate: {dcfTerminalGrowth.toFixed(1)}%
                    </label>
                    <input 
                      type="range" 
                      min="0" 
                      max="5" 
                      step="0.5" 
                      value={dcfTerminalGrowth} 
                      onChange={(e) => setDcfTerminalGrowth(parseFloat(e.target.value))} 
                      style={{ width: '100%', marginBottom: '8px' }} 
                    />
                    <div style={{ fontSize: '12px', color: '#64748b', display: 'flex', justifyContent: 'space-between' }}>
                      <span>Conservative: 0-2%</span>
                      <span>Typical: 2-3%</span>
                      <span>Optimistic: 3-5%</span>
                    </div>
                  </div>
                  
                  <div style={{ background: '#f8fafc', borderRadius: '8px', padding: '16px', border: '1px solid #e2e8f0' }}>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>
                      Estimated Business Value (DCF)
                    </div>
                    <div style={{ fontSize: '36px', fontWeight: '700', color: '#f59e0b' }}>
                      ${Math.round(dcfValue).toLocaleString()}
                    </div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '8px' }}>
                      <strong>Note:</strong> DCF based on Free Cash Flow (FCF) projections. Valuations are highly sensitive to assumptions about growth rates, discount rates, working capital, and capital expenditures.
                    </div>
                  </div>
                </div>
              </>
            );
          })()}
        </div>
      )}

      {/* Cash Flow View */}
      {currentView === 'cash-flow' && selectedCompanyId && monthly.length > 0 && (
        <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '32px' }}>
          <style>{`
            @media print {
              @page {
                size: portrait;
                margin: 0.3in;
              }
              
              /* Hide navigation and UI elements */
              .no-print,
              header,
              nav,
              aside,
              [role="navigation"],
              button {
                display: none !important;
              }
              
              /* Remove background colors and shadows */
              * {
                box-shadow: none !important;
              }
              
              /* First page: Summary cards and start of table */
              .cf-summary-cards {
                page-break-after: avoid;
              }
              
              /* Force page break before metrics section */
              .cf-metrics-section {
                page-break-before: always;
                margin-top: 0 !important;
              }
              
              /* Scale down content to fit portrait */
              .cf-table-container {
                transform: scale(0.75);
                transform-origin: top left;
                width: 133.33%;
              }
              
              /* Reduce font sizes for compact display */
              h1 {
                font-size: 20px !important;
                margin-bottom: 12px !important;
              }
              
              h2 {
                font-size: 16px !important;
                margin-bottom: 12px !important;
              }
              
              /* Compress summary cards */
              .cf-summary-cards > div {
                padding: 12px !important;
              }
              
              .cf-summary-cards > div > div:first-child {
                font-size: 10px !important;
              }
              
              .cf-summary-cards > div > div:nth-child(2) {
                font-size: 20px !important;
              }
              
              .cf-summary-cards > div > div:last-child {
                font-size: 9px !important;
              }
              
              /* Table styling */
              table {
                font-size: 9px !important;
              }
              
              th, td {
                padding: 4px 6px !important;
              }
            }
          `}</style>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Cash Flow Analysis</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
              {cashFlowDisplay !== 'monthly' && (
                <button 
                  className="no-print"
                  onClick={() => window.print()} 
                  style={{ 
                    padding: '12px 24px', 
                    background: '#667eea', 
                    color: 'white', 
                    border: 'none', 
                    borderRadius: '8px', 
                    fontSize: '14px', 
                    fontWeight: '600', 
                    cursor: 'pointer',
                    boxShadow: '0 2px 8px rgba(102, 126, 234, 0.3)'
                  }}>
                  ðŸ–¨ï¸ Print
                </button>
              )}
            </div>
          </div>
          
          {/* Display Period Tabs */}
          <div style={{ display: 'flex', gap: '8px', marginBottom: '32px', borderBottom: '2px solid #e2e8f0' }}>
            <button
              onClick={() => setCashFlowDisplay('monthly')}
              style={{
                padding: '12px 24px',
                background: cashFlowDisplay === 'monthly' ? '#667eea' : 'transparent',
                color: cashFlowDisplay === 'monthly' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: cashFlowDisplay === 'monthly' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Monthly
            </button>
            <button
              onClick={() => setCashFlowDisplay('quarterly')}
              style={{
                padding: '12px 24px',
                background: cashFlowDisplay === 'quarterly' ? '#667eea' : 'transparent',
                color: cashFlowDisplay === 'quarterly' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: cashFlowDisplay === 'quarterly' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Last 4 Quarters
            </button>
            <button
              onClick={() => setCashFlowDisplay('annual')}
              style={{
                padding: '12px 24px',
                background: cashFlowDisplay === 'annual' ? '#667eea' : 'transparent',
                color: cashFlowDisplay === 'annual' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: cashFlowDisplay === 'annual' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Last 3 Years
            </button>
          </div>

          {/* Educational Resources - Side by Side */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px' }}>
            {/* Cash Flow Metrics Definitions */}
            <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '12px 24px', border: '1px solid #e2e8f0' }}>
              <details>
                <summary style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', cursor: 'pointer', marginBottom: '16px' }}>
                  ðŸ’° Cash Flow Metrics - Definitions & Examples
                </summary>
              
              <div style={{ display: 'grid', gap: '20px', marginTop: '16px' }}>
                {/* Operating Cash Flow */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #10b981' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#10b981', fontSize: '14px', fontWeight: '700' }}>Operating Cash Flow (OCF)</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Cash generated from normal business operations. Shows the company's ability to generate cash from its core activities.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> Net Income + Depreciation + Change in Working Capital
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If Net Income = $50,000, Depreciation = $5,000, and Working Capital decreased by $3,000 (a source of cash), then OCF = $50,000 + $5,000 + $3,000 = <strong>$58,000</strong>
                  </p>
                </div>

                {/* Investing Cash Flow */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #ef4444' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#ef4444', fontSize: '14px', fontWeight: '700' }}>Investing Cash Flow</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Cash used for investments in long-term assets like equipment, property, and other capital expenditures. Typically negative as it represents cash outflows.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> -(Capital Expenditures)
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If the company purchased $15,000 in new equipment, then Investing Cash Flow = <strong>-$15,000</strong>
                  </p>
                </div>

                {/* Financing Cash Flow */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #3b82f6' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#3b82f6', fontSize: '14px', fontWeight: '700' }}>Financing Cash Flow</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Cash from financing activities including debt changes, equity changes, and owner distributions. Shows how the company finances its operations.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> Change in Long-Term Debt + Change in Total Equity
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If debt decreased by $3,000 (payment) and equity increased by $2,000 (owner contribution), then Financing Cash Flow = -$3,000 + $2,000 = <strong>-$1,000</strong>
                  </p>
                </div>

                {/* Free Cash Flow */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #667eea' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#667eea', fontSize: '14px', fontWeight: '700' }}>Free Cash Flow (FCF)</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Cash available after maintaining/expanding the asset base. This is cash available for distributions, debt repayment, or growth initiatives.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> Operating Cash Flow - Capital Expenditures
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If OCF = $58,000 and CapEx = $15,000, then FCF = $58,000 - $15,000 = <strong>$43,000</strong>
                  </p>
                </div>

                {/* Cash Flow Margin */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #f59e0b' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#f59e0b', fontSize: '14px', fontWeight: '700' }}>Cash Flow Margin</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Percentage of revenue converted to operating cash flow. Higher percentages indicate better cash generation efficiency.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> (Operating Cash Flow Ã· Revenue) Ã— 100
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If OCF = $58,000 and Revenue = $250,000, then Cash Flow Margin = ($58,000 Ã· $250,000) Ã— 100 = <strong>23.2%</strong>
                  </p>
                </div>

                {/* Days Cash On Hand */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #8b5cf6' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#8b5cf6', fontSize: '14px', fontWeight: '700' }}>Days Cash On Hand</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Number of days the company can operate with its current cash balance at the current cash flow rate. Indicates financial runway.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> Ending Cash Ã· (Operating Cash Flow Ã— 30)
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If Ending Cash = $75,000 and monthly OCF = $58,000, then Days Cash On Hand = $75,000 Ã· ($58,000 Ã— 30) = <strong>38.8 days</strong>
                  </p>
                </div>

                {/* DIO */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #06b6d4' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#06b6d4', fontSize: '14px', fontWeight: '700' }}>DIO (Days Inventory Outstanding)</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Average number of days inventory is held before being sold. Lower values indicate faster inventory turnover and better working capital management.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> 365 Ã· Inventory Turnover<br/>
                    <span style={{ fontSize: '12px' }}>Where Inventory Turnover = LTM COGS Ã· Avg Inventory</span>
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If LTM COGS = $600,000 and Avg Inventory = $50,000, then Inventory Turnover = 12. DIO = 365 Ã· 12 = <strong>30.4 days</strong>
                  </p>
                </div>

                {/* DSO */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #14b8a6' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#14b8a6', fontSize: '14px', fontWeight: '700' }}>DSO (Days Sales Outstanding)</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Average number of days to collect payment from customers after a sale. Lower values indicate faster cash collection and better receivables management.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> 365 Ã· Receivables Turnover<br/>
                    <span style={{ fontSize: '12px' }}>Where Receivables Turnover = LTM Revenue Ã· Avg A/R</span>
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If LTM Revenue = $1,200,000 and Avg A/R = $100,000, then Receivables Turnover = 12. DSO = 365 Ã· 12 = <strong>30.4 days</strong>
                  </p>
                </div>

                {/* DPO */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #ec4899' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#ec4899', fontSize: '14px', fontWeight: '700' }}>DPO (Days Payables Outstanding)</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Average number of days the company takes to pay its suppliers. Higher values can indicate better use of supplier credit, but be careful not to damage supplier relationships.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> 365 Ã· Payables Turnover<br/>
                    <span style={{ fontSize: '12px' }}>Where Payables Turnover = LTM COGS Ã· Avg A/P</span>
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If LTM COGS = $600,000 and Avg A/P = $75,000, then Payables Turnover = 8. DPO = 365 Ã· 8 = <strong>45.6 days</strong>
                  </p>
                </div>

                {/* Cash Conversion Cycle */}
                <div style={{ background: 'white', padding: '16px', borderRadius: '8px', borderLeft: '4px solid #f97316' }}>
                  <h4 style={{ margin: '0 0 8px 0', color: '#f97316', fontSize: '14px', fontWeight: '700' }}>Cash Conversion Cycle (CCC)</h4>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                    <strong>Definition:</strong> Number of days between paying suppliers and collecting cash from customers. Shows how efficiently the company manages working capital. Lower (or negative) values are better.
                  </p>
                  <p style={{ margin: '0 0 8px 0', fontSize: '13px', color: '#475569', fontFamily: 'monospace', background: '#f1f5f9', padding: '8px', borderRadius: '4px' }}>
                    <strong>Formula:</strong> DIO + DSO - DPO
                  </p>
                  <p style={{ margin: '0', fontSize: '13px', color: '#64748b', lineHeight: '1.6' }}>
                    <strong>Example:</strong> If DIO = 30.4 days, DSO = 30.4 days, and DPO = 45.6 days, then CCC = 30.4 + 30.4 - 45.6 = <strong>15.2 days</strong>. This means cash is tied up for about 15 days.
                  </p>
                </div>
              </div>
            </details>
            </div>

            {/* Cash Flow Management Article */}
            <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '12px 24px', border: '1px solid #e2e8f0' }}>
              <details>
                <summary style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', cursor: 'pointer', marginBottom: '16px' }}>
                  ?? Why Cash Flow Management is Critical for your Business
                </summary>
              
              <div style={{ marginTop: '16px', fontSize: '14px', lineHeight: '1.8', color: '#475569' }}>
                <p style={{ marginBottom: '16px' }}>
                  Liquidity fuels a business's ability to adapt. Whether it's covering payroll, meeting supplier deadlines, or investing in expansion, cash flow keeps the engine running. Without careful cash flow management, even profitable businesses can face serious challenges due to gaps between inflows and outflows.
                </p>
                
                <p style={{ marginBottom: '16px' }}>
                  Small businesses are especially vulnerable because they often lack the financial buffers that larger companies enjoy. Missed payments from clients, unexpected expenses, or seasonal slowdowns can quickly destabilize operations. By proactively managing cash flow, you create the flexibility needed to navigate these hurdles and achieve sustainable growth.
                </p>

                <h3 style={{ fontSize: '16px', fontWeight: '700', color: '#1e293b', marginTop: '24px', marginBottom: '12px' }}>
                  Proven Strategies to Strengthen Cash Flow
                </h3>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  1. Build Accurate Cash Flow Forecasts
                </h4>
                <p style={{ marginBottom: '12px' }}>
                  Forecasting cash flow is the cornerstone of liquidity management. By analyzing expected inflows and outflows over time, businesses can identify potential shortfalls and act early to prevent disruptions.
                </p>
                <p style={{ marginBottom: '8px', fontWeight: '600' }}>A robust forecast should:</p>
                <ul style={{ marginLeft: '20px', marginBottom: '16px' }}>
                  <li>Include all revenue sources, such as customer payments, loans, or grants.</li>
                  <li>Account for fixed expenses like rent and payroll, as well as variable costs like inventory purchases.</li>
                  <li>Be updated regularly to reflect current business conditions.</li>
                </ul>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  2. Streamline Accounts Receivable
                </h4>
                <p style={{ marginBottom: '12px' }}>
                  Late payments can cripple your cash flow. Implement these strategies to speed up receivables:
                </p>
                <ul style={{ marginLeft: '20px', marginBottom: '16px' }}>
                  <li><strong>Set clear payment terms:</strong> Clearly outline due dates and penalties for late payments in contracts.</li>
                  <li><strong>Send invoices promptly:</strong> The faster you send invoices, the sooner you'll get paid.</li>
                  <li><strong>Offer incentives:</strong> Discounts for early payments encourage timely cash inflows.</li>
                  <li><strong>Follow up persistently:</strong> Don't hesitate to send polite reminders for overdue payments.</li>
                </ul>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  3. Optimize Accounts Payable
                </h4>
                <p style={{ marginBottom: '12px' }}>
                  Balancing outgoing payments is just as important as collecting receivables. Avoid paying too early, which could leave your business cash-strapped. On the other hand, paying too late may harm vendor relationships. Use these best practices:
                </p>
                <ul style={{ marginLeft: '20px', marginBottom: '16px' }}>
                  <li>Take advantage of the full payment terms offered by suppliers.</li>
                  <li>Negotiate favorable terms, such as discounts for bulk orders or extended deadlines.</li>
                  <li>Schedule payments strategically to align with cash flow peaks.</li>
                </ul>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  4. Control Operational Expenses
                </h4>
                <p style={{ marginBottom: '16px' }}>
                  Every dollar saved is a dollar added to your liquidity. Regularly audit your operational expenses and look for areas where you can cut costs without sacrificing quality. Consider adopting zero-based budgeting, where all expenses must be justified rather than relying on past budgets.
                </p>
                <p style={{ marginBottom: '16px' }}>
                  Focus on reducing discretionary spending, renegotiating supplier contracts, and switching to cost-efficient alternatives. Even small adjustments can have a significant impact on your overall cash flow.
                </p>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  5. Improve Inventory Management
                </h4>
                <p style={{ marginBottom: '16px' }}>
                  Inventory ties up cash, especially when stock levels are too high. Use data to forecast demand accurately and implement just-in-time (JIT) inventory systems to minimize overstocking. Regularly review inventory levels to ensure that slow-moving or obsolete stock isn't draining your resources.
                </p>
                <p style={{ marginBottom: '16px' }}>
                  Efficient inventory management not only frees up cash but also reduces storage and insurance costs.
                </p>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  6. Establish a Cash Reserve
                </h4>
                <p style={{ marginBottom: '16px' }}>
                  A strong cash reserve acts as a buffer during challenging times. Set aside a portion of profits regularly to build an emergency fund that can cover at least three to six months of operating expenses. This reserve will protect your business from unexpected events like economic downturns, supply chain disruptions, or market fluctuations.
                </p>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  7. Use Short-Term Financing Wisely
                </h4>
                <p style={{ marginBottom: '16px' }}>
                  Short-term financing options, such as lines of credit or invoice financing, can help bridge gaps when cash flow is tight. However, it's essential to use these options strategically. Only borrow what you can comfortably repay, and ensure that repayment terms align with your cash flow forecast to avoid over-leveraging.
                </p>
                <p style={{ marginBottom: '16px' }}>
                  Short-term loans can be particularly helpful during seasonal slowdowns or when expanding inventory to meet rising demand.
                </p>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  8. Automate Financial Processes
                </h4>
                <p style={{ marginBottom: '16px' }}>
                  Manual financial tracking is time-consuming and prone to errors. Adopting tools for automating cash flow forecasting, invoice management, and financial reporting saves time and improves accuracy. Automation ensures you always have a clear view of your business's financial health.
                </p>

                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginTop: '20px', marginBottom: '8px' }}>
                  9. Monitor and Adjust Frequently
                </h4>
                <p style={{ marginBottom: '16px' }}>
                  The financial landscape is ever-changing, and your cash flow strategy should adapt to it. Regularly review your cash flow reports, identify trends, and adjust your plans as needed. This proactive approach helps you avoid surprises and ensures your business stays on solid financial footing.
                </p>
                <p style={{ marginBottom: '16px' }}>
                  Tracking key performance indicators (KPIs), such as days sales outstanding (DSO) and current ratio, can provide deeper insights into your financial health.
                </p>

                <h3 style={{ fontSize: '16px', fontWeight: '700', color: '#1e293b', marginTop: '24px', marginBottom: '12px' }}>
                  Conclusion: Liquidity is the Key to Resilience
                </h3>
                <p style={{ marginBottom: '0' }}>
                  Small businesses thrive when they have strong control over their cash flow. By implementing the strategies outlined above you can stay ahead of cash flow challenges, maintain liquidity, and focus on what matters most - growing your business.
                </p>
              </div>
              </details>
            </div>
          </div>

          {(() => {
            // Calculate cash flow data based on view
            const dataMonths = cashFlowDisplay === 'quarterly' ? 12 : (cashFlowDisplay === 'annual' ? 36 : 12);
            const dataSet = monthly.slice(-dataMonths);
            
            
            const cashFlowData = dataSet.map((curr, idx) => {
              const prev = idx === 0 && monthly.length > dataMonths ? monthly[monthly.length - dataMonths - 1] : (idx > 0 ? dataSet[idx - 1] : curr);
              
              // Operating Activities
              const netIncome = curr.revenue - curr.cogsTotal - curr.expense;
              const depreciation = curr.depreciationAmortization || 0; // Depreciation and amortization expense
              const changeInAR = curr.ar - prev.ar;
              const changeInInventory = curr.inventory - prev.inventory;
              const changeInAP = curr.ap - prev.ap;
              const changeInWorkingCapital = -(changeInAR + changeInInventory - changeInAP);
              const operatingCashFlow = netIncome + depreciation + changeInWorkingCapital;
              
              // Investing Activities
              const changeInFixedAssets = curr.fixedAssets - prev.fixedAssets;
              const capitalExpenditures = changeInFixedAssets + depreciation; // Add back depreciation to estimate CapEx
              const investingCashFlow = -capitalExpenditures;
              
              // Financing Activities
              const changeInDebt = curr.ltd - prev.ltd;
              const changeInEquity = curr.totalEquity - prev.totalEquity; // Total equity change (net income already in retained earnings)
              const financingCashFlow = changeInDebt + changeInEquity;
              
              // Net Change and Free Cash Flow
              const netCashChange = operatingCashFlow + investingCashFlow + financingCashFlow;
              const freeCashFlow = operatingCashFlow - Math.max(0, capitalExpenditures);
              
              // Metrics
              const cashFlowMargin = curr.revenue > 0 ? (operatingCashFlow / curr.revenue) * 100 : 0;
              const daysCashOnHand = operatingCashFlow > 0 ? (curr.cash / (operatingCashFlow / 30)) : 0;
              
              // Working Capital Metrics - using LTM for stability
              // Calculate LTM revenue and COGS for this month
              const monthIndex = monthly.findIndex(m => m.month === curr.month);
              const last12Months = monthIndex >= 11 ? monthly.slice(monthIndex - 11, monthIndex + 1) : monthly.slice(0, monthIndex + 1);
              const ltmRevenue = last12Months.reduce((sum, m) => sum + (m.revenue || 0), 0);
              const ltmCOGS = last12Months.reduce((sum, m) => sum + (m.cogsTotal || 0), 0);
              
              // Average balances (current + prior month / 2)
              const avgInventory = (curr.inventory + prev.inventory) / 2;
              const avgAR = (curr.ar + prev.ar) / 2;
              const avgAP = (curr.ap + prev.ap) / 2;
              
              // Turnover ratios
              const inventoryTurnover = avgInventory > 0 ? ltmCOGS / avgInventory : 0;
              const receivablesTurnover = avgAR > 0 ? ltmRevenue / avgAR : 0;
              const payablesTurnover = avgAP > 0 ? ltmCOGS / avgAP : 0;
              
              // Days metrics
              const DIO = inventoryTurnover > 0 ? 365 / inventoryTurnover : 0; // Days Inventory Outstanding
              const DSO = receivablesTurnover > 0 ? 365 / receivablesTurnover : 0; // Days Sales Outstanding
              const DPO = payablesTurnover > 0 ? 365 / payablesTurnover : 0; // Days Payables Outstanding
              const CCC = DIO + DSO - DPO; // Cash Conversion Cycle
              
              return {
                month: curr.month,
                netIncome,
                depreciation,
                changeInWorkingCapital,
                operatingCashFlow,
                capitalExpenditures,
                investingCashFlow,
                changeInDebt,
                changeInEquity,
                financingCashFlow,
                netCashChange,
                freeCashFlow,
                cashFlowMargin,
                daysCashOnHand,
                endingCash: curr.cash,
                DIO,
                DSO,
                DPO,
                CCC
              };
            });

            // Aggregate data based on display selection
            let displayData = cashFlowData;
            if (cashFlowDisplay === 'quarterly') {
              // Aggregate into quarters (3 months each)
              displayData = [];
              for (let i = 0; i < cashFlowData.length; i += 3) {
                const quarter = cashFlowData.slice(i, i + 3);
                const quarterEnd = quarter[quarter.length - 1].month;
                const aggregated = {
                  month: quarterEnd,
                  netIncome: quarter.reduce((sum, d) => sum + d.netIncome, 0),
                  depreciation: quarter.reduce((sum, d) => sum + d.depreciation, 0),
                  changeInWorkingCapital: quarter.reduce((sum, d) => sum + d.changeInWorkingCapital, 0),
                  operatingCashFlow: quarter.reduce((sum, d) => sum + d.operatingCashFlow, 0),
                  capitalExpenditures: quarter.reduce((sum, d) => sum + d.capitalExpenditures, 0),
                  investingCashFlow: quarter.reduce((sum, d) => sum + d.investingCashFlow, 0),
                  changeInDebt: quarter.reduce((sum, d) => sum + d.changeInDebt, 0),
                  changeInEquity: quarter.reduce((sum, d) => sum + d.changeInEquity, 0),
                  financingCashFlow: quarter.reduce((sum, d) => sum + d.financingCashFlow, 0),
                  netCashChange: quarter.reduce((sum, d) => sum + d.netCashChange, 0),
                  freeCashFlow: quarter.reduce((sum, d) => sum + d.freeCashFlow, 0),
                  cashFlowMargin: quarter.reduce((sum, d) => sum + d.cashFlowMargin, 0) / quarter.length,
                  daysCashOnHand: quarter[quarter.length - 1].daysCashOnHand,
                  endingCash: quarter[quarter.length - 1].endingCash,
                  DIO: quarter[quarter.length - 1].DIO,
                  DSO: quarter[quarter.length - 1].DSO,
                  DPO: quarter[quarter.length - 1].DPO,
                  CCC: quarter[quarter.length - 1].CCC
                };
                displayData.push(aggregated);
              }
            } else if (cashFlowDisplay === 'annual') {
              // Aggregate into 3 annual periods (12 months each)
              displayData = [];
              const totalMonths = cashFlowData.length;
              const yearsToShow = Math.min(3, Math.floor(totalMonths / 12));
              
              for (let i = 0; i < yearsToShow; i++) {
                const yearStart = totalMonths - (yearsToShow - i) * 12;
                const yearEnd = yearStart + 12;
                const yearData = cashFlowData.slice(yearStart, yearEnd);
                
                if (yearData.length > 0) {
                  const yearEndDate = yearData[yearData.length - 1].month;
                  displayData.push({
                    month: yearEndDate,
                    netIncome: yearData.reduce((sum, d) => sum + d.netIncome, 0),
                    depreciation: yearData.reduce((sum, d) => sum + d.depreciation, 0),
                    changeInWorkingCapital: yearData.reduce((sum, d) => sum + d.changeInWorkingCapital, 0),
                    operatingCashFlow: yearData.reduce((sum, d) => sum + d.operatingCashFlow, 0),
                    capitalExpenditures: yearData.reduce((sum, d) => sum + d.capitalExpenditures, 0),
                    investingCashFlow: yearData.reduce((sum, d) => sum + d.investingCashFlow, 0),
                    changeInDebt: yearData.reduce((sum, d) => sum + d.changeInDebt, 0),
                    changeInEquity: yearData.reduce((sum, d) => sum + d.changeInEquity, 0),
                    financingCashFlow: yearData.reduce((sum, d) => sum + d.financingCashFlow, 0),
                    netCashChange: yearData.reduce((sum, d) => sum + d.netCashChange, 0),
                    freeCashFlow: yearData.reduce((sum, d) => sum + d.freeCashFlow, 0),
                    cashFlowMargin: yearData.reduce((sum, d) => sum + d.cashFlowMargin, 0) / yearData.length,
                    daysCashOnHand: yearData[yearData.length - 1].daysCashOnHand,
                    endingCash: yearData[yearData.length - 1].endingCash,
                    DIO: yearData[yearData.length - 1].DIO,
                    DSO: yearData[yearData.length - 1].DSO,
                    DPO: yearData[yearData.length - 1].DPO,
                    CCC: yearData[yearData.length - 1].CCC
                  });
                }
              }
            }

            // Summary metrics - always use last 12 months for consistency
            const last12MonthsData = monthly.slice(-12).map((curr, idx) => {
              const prev = idx === 0 && monthly.length > 12 ? monthly[monthly.length - 13] : (idx > 0 ? monthly.slice(-12)[idx - 1] : curr);
              const netIncome = curr.revenue - curr.cogsTotal - curr.expense;
              const depreciation = curr.depreciationAmortization || 0;
              const changeInAR = curr.ar - prev.ar;
              const changeInInventory = curr.inventory - prev.inventory;
              const changeInAP = curr.ap - prev.ap;
              const changeInWorkingCapital = -(changeInAR + changeInInventory - changeInAP);
              const operatingCashFlow = netIncome + depreciation + changeInWorkingCapital;
              const changeInFixedAssets = curr.fixedAssets - prev.fixedAssets;
              const capitalExpenditures = changeInFixedAssets + depreciation;
              const investingCashFlow = -capitalExpenditures;
              const changeInDebt = curr.ltd - prev.ltd;
              const changeInEquity = curr.totalEquity - prev.totalEquity; // Total equity change (net income already in retained earnings)
              const financingCashFlow = changeInDebt + changeInEquity;
              const freeCashFlow = operatingCashFlow - Math.max(0, capitalExpenditures);
              const cashFlowMargin = curr.revenue > 0 ? (operatingCashFlow / curr.revenue) * 100 : 0;
              return { operatingCashFlow, investingCashFlow, financingCashFlow, freeCashFlow, cashFlowMargin };
            });
            const totalOperatingCF = last12MonthsData.reduce((sum, d) => sum + d.operatingCashFlow, 0);
            const totalInvestingCF = last12MonthsData.reduce((sum, d) => sum + d.investingCashFlow, 0);
            const totalFinancingCF = last12MonthsData.reduce((sum, d) => sum + d.financingCashFlow, 0);
            const totalFreeCF = last12MonthsData.reduce((sum, d) => sum + d.freeCashFlow, 0);
            const avgCashFlowMargin = last12MonthsData.reduce((sum, d) => sum + d.cashFlowMargin, 0) / last12MonthsData.length;

            return (
              <>
                {/* Summary Cards */}
                <div className="cf-summary-cards" style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '32px' }}>
                  <div style={{ background: 'white', borderRadius: '12px', padding: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #10b981' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Operating Cash Flow (12mo)</div>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>
                      ${totalOperatingCF.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                    </div>
                    <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>Cash from operations</div>
                  </div>
                  
                  <div style={{ background: 'white', borderRadius: '12px', padding: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #ef4444' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Investing Cash Flow (12mo)</div>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#ef4444' }}>
                      ${totalInvestingCF.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                    </div>
                    <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>CapEx & investments</div>
                  </div>
                  
                  <div style={{ background: 'white', borderRadius: '12px', padding: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #3b82f6' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Financing Cash Flow (12mo)</div>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#3b82f6' }}>
                      ${totalFinancingCF.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                    </div>
                    <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>Debt & equity changes</div>
                  </div>
                  
                  <div style={{ background: 'white', borderRadius: '12px', padding: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #667eea' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Free Cash Flow (12mo)</div>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: totalFreeCF >= 0 ? '#10b981' : '#ef4444' }}>
                      ${totalFreeCF.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                    </div>
                    <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>OCF - CapEx</div>
                  </div>
                  
                  <div style={{ background: 'white', borderRadius: '12px', padding: '20px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', border: '2px solid #f59e0b' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#64748b', marginBottom: '4px' }}>Avg Cash Flow Margin</div>
                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#f59e0b' }}>
                      {avgCashFlowMargin.toFixed(1)}%
                    </div>
                    <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>OCF / Revenue</div>
                  </div>
                </div>

                {/* Cash Flow Statement Table */}
                <div className="cf-table-container" style={{ background: 'white', borderRadius: '12px', padding: '32px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Statement of Cash Flows</h2>
                  
                  <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                      <thead>
                        <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                          <th style={{ textAlign: 'left', padding: '10px', fontSize: '13px', fontWeight: '600', color: '#64748b', position: 'sticky', left: 0, background: 'white', minWidth: '200px' }}>Cash Flow Item</th>
                          {displayData.map((cf, i) => (
                            <th key={i} style={{ textAlign: 'right', padding: '10px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '90px' }}>
                              {cf.month}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {/* Operating Activities */}
                        <tr style={{ background: '#f0fdf4' }}>
                          <td colSpan={13} style={{ padding: '12px 10px', fontSize: '14px', fontWeight: '700', color: '#065f46' }}>
                            OPERATING ACTIVITIES
                          </td>
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', paddingLeft: '24px' }}>Net Income</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              ${Math.round(cf.netIncome).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', paddingLeft: '24px' }}>+ Depreciation</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              ${Math.round(cf.depreciation).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', paddingLeft: '24px' }}>+ Change in Working Capital</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: cf.changeInWorkingCapital >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                              ${Math.round(cf.changeInWorkingCapital).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '2px solid #10b981', background: '#f0fdf4' }}>
                          <td style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#065f46' }}>Operating Cash Flow</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#065f46', textAlign: 'right' }}>
                              ${Math.round(cf.operatingCashFlow).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        
                        {/* Investing Activities */}
                        <tr style={{ background: '#fef2f2' }}>
                          <td colSpan={13} style={{ padding: '12px 10px', fontSize: '14px', fontWeight: '700', color: '#991b1b' }}>
                            INVESTING ACTIVITIES
                          </td>
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', paddingLeft: '24px' }}>Capital Expenditures</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#ef4444', textAlign: 'right' }}>
                              (${Math.round(cf.capitalExpenditures).toLocaleString()})
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '2px solid #ef4444', background: '#fef2f2' }}>
                          <td style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#991b1b' }}>Investing Cash Flow</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#991b1b', textAlign: 'right' }}>
                              ${Math.round(cf.investingCashFlow).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        
                        {/* Financing Activities */}
                        <tr style={{ background: '#eff6ff' }}>
                          <td colSpan={13} style={{ padding: '12px 10px', fontSize: '14px', fontWeight: '700', color: '#1e40af' }}>
                            FINANCING ACTIVITIES
                          </td>
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', paddingLeft: '24px' }}>Change in Long-Term Debt</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: cf.changeInDebt >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                              ${Math.round(cf.changeInDebt).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', paddingLeft: '24px' }}>Change in Equity</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: cf.changeInEquity >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                              ${Math.round(cf.changeInEquity).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '2px solid #3b82f6', background: '#eff6ff' }}>
                          <td style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#1e40af' }}>Financing Cash Flow</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#1e40af', textAlign: 'right' }}>
                              ${Math.round(cf.financingCashFlow).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        
                        {/* Net Change */}
                        <tr style={{ borderBottom: '3px double #1e293b', background: '#f8fafc' }}>
                          <td style={{ padding: '12px 10px', fontSize: '14px', fontWeight: '700', color: '#1e293b' }}>Net Change in Cash</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '12px 10px', fontSize: '14px', fontWeight: '700', color: cf.netCashChange >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                              ${Math.round(cf.netCashChange).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ background: '#fef3c7' }}>
                          <td style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: '#92400e' }}>Free Cash Flow</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '10px', fontSize: '13px', fontWeight: '700', color: cf.freeCashFlow >= 0 ? '#065f46' : '#991b1b', textAlign: 'right' }}>
                              ${Math.round(cf.freeCashFlow).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                          <td style={{ padding: '10px', fontSize: '13px', fontWeight: '600', color: '#475569' }}>Ending Cash Balance</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '10px', fontSize: '13px', fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>
                              ${Math.round(cf.endingCash).toLocaleString()}
                            </td>
                          ))}
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Cash Flow Metrics */}
                <div className="cf-metrics-section" style={{ background: 'white', borderRadius: '12px', padding: '32px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Cash Flow Metrics</h2>
                  
                  <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                      <thead>
                        <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                          <th style={{ textAlign: 'left', padding: '10px', fontSize: '13px', fontWeight: '600', color: '#64748b', position: 'sticky', left: 0, background: 'white', minWidth: '180px' }}>Metric</th>
                          {displayData.map((cf, i) => (
                            <th key={i} style={{ textAlign: 'right', padding: '10px', fontSize: '11px', fontWeight: '600', color: '#64748b', minWidth: '90px' }}>
                              {cf.month}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569' }}>Cash Flow Margin (%)</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              {cf.cashFlowMargin.toFixed(1)}%
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569' }}>Days Cash on Hand</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              {cf.daysCashOnHand.toFixed(0)} days
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569' }}>Cash Conversion Rate</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              {cf.netIncome > 0 ? ((cf.operatingCashFlow / cf.netIncome) * 100).toFixed(0) : 'N/A'}%
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569' }}>DIO (Days Inventory Outstanding)</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              {cf.DIO ? cf.DIO.toFixed(0) : 'N/A'} days
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569' }}>DSO (Days Sales Outstanding)</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              {cf.DSO ? cf.DSO.toFixed(0) : 'N/A'} days
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569' }}>DPO (Days Payables Outstanding)</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: '#1e293b', textAlign: 'right' }}>
                              {cf.DPO ? cf.DPO.toFixed(0) : 'N/A'} days
                            </td>
                          ))}
                        </tr>
                        <tr style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '8px 10px', fontSize: '12px', color: '#475569', fontWeight: '600' }}>Cash Conversion Cycle (CCC)</td>
                          {displayData.map((cf, i) => (
                            <td key={i} style={{ padding: '8px 10px', fontSize: '12px', color: cf.CCC < 30 ? '#10b981' : (cf.CCC > 60 ? '#ef4444' : '#1e293b'), textAlign: 'right', fontWeight: '600' }}>
                              {cf.CCC ? cf.CCC.toFixed(0) : 'N/A'} days
                            </td>
                          ))}
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Key Insights */}
                <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Cash Flow Insights</h2>
                  
                  <div style={{ display: 'grid', gap: '16px' }}>
                    {totalOperatingCF > 0 ? (
                      <div style={{ padding: '16px', background: '#f0fdf4', border: '1px solid #86efac', borderRadius: '8px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '4px' }}>? Positive Operating Cash Flow</div>
                        <div style={{ fontSize: '13px', color: '#047857' }}>
                          The company generated ${(totalOperatingCF / 1000).toFixed(0)}K in cash from operations over the last 12 months, indicating healthy operational performance.
                        </div>
                      </div>
                    ) : (
                      <div style={{ padding: '16px', background: '#fef2f2', border: '1px solid #fca5a5', borderRadius: '8px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#991b1b', marginBottom: '4px' }}>âš ï¸ Negative Operating Cash Flow</div>
                        <div style={{ fontSize: '13px', color: '#dc2626' }}>
                          The company consumed ${Math.abs(totalOperatingCF / 1000).toFixed(0)}K in cash from operations, which may indicate operational challenges.
                        </div>
                      </div>
                    )}
                    
                    {totalFreeCF > 0 ? (
                      <div style={{ padding: '16px', background: '#f0fdf4', border: '1px solid #86efac', borderRadius: '8px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '4px' }}>? Positive Free Cash Flow</div>
                        <div style={{ fontSize: '13px', color: '#047857' }}>
                          After capital expenditures, the company has ${(totalFreeCF / 1000).toFixed(0)}K in free cash flow available for growth, debt reduction, or distributions.
                        </div>
                      </div>
                    ) : (
                      <div style={{ padding: '16px', background: '#fffbeb', border: '1px solid #fcd34d', borderRadius: '8px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#92400e', marginBottom: '4px' }}>âš ï¸ Negative Free Cash Flow</div>
                        <div style={{ fontSize: '13px', color: '#b45309' }}>
                          Capital expenditures exceed operating cash flow by ${Math.abs(totalFreeCF / 1000).toFixed(0)}K, requiring external financing.
                        </div>
                      </div>
                    )}
                    
                    {avgCashFlowMargin > 15 ? (
                      <div style={{ padding: '16px', background: '#f0fdf4', border: '1px solid #86efac', borderRadius: '8px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '4px' }}>? Strong Cash Flow Margin</div>
                        <div style={{ fontSize: '13px', color: '#047857' }}>
                          Average cash flow margin of {avgCashFlowMargin.toFixed(1)}% indicates the company efficiently converts revenue into cash.
                        </div>
                      </div>
                    ) : avgCashFlowMargin < 5 ? (
                      <div style={{ padding: '16px', background: '#fef2f2', border: '1px solid #fca5a5', borderRadius: '8px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#991b1b', marginBottom: '4px' }}>âš ï¸ Low Cash Flow Margin</div>
                        <div style={{ fontSize: '13px', color: '#dc2626' }}>
                          Cash flow margin of {avgCashFlowMargin.toFixed(1)}% suggests challenges in converting revenue to cash. Review receivables collection and expense timing.
                        </div>
                      </div>
                    ) : null}
                  </div>
                </div>
              </>
            );
          })()}
        </div>
      )}

      {/* CSV Trial Balance Data Mapping View - Show when CSV data is loaded OR when there are saved mappings */}
      {(currentView === 'admin' && adminDashboardTab === 'data-mapping' && selectedCompanyId && !qbRawData && (csvTrialBalanceData?._companyId === selectedCompanyId || (aiMappings.length > 0 && showMappingSection))) && (() => {
        const currentCompany = Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined;

        // Get accounts for mapping from CSV data (if available)
        const csvAccountsForMapping = csvTrialBalanceData ? getAccountsForMapping(csvTrialBalanceData) : [];
        const hasCsvData = csvTrialBalanceData && csvTrialBalanceData._companyId === selectedCompanyId;

        return (
          <div key={`csv-data-mapping-${selectedCompanyId}-${dataRefreshKey}`} style={{ maxWidth: '1800px', margin: '0 auto', padding: '32px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>ðŸ”— Account Mapping</h1>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
            </div>
            <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '16px' }}>
              {hasCsvData
                ? `Map Trial Balance accounts to your standardized financial fields - Source: ${csvTrialBalanceData.fileName || 'CSV Upload'} - ${csvTrialBalanceData.dates?.length || 0} periods`
                : `${aiMappings.length} saved account mappings loaded from database`
              }
            </p>


            {/* AI-Assisted Mapping Section for CSV */}
            {hasCsvData && (
            <div style={{ marginBottom: '32px' }}>
              <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <div>
                    <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>
                      AI-Assisted Account Mapping
                    </h2>
                    <p style={{ fontSize: '14px', color: '#64748b', margin: 0 }}>
                      Use AI to automatically suggest mappings from Trial Balance accounts ({csvAccountsForMapping.length} accounts) to your standardized financial fields
                    </p>
                  </div>
                  <button
                    onClick={async () => {
                      setIsGeneratingMappings(true);
                      try {
                        // Convert CSV accounts to format expected by AI mapping
                        const qbAccountsWithClass = csvAccountsForMapping.map(acc => ({
                          name: acc.name,
                          classification: acc.classification,
                          accountCode: acc.acctId,  // Include account code for better AI mapping
                          accountType: acc.acctType,
                        }));

                        console.log('?? CSV accounts to map:', qbAccountsWithClass.length);
                        console.log('?? First 10 accounts:', qbAccountsWithClass.slice(0, 10));

                        const response = await fetch('/api/ai-mapping/enhanced', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ 
                            qbAccountsWithClass,
                            companyId: selectedCompanyId,
                            targetFields: []
                          })
                        });

                        if (!response.ok) {
                          throw new Error('Failed to generate mappings');
                        }

                        const data = await response.json();
                        setAiMappings(data.mappings || []);
                        setShowMappingSection(true);
                      } catch (error: any) {
                        console.error('Error generating mappings:', error);
                        alert('Failed to generate AI mappings: ' + error.message);
                      } finally {
                        setIsGeneratingMappings(false);
                      }
                    }}
                    disabled={isGeneratingMappings || csvAccountsForMapping.length === 0}
                    style={{
                      padding: '12px 24px',
                      background: isGeneratingMappings ? '#94a3b8' : '#10b981',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: isGeneratingMappings ? 'not-allowed' : 'pointer',
                      boxShadow: '0 2px 6px rgba(16, 185, 129, 0.3)',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}
                  >
                    {isGeneratingMappings ? (
                      <>
                        <span>?</span>
                        <span>Generating Mappings...</span>
                      </>
                    ) : (
                      <>
                        <span>ðŸ¤–</span>
                        <span>Generate AI Mappings</span>
                      </>
                    )}
                  </button>
                </div>

                {/* Account Summary by Type */}
                <div style={{ marginTop: '16px', padding: '16px', background: '#f0fdf4', borderRadius: '8px', border: '1px solid #86efac' }}>
                  <div style={{ fontSize: '13px', fontWeight: '600', color: '#065f46', marginBottom: '8px' }}>Accounts by Type:</div>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                    {Object.entries(csvTrialBalanceData.accountsByType || {}).map(([type, accounts]: [string, any]) => (
                      <span key={type} style={{
                        padding: '4px 12px',
                        background: 'white',
                        borderRadius: '16px',
                        fontSize: '12px',
                        color: '#065f46',
                        border: '1px solid #86efac'
                      }}>
                        {type}: {accounts.length}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            </div>
            )}

            {/* Mapping Results Section */}
            {showMappingSection && aiMappings.length > 0 && (
              <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', marginBottom: '32px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', margin: 0 }}>
                    Account Mappings ({aiMappings.length} accounts)
                  </h2>
                </div>

                <AccountMappingTable
                  mappings={aiMappings}
                  linesOfBusiness={linesOfBusiness}
                  userDefinedAllocations={userDefinedAllocations}
                  onMappingChange={(index, updates) => {
                    const updated = [...aiMappings];
                    updated[index] = { ...updated[index], ...updates };
                    setAiMappings(updated);
                  }}
                />

                {/* Save Mappings Section */}
                <div style={{ marginTop: '32px', paddingTop: '24px', borderTop: '2px solid #e2e8f0' }}>
                  <div style={{ display: 'flex', gap: '16px', alignItems: 'center', justifyContent: 'space-between' }}>
                    <div>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>Save Account Mappings</h3>
                      <p style={{ fontSize: '14px', color: '#64748b', margin: 0 }}>Save your mappings to use them for future data processing.</p>
                    </div>
                    <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                      <button
                        onClick={async () => {
                          if (!aiMappings || aiMappings.length === 0) {
                            alert('Please save account mappings first!');
                            return;
                          }

                          if (!csvTrialBalanceData || csvTrialBalanceData._companyId !== selectedCompanyId) {
                            alert('No CSV/Trial Balance data available!');
                            return;
                          }

                          if (!currentUser) {
                            alert('User not logged in!');
                            return;
                          }

                          setIsProcessingMonthlyData(true);
                          try {
                            console.log('?? Processing CSV/Trial Balance data using mappings...');
                            console.log('?? Total mappings:', aiMappings.length);

                            // Process the CSV data using mappings
                            const processedData = processTrialBalanceToMonthly(csvTrialBalanceData, aiMappings);

                            // Save to database
                            const response = await fetch('/api/financials', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                companyId: selectedCompanyId,
                                uploadedByUserId: currentUser.id,
                                fileName: csvTrialBalanceData.fileName || 'CSV Trial Balance Upload',
                                rawData: csvTrialBalanceData,
                                columnMapping: { source: 'csv_trial_balance', mappings: aiMappings },
                                monthlyData: processedData
                              })
                            });

                            if (!response.ok) {
                              throw new Error('Failed to save processed data');
                            }

                            const result = await response.json();
                            console.log(`? Processed and saved ${processedData.length} months of CSV data`);

                            // Automatically create master data from the processed data
                            try {
                              console.log('ðŸ”„ Auto-creating master data...');
                              const masterDataResponse = await fetch('/api/save-master-file', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                  companyId: selectedCompanyId,
                                  monthlyData: processedData
                                })
                              });

                              const masterDataResult = await masterDataResponse.json();
                              if (masterDataResult.success) {
                                console.log(`âœ… Master data auto-created: ${masterDataResult.months} months`);
                              } else {
                                console.error('âŒ Failed to auto-create master data:', masterDataResult.error);
                              }
                            } catch (masterDataError) {
                              console.error('âŒ Error auto-creating master data:', masterDataError);
                            }

                            // Update local state
                            setLoadedMonthlyData(processedData);

                            alert(`? Successfully processed and saved ${processedData.length} months of financial data from CSV/Trial Balance!`);
                          } catch (error: any) {
                            console.error('Error processing CSV data:', error);
                            alert('Failed to process CSV data: ' + error.message);
                          } finally {
                            setIsProcessingMonthlyData(false);
                          }
                        }}
                        disabled={isProcessingMonthlyData || aiMappings.length === 0}
                        style={{
                          padding: '8px 16px',
                          background: isProcessingMonthlyData || aiMappings.length === 0 ? '#9ca3af' : '#3b82f6',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '13px',
                          fontWeight: '600',
                          cursor: isProcessingMonthlyData || aiMappings.length === 0 ? 'not-allowed' : 'pointer',
                          boxShadow: '0 2px 6px rgba(59, 130, 246, 0.3)'
                        }}
                      >
                        {isProcessingMonthlyData ? 'Processing...' : 'âš™ï¸ Process & Save Monthly Data'}
                      </button>
                      <button
                        onClick={async () => {
                          try {
                            console.log('ðŸ” Save Mappings Debug:', {
                              currentCompany,
                              currentCompanyId: currentCompany?.id,
                              selectedCompanyId,
                              aiMappingsCount: aiMappings?.length,
                              aiMappingsSample: aiMappings?.slice(0, 2),
                              linesOfBusinessCount: linesOfBusiness?.length
                            });

                            if (!currentCompany?.id) {
                              alert(`Cannot save mappings: Company not found. Selected: ${selectedCompanyId}, Available companies: ${companies?.length || 0}`);
                              return;
                            }

                            if (!aiMappings || aiMappings.length === 0) {
                              alert('No mappings to save. Please generate AI mappings first.');
                              return;
                            }

                            setIsSavingMappings(true);
                            const response = await fetch('/api/account-mappings', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                companyId: currentCompany.id,
                                mappings: aiMappings,
                                linesOfBusiness: linesOfBusiness
                              })
                            });

                            if (response.ok) {
                              toast.success('Account mappings saved successfully!');
                            } else {
                              toast.error('Failed to save account mappings');
                            }
                          } catch (error) {
                            console.error('Error saving mappings:', error);
                            toast.error('Failed to save account mappings');
                          } finally {
                            setIsSavingMappings(false);
                          }
                        }}
                        disabled={isSavingMappings}
                        style={{
                          padding: '8px 16px',
                          background: isSavingMappings ? '#9ca3af' : '#10b981',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: isSavingMappings ? 'not-allowed' : 'pointer',
                          boxShadow: '0 2px 6px rgba(16, 185, 129, 0.3)'
                        }}
                      >
                        {isSavingMappings ? 'Saving...' : 'ðŸ’¾ Save Mappings'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Account Preview Section */}
            {hasCsvData && csvTrialBalanceData && (
            <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '16px' }}>
                Account Preview (All {csvTrialBalanceData.accounts?.length || 0} accounts - Most Recent Period)
              </h2>
              {/* Debug info */}
              <div style={{ background: '#fef3c7', border: '1px solid #f59e0b', borderRadius: '6px', padding: '8px', marginBottom: '16px', fontSize: '12px' }}>
                <strong>Debug Info:</strong><br/>
                Accounts: {csvTrialBalanceData.accounts?.length || 0}<br/>
                Dates: {csvTrialBalanceData.dates?.join(', ') || 'none'}<br/>
                Latest Date: "{csvTrialBalanceData.dates?.[csvTrialBalanceData.dates.length - 1]}"<br/>
                {csvTrialBalanceData.accounts?.[0] && (
                  <>First account keys: {Object.keys(csvTrialBalanceData.accounts[0]).join(', ')}</>
                )}
              </div>
              <div style={{ overflowX: 'auto', maxHeight: '600px', overflowY: 'auto' }}>
                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                  <thead style={{ position: 'sticky', top: 0, background: '#f8fafc', zIndex: 1 }}>
                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                      <th style={{ textAlign: 'left', padding: '8px', fontWeight: '600', color: '#475569', minWidth: '80px' }}>Type</th>
                      <th style={{ textAlign: 'left', padding: '8px', fontWeight: '600', color: '#475569', minWidth: '60px' }}>ID</th>
                      <th style={{ textAlign: 'left', padding: '8px', fontWeight: '600', color: '#475569', minWidth: '200px' }}>Description</th>
                      <th style={{ textAlign: 'right', padding: '8px', fontWeight: '600', color: '#475569', minWidth: '100px' }}>Latest Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    {csvTrialBalanceData.accounts?.map((account: any, idx: number) => {
                      const latestDate = csvTrialBalanceData.dates?.[csvTrialBalanceData.dates.length - 1];
                      const latestValue = latestDate && account.values ? (account.values[latestDate] || 0) : 0;

                      // Debug logging for first few accounts
                      if (idx < 5) {
                        console.log(`[Account Preview Debug] Account ${idx}:`);
                        console.log(`  Description: "${account.description}"`);
                        console.log(`  Latest Date: "${latestDate}"`);
                        console.log(`  Available dates in account.values:`, Object.keys(account.values || {}));
                        console.log(`  Raw latest value from account.values[${latestDate}]:`, account.values?.[latestDate]);
                        console.log(`  Final latestValue: ${latestValue}`);
                        console.log(`  Account values object:`, account.values);
                        console.log(`---`);
                      }

                      return (
                        <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                          <td style={{ padding: '6px 8px', color: '#64748b', fontSize: '11px' }}>{account.acctType}</td>
                          <td style={{ padding: '6px 8px', color: '#64748b', fontSize: '11px', fontFamily: 'monospace' }}>{account.acctId}</td>
                          <td style={{ padding: '6px 8px', color: '#1e293b', fontSize: '11px' }}>{account.description}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', color: latestValue >= 0 ? '#10b981' : '#ef4444', fontWeight: '600', fontSize: '11px', fontFamily: 'monospace' }}>
                            ${Math.abs(latestValue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            {latestValue < 0 && ' (CR)'}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              <div style={{ marginTop: '12px', padding: '8px', background: '#f0f9ff', border: '1px solid #bae6fd', borderRadius: '6px' }}>
                <p style={{ fontSize: '12px', color: '#0369a1', margin: 0, fontWeight: '500' }}>
                  ðŸ“Š Showing amounts for most recent period: {csvTrialBalanceData.dates?.[csvTrialBalanceData.dates.length - 1] || 'N/A'}
                </p>
                <p style={{ fontSize: '11px', color: '#64748b', margin: '4px 0 0 0' }}>
                  Total accounts: {csvTrialBalanceData.accounts?.length || 0} |
                  Scroll to see all accounts | Use this to verify account mappings and amounts
                </p>
              </div>
            </div>
            )}
          </div>
        );
      })()}

      {/* Data Mapping View - AI-Assisted Mapping Interface */}
      {(currentView === 'admin' && adminDashboardTab === 'data-mapping' && selectedCompanyId && qbRawData) && (() => {
        // CRITICAL SECURITY CHECK: Ensure qbRawData matches the selected company
        if (!qbRawData._companyId || qbRawData._companyId !== selectedCompanyId) {
          console.error(`ðŸš¨ SECURITY BLOCK: Data mismatch! Selected: ${selectedCompanyId}, Data companyId: ${qbRawData._companyId || 'MISSING'}`);
          return <div style={{ padding: '48px', textAlign: 'center' }}>
            <div style={{ fontSize: '18px', color: '#ef4444', marginBottom: '12px' }}>â³ Loading company data...</div>
            <div style={{ fontSize: '14px', color: '#64748b' }}>Please wait while we fetch the correct financial data.</div>
          </div>;
        }
        
        const currentCompany = Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined;
        const currentCompanyName = currentCompany?.name || 'Unknown';
        console.log(`ðŸ”„ ========================================`);
        console.log(`ðŸ”„ DATA MAPPING RENDERING (Refresh Key: ${dataRefreshKey})`);
        console.log(`ðŸ”„ Selected Company: "${currentCompanyName}" (ID: ${selectedCompanyId})`);
        console.log(`ðŸ”„ QB Data sync date:`, qbRawData.syncDate);
        console.log(`ðŸ”„ Data belongs to company:`, qbRawData._companyId);
        console.log(`ðŸ”„ Record ID:`, qbRawData._recordId);
        console.log(`ðŸ”„ ========================================`);
        
        // Helper function to recursively extract all rows from QB report
        // Extract from the last month column, not the total column
        // Calculate totals by summing detail rows instead of using QB's Summary rows
        const extractRows = (data: any, level: number = 0, parentSection: string = ''): any[] => {
          const result: any[] = [];
          
          if (!data) return result;
          
          // Check if this is a multi-column report (monthly breakdown)
          const columns = data.Columns?.Column || [];
          const hasMultipleMonths = columns.length > 2; // More than just account name + one value column
          
          const rows = Array.isArray(data?.Rows) ? data.Rows : (data?.Rows?.Row ? (Array.isArray(data.Rows.Row) ? data.Rows.Row : [data.Rows.Row]) : []);
          
          for (const row of rows) {
            if (row.type === 'Section') {
              // Add section header
              const sectionName = row.Header?.ColData?.[0]?.value || parentSection;
              if (sectionName) {
                result.push({
                  type: 'section',
                  name: sectionName,
                  level,
                  isHeader: true,
                  section: sectionName
                });
              }
              
              // Track index before nested rows for calculating section total
              const beforeNestedIndex = result.length;
              
              // Recursively process nested rows WITH section tracking
              if (row.Rows?.Row) {
                const nested = extractRows({ Rows: { Row: row.Rows.Row } }, level + 1, sectionName);
                result.push(...nested);
              }
              
              // Calculate section total by summing ONLY data rows (not subtotals) in this section
              const nestedRows = result.slice(beforeNestedIndex);
              let calculatedTotal = 0;
              nestedRows.forEach(r => {
                if (r.type === 'data') {  // Only sum detail rows, not subtotal rows
                  const numValue = parseFloat(r.value) || 0;
                  calculatedTotal += numValue;
                }
              });
              
              // Add section summary/total with calculated value
              if (row.Summary?.ColData) {
                const name = row.Summary.ColData[0]?.value || '';
                if (name) {
                  result.push({
                    type: 'total',
                    name,
                    value: calculatedTotal,
                    level,
                    isTotal: true
                  });
                }
              }
            } else if (row.type === 'Data' && row.ColData) {
              // Add data row (individual account)
              const name = row.ColData[0]?.value || '';
              // Extract from appropriate column: last month if multi-month, otherwise last column
              let value = '0';
              for (let i = row.ColData.length - 1; i >= 1; i--) {
                const colValue = row.ColData[i]?.value;
                if (colValue !== undefined && colValue !== '' && !isNaN(parseFloat(colValue))) {
                  value = colValue;
                  break;
                }
              }
              if (name) {
                result.push({
                  type: 'data',
                  name,
                  value,
                  level,
                  section: parentSection  // Track which section this account belongs to
                });
              }
            }
          }
          
          return result;
        };
        
        const plRows = extractRows(qbRawData.profitAndLoss);
        const bsRows = extractRows(qbRawData.balanceSheet);
        
        // Debug: Log all total rows to identify the Total Income discrepancy
        console.log('=== P&L Total Rows ===');
        plRows.filter(r => r.isTotal).forEach(r => {
          console.log(`${r.name}: ${r.value}`);
        });
        
        return (
          <div key={`data-mapping-${selectedCompanyId}-${dataRefreshKey}`} style={{ maxWidth: '1800px', margin: '0 auto', padding: '32px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>ðŸ”— Account Mapping</h1>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
            </div>
            <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '16px' }}>
              Map QuickBooks accounts to your standardized financial fields - Synced: {qbRawData.syncDate ? new Date(qbRawData.syncDate).toLocaleString() : 'Unknown'}
            </p>


            {/* AI-Assisted Mapping Section */}
            <div style={{ marginBottom: '32px' }}>
              <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <div>
                    <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>
                      AI-Assisted Account Mapping
                    </h2>
                    <p style={{ fontSize: '14px', color: '#64748b', margin: 0 }}>
                      Use AI to automatically suggest mappings from QuickBooks accounts to your standardized financial fields
                    </p>
                  </div>
                  <button
                    onClick={async () => {
                      setIsGeneratingMappings(true);
                      try {
                        // Build account classification lookup from Chart of Accounts
                        const accountClassifications: Record<string, string> = {};
                        const chartOfAccounts = qbRawData?.chartOfAccounts?.QueryResponse?.Account || [];
                        
                        console.log('ðŸ” Chart of Accounts sample:', chartOfAccounts.slice(0, 5));
                        console.log('ðŸ” Total accounts in chart:', chartOfAccounts.length);
                        
                        chartOfAccounts.forEach((account: any) => {
                          const accountName = account.Name;
                          const accountType = account.AccountType || '';
                          
                          // DEBUG: Log first 10 accounts to see the data structure
                          if (chartOfAccounts.indexOf(account) < 10) {
                            console.log(`Account: "${accountName}" | Type: "${accountType}" | Full:`, account);
                          }
                          
                          // Map QB AccountType to our simplified classifications
                          let classification = '';
                          if (accountType === 'Income' || accountType === 'Other Income') {
                            classification = 'Revenue';
                          } else if (accountType === 'Cost of Goods Sold') {
                            classification = 'Cost of Goods Sold';
                          } else if (accountType === 'Expense' || accountType === 'Other Expense') {
                            classification = 'Expense';
                          } else if (
                            accountType === 'Bank' || 
                            accountType === 'Accounts Receivable' || 
                            accountType === 'Other Current Asset' || 
                            accountType === 'Fixed Asset' || 
                            accountType === 'Other Asset' ||
                            accountType.includes('Asset')
                          ) {
                            classification = 'Asset';
                          } else if (
                            accountType === 'Accounts Payable' || 
                            accountType === 'Credit Card' || 
                            accountType === 'Other Current Liability' || 
                            accountType === 'Long Term Liability' ||
                            accountType.includes('Liability')
                          ) {
                            classification = 'Liability';
                          } else if (accountType === 'Equity') {
                            classification = 'Equity';
                          }
                          
                          if (accountName && classification) {
                            accountClassifications[accountName] = classification;
                          }
                        });
                        
                        if (Object.keys(accountClassifications).length === 0) {
                          console.error('?? No Chart of Accounts data found! Classifications will be incorrect.');
                        }
                        
                        // Extract all account names WITH classifications from QB data
                        const qbAccountsWithClass: Array<{name: string, classification: string}> = [];
                        
                        // Use the SAME extractRows function that works for display
                        const plRows = extractRows(qbRawData.profitAndLoss);
                        const bsRows = extractRows(qbRawData.balanceSheet);
                        
                        // For P&L: Get individual REVENUE items AND individual EXPENSE items (not totals)
                        const revenueDataRows = plRows.filter(r => {
                          if (r.type !== 'data' || r.isHeader || r.isTotal) return false;
                          const section = (r.section || '').toLowerCase();
                          return section.includes('income') || section.includes('revenue');
                        });
                        const expenseDataRows = plRows.filter(r => {
                          if (r.type !== 'data' || r.isHeader || r.isTotal) return false;
                          const section = (r.section || '').toLowerCase();
                          return section.includes('expense') || section.includes('cost');
                        });
                        
                        // For Balance Sheet: Get individual items (all detail accounts)
                        const bsDataRows = bsRows.filter(r => r.type === 'data' && !r.isHeader && !r.isTotal);
                        
                        console.log('ðŸ” Revenue individual items:', revenueDataRows.length);
                        console.log('ðŸ” Expense individual items:', expenseDataRows.length);
                        console.log('ðŸ” BS individual items:', bsDataRows.length);
                        
                        // DEBUG: Pick first revenue account to track through entire process
                        const testAccount = revenueDataRows[0]?.name || expenseDataRows[0]?.name || bsDataRows[0]?.name;
                        console.log(`\nðŸ”¬ TRACKING TEST ACCOUNT: "${testAccount}"`);
                        if (testAccount) {
                          const testRow = plRows.find(r => r.name === testAccount) || bsRows.find(r => r.name === testAccount);
                          console.log('Test account raw data:', testRow);
                        }
                        
                        // Add revenue individual items
                        revenueDataRows.forEach(row => {
                          const classification = accountClassifications[row.name] || 'Revenue';
                          qbAccountsWithClass.push({ name: row.name, classification });
                        });
                        
                        // Add expense individual items
                        expenseDataRows.forEach(row => {
                          const classification = accountClassifications[row.name] || 'Expense';
                          qbAccountsWithClass.push({ name: row.name, classification });
                        });
                        
                        // Add BS individual items
                        let assetCount = 0, liabilityCount = 0, equityCount = 0;
                        bsDataRows.forEach((row, idx) => {
                          // Try to get classification from Chart of Accounts first
                          let classification = accountClassifications[row.name];
                          
                          // If not found, determine from Balance Sheet section
                          if (!classification && row.section) {
                            const section = row.section.toLowerCase();
                            if (section.includes('asset')) {
                              classification = 'Asset';
                              assetCount++;
                            } else if (section.includes('liabilit')) {
                              classification = 'Liability';
                              liabilityCount++;
                            } else if (section.includes('equity')) {
                              classification = 'Equity';
                              equityCount++;
                            } else {
                              // Default to Asset only if we really can't determine
                              classification = 'Asset';
                              assetCount++;
                            }
                            
                            // Debug first 5 accounts
                            if (idx < 5) {
                              console.log(`BS Account ${idx}: "${row.name}" | Section: "${row.section}" ? ${classification}`);
                            }
                          } else if (!classification) {
                            classification = 'Asset'; // Last resort default
                            assetCount++;
                          } else {
                            // Count from Chart of Accounts lookup
                            if (classification === 'Asset') assetCount++;
                            else if (classification === 'Liability') liabilityCount++;
                            else if (classification === 'Equity') equityCount++;
                          }
                          
                          qbAccountsWithClass.push({ name: row.name, classification });
                        });
                        
                        console.log(`ðŸ“Š BS Classification breakdown: Assets=${assetCount}, Liabilities=${liabilityCount}, Equity=${equityCount}`);
                        
                        console.log('ðŸ” TOTAL accounts to map:', qbAccountsWithClass.length);
                        console.log('ðŸ” First 10 accounts:', qbAccountsWithClass.slice(0, 10).map(a => a.name));

                        const response = await fetch('/api/ai-mapping/enhanced', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ 
                            qbAccountsWithClass,
                            companyId: selectedCompanyId,
                            targetFields: []
                          })
                        });

                        if (!response.ok) {
                          throw new Error('Failed to generate mappings');
                        }

                        const data = await response.json();
                        setAiMappings(data.mappings || []);
                        
                        // DEBUG: Track test account through mapping
                        if (testAccount) {
                          const testMapping = data.mappings.find((m: any) => m.qbAccount === testAccount);
                          console.log(`\nðŸ”¬ TEST ACCOUNT MAPPING:`, testMapping);
                        }
                        
                        setShowMappingSection(true);
                      } catch (error: any) {
                        console.error('Error generating mappings:', error);
                        alert('Failed to generate AI mappings: ' + error.message);
                      } finally {
                        setIsGeneratingMappings(false);
                      }
                    }}
                    disabled={isGeneratingMappings || plRows.length === 0}
                    style={{
                      padding: '12px 24px',
                      background: isGeneratingMappings ? '#94a3b8' : '#667eea',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: isGeneratingMappings ? 'not-allowed' : 'pointer',
                      boxShadow: '0 2px 6px rgba(102, 126, 234, 0.3)',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}
                  >
                    {isGeneratingMappings ? (
                      <>
                        <span>ðŸ¤–</span>
                        <span>Generating Mappings...</span>
                      </>
                    ) : (
                      <>
                        <span>ðŸ¤–</span>
                        <span>Generate AI Mappings</span>
                      </>
                    )}
                  </button>
                </div>

                {showMappingSection && aiMappings.length > 0 && (
                  <div>
                    <div style={{ marginBottom: '16px', padding: '16px', background: '#f0f9ff', border: '1px solid #bae6fd', borderRadius: '8px' }}>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#0369a1', marginBottom: '4px' }}>
                        ? AI Suggestions Generated
                      </div>
                      <div style={{ fontSize: '13px', color: '#0c4a6e' }}>
                        Review the suggested mappings below. You can edit any mapping before saving. Mappings will be used to automatically populate your standardized financial statements from QuickBooks data.
                      </div>
                    </div>

                    <div style={{ maxHeight: '500px', overflowY: 'auto', marginBottom: '16px' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                        <thead style={{ position: 'sticky', top: 0, background: 'white', zIndex: 1 }}>
                          <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                            <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#1e293b', width: '10%' }}>Classification</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#1e293b', width: '20%' }}>QuickBooks Account</th>
                            <th style={{ padding: '12px', textAlign: 'right', fontWeight: '600', color: '#1e293b', width: '10%' }}>Amount</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#1e293b', width: '15%' }}>Target Field</th>
                            <th colSpan={linesOfBusiness.filter(lob => lob.name.trim() !== '').length || 1} style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#1e293b', borderLeft: '2px solid #e2e8f0', borderRight: '2px solid #e2e8f0' }}>
                              Line of Business Allocation (%)
                            </th>
                            <th style={{ padding: '12px', textAlign: 'center', fontWeight: '600', color: '#1e293b', width: '7%' }}>Total %</th>
                            <th style={{ padding: '12px', textAlign: 'left', fontWeight: '600', color: '#1e293b', width: '10%' }}>Confidence</th>
                          </tr>
                          <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                            <th colSpan={4}></th>
                            {linesOfBusiness.filter(lob => lob.name.trim() !== '').length > 0 ? (
                              linesOfBusiness.filter(lob => lob.name.trim() !== '').map((lob, idx) => (
                                <th key={idx} style={{ padding: '8px 4px', textAlign: 'center', fontSize: '11px', fontWeight: '600', color: '#475569', borderLeft: idx === 0 ? '2px solid #e2e8f0' : '1px solid #f1f5f9', borderRight: idx === linesOfBusiness.filter(l => l.name.trim() !== '').length - 1 ? '2px solid #e2e8f0' : 'none', background: '#f8fafc' }}>
                                  {lob.name}
                                </th>
                              ))
                            ) : (
                              <th style={{ padding: '8px 4px', textAlign: 'center', fontSize: '11px', fontWeight: '600', color: '#94a3b8', borderLeft: '2px solid #e2e8f0', borderRight: '2px solid #e2e8f0', background: '#f8fafc' }}>
                                Define LOBs above
                              </th>
                            )}
                            <th></th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                          {(() => {
                            // Sort mappings by classification
                            const classificationOrder = ['Revenue', 'Cost of Goods Sold', 'COGS', 'Expense', 'Asset', 'Current Asset', 'Fixed Asset', 'Other Asset', 'Liability', 'Current Liability', 'Long Term Liability', 'Equity'];
                            const sortedMappings = [...aiMappings].sort((a, b) => {
                              const aClass = a.qbAccountClassification || '';
                              const bClass = b.qbAccountClassification || '';
                              const aIdx = classificationOrder.findIndex(c => aClass.includes(c) || c.includes(aClass));
                              const bIdx = classificationOrder.findIndex(c => bClass.includes(c) || c.includes(bClass));
                              if (aIdx === -1 && bIdx === -1) return 0;
                              if (aIdx === -1) return 1;
                              if (bIdx === -1) return -1;
                              return aIdx - bIdx;
                            });
                            
                            return sortedMappings.map((mapping, idx) => {
                              // Get amount from already-extracted plRows and bsRows
                              let amount = null;
                              if (plRows && bsRows) {
                                const allRows = [...plRows, ...bsRows];
                                const accountRow = allRows.find((row: any) => row.name === mapping.qbAccount);
                                if (accountRow) {
                                  amount = parseFloat(accountRow.value) || 0;
                                }
                              }
                              
                              return (
                                <tr key={`${mapping.qbAccount}-${idx}`} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                  <td style={{ padding: '12px', color: '#475569', fontSize: '12px', fontWeight: '600' }}>
                                    {mapping.qbAccountClassification || '-'}
                                  </td>
                                  <td style={{ padding: '12px', color: '#475569' }}>{mapping.qbAccount}</td>
                                  <td style={{ padding: '12px', color: '#475569', textAlign: 'right', fontFamily: 'monospace' }}>
                                    {amount !== null && amount !== undefined ? `$${Number(amount).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : '-'}
                                  </td>
                                  <td style={{ padding: '12px' }}>
                                    <select
                                      value={mapping.targetField || ''}
                                      onChange={(e) => {
                                        const newValue = e.target.value;
                                        const updated = aiMappings.map(m => 
                                          m.qbAccount === mapping.qbAccount 
                                            ? { ...m, targetField: newValue }
                                            : m
                                        );
                                        setAiMappings(updated);
                                      }}
                                      style={{
                                        width: '100%',
                                        padding: '6px 10px',
                                        border: '1px solid #cbd5e1',
                                        borderRadius: '6px',
                                        fontSize: '13px',
                                        color: '#1e293b',
                                        cursor: 'pointer'
                                      }}
                                    >
                                      <option value="">-- Select Field --</option>
                                      <optgroup label="Income Statement">
                                        <option value="revenue">Revenue</option>
                                        <option value="expense">Total Expense</option>
                                        <option value="cogsPayroll">COGS - Payroll</option>
                                        <option value="cogsOwnerPay">COGS - Owner Pay</option>
                                        <option value="cogsContractors">COGS - Contractors</option>
                                        <option value="cogsMaterials">COGS - Materials</option>
                                        <option value="cogsCommissions">COGS - Commissions</option>
                                        <option value="cogsOther">COGS - Other</option>
                                        <option value="cogsTotal">COGS - Total</option>
                                        <option value="payroll">Payroll</option>
                                        <option value="ownerBasePay">Owner Base Pay</option>
                                        <option value="benefits">Benefits</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="professionalFees">Professional Fees</option>
                                        <option value="subcontractors">Subcontractors</option>
                                        <option value="rent">Rent</option>
                                        <option value="taxLicense">Tax & License</option>
                                        <option value="phoneComm">Phone & Communication</option>
                                        <option value="infrastructure">Infrastructure/Utilities</option>
                                        <option value="autoTravel">Auto & Travel</option>
                                        <option value="salesExpense">Sales & Marketing</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="trainingCert">Training & Certification</option>
                                        <option value="mealsEntertainment">Meals & Entertainment</option>
                                        <option value="interestExpense">Interest Expense</option>
                                        <option value="depreciationAmortization">Depreciation & Amortization</option>
                                        <option value="otherExpense">Other Expense</option>
                                        <option value="nonOperatingIncome">Non-Operating Income</option>
                                        <option value="extraordinaryItems">Extraordinary Items</option>
                                      </optgroup>
                                      <optgroup label="Balance Sheet - Assets">
                                        <option value="cash">Cash</option>
                                        <option value="ar">Accounts Receivable</option>
                                        <option value="inventory">Inventory</option>
                                        <option value="otherCA">Other Current Assets</option>
                                        <option value="tca">Total Current Assets</option>
                                        <option value="fixedAssets">Fixed Assets</option>
                                        <option value="otherAssets">Other Assets</option>
                                        <option value="totalAssets">Total Assets</option>
                                      </optgroup>
                                      <optgroup label="Balance Sheet - Liabilities">
                                        <option value="ap">Accounts Payable</option>
                                        <option value="otherCL">Other Current Liabilities</option>
                                        <option value="tcl">Total Current Liabilities</option>
                                        <option value="ltd">Long Term Debt</option>
                                        <option value="totalLiab">Total Liabilities</option>
                                      </optgroup>
                                      <optgroup label="Balance Sheet - Equity">
                                        <option value="ownersCapital">Owner's Capital</option>
                                        <option value="ownersDraw">Owner's Draw</option>
                                        <option value="commonStock">Common Stock</option>
                                        <option value="preferredStock">Preferred Stock</option>
                                        <option value="retainedEarnings">Retained Earnings</option>
                                        <option value="additionalPaidInCapital">Additional Paid-In Capital</option>
                                        <option value="treasuryStock">Treasury Stock</option>
                                        <option value="totalEquity">Total Equity</option>
                                        <option value="totalLAndE">Total Liabilities & Equity</option>
                                      </optgroup>
                                    </select>
                                  </td>
                                  {linesOfBusiness.filter(lob => lob.name.trim() !== '').length > 0 ? (
                                    linesOfBusiness.filter(lob => lob.name.trim() !== '').map((lob, lobIdx) => {
                                      const lobAllocations = mapping.lobAllocations || {};
                                      const currentPercent = lobAllocations[lob.name] !== undefined ? lobAllocations[lob.name] : 0;
                                      const allAllocations = lobAllocations;
                                      const total = Object.values(allAllocations).reduce((sum: number, val: any) => sum + (val || 0), 0);
                                      const isOverAllocated = total > 100;
                                      const isUnderAllocated = total < 100 && total > 0;
                                      
                                      return (
                                        <td key={lobIdx} style={{ padding: '8px 4px', borderLeft: lobIdx === 0 ? '2px solid #e2e8f0' : '1px solid #f1f5f9', borderRight: lobIdx === linesOfBusiness.filter(l => l.trim() !== '').length - 1 ? '2px solid #e2e8f0' : 'none', background: '#fafafa' }}>
                                          <input
                                            type="number"
                                            min="0"
                                            max="100"
                                            value={currentPercent}
                                            onChange={(e) => {
                                              const newValue = parseInt(e.target.value) || 0;
                                              const clamped = Math.min(Math.max(newValue, 0), 100);
                                              const updated = aiMappings.map(m =>
                                                m.qbAccount === mapping.qbAccount
                                                  ? {
                                                      ...m,
                                                      lobAllocations: {
                                                        ...(m.lobAllocations || {}),
                                                        [lob]: clamped
                                                      }
                                                    }
                                                  : m
                                              );
                                              setAiMappings(updated);
                                            }}
                                            style={{
                                              width: '50px',
                                              padding: '4px 6px',
                                              border: isOverAllocated ? '2px solid #ef4444' : isUnderAllocated ? '2px solid #f59e0b' : '1px solid #cbd5e1',
                                              borderRadius: '4px',
                                              fontSize: '12px',
                                              color: '#1e293b',
                                              textAlign: 'center',
                                              background: 'white'
                                            }}
                                            title={isOverAllocated ? `Total allocation is ${total}% (exceeds 100%)` : isUnderAllocated ? `Total allocation is ${total}% (less than 100%)` : `Total allocation: ${total}%`}
                                          />
                                        </td>
                                      );
                                    })
                                  ) : (
                                    <td style={{ padding: '12px', textAlign: 'center', color: '#94a3b8', fontSize: '12px', borderLeft: '2px solid #e2e8f0', borderRight: '2px solid #e2e8f0', background: '#fafafa' }}>
                                      -
                                    </td>
                                  )}
                                  <td style={{ padding: '12px', textAlign: 'center' }}>
                                    {(() => {
                                      const lobAllocations = mapping.lobAllocations || {};
                                      const total = Object.values(lobAllocations).reduce((sum: number, val: any) => sum + (val || 0), 0);
                                      const isOverAllocated = total > 100;
                                      const isUnderAllocated = total < 100 && total > 0;
                                      const isPerfect = total === 100;
                                      
                                      return (
                                        <span style={{
                                          padding: '4px 8px',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          fontWeight: '600',
                                          background: isOverAllocated ? '#fee2e2' : isUnderAllocated ? '#fef3c7' : isPerfect ? '#dcfce7' : '#f1f5f9',
                                          color: isOverAllocated ? '#dc2626' : isUnderAllocated ? '#d97706' : isPerfect ? '#16a34a' : '#64748b'
                                        }}>
                                          {total}%
                                        </span>
                                      );
                                    })()}
                                  </td>
                                  <td style={{ padding: '12px' }}>
                                    <select
                                      value={mapping.confidence}
                                      onChange={(e) => {
                                        const newValue = e.target.value;
                                        const updated = aiMappings.map(m => 
                                          m.qbAccount === mapping.qbAccount 
                                            ? { ...m, confidence: newValue }
                                            : m
                                        );
                                        setAiMappings(updated);
                                      }}
                                      style={{
                                        padding: '6px 10px',
                                        border: '1px solid #cbd5e1',
                                        borderRadius: '6px',
                                        fontSize: '13px',
                                        color: '#1e293b',
                                        background: mapping.confidence === 'high' ? '#dcfce7' : (mapping.confidence === 'medium' ? '#fef3c7' : '#fee2e2')
                                      }}
                                    >
                                      <option value="high">High</option>
                                      <option value="medium">Medium</option>
                                      <option value="low">Low</option>
                                    </select>
                                  </td>
                                </tr>
                              );
                            });
                          })()}
                        </tbody>
                      </table>
                    </div>

                    {/* Action Buttons Section */}
                    <div style={{ marginTop: '24px', padding: '20px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                      {/* Row 1: Mapping Controls */}
                      <div style={{ display: 'flex', gap: '12px', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', paddingBottom: '16px', borderBottom: '1px solid #e2e8f0' }}>
                        <div>
                          <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>Account Mapping Controls</h3>
                          <p style={{ fontSize: '12px', color: '#64748b', margin: 0 }}>Save your mappings before processing data</p>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                          <button
                            onClick={async () => {
                              if (confirm('Are you sure you want to clear all mappings? This will delete saved mappings from the database.')) {
                                try {
                                  // Delete from database
                                  const response = await fetch(`/api/account-mappings?companyId=${selectedCompanyId}`, {
                                    method: 'DELETE'
                                  });
                                  if (!response.ok) throw new Error('Failed to delete mappings');
                                  
                                  // Clear from state
                                  setAiMappings([]);
                                  alert('All mappings cleared! ?');
                                } catch (error: any) {
                                  alert('Failed to clear mappings: ' + error.message);
                                }
                              }
                            }}
                            disabled={aiMappings.length === 0}
                            style={{
                              padding: '10px 20px',
                              background: aiMappings.length === 0 ? '#f1f5f9' : '#fee2e2',
                              color: aiMappings.length === 0 ? '#94a3b8' : '#dc2626',
                              border: '1px solid #fecaca',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                              cursor: aiMappings.length === 0 ? 'not-allowed' : 'pointer'
                            }}
                          >
                            ðŸ§¹ Clear All
                          </button>
                          <button
                            onClick={() => {
                              setShowMappingSection(false);
                              setAiMappings([]);
                            }}
                            style={{
                              padding: '10px 20px',
                              background: 'white',
                              color: '#64748b',
                              border: '1px solid #cbd5e1',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                              cursor: 'pointer'
                            }}
                          >
                            Cancel
                          </button>
                          <button
                            onClick={async () => {
                              setIsSavingMappings(true);
                              try {
                                // Deduplicate mappings by qbAccount (keep first occurrence)
                                const uniqueMappings = aiMappings.filter((m, index, self) =>
                                  index === self.findIndex((t) => t.qbAccount === m.qbAccount)
                                );
                                
                                console.log(`Deduplicating mappings: ${aiMappings.length} -> ${uniqueMappings.length}`);
                                
                                const response = await fetch('/api/account-mappings', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({
                                    companyId: selectedCompanyId,
                                    mappings: uniqueMappings,
                                    linesOfBusiness: linesOfBusiness.filter(lob => lob.name.trim() !== '')
                                  })
                                });

                                if (!response.ok) {
                                  const errorData = await response.json();
                                  throw new Error(errorData.details || 'Failed to save mappings');
                                }

                                // Update local state to reflect deduplicated mappings
                                setAiMappings(uniqueMappings);
                                
                                alert('Mappings saved successfully! ?');
                                // Keep the section visible after saving so users can see their saved mappings
                              } catch (error: any) {
                                console.error('Error saving mappings:', error);
                                alert('Failed to save mappings: ' + error.message);
                              } finally {
                                setIsSavingMappings(false);
                              }
                            }}
                            disabled={isSavingMappings}
                            style={{
                              padding: '10px 24px',
                              background: isSavingMappings ? '#94a3b8' : '#10b981',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                              cursor: isSavingMappings ? 'not-allowed' : 'pointer',
                              boxShadow: '0 2px 6px rgba(16, 185, 129, 0.3)'
                            }}
                          >
                            {isSavingMappings ? 'Saving...' : 'ðŸ’¾ Save Mappings'}
                          </button>
                        </div>
                      </div>

                      {/* Row 2: Data Processing */}
                      <div style={{ display: 'flex', gap: '12px', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '4px' }}>Data Processing</h3>
                          <p style={{ fontSize: '12px', color: '#64748b', margin: 0 }}>Process QuickBooks data using your saved mappings</p>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                      <button
                        onClick={async () => {
                          if (!aiMappings || aiMappings.length === 0) {
                            alert('Please save account mappings first!');
                            return;
                          }
                          
                          if (!qbRawData || !qbRawData.profitAndLoss) {
                            alert('No QuickBooks data available!');
                            return;
                          }
                          
                          setIsProcessingMonthlyData(true);
                          try {
                            console.log('ðŸ”„ Processing 36 months of data using mappings...');
                            console.log('ðŸ“‹ Total mappings:', aiMappings.length);
                            
                            // DEBUG: Track Professional Services expense account
                            const testMapping = aiMappings.find(m => 
                              m.qbAccount?.toLowerCase().includes('professional') || 
                              m.qbAccount?.toLowerCase().includes('accounting') ||
                              m.qbAccount?.toLowerCase().includes('legal')
                            );
                            const testAccountName = testMapping?.qbAccount;
                            console.log(`ðŸ”¬ TRACKING PROFESSIONAL SERVICES: "${testAccountName}"`, testMapping);
                            
                            // Get column information from QB report
                            const plColumns = qbRawData.profitAndLoss.Columns?.Column || [];
                            const bsColumns = qbRawData.balanceSheet?.Columns?.Column || [];
                            
                            console.log('QB P&L Columns:', plColumns.map((c: any) => c.ColTitle || c.ColType));
                            
                            // The first column is account names, rest are data columns
                            // Filter out "Total" column if present (usually the last one)
                            const monthColumns = plColumns.slice(1).filter((col: any) => {
                              const title = col.ColTitle || '';
                              return title && title.toLowerCase() !== 'total';
                            });
                            console.log(`Found ${monthColumns.length} month columns in P&L`);
                            console.log('Month column headers:', monthColumns.map((c: any) => c.ColTitle));
                            
                            // Helper function to extract all account values for a specific column index
                            // Uses the SAME recursive logic as the working P&L display extraction
                            const extractColumnData = (reportData: any, columnIndex: number, isFirstCall = false) => {
                              const accountValues: { [accountName: string]: number } = {};
                              
                              const processRows = (rows: any[], depth = 0) => {
                                for (const row of rows) {
                                  if (row.type === 'Section') {
                                    // Process nested rows first
                                    if (row.Rows?.Row) {
                                      const subRows = Array.isArray(row.Rows.Row) ? row.Rows.Row : [row.Rows.Row];
                                      processRows(subRows, depth + 1);
                                    }
                                    
                                    // Get section total from Summary row
                                    if (row.Summary?.ColData) {
                                      const accountName = row.Summary.ColData[0]?.value || '';
                                      const value = row.Summary.ColData[columnIndex]?.value;
                                      
                                      if (accountName) {
                                        const numValue = value === '' || value === undefined ? 0 : parseFloat(value);
                                        accountValues[accountName] = isNaN(numValue) ? 0 : numValue;
                                        
                                        if (isFirstCall && accountName.toLowerCase().includes('legal')) {
                                          console.log(`\nðŸ’° Found Section Summary "${accountName}":`, {
                                      columnIndex,
                                      value,
                                            numValue
                                          });
                                        }
                                      }
                                    }
                                  } else if (row.type === 'Data' && row.ColData) {
                                    // Get detail account value
                                    const accountName = row.ColData[0]?.value || '';
                                    const value = row.ColData[columnIndex]?.value;
                                    
                                  if (accountName) {
                                    const numValue = value === '' || value === undefined ? 0 : parseFloat(value);
                                    accountValues[accountName] = isNaN(numValue) ? 0 : numValue;
                                  }
                                }
                                }
                              };
                              
                              const rows = Array.isArray(reportData?.Rows) ? reportData.Rows : 
                                          (reportData?.Rows?.Row ? (Array.isArray(reportData.Rows.Row) ? reportData.Rows.Row : [reportData.Rows.Row]) : []);
                              
                              processRows(rows, 0);
                              
                              if (isFirstCall) {
                                console.log(`\nðŸ“Š Extraction results: Found ${Object.keys(accountValues).length} accounts`);
                              }
                              
                              return accountValues;
                            };
                            
                            // Process each month's data
                            const monthlyData: any[] = [];
                            
                            for (let i = 1; i <= monthColumns.length; i++) {
                              // Extract data for this column (enable debug logging for first month)
                              const plData = extractColumnData(qbRawData.profitAndLoss, i, i === 1);
                              const bsData = qbRawData.balanceSheet ? extractColumnData(qbRawData.balanceSheet, i, false) : {};
                              
                              // Debug logging for first few months
                              if (i <= 3) {
                                console.log(`\nðŸ” Month ${i} extraction debug:`);
                                console.log(`P&L data keys:`, Object.keys(plData).slice(0, 10));
                                console.log(`P&L sample values:`, Object.entries(plData).slice(0, 5));
                                console.log(`BS data keys:`, Object.keys(bsData).slice(0, 10));
                              }
                              
                              // Debug mappings for first month
                              if (i === 1) {
                                console.log(`\nðŸ—ºï¸ Total mappings: ${aiMappings.length}`);
                                const targetFieldCounts: Record<string, number> = {};
                                aiMappings.forEach(m => {
                                  targetFieldCounts[m.targetField] = (targetFieldCounts[m.targetField] || 0) + 1;
                                });
                                console.log(`Target field distribution:`, targetFieldCounts);
                                const revenueMappings = aiMappings.filter(m => m.targetField === 'revenue');
                                console.log(`Revenue mappings (${revenueMappings.length}):`, revenueMappings.map(m => m.qbAccount));
                              }
                              
                              // Initialize month record
                              const monthRecord: any = {
                                revenue: 0,
                                expense: 0,
                                cogsPayroll: 0,
                                cogsOwnerPay: 0,
                                cogsContractors: 0,
                                cogsMaterials: 0,
                                cogsCommissions: 0,
                                cogsOther: 0,
                                cogsTotal: 0,
                                payroll: 0,
                                ownerBasePay: 0,
                                benefits: 0,
                                insurance: 0,
                                professionalFees: 0,
                                subcontractors: 0,
                                rent: 0,
                                taxLicense: 0,
                                phoneComm: 0,
                                infrastructure: 0,
                                autoTravel: 0,
                                salesExpense: 0,
                                marketing: 0,
                                trainingCert: 0,
                                mealsEntertainment: 0,
                                interestExpense: 0,
                                depreciationAmortization: 0,
                                otherExpense: 0,
                                nonOperatingIncome: 0,
                                extraordinaryItems: 0,
                                cash: 0,
                                ar: 0,
                                inventory: 0,
                                otherCA: 0,
                                tca: 0,
                                fixedAssets: 0,
                                otherAssets: 0,
                                totalAssets: 0,
                                ap: 0,
                                otherCL: 0,
                                tcl: 0,
                                ltd: 0,
                                totalLiab: 0,
                                ownersCapital: 0,
                                ownersDraw: 0,
                                commonStock: 0,
                                preferredStock: 0,
                                retainedEarnings: 0,
                                additionalPaidInCapital: 0,
                                treasuryStock: 0,
                                totalEquity: 0,
                                totalLAndE: 0
                              };
                              
                              // Apply mappings to populate the month record
                              aiMappings.forEach((mapping, idx) => {
                                const qbAccount = mapping.qbAccount;
                                const targetField = mapping.targetField;
                                const classification = mapping.qbAccountClassification || '';
                                
                                // Get value from appropriate data source
                                const isBalanceSheet = classification.includes('Asset') || 
                                                      classification.includes('Liability') || 
                                                      classification.includes('Equity');
                                const value = isBalanceSheet ? (bsData[qbAccount] || 0) : (plData[qbAccount] || 0);
                                
                                // DEBUG: Track test account through every month
                                if (qbAccount === testAccountName) {
                                  console.log(`\nðŸ”¬ MONTH ${i} - TEST ACCOUNT "${testAccountName}":`, {
                                    targetField,
                                    classification,
                                    isBalanceSheet,
                                    foundInPLData: qbAccount in plData,
                                    foundInBSData: qbAccount in bsData,
                                    extractedValue: value,
                                    plDataKeys: Object.keys(plData).slice(0, 5),
                                    bsDataKeys: Object.keys(bsData).slice(0, 5)
                                  });
                                }
                                
                                // Map to target field
                                if (targetField === 'revenue') monthRecord.revenue += value;
                                else if (targetField === 'expense') monthRecord.expense += value;
                                else if (targetField === 'cogsPayroll') monthRecord.cogsPayroll += value;
                                else if (targetField === 'cogsOwnerPay') monthRecord.cogsOwnerPay += value;
                                else if (targetField === 'cogsContractors') monthRecord.cogsContractors += value;
                                else if (targetField === 'cogsMaterials') monthRecord.cogsMaterials += value;
                                else if (targetField === 'cogsCommissions') monthRecord.cogsCommissions += value;
                                else if (targetField === 'cogsOther') monthRecord.cogsOther += value;
                                else if (targetField === 'payroll') monthRecord.payroll += value;
                                else if (targetField === 'ownerBasePay') monthRecord.ownerBasePay += value;
                                else if (targetField === 'benefits') monthRecord.benefits += value;
                                else if (targetField === 'insurance') monthRecord.insurance += value;
                                else if (targetField === 'professionalFees') monthRecord.professionalFees += value;
                                else if (targetField === 'subcontractors') monthRecord.subcontractors += value;
                                else if (targetField === 'rent') monthRecord.rent += value;
                                else if (targetField === 'taxLicense') monthRecord.taxLicense += value;
                                else if (targetField === 'phoneComm') monthRecord.phoneComm += value;
                                else if (targetField === 'infrastructure') monthRecord.infrastructure += value;
                                else if (targetField === 'autoTravel') monthRecord.autoTravel += value;
                                else if (targetField === 'salesExpense') monthRecord.salesExpense += value;
                                else if (targetField === 'marketing') monthRecord.marketing += value;
                                else if (targetField === 'trainingCert') monthRecord.trainingCert += value;
                                else if (targetField === 'mealsEntertainment') monthRecord.mealsEntertainment += value;
                                else if (targetField === 'interestExpense') monthRecord.interestExpense += value;
                                else if (targetField === 'depreciationAmortization') monthRecord.depreciationAmortization += value;
                                else if (targetField === 'otherExpense') monthRecord.otherExpense += value;
                                else if (targetField === 'nonOperatingIncome') monthRecord.nonOperatingIncome += value;
                                else if (targetField === 'extraordinaryItems') monthRecord.extraordinaryItems += value;
                                else if (targetField === 'cash') monthRecord.cash += value;
                                else if (targetField === 'ar') monthRecord.ar += value;
                                else if (targetField === 'inventory') monthRecord.inventory += value;
                                else if (targetField === 'otherCA') monthRecord.otherCA += value;
                                else if (targetField === 'tca') monthRecord.tca += value;
                                else if (targetField === 'fixedAssets') monthRecord.fixedAssets += value;
                                else if (targetField === 'otherAssets') monthRecord.otherAssets += value;
                                else if (targetField === 'totalAssets') monthRecord.totalAssets += value;
                                else if (targetField === 'ap') monthRecord.ap += value;
                                else if (targetField === 'otherCL') monthRecord.otherCL += value;
                                else if (targetField === 'tcl') monthRecord.tcl += value;
                                else if (targetField === 'ltd') monthRecord.ltd += value;
                                else if (targetField === 'totalLiab') monthRecord.totalLiab += value;
                                else if (targetField === 'ownersCapital') monthRecord.ownersCapital += value;
                                else if (targetField === 'ownersDraw') monthRecord.ownersDraw += value;
                                else if (targetField === 'commonStock') monthRecord.commonStock += value;
                                else if (targetField === 'preferredStock') monthRecord.preferredStock += value;
                                else if (targetField === 'retainedEarnings') monthRecord.retainedEarnings += value;
                                else if (targetField === 'additionalPaidInCapital') monthRecord.additionalPaidInCapital += value;
                                else if (targetField === 'treasuryStock') monthRecord.treasuryStock += value;
                                else if (targetField === 'totalEquity') monthRecord.totalEquity += value;
                                else if (targetField === 'totalLAndE') monthRecord.totalLAndE += value;
                              });
                              
                              // Calculate totals
                              monthRecord.cogsTotal = monthRecord.cogsPayroll + monthRecord.cogsOwnerPay + 
                                                     monthRecord.cogsContractors + monthRecord.cogsMaterials + 
                                                     monthRecord.cogsCommissions + monthRecord.cogsOther;
                              monthRecord.expense = monthRecord.payroll + monthRecord.ownerBasePay + 
                                                   monthRecord.benefits + monthRecord.insurance + 
                                                   monthRecord.professionalFees + monthRecord.subcontractors + 
                                                   monthRecord.rent + monthRecord.taxLicense + 
                                                   monthRecord.phoneComm + monthRecord.infrastructure + 
                                                   monthRecord.autoTravel + monthRecord.salesExpense + 
                                                   monthRecord.marketing + monthRecord.trainingCert + 
                                                   monthRecord.mealsEntertainment + monthRecord.interestExpense + 
                                                   monthRecord.depreciationAmortization + monthRecord.otherExpense;
                              monthRecord.tca = monthRecord.cash + monthRecord.ar + monthRecord.inventory + monthRecord.otherCA;
                              monthRecord.totalAssets = monthRecord.tca + monthRecord.fixedAssets + monthRecord.otherAssets;
                              monthRecord.tcl = monthRecord.ap + monthRecord.otherCL;
                              monthRecord.totalLiab = monthRecord.tcl + monthRecord.ltd;
                              monthRecord.totalEquity = monthRecord.ownersCapital + monthRecord.ownersDraw + 
                                                       monthRecord.commonStock + monthRecord.preferredStock + 
                                                       monthRecord.retainedEarnings + monthRecord.additionalPaidInCapital + 
                                                       monthRecord.treasuryStock;
                              monthRecord.totalLAndE = monthRecord.totalLiab + monthRecord.totalEquity;
                              
                              // Get month date from column header
                              const columnHeader = monthColumns[i - 1]?.ColTitle || '';
                              let monthDate = new Date();
                              let parsedSuccessfully = false;
                              
                              // Try to parse month from column header (e.g., "Sep 30, 2022", "Oct 2022", "Sep-2025")
                              if (columnHeader) {
                                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                const fullMonthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                                
                                // Remove commas and split on spaces/dashes
                                const cleanHeader = columnHeader.replace(/,/g, '');
                                const parts = cleanHeader.split(/[-\s]+/);
                                
                                // Find month name (could be at any position)
                                let monthIndex = -1;
                                let monthPart = '';
                                for (const part of parts) {
                                  monthIndex = monthNames.indexOf(part);
                                  if (monthIndex === -1) {
                                    monthIndex = fullMonthNames.indexOf(part);
                                  }
                                  if (monthIndex >= 0) {
                                    monthPart = part;
                                    break;
                                  }
                                }
                                
                                // Find year (4-digit number)
                                let year = 0;
                                for (const part of parts) {
                                  const num = parseInt(part);
                                  if (!isNaN(num) && num >= 2000 && num <= 2100) {
                                    year = num;
                                    break;
                                  }
                                }
                                
                                if (monthIndex >= 0 && year > 0) {
                                  monthDate = new Date(year, monthIndex, 1);
                                  parsedSuccessfully = true;
                                }
                              }
                              
                              if (!parsedSuccessfully) {
                                console.warn(`Failed to parse date from column header: "${columnHeader}"`);
                              }
                              
                              monthRecord.monthDate = monthDate.toISOString();
                              monthlyData.push(monthRecord);
                              
                              // Log first few months for debugging
                              if (i <= 3) {
                                console.log(`Month ${i}: Column="${columnHeader}", Date=${monthDate.toISOString().substring(0, 7)}, Revenue=${monthRecord.revenue}`);
                              }
                            }
                            
                            console.log(`? Processed ${monthlyData.length} months of data`);
                            console.log('First month:', monthlyData[0]);
                            console.log('Last month:', monthlyData[monthlyData.length - 1]);
                            console.log('Date range:', monthlyData[0]?.monthDate?.substring(0, 7), 'to', monthlyData[monthlyData.length - 1]?.monthDate?.substring(0, 7));
                            
                            // DEBUG: Final summary of test account
                            if (testAccountName) {
                              const testMapping = aiMappings.find(m => m.qbAccount === testAccountName);
                              const targetField = testMapping?.targetField;
                              console.log(`\nðŸ”¬ FINAL SUMMARY - TEST ACCOUNT "${testAccountName}":`);
                              console.log(`Mapped to field: ${targetField}`);
                              console.log('Values across all months:');
                              monthlyData.forEach((month, idx) => {
                                if (targetField && month[targetField]) {
                                  console.log(`  Month ${idx + 1}: ${month[targetField]}`);
                                }
                              });
                            }
                            
                            // Check if we have less than expected months
                            if (monthlyData.length < 12) {
                              console.warn(`?? WARNING: Only ${monthlyData.length} months of data found. Expected at least 12 months for proper reporting.`);
                              if (monthlyData.length === 1) {
                                alert(`?? Only 1 month of data was processed!\n\nQuickBooks may have returned a single-column report instead of monthly breakdown.\n\nThe reports need at least 12 months of data to function properly.\n\nTip: Check the QuickBooks sync settings or try re-syncing.`);
                              } else {
                                alert(`?? Only ${monthlyData.length} months of data processed.\n\nReports work best with at least 12 months of data.`);
                              }
                            }

                            // Calculate total expenses for QuickBooks data (same as CSV processing)
                            monthlyData.forEach(monthRecord => {
                              monthRecord.expense = monthRecord.payroll + monthRecord.ownerBasePay +
                                                   monthRecord.benefits + monthRecord.insurance +
                                                   monthRecord.professionalFees + monthRecord.subcontractors +
                                                   monthRecord.rent + monthRecord.taxLicense +
                                                   monthRecord.phoneComm + monthRecord.infrastructure +
                                                   monthRecord.autoTravel + monthRecord.salesExpense +
                                                   monthRecord.marketing + monthRecord.trainingCert +
                                                   monthRecord.mealsEntertainment + monthRecord.interestExpense +
                                                   monthRecord.depreciationAmortization + monthRecord.otherExpense;
                            });

                            // Save to database
                            if (!currentUser) {
                              throw new Error('User not logged in');
                            }
                            
                            const saveResponse = await fetch('/api/financials', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                companyId: selectedCompanyId,
                                uploadedByUserId: currentUser.id,
                                fileName: 'QuickBooks Sync Data',
                                rawData: qbRawData,
                                columnMapping: { source: 'quickbooks', mappings: aiMappings },
                                monthlyData
                              })
                            });
                            
                            if (!saveResponse.ok) {
                              throw new Error('Failed to save monthly data');
                            }
                            
                            // Convert and load the monthly data into state so Data Review tab shows it immediately
                            const convertedMonthly = monthlyData.map((m: any) => ({
                              date: new Date(m.monthDate),
                              month: new Date(m.monthDate).toLocaleDateString('en-US', { month: '2-digit', year: 'numeric' }),
                              revenue: m.revenue || 0,
                              expense: m.expense || 0,
                              cogsPayroll: m.cogsPayroll || 0,
                              cogsOwnerPay: m.cogsOwnerPay || 0,
                              cogsContractors: m.cogsContractors || 0,
                              cogsMaterials: m.cogsMaterials || 0,
                              cogsCommissions: m.cogsCommissions || 0,
                              cogsOther: m.cogsOther || 0,
                              cogsTotal: m.cogsTotal || 0,
                              payroll: m.payroll || 0,
                              ownerBasePay: m.ownerBasePay || 0,
                              benefits: m.benefits || 0,
                              insurance: m.insurance || 0,
                              professionalFees: m.professionalFees || 0,
                              subcontractors: m.subcontractors || 0,
                              rent: m.rent || 0,
                              taxLicense: m.taxLicense || 0,
                              phoneComm: m.phoneComm || 0,
                              infrastructure: m.infrastructure || 0,
                              autoTravel: m.autoTravel || 0,
                              salesExpense: m.salesExpense || 0,
                              marketing: m.marketing || 0,
                              trainingCert: m.trainingCert || 0,
                              mealsEntertainment: m.mealsEntertainment || 0,
                              interestExpense: m.interestExpense || 0,
                              depreciationAmortization: m.depreciationAmortization || 0,
                              otherExpense: m.otherExpense || 0,
                              nonOperatingIncome: m.nonOperatingIncome || 0,
                              extraordinaryItems: m.extraordinaryItems || 0,
                              cash: m.cash || 0,
                              ar: m.ar || 0,
                              inventory: m.inventory || 0,
                              otherCA: m.otherCA || 0,
                              tca: m.tca || 0,
                              fixedAssets: m.fixedAssets || 0,
                              otherAssets: m.otherAssets || 0,
                              totalAssets: m.totalAssets || 0,
                              ap: m.ap || 0,
                              otherCL: m.otherCL || 0,
                              tcl: m.tcl || 0,
                              ltd: m.ltd || 0,
                              totalLiab: m.totalLiab || 0,
                              ownersCapital: m.ownersCapital || 0,
                              ownersDraw: m.ownersDraw || 0,
                              commonStock: m.commonStock || 0,
                              preferredStock: m.preferredStock || 0,
                              retainedEarnings: m.retainedEarnings || 0,
                              additionalPaidInCapital: m.additionalPaidInCapital || 0,
                              treasuryStock: m.treasuryStock || 0,
                              totalEquity: m.totalEquity || 0,
                              totalLAndE: m.totalLAndE || 0
                            }));
                            setLoadedMonthlyData(convertedMonthly);
                            console.log('? Updated loadedMonthlyData state with', convertedMonthly.length, 'months');
                            
                            alert(`? Successfully processed and saved ${monthlyData.length} months of financial data!`);
                          } catch (error: any) {
                            console.error('Error processing monthly data:', error);
                            alert('Failed to process monthly data: ' + error.message);
                          } finally {
                            setIsProcessingMonthlyData(false);
                          }
                        }}
                        disabled={isProcessingMonthlyData || aiMappings.length === 0}
                        style={{
                          padding: '10px 24px',
                          background: isProcessingMonthlyData || aiMappings.length === 0 ? '#94a3b8' : '#3b82f6',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '13px',
                          fontWeight: '600',
                          cursor: isProcessingMonthlyData || aiMappings.length === 0 ? 'not-allowed' : 'pointer',
                          boxShadow: '0 2px 6px rgba(59, 130, 246, 0.3)'
                        }}
                      >
                        {isProcessingMonthlyData ? 'Processing...' : 'âš™ï¸ Process & Save Monthly Data'}
                      </button>
                          <button
                            onClick={async () => {
                              try {
                                // Fetch the saved monthly data from the API
                                const response = await fetch(`/api/financials?companyId=${selectedCompanyId}`);
                                if (!response.ok) {
                                  throw new Error('Failed to load financial data');
                                }
                                
                                const data = await response.json();
                                const monthlyData = data.records?.[0]?.monthlyData || [];
                                
                                if (!monthlyData || monthlyData.length === 0) {
                                  alert('No financial data found. Please process the monthly data first.');
                                  return;
                                }
                                
                                // Convert to CSV
                                const headers = Object.keys(monthlyData[0]).filter(key => key !== 'id' && key !== 'companyId' && key !== 'createdAt' && key !== 'updatedAt');
                                const csvContent = [
                                  headers.join(','),
                                  ...monthlyData.map((row: any) => 
                                    headers.map(header => {
                                      const value = row[header];
                                      // Format dates nicely
                                      if (header === 'monthDate' && value) {
                                        return new Date(value).toISOString().substring(0, 7); // YYYY-MM format
                                      }
                                      // Handle numbers
                                      if (typeof value === 'number') {
                                        return value;
                                      }
                                      // Escape commas in strings
                                      if (typeof value === 'string' && value.includes(',')) {
                                        return `"${value}"`;
                                      }
                                      return value || 0;
                                    }).join(',')
                                  )
                                ].join('\n');
                                
                                // Create download link
                                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                const link = document.createElement('a');
                                const url = URL.createObjectURL(blob);
                                const companyName = (Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined)?.name || 'Company';
                                const fileName = `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_Financial_Data_${new Date().toISOString().substring(0, 10)}.csv`;
                                
                                link.setAttribute('href', url);
                                link.setAttribute('download', fileName);
                                link.style.visibility = 'hidden';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                              } catch (error: any) {
                                console.error('Error downloading data:', error);
                                alert('Failed to download data: ' + error.message);
                              }
                            }}
                            style={{
                              padding: '10px 24px',
                              background: '#10b981',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              boxShadow: '0 2px 6px rgba(16, 185, 129, 0.3)'
                            }}
                          >
                            ?? Download Mapped Data (CSV)
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      })()}

      {/* QB-SPECIFIC SECTION REMOVED - Now using unified monthly array approach */}

      {/* Financial Statements View - P&L and Balance Sheet ONLY - DISABLED */}
      {false && currentView === 'financial-statements' && selectedCompanyId && qbRawData && (() => {
        // CRITICAL SECURITY CHECK: Ensure qbRawData matches the selected company
        if (!qbRawData._companyId || qbRawData._companyId !== selectedCompanyId) {
          console.error(`ðŸš¨ SECURITY BLOCK: Data mismatch! Selected: ${selectedCompanyId}, Data companyId: ${qbRawData._companyId || 'MISSING'}`);
          return <div style={{ padding: '48px', textAlign: 'center' }}>
            <div style={{ fontSize: '18px', color: '#ef4444', marginBottom: '12px' }}>â³ Loading company data...</div>
            <div style={{ fontSize: '14px', color: '#64748b' }}>Please wait while we fetch the correct financial data.</div>
          </div>;
        }
        
        const currentCompany = Array.isArray(companies) ? companies.find(c => c.id === selectedCompanyId) : undefined;
        const currentCompanyName = currentCompany?.name || 'Unknown';
        console.log(`ðŸ“Š ========================================`);
        console.log(`ðŸ“Š FINANCIAL STATEMENTS RENDERING (Refresh Key: ${dataRefreshKey})`);
        console.log(`ðŸ“Š Selected Company: "${currentCompanyName}" (ID: ${selectedCompanyId})`);
        console.log(`ðŸ“Š QB Data sync date:`, qbRawData.syncDate);
        console.log(`ðŸ“Š Data belongs to company:`, qbRawData._companyId);
        console.log(`ðŸ“Š Record ID:`, qbRawData._recordId);
        console.log(`ðŸ“Š ========================================`);

        // Helper function to recursively extract all rows from QB report
        const extractRows = (data: any, level: number = 0, parentSection: string = ''): any[] => {
          const result: any[] = [];
          if (!data?.Rows?.Row) return result;
          const rows = Array.isArray(data.Rows.Row) ? data.Rows.Row : [data.Rows.Row];
          
          for (const row of rows) {
            if (row.type === 'Section') {
              const headerName = row.Header?.ColData?.[0]?.value || '';
              result.push({
                type: 'header',
                name: headerName,
                level,
                isHeader: true,
                section: headerName
              });
              if (row.Rows?.Row) {
                const childRows = Array.isArray(row.Rows.Row) ? row.Rows.Row : [row.Rows.Row];
                result.push(...extractRows({ Rows: { Row: childRows } }, level + 1, headerName));
              }
              if (row.Summary?.ColData) {
                const summaryName = row.Summary.ColData[0]?.value || `Total ${headerName}`;
                const value = row.Summary.ColData[row.Summary.ColData.length - 1]?.value;
                let calculatedTotal = 0;
                const dataRows = result.filter(r => r.section === headerName && r.type === 'data');
                if (dataRows.length > 0) {
                  calculatedTotal = dataRows.reduce((sum, r) => sum + (parseFloat(r.value) || 0), 0);
                } else {
                  calculatedTotal = parseFloat(value) || 0;
                }
                if (summaryName && !isNaN(calculatedTotal)) {
                  result.push({
                    type: 'total',
                    name: summaryName,
                    value: calculatedTotal,
                    level,
                    isTotal: true
                  });
                }
              }
            } else if (row.type === 'Data' && row.ColData) {
              const name = row.ColData[0]?.value || '';
              let value = '0';
              for (let i = row.ColData.length - 1; i >= 1; i--) {
                const colValue = row.ColData[i]?.value;
                if (colValue !== undefined && colValue !== '' && !isNaN(parseFloat(colValue))) {
                  value = colValue;
                  break;
                }
              }
              result.push({
                type: 'data',
                name,
                value: parseFloat(value) || 0,
                level,
                section: parentSection,
                colData: row.ColData
              });
            }
          }
          return result;
        };

        const plRows = qbRawData.profitAndLoss?.Rows?.Row ? extractRows(qbRawData.profitAndLoss) : [];
        const bsRows = qbRawData.balanceSheet?.Rows?.Row ? extractRows(qbRawData.balanceSheet) : [];
        
        return (
          <div key={`financial-statements-${selectedCompanyId}-${dataRefreshKey}`} style={{ maxWidth: '1800px', margin: '0 auto', padding: '32px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Financial Statements</h1>
              {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
            </div>
            <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '12px' }}>
              QuickBooks Data - Synced: {qbRawData.syncDate ? new Date(qbRawData.syncDate).toLocaleString() : 'Unknown'}
            </p>

            {/* Tab Navigation */}
            <div style={{ display: 'flex', gap: '8px', marginBottom: '12px', borderBottom: '2px solid #e2e8f0' }}>
              <button
                onClick={() => setFinancialStatementsTab('aggregated')}
                style={{
                  padding: '12px 24px',
                  background: financialStatementsTab === 'aggregated' ? '#667eea' : 'transparent',
                  color: financialStatementsTab === 'aggregated' ? 'white' : '#64748b',
                  border: 'none',
                  borderBottom: financialStatementsTab === 'aggregated' ? '3px solid #667eea' : '3px solid transparent',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  borderRadius: '8px 8px 0 0',
                  transition: 'all 0.2s'
                }}
              >
                Aggregated Financials
              </button>
              <button
                onClick={() => setFinancialStatementsTab('line-of-business')}
                style={{
                  padding: '12px 24px',
                  background: financialStatementsTab === 'line-of-business' ? '#667eea' : 'transparent',
                  color: financialStatementsTab === 'line-of-business' ? 'white' : '#64748b',
                  border: 'none',
                  borderBottom: financialStatementsTab === 'line-of-business' ? '3px solid #667eea' : '3px solid transparent',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  borderRadius: '8px 8px 0 0',
                  transition: 'all 0.2s'
                }}
              >
                Line of Business Reporting
              </button>
            </div>

            {/* Aggregated Financials Tab */}
            {financialStatementsTab === 'aggregated' && (
            <>
            {/* Statement Controls */}
            <div style={{ marginBottom: '32px', padding: '24px', background: 'white', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px' }}>
                {/* Type of Statement */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                    Type of Statement
                  </label>
                  <select 
                    value={statementType}
                    onChange={(e) => setStatementType(e.target.value as 'income-statement' | 'balance-sheet')}
                    style={{ 
                      width: '100%', 
                      padding: '10px 12px', 
                      border: '1px solid #cbd5e1', 
                      borderRadius: '6px', 
                      fontSize: '14px',
                      color: '#1e293b',
                      background: 'white',
                      cursor: 'pointer'
                    }}
                  >
                    <option value="income-statement">Income Statement</option>
                    <option value="balance-sheet">Balance Sheet</option>
                  </select>
                </div>

                {/* Period */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                    Period
                  </label>
                  <select 
                    value={statementPeriod}
                    onChange={(e) => setStatementPeriod(e.target.value as any)}
                    style={{ 
                      width: '100%', 
                      padding: '10px 12px', 
                      border: '1px solid #cbd5e1', 
                      borderRadius: '6px', 
                      fontSize: '14px',
                      color: '#1e293b',
                      background: 'white',
                      cursor: 'pointer'
                    }}
                  >
                    <option value="current-month">Current Month</option>
                    <option value="current-quarter">Current Quarter</option>
                    <option value="last-12-months">Last 12 months</option>
                    <option value="ytd">YTD</option>
                    <option value="last-year">Last Year</option>
                    <option value="last-3-years">Last 3 Years</option>
                  </select>
                </div>

                {/* Display As */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                    Display As
                  </label>
                  <select 
                    value={statementDisplay}
                    onChange={(e) => setStatementDisplay(e.target.value as 'monthly' | 'quarterly' | 'annual')}
                    style={{ 
                      width: '100%', 
                      padding: '10px 12px', 
                      border: '1px solid #cbd5e1', 
                      borderRadius: '6px', 
                      fontSize: '14px',
                      color: '#1e293b',
                      background: 'white',
                      cursor: 'pointer'
                    }}
                  >
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="annual">Annual</option>
                  </select>
                </div>
              </div>
            </div>

            {/* Statement Content Area */}
            <AggregatedFinancialsTab
              selectedCompanyId={selectedCompanyId}
              statementType={statementType}
              statementPeriod={statementPeriod}
              statementDisplay={statementDisplay}
            />
            </>
          )}

          {!selectedCompanyId && adminDashboardTab === 'import-financials' && (
                const cogsPayroll = currentMonth.cogsPayroll || 0;
                const cogsOwnerPay = currentMonth.cogsOwnerPay || 0;
                const cogsContractors = currentMonth.cogsContractors || 0;
                const cogsMaterials = currentMonth.cogsMaterials || 0;
                const cogsCommissions = currentMonth.cogsCommissions || 0;
                const cogsOther = currentMonth.cogsOther || 0;
                const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;

                const grossProfit = revenue - cogs;
                const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

                // Operating Expenses - All fields that have data from DataReviewTab
                const payroll = currentMonth.payroll || 0;
                const benefits = currentMonth.benefits || 0;
                const insurance = currentMonth.insurance || 0;
                const professionalFees = currentMonth.professionalFees || 0;
                const subcontractors = currentMonth.subcontractors || 0;
                const rent = currentMonth.rent || 0;
                const taxLicense = currentMonth.taxLicense || 0;
                const phoneComm = currentMonth.phoneComm || 0;
                const infrastructure = currentMonth.infrastructure || 0;
                const autoTravel = currentMonth.autoTravel || 0;
                const salesExpense = currentMonth.salesExpense || 0;
                const marketing = currentMonth.marketing || 0;
                const mealsEntertainment = currentMonth.mealsEntertainment || 0;
                const otherExpense = currentMonth.otherExpense || 0;

                // Calculate total operating expenses including all expense fields from DataReviewTab
                const totalOpex = payroll + benefits + insurance + professionalFees + subcontractors +
                                 rent + taxLicense + phoneComm + infrastructure + autoTravel +
                                 salesExpense + marketing + mealsEntertainment + otherExpense;

                const operatingIncome = grossProfit - totalOpex;
                const operatingMargin = revenue > 0 ? (operatingIncome / revenue) * 100 : 0;
                
                // Other Income/Expense
                const interestExpense = currentMonth.interestExpense || 0;
                const nonOperatingIncome = currentMonth.nonOperatingIncome || 0;
                const extraordinaryItems = currentMonth.extraordinaryItems || 0;
                
                const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                const netMargin = revenue > 0 ? (netIncome / revenue) * 100 : 0;
                
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                      <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Income Statement</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>For the Month Ended {monthName}</div>
                      </div>

                      {/* Revenue Section */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e2e8f0' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Revenue</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* COGS Section */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Cost of Goods Sold</div>
                        {cogsPayroll > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Payroll</span>
                            <span style={{ color: '#475569' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsOwnerPay > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Owner Pay</span>
                            <span style={{ color: '#475569' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsContractors > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Contractors</span>
                            <span style={{ color: '#475569' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsMaterials > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Materials</span>
                            <span style={{ color: '#475569' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsCommissions > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Commissions</span>
                            <span style={{ color: '#475569' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsOther > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Other</span>
                            <span style={{ color: '#475569' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Total COGS</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Gross Profit */}
                      <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', color: '#1e40af' }}>Gross Profit</span>
                          <span style={{ fontWeight: '700', color: '#1e40af' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                        <div style={{ fontSize: '13px', color: '#1e40af', textAlign: 'right' }}>
                          {grossMargin.toFixed(1)}% margin
                        </div>
                      </div>

                      {/* Operating Expenses */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Operating Expenses</div>
                        {payroll > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Payroll</span>
                            <span style={{ color: '#475569' }}>${payroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {benefits > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Benefits</span>
                            <span style={{ color: '#475569' }}>${benefits.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {insurance > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Insurance</span>
                            <span style={{ color: '#475569' }}>${insurance.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {professionalFees > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Professional Services</span>
                            <span style={{ color: '#475569' }}>${professionalFees.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {subcontractors > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Subcontractors</span>
                            <span style={{ color: '#475569' }}>${subcontractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {rent > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Rent/Lease</span>
                            <span style={{ color: '#475569' }}>${rent.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {taxLicense > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Tax & License</span>
                            <span style={{ color: '#475569' }}>${taxLicense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {phoneComm > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Phone & Communication</span>
                            <span style={{ color: '#475569' }}>${phoneComm.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {infrastructure > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Infrastructure/Utilities</span>
                            <span style={{ color: '#475569' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {autoTravel > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Auto & Travel</span>
                            <span style={{ color: '#475569' }}>${autoTravel.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {salesExpense > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Sales & Marketing</span>
                            <span style={{ color: '#475569' }}>${salesExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {marketing > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Marketing</span>
                            <span style={{ color: '#475569' }}>${marketing.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {mealsEntertainment > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Meals & Entertainment</span>
                            <span style={{ color: '#475569' }}>${mealsEntertainment.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {otherExpense > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Other Expenses</span>
                            <span style={{ color: '#475569' }}>${otherExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Operating Expenses</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Operating Income */}
                      <div style={{ marginBottom: '12px', background: '#f0fdf4', padding: '12px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', color: '#166534' }}>Operating Income</span>
                          <span style={{ fontWeight: '700', color: '#166534' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                        <div style={{ fontSize: '13px', color: '#166534', textAlign: 'right' }}>
                          {operatingMargin.toFixed(1)}% margin
                        </div>
                      </div>

                      {/* Other Income/Expense */}
                      {(interestExpense > 0 || nonOperatingIncome > 0 || extraordinaryItems !== 0) && (
                        <div style={{ marginBottom: '12px' }}>
                          <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Other Income/(Expense)</div>
                          {nonOperatingIncome > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Non-Operating Income</span>
                              <span style={{ color: '#10b981' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {interestExpense > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Interest Expense</span>
                              <span style={{ color: '#ef4444' }}>($  {interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                            </div>
                          )}
                          {extraordinaryItems !== 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Extraordinary Items</span>
                              <span style={{ color: extraordinaryItems >= 0 ? '#10b981' : '#ef4444' }}>
                                {extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}
                              </span>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Net Income */}
                      <div style={{ background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>Net Income</span>
                          <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>
                            ${netIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                          </span>
                        </div>
                        <div style={{ fontSize: '14px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                          {netMargin.toFixed(1)}% net margin
                        </div>
                      </div>
                  </div>
                );
              } else if (statementType === 'income-statement-percent' && statementPeriod === 'current-month') {
                const currentMonth = monthly[monthly.length - 1];
                const monthDate = new Date(currentMonth.date || currentMonth.month);
                const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Revenue
                const revenue = currentMonth.revenue || 0;

                // Cost of Goods Sold
                const cogsPayroll = currentMonth.cogsPayroll || 0;
                const cogsOwnerPay = currentMonth.cogsOwnerPay || 0;
                const cogsContractors = currentMonth.cogsContractors || 0;
                const cogsMaterials = currentMonth.cogsMaterials || 0;
                const cogsCommissions = currentMonth.cogsCommissions || 0;
                const cogsOther = currentMonth.cogsOther || 0;
                const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;

                const grossProfit = revenue - cogs;
                const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

                // Operating Expenses - All fields that have data from DataReviewTab
                const payroll = currentMonth.payroll || 0;
                const benefits = currentMonth.benefits || 0;
                const insurance = currentMonth.insurance || 0;
                const professionalFees = currentMonth.professionalFees || 0;
                const subcontractors = currentMonth.subcontractors || 0;
                const rent = currentMonth.rent || 0;
                const taxLicense = currentMonth.taxLicense || 0;
                const phoneComm = currentMonth.phoneComm || 0;
                const infrastructure = currentMonth.infrastructure || 0;
                const autoTravel = currentMonth.autoTravel || 0;
                const salesExpense = currentMonth.salesExpense || 0;
                const marketing = currentMonth.marketing || 0;
                const mealsEntertainment = currentMonth.mealsEntertainment || 0;
                const otherExpense = currentMonth.otherExpense || 0;

                // Calculate total operating expenses including all expense fields from DataReviewTab
                const totalOpex = payroll + benefits + insurance + professionalFees + subcontractors +
                                 rent + taxLicense + phoneComm + infrastructure + autoTravel +
                                 salesExpense + marketing + mealsEntertainment + otherExpense;

                const operatingIncome = grossProfit - totalOpex;
                const operatingMargin = revenue > 0 ? (operatingIncome / revenue) * 100 : 0;
                
                // Other Income/Expense
                const interestExpense = currentMonth.interestExpense || 0;
                const nonOperatingIncome = currentMonth.nonOperatingIncome || 0;
                const extraordinaryItems = currentMonth.extraordinaryItems || 0;
                
                const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                const netMargin = revenue > 0 ? (netIncome / revenue) * 100 : 0;
                
                // Helper function to calculate percentage
                const pct = (amount: number) => revenue > 0 ? (amount / revenue) * 100 : 0;
                
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                    <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                      <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Income Statement - Common Size Analysis</h2>
                      <div style={{ fontSize: '14px', color: '#64748b' }}>For the Month Ended {monthName} - All items shown as % of Revenue</div>
                    </div>

                    {/* Column Headers */}
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderBottom: '2px solid #cbd5e1', marginBottom: '12px', fontWeight: '600', fontSize: '13px', color: '#475569' }}>
                      <div>Line Item</div>
                      <div style={{ textAlign: 'right' }}>Amount</div>
                      <div style={{ textAlign: 'right' }}>% of Revenue</div>
                    </div>

                    {/* Revenue Section */}
                    <div style={{ marginBottom: '12px' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderBottom: '1px solid #e2e8f0', background: '#f8fafc' }}>
                        <span style={{ fontWeight: '600', color: '#1e293b' }}>Revenue</span>
                        <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>100.0%</span>
                      </div>
                    </div>

                    {/* COGS Section */}
                    <div style={{ marginBottom: '12px' }}>
                      <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Cost of Goods Sold</div>
                      {cogsPayroll > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Payroll</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsPayroll).toFixed(1)}%</span>
                        </div>
                      )}
                      {cogsOwnerPay > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Owner Pay</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsOwnerPay).toFixed(1)}%</span>
                        </div>
                      )}
                      {cogsContractors > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Contractors</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsContractors).toFixed(1)}%</span>
                        </div>
                      )}
                      {cogsMaterials > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Materials</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsMaterials).toFixed(1)}%</span>
                        </div>
                      )}
                      {cogsCommissions > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Commissions</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsCommissions).toFixed(1)}%</span>
                        </div>
                      )}
                      {cogsOther > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Other</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsOther).toFixed(1)}%</span>
                        </div>
                      )}
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                        <span style={{ fontWeight: '600', color: '#1e293b', paddingLeft: '20px' }}>Total COGS</span>
                        <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>{pct(cogs).toFixed(1)}%</span>
                      </div>
                    </div>

                    {/* Gross Profit */}
                    <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr' }}>
                        <span style={{ fontWeight: '700', color: '#1e40af' }}>Gross Profit</span>
                        <span style={{ fontWeight: '700', color: '#1e40af', textAlign: 'right' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ fontWeight: '700', color: '#1e40af', textAlign: 'right' }}>{grossMargin.toFixed(1)}%</span>
                      </div>
                    </div>

                    {/* Operating Expenses */}
                    <div style={{ marginBottom: '12px' }}>
                      <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Operating Expenses</div>
                      {payroll > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Payroll</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${payroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(payroll).toFixed(1)}%</span>
                        </div>
                      )}
                      {benefits > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Benefits</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${benefits.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(benefits).toFixed(1)}%</span>
                        </div>
                      )}
                      {insurance > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Insurance</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${insurance.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(insurance).toFixed(1)}%</span>
                        </div>
                      )}
                      {professionalFees > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Professional Services</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${professionalFees.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(professionalFees).toFixed(1)}%</span>
                        </div>
                      )}
                      {subcontractors > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Subcontractors</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${subcontractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(subcontractors).toFixed(1)}%</span>
                        </div>
                      )}
                      {rent > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Rent/Lease</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${rent.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(rent).toFixed(1)}%</span>
                        </div>
                      )}
                      {taxLicense > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Tax & License</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${taxLicense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(taxLicense).toFixed(1)}%</span>
                        </div>
                      )}
                      {phoneComm > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Phone & Communication</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${phoneComm.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(phoneComm).toFixed(1)}%</span>
                        </div>
                      )}
                      {infrastructure > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Infrastructure/Utilities</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(infrastructure).toFixed(1)}%</span>
                        </div>
                      )}
                      {autoTravel > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Auto & Travel</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${autoTravel.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(autoTravel).toFixed(1)}%</span>
                        </div>
                      )}
                      {salesExpense > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Sales & Marketing</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${salesExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(salesExpense).toFixed(1)}%</span>
                        </div>
                      )}
                      {marketing > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Marketing</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${marketing.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(marketing).toFixed(1)}%</span>
                        </div>
                      )}
                      {mealsEntertainment > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Meals & Entertainment</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${mealsEntertainment.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(mealsEntertainment).toFixed(1)}%</span>
                        </div>
                      )}
                      {otherExpense > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Other Expenses</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>${otherExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#475569', textAlign: 'right' }}>{pct(otherExpense).toFixed(1)}%</span>
                        </div>
                      )}
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                        <span style={{ fontWeight: '600', color: '#1e293b', paddingLeft: '20px' }}>Total Operating Expenses</span>
                        <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>{pct(totalOpex).toFixed(1)}%</span>
                      </div>
                    </div>

                    {/* Operating Income */}
                    <div style={{ marginBottom: '12px', background: '#f0fdf4', padding: '12px', borderRadius: '8px' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr' }}>
                        <span style={{ fontWeight: '700', color: '#166534' }}>Operating Income</span>
                        <span style={{ fontWeight: '700', color: '#166534', textAlign: 'right' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ fontWeight: '700', color: '#166534', textAlign: 'right' }}>{operatingMargin.toFixed(1)}%</span>
                      </div>
                    </div>

                    {/* Other Income/Expense */}
                    {(interestExpense > 0 || nonOperatingIncome > 0 || extraordinaryItems !== 0) && (
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Other Income/(Expense)</div>
                        {nonOperatingIncome > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                            <span style={{ color: '#475569', paddingLeft: '20px' }}>Non-Operating Income</span>
                            <span style={{ color: '#10b981', textAlign: 'right' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            <span style={{ color: '#10b981', textAlign: 'right' }}>{pct(nonOperatingIncome).toFixed(1)}%</span>
                          </div>
                        )}
                        {interestExpense > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                            <span style={{ color: '#475569', paddingLeft: '20px' }}>Interest Expense</span>
                            <span style={{ color: '#ef4444', textAlign: 'right' }}>($  {interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                            <span style={{ color: '#ef4444', textAlign: 'right' }}>({pct(interestExpense).toFixed(1)}%)</span>
                          </div>
                        )}
                        {extraordinaryItems !== 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                            <span style={{ color: '#475569', paddingLeft: '20px' }}>Extraordinary Items</span>
                            <span style={{ color: extraordinaryItems >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                              {extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}
                            </span>
                            <span style={{ color: extraordinaryItems >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                              {extraordinaryItems >= 0 ? '' : '('}{pct(Math.abs(extraordinaryItems)).toFixed(1)}%{extraordinaryItems < 0 ? ')' : ''}
                            </span>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Net Income */}
                    <div style={{ background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr' }}>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>Net Income</span>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                          ${netIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                        </span>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                          {netMargin.toFixed(1)}%
                        </span>
                      </div>
                    </div>
                  </div>
                );
              } else if (statementType === 'balance-sheet' && statementPeriod === 'current-month') {
                const currentMonth = monthly[monthly.length - 1];
                const monthDate = new Date(currentMonth.date || currentMonth.month);
                const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Assets - Use imported values directly (do not calculate)
                const cash = currentMonth.cash || 0;
                const ar = currentMonth.ar || 0;
                const inventory = currentMonth.inventory || 0;
                const otherCA = currentMonth.otherCA || 0;
                const tca = currentMonth.tca || 0;
                
                const fixedAssets = currentMonth.fixedAssets || 0;
                const otherAssets = currentMonth.otherAssets || 0;
                const totalAssets = currentMonth.totalAssets || 0;
                
                // Liabilities - Use imported values directly (do not calculate)
                const ap = currentMonth.ap || 0;
                const otherCL = currentMonth.otherCL || 0;
                const tcl = currentMonth.tcl || 0;
                
                const ltd = currentMonth.ltd || 0;
                const totalLiabilities = currentMonth.totalLiab || 0;
                
                // Equity - Get detail fields
                const ownersCapital = currentMonth.ownersCapital || 0;
                const ownersDraw = currentMonth.ownersDraw || 0;
                const commonStock = currentMonth.commonStock || 0;
                const preferredStock = currentMonth.preferredStock || 0;
                const retainedEarnings = currentMonth.retainedEarnings || 0;
                const additionalPaidInCapital = currentMonth.additionalPaidInCapital || 0;
                const treasuryStock = currentMonth.treasuryStock || 0;
                
                // Calculate total equity from components or use imported value
                const totalEquity = currentMonth.totalEquity || (ownersCapital + ownersDraw + commonStock + preferredStock + retainedEarnings + additionalPaidInCapital + treasuryStock);
                
                // Total L&E - Use imported value if available, otherwise calculate
                const totalLAndE = currentMonth.totalLAndE || (totalLiabilities + totalEquity);
                
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                    <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                      <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Balance Sheet</h2>
                      <div style={{ fontSize: '14px', color: '#64748b' }}>As of {monthName}</div>
                    </div>

                    {/* ASSETS */}
                    <div style={{ marginBottom: '32px' }}>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #667eea' }}>ASSETS</div>
                      
                      {/* Current Assets */}
                      <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Current Assets</div>
                        {cash !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Cash</span>
                            <span style={{ color: '#475569' }}>${cash.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {ar !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Accounts Receivable</span>
                            <span style={{ color: '#475569' }}>${ar.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {inventory !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Inventory</span>
                            <span style={{ color: '#475569' }}>${inventory.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {otherCA !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Other Current Assets</span>
                            <span style={{ color: '#475569' }}>${otherCA.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 20px', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Current Assets</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${tca.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Non-Current Assets */}
                      {fixedAssets !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Fixed Assets</span>
                          <span style={{ color: '#475569' }}>${fixedAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {otherAssets !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Other Assets</span>
                          <span style={{ color: '#475569' }}>${otherAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #667eea', marginTop: '8px', background: '#f8fafc' }}>
                        <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>TOTAL ASSETS</span>
                        <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>${totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    </div>

                    {/* LIABILITIES */}
                    <div style={{ marginBottom: '32px' }}>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #f59e0b' }}>LIABILITIES</div>
                      
                      {/* Current Liabilities */}
                      <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Current Liabilities</div>
                        {ap !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Accounts Payable</span>
                            <span style={{ color: '#475569' }}>${ap.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {otherCL !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Other Current Liabilities</span>
                            <span style={{ color: '#475569' }}>${otherCL.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 20px', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Current Liabilities</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${tcl.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Long-term Debt */}
                      {ltd !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Long-term Debt</span>
                          <span style={{ color: '#475569' }}>${ltd.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #f59e0b', marginTop: '8px', background: '#fef3c7' }}>
                        <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>TOTAL LIABILITIES</span>
                        <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>${totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    </div>

                    {/* EQUITY */}
                    <div style={{ marginBottom: '12px' }}>
                      <div style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #10b981' }}>EQUITY</div>
                      
                      {/* Equity Detail Fields */}
                      {ownersCapital !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Owner's Capital</span>
                          <span style={{ color: '#475569' }}>${ownersCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {ownersDraw !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Owner's Draw</span>
                          <span style={{ color: '#475569' }}>${ownersDraw.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {commonStock !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Common Stock</span>
                          <span style={{ color: '#475569' }}>${commonStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {preferredStock !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Preferred Stock</span>
                          <span style={{ color: '#475569' }}>${preferredStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {retainedEarnings !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Retained Earnings</span>
                          <span style={{ color: '#475569' }}>${retainedEarnings.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {additionalPaidInCapital !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Additional Paid-In Capital</span>
                          <span style={{ color: '#475569' }}>${additionalPaidInCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {treasuryStock !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Treasury Stock</span>
                          <span style={{ color: '#475569' }}>${treasuryStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #10b981', marginTop: '4px', background: '#d1fae5' }}>
                        <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>TOTAL EQUITY</span>
                        <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>${totalEquity.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    </div>

                    {/* TOTAL LIABILITIES & EQUITY */}
                    <div style={{ background: '#f1f5f9', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>TOTAL LIABILITIES & EQUITY</span>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>
                          ${totalLAndE.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                        </span>
                      </div>
                      {Math.abs(totalAssets - totalLAndE) > 0.01 && (
                        <div style={{ fontSize: '12px', color: '#ef4444', marginTop: '8px', textAlign: 'right' }}>
                          ?? Balance check: Assets - (Liabilities + Equity) = ${(totalAssets - totalLAndE).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                        </div>
                      )}
                    </div>
                  </div>
                );
              }
              
              // Multi-period logic (Current Quarter, Last 12 Months, YTD, Last Year, Last 3 Years)
              else if (monthly.length > 0 && statementPeriod !== 'current-month') {
                // Helper function to get months for the selected period
                const getMonthsForPeriod = () => {
                  const now = new Date();
                  const currentYear = now.getFullYear();
                  const currentMonth = now.getMonth(); // 0-11
                  
                  switch (statementPeriod) {
                    case 'current-quarter':
                      // Last 3 months
                      return monthly.slice(-3);
                    
                    case 'last-12-months':
                      // Last 12 months
                      return monthly.slice(-12);
                    
                    case 'ytd':
                      // Year to date - from January of current year to now
                      return monthly.filter(m => {
                        const mDate = new Date(m.date || m.month);
                        return mDate.getFullYear() === currentYear;
                      });
                    
                    case 'last-year':
                      // Full previous year
                      return monthly.filter(m => {
                        const mDate = new Date(m.date || m.month);
                        return mDate.getFullYear() === currentYear - 1;
                      });
                    
                    case 'last-3-years':
                      // Last 36 months
                      return monthly.slice(-36);
                    
                    default:
                      return [];
                  }
                };
                
                const periodMonths = getMonthsForPeriod();
                
                if (periodMonths.length === 0) {
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '48px 32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', minHeight: '400px', textAlign: 'center' }}>
                      <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>
                        ðŸ“Š No Data Available
                      </div>
                      <p style={{ fontSize: '14px', color: '#94a3b8' }}>
                        No financial data available for the selected period.
                      </p>
                    </div>
                  );
                }
                
                // Get period label
                const getPeriodLabel = () => {
                  const firstMonth = periodMonths[0];
                  const lastMonth = periodMonths[periodMonths.length - 1];
                  const firstDate = new Date(firstMonth.date || firstMonth.month);
                  const lastDate = new Date(lastMonth.date || lastMonth.month);
                  
                  switch (statementPeriod) {
                    case 'current-quarter':
                      return `Current Quarter (${firstDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${lastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
                    case 'last-12-months':
                      return `Last 12 Months (${firstDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${lastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
                    case 'ytd':
                      return `Year to Date ${lastDate.getFullYear()} (Jan - ${lastDate.toLocaleDateString('en-US', { month: 'short' })})`;
                    case 'last-year':
                      return `Fiscal Year ${firstDate.getFullYear()}`;
                    case 'last-3-years':
                      return `Last 3 Years (${firstDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${lastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
                    default:
                      return '';
                  }
                };
                
              const periodLabel = getPeriodLabel();
              const latestMonth = periodMonths[periodMonths.length - 1];
              
              // Helper function to group months by display period
              const groupMonthsByDisplay = () => {
                if (statementDisplay === 'monthly') {
                  return periodMonths.map(m => {
                    const dateValue = m.date || m.month;
                    const dateObj = dateValue ? new Date(dateValue) : new Date();
                    const label = !isNaN(dateObj.getTime()) 
                      ? dateObj.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                      : 'Unknown';
                    return { label, months: [m] };
                  });
                } else if (statementDisplay === 'quarterly') {
                  const quarters: { [key: string]: any[] } = {};
                  periodMonths.forEach(m => {
                    const dateValue = m.date || m.month;
                    const date = dateValue ? new Date(dateValue) : new Date();
                    if (!isNaN(date.getTime())) {
                      const year = date.getFullYear();
                      const quarter = Math.floor(date.getMonth() / 3) + 1;
                      const key = `Q${quarter} ${year}`;
                      if (!quarters[key]) quarters[key] = [];
                      quarters[key].push(m);
                    }
                  });
                  return Object.entries(quarters).map(([key, months]) => ({
                    label: key,
                    months
                  }));
                } else {
                  const years: { [key: string]: any[] } = {};
                  periodMonths.forEach(m => {
                    const dateValue = m.date || m.month;
                    const date = dateValue ? new Date(dateValue) : new Date();
                    if (!isNaN(date.getTime())) {
                      const year = date.getFullYear().toString();
                      if (!years[year]) years[year] = [];
                      years[year].push(m);
                    }
                  });
                  return Object.entries(years).map(([year, months]) => ({
                    label: year,
                    months
                  }));
                }
              };
              
              const displayPeriods = groupMonthsByDisplay();

              // INCOME STATEMENT - Aggregate across period
              if (statementType === 'income-statement' || statementType === 'income-statement-percent') {
                // Check if showing multiple periods side-by-side
                if (displayPeriods.length > 1) {
                  const calc = (months: any[], field: string) => months.reduce((sum, m) => sum + (m[field] || 0), 0);
                  const periodsData = displayPeriods.map(p => {
                    const m = p.months;

                    // Calculate revenue and COGS
                    const revenue = calc(m, 'revenue');
                    const cogsPayroll = calc(m, 'cogsPayroll');
                    const cogsOwnerPay = calc(m, 'cogsOwnerPay');
                    const cogsContractors = calc(m, 'cogsContractors');
                    const cogsMaterials = calc(m, 'cogsMaterials');
                    const cogsCommissions = calc(m, 'cogsCommissions');
                    const cogsOther = calc(m, 'cogsOther');
                    const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                    const grossProfit = revenue - cogs;

                    // Dynamically calculate operating expense fields only
                    const expenseFields = [
                      'payroll', 'benefits', 'insurance', 'professionalFees', 'subcontractors',
                      'rent', 'taxLicense', 'phoneComm', 'infrastructure', 'autoTravel',
                      'salesExpense', 'marketing', 'mealsEntertainment', 'otherExpense'
                    ];

                    const expenses: { [key: string]: number } = {};
                    expenseFields.forEach(field => {
                      expenses[field] = calc(m, field);
                    });

                    // Calculate total operating expenses dynamically
                    const totalOpex = Object.values(expenses).reduce((sum, value) => sum + value, 0);

                    const operatingIncome = grossProfit - totalOpex;
                    const interestExpense = calc(m, 'interestExpense');
                    const nonOperatingIncome = calc(m, 'nonOperatingIncome');
                    const extraordinaryItems = calc(m, 'extraordinaryItems');
                    const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;

                    return {
                      label: p.label,
                      revenue, cogs, grossProfit,
                      ...expenses, // Include all expense fields dynamically
                      totalOpex, operatingIncome, interestExpense, nonOperatingIncome, extraordinaryItems, netIncome
                    };
                  });

                  // Helper function for percentage calculations
                  const isPercentMode = statementType === 'income-statement-percent';
                  const formatValue = (value: number, revenue: number) => {
                    if (isPercentMode) {
                      const pct = revenue > 0 ? (value / revenue) * 100 : 0;
                      return `${pct.toFixed(1)}%`;
                    }
                    return `$${value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                  };

                  const Row = ({ label, values, indent = 0, bold = false }: any) => (
                    <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: bold ? '14px' : '13px', fontWeight: bold ? '600' : 'normal' }}>
                      <div style={{ color: bold ? '#475569' : '#64748b', paddingLeft: `${indent}px` }}>{label}</div>
                      {values.map((v: number, i: number) => {
                        const revenue = periodsData[i].revenue;
                        return (
                          <div key={i} style={{ textAlign: 'right', color: bold ? '#475569' : '#64748b' }}>
                            {formatValue(v, revenue)}
                          </div>
                        );
                      })}
                    </div>
                  );
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', overflowX: 'auto' }}>
                      <div style={{ marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>
                          {isPercentMode ? 'Comparative Income Statement - Common Size Analysis' : 'Comparative Income Statement'}
                        </h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>
                          {periodLabel} - {statementDisplay === 'monthly' ? 'Monthly' : statementDisplay === 'quarterly' ? 'Quarterly' : 'Annual'}
                          {isPercentMode ? ' - All items shown as % of Revenue' : ''}
                        </div>
                      </div>
                      <div style={{ minWidth: `${200 + (periodsData.length * 110)}px` }}>
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 0', borderBottom: '2px solid #1e293b', fontWeight: '600', color: '#1e293b', fontSize: '13px' }}>
                          <div>Line Item</div>
                          {periodsData.map((p, i) => <div key={i} style={{ textAlign: 'right', color: '#1e293b' }}>{p.label || 'N/A'}</div>)}
                        </div>
                        <Row label="Revenue" values={periodsData.map(p => p.revenue)} bold />
                        <Row label="Total COGS" values={periodsData.map(p => p.cogs)} bold />
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>Gross Profit</div>
                          {periodsData.map((p, i) => <div key={i} style={{ textAlign: 'right' }}>{formatValue(p.grossProfit, p.revenue)}</div>)}
                        </div>
                        <div style={{ margin: '12px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Operating Expenses</div>
                        {(() => {
                          // Define all possible expense fields with their display names
                          const expenseFieldDefinitions = [
                            // Operating Expenses - Complete list in correct order
                            { key: 'payroll', label: 'Payroll' },
                            { key: 'benefits', label: 'Benefits' },
                            { key: 'insurance', label: 'Insurance' },
                            { key: 'professionalFees', label: 'Professional Services' },
                            { key: 'subcontractors', label: 'Subcontractors' },
                            { key: 'rent', label: 'Rent/Lease' },
                            { key: 'taxLicense', label: 'Tax & License' },
                            { key: 'phoneComm', label: 'Phone & Communication' },
                            { key: 'infrastructure', label: 'Infrastructure/Utilities' },
                            { key: 'autoTravel', label: 'Auto & Travel' },
                            { key: 'salesExpense', label: 'Sales & Marketing' },
                            { key: 'marketing', label: 'Marketing' },
                            { key: 'mealsEntertainment', label: 'Meals & Entertainment' },
                            { key: 'otherExpense', label: 'Other Expenses' }
                          ];

                          // Render only fields that have values in at least one period
                          return expenseFieldDefinitions.map(fieldDef => {
                            const hasValue = periodsData.some(p => (p[fieldDef.key as keyof typeof p] as number) > 0);
                            if (hasValue) {
                              return (
                                <Row
                                  key={fieldDef.key}
                                  label={fieldDef.label}
                                  values={periodsData.map(p => p[fieldDef.key as keyof typeof p] as number)}
                                  indent={20}
                                />
                              );
                            }
                            return null;
                          });
                        })()}
                        <Row label="Total Operating Expenses" values={periodsData.map(p => p.totalOpex)} bold />
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>Operating Income</div>
                          {periodsData.map((p, i) => <div key={i} style={{ textAlign: 'right' }}>{formatValue(p.operatingIncome, p.revenue)}</div>)}
                        </div>
                        {periodsData.some(p => p.interestExpense > 0 || p.nonOperatingIncome > 0 || p.extraordinaryItems !== 0) && (
                          <>
                            <div style={{ margin: '12px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Other Income/(Expense)</div>
                            {periodsData.some(p => p.interestExpense > 0) && <Row label="Interest Expense" values={periodsData.map(p => -p.interestExpense)} indent={20} />}
                            {periodsData.some(p => p.nonOperatingIncome > 0) && <Row label="Non-Operating Income" values={periodsData.map(p => p.nonOperatingIncome)} indent={20} />}
                            {periodsData.some(p => p.extraordinaryItems !== 0) && <Row label="Extraordinary Items" values={periodsData.map(p => p.extraordinaryItems)} indent={20} />}
                          </>
                        )}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 8px', background: '#dcfce7', borderRadius: '4px', margin: '12px 0 0', fontWeight: '700', fontSize: '15px' }}>
                          <div style={{ color: '#166534' }}>Net Income</div>
                          {periodsData.map((p, i) => {
                            const formattedValue = formatValue(Math.abs(p.netIncome), p.revenue);
                            return (
                              <div key={i} style={{ textAlign: 'right', color: p.netIncome >= 0 ? '#166534' : '#991b1b' }}>
                                {p.netIncome >= 0 ? (isPercentMode ? formattedValue : '$' + formattedValue.slice(1)) : `(${formattedValue})`}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );
                }
                
                // Sum all income statement items
                const revenue = periodMonths.reduce((sum, m) => sum + (m.revenue || 0), 0);

                const cogsPayroll = periodMonths.reduce((sum, m) => sum + (m.cogsPayroll || 0), 0);
                const cogsOwnerPay = periodMonths.reduce((sum, m) => sum + (m.cogsOwnerPay || 0), 0);
                const cogsContractors = periodMonths.reduce((sum, m) => sum + (m.cogsContractors || 0), 0);
                const cogsMaterials = periodMonths.reduce((sum, m) => sum + (m.cogsMaterials || 0), 0);
                const cogsCommissions = periodMonths.reduce((sum, m) => sum + (m.cogsCommissions || 0), 0);
                const cogsOther = periodMonths.reduce((sum, m) => sum + (m.cogsOther || 0), 0);
                const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;

                const grossProfit = revenue - cogs;
                const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

                // Dynamically calculate all expense fields
                const expenseFields = [
                  'cogsPayroll', 'cogsOwnerPay', 'cogsContractors', 'cogsMaterials', 'cogsCommissions', 'cogsOther',
                  'payroll', 'ownerBasePay', 'ownersRetirement', 'subcontractors',
                  'salesExpense', 'rent', 'infrastructure', 'autoTravel',
                  'professionalFees', 'insurance', 'marketing', 'interestExpense',
                  'depreciationAmortization', 'otherExpense'
                ];

                const expenses: { [key: string]: number } = {};
                expenseFields.forEach(field => {
                  expenses[field] = periodMonths.reduce((sum, m) => sum + (m[field] || 0), 0);
                });

                // Calculate total operating expenses dynamically
                const totalOpex = Object.values(expenses).reduce((sum, value) => sum + value, 0);
                  
                  const operatingIncome = grossProfit - totalOpex;
                  const operatingMargin = revenue > 0 ? (operatingIncome / revenue) * 100 : 0;
                  
                  const interestExpense = periodMonths.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                  const nonOperatingIncome = periodMonths.reduce((sum, m) => sum + (m.nonOperatingIncome || 0), 0);
                  const extraordinaryItems = periodMonths.reduce((sum, m) => sum + (m.extraordinaryItems || 0), 0);
                  
                  const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                  const netMargin = revenue > 0 ? (netIncome / revenue) * 100 : 0;
                  
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                        <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                          <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Income Statement</h2>
                          <div style={{ fontSize: '14px', color: '#64748b' }}>For the Period: {periodLabel}</div>
                        </div>

                        {/* Revenue Section */}
                        <div style={{ marginBottom: '12px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e2e8f0' }}>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>Revenue</span>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* COGS Section */}
                        <div style={{ marginBottom: '12px' }}>
                          <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Cost of Goods Sold</div>
                          {cogsPayroll > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>COGS - Payroll</span>
                              <span style={{ color: '#475569' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {cogsOwnerPay > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>COGS - Owner Pay</span>
                              <span style={{ color: '#475569' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {cogsContractors > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>COGS - Contractors</span>
                              <span style={{ color: '#475569' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {cogsMaterials > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>COGS - Materials</span>
                              <span style={{ color: '#475569' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {cogsCommissions > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>COGS - Commissions</span>
                              <span style={{ color: '#475569' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {cogsOther > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>COGS - Other</span>
                              <span style={{ color: '#475569' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>Total COGS</span>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* Gross Profit */}
                        <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                            <span style={{ fontWeight: '700', color: '#1e40af' }}>Gross Profit</span>
                            <span style={{ fontWeight: '700', color: '#1e40af' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                          <div style={{ fontSize: '13px', color: '#1e40af', textAlign: 'right' }}>
                            {grossMargin.toFixed(1)}% margin
                          </div>
                        </div>

                        {/* Operating Expenses */}
                        <div style={{ marginBottom: '12px' }}>
                          <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Operating Expenses</div>
                          {payroll > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Payroll</span>
                              <span style={{ color: '#475569' }}>${payroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {ownerBasePay > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Owner's Base Pay</span>
                              <span style={{ color: '#475569' }}>${ownerBasePay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {ownersRetirement > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Owner's Retirement</span>
                              <span style={{ color: '#475569' }}>${ownersRetirement.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {professionalFees > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Professional Services</span>
                              <span style={{ color: '#475569' }}>${professionalFees.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {rent > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Rent/Lease</span>
                              <span style={{ color: '#475569' }}>${rent.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {infrastructure > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Infrastructure</span>
                              <span style={{ color: '#475569' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {autoTravel > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Auto & Travel</span>
                              <span style={{ color: '#475569' }}>${autoTravel.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {insurance > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Insurance</span>
                              <span style={{ color: '#475569' }}>${insurance.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {salesExpense > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Sales & Marketing</span>
                              <span style={{ color: '#475569' }}>${salesExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {subcontractors > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Contractors - Distribution</span>
                              <span style={{ color: '#475569' }}>${subcontractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {depreciationAmortization > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Depreciation & Amortization</span>
                              <span style={{ color: '#475569' }}>${depreciationAmortization.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {marketing > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Other Operating Expenses</span>
                              <span style={{ color: '#475569' }}>${marketing.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Operating Expenses</span>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* Operating Income */}
                        <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                            <span style={{ fontWeight: '700', color: '#1e40af' }}>Operating Income</span>
                            <span style={{ fontWeight: '700', color: '#1e40af' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                          <div style={{ fontSize: '13px', color: '#1e40af', textAlign: 'right' }}>
                            {operatingMargin.toFixed(1)}% operating margin
                          </div>
                        </div>

                        {/* Other Income/Expense */}
                        <div style={{ marginBottom: '12px' }}>
                          <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Other Income/(Expense)</div>
                          {interestExpense > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Interest Expense</span>
                              <span style={{ color: '#475569' }}>(${ interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                            </div>
                          )}
                          {nonOperatingIncome > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Non-Operating Income</span>
                              <span style={{ color: '#475569' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {extraordinaryItems !== 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#475569' }}>Extraordinary Items</span>
                              <span style={{ color: '#475569' }}>{extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}</span>
                            </div>
                          )}
                        </div>

                        {/* Net Income */}
                        <div style={{ background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', padding: '16px', borderRadius: '8px', marginTop: '24px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                            <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>Net Income</span>
                            <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>
                              {netIncome >= 0 ? '$' : '($'}{Math.abs(netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{netIncome < 0 ? ')' : ''}
                            </span>
                          </div>
                          <div style={{ fontSize: '14px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                            {netMargin.toFixed(1)}% net margin
                          </div>
                        </div>
                    </div>
                  );
                }
                
                // COMMON SIZE INCOME STATEMENT - Aggregate with percentages
                else if (statementType === 'income-statement-percent') {
                  // Check if showing multiple periods side-by-side
                  if (displayPeriods.length > 1) {
                    const calc = (months: any[], field: string) => months.reduce((sum, m) => sum + (m[field] || 0), 0);
                    const periodsData = displayPeriods.map(p => {
                      const m = p.months;

                      // Calculate revenue and COGS
                      const revenue = calc(m, 'revenue');
                      const cogsPayroll = calc(m, 'cogsPayroll');
                      const cogsOwnerPay = calc(m, 'cogsOwnerPay');
                      const cogsContractors = calc(m, 'cogsContractors');
                      const cogsMaterials = calc(m, 'cogsMaterials');
                      const cogsCommissions = calc(m, 'cogsCommissions');
                      const cogsOther = calc(m, 'cogsOther');
                      const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                      const grossProfit = revenue - cogs;

                      // Dynamically calculate operating expense fields only
                      const expenseFields = [
                        'payroll', 'benefits', 'insurance', 'professionalFees', 'subcontractors',
                        'rent', 'taxLicense', 'phoneComm', 'infrastructure', 'autoTravel',
                        'salesExpense', 'marketing', 'mealsEntertainment', 'otherExpense'
                      ];

                      const expenses: { [key: string]: number } = {};
                      expenseFields.forEach(field => {
                        expenses[field] = calc(m, field);
                      });

                      // Calculate total operating expenses dynamically
                      const totalOpex = Object.values(expenses).reduce((sum, value) => sum + value, 0);

                      const operatingIncome = grossProfit - totalOpex;
                      const interestExpense = calc(m, 'interestExpense');
                      const nonOperatingIncome = calc(m, 'nonOperatingIncome');
                      const extraordinaryItems = calc(m, 'extraordinaryItems');
                      const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;

                      return {
                        label: p.label,
                        revenue, cogs, grossProfit,
                        ...expenses, // Include all expense fields dynamically
                        totalOpex, operatingIncome, interestExpense, nonOperatingIncome, extraordinaryItems, netIncome
                      };
                    });
                    const RowWithPercent = ({ label, values, indent = 0, bold = false }: any) => (
                      <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '4px 0', fontSize: bold ? '14px' : '13px', fontWeight: bold ? '600' : 'normal' }}>
                        <div style={{ color: bold ? '#475569' : '#64748b', paddingLeft: `${indent}px` }}>{label}</div>
                        {values.map((v: number, i: number) => {
                          const pct = periodsData[i].revenue > 0 ? (v / periodsData[i].revenue) * 100 : 0;
                          return (
                            <div key={i} style={{ display: 'contents' }}>
                              <div style={{ textAlign: 'right', color: bold ? '#475569' : '#64748b' }}>${v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b', fontSize: '12px' }}>{pct.toFixed(1)}%</div>
                            </div>
                          );
                        })}
                      </div>
                    );
                    return (
                      <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', overflowX: 'auto' }}>
                        <div style={{ marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                          <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Comparative Common Size Income Statement</h2>
                          <div style={{ fontSize: '14px', color: '#64748b' }}>{periodLabel} - {statementDisplay === 'monthly' ? 'Monthly' : statementDisplay === 'quarterly' ? 'Quarterly' : 'Annual'}</div>
                        </div>
                        <div style={{ minWidth: `${200 + (periodsData.length * 150)}px` }}>
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '12px 0', borderBottom: '2px solid #1e293b', fontWeight: '600', color: '#1e293b' }}>
                          <div>Line Item</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ display: 'contents' }}>
                              <div style={{ textAlign: 'right' }}>{p.label}</div>
                              <div style={{ textAlign: 'right', fontSize: '12px' }}>% of Rev</div>
                            </div>
                          ))}
                          </div>
                          <RowWithPercent label="Revenue" values={periodsData.map(p => p.revenue)} bold />
                          <RowWithPercent label="Total COGS" values={periodsData.map(p => p.cogs)} bold />
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                            <div>Gross Profit</div>
                            {periodsData.map((p, i) => {
                              const pct = p.revenue > 0 ? (p.grossProfit / p.revenue) * 100 : 0;
                              return (
                                <div key={i} style={{ display: 'contents' }}>
                                  <div style={{ textAlign: 'right' }}>${p.grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                  <div style={{ textAlign: 'right', fontSize: '12px' }}>{pct.toFixed(1)}%</div>
                                </div>
                              );
                            })}
                          </div>
                          <div style={{ margin: '12px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Operating Expenses</div>
                          {(() => {
                            // Define all possible expense fields with their display names
                            const expenseFieldDefinitions = [
                              // Operating Expenses - Complete list in correct order
                              { key: 'payroll', label: 'Payroll' },
                              { key: 'benefits', label: 'Benefits' },
                              { key: 'insurance', label: 'Insurance' },
                              { key: 'professionalFees', label: 'Professional Services' },
                              { key: 'subcontractors', label: 'Subcontractors' },
                              { key: 'rent', label: 'Rent/Lease' },
                              { key: 'taxLicense', label: 'Tax & License' },
                              { key: 'phoneComm', label: 'Phone & Communication' },
                              { key: 'infrastructure', label: 'Infrastructure/Utilities' },
                              { key: 'autoTravel', label: 'Auto & Travel' },
                              { key: 'salesExpense', label: 'Sales & Marketing' },
                              { key: 'marketing', label: 'Marketing' },
                              { key: 'mealsEntertainment', label: 'Meals & Entertainment' },
                              { key: 'otherExpense', label: 'Other Expenses' }
                            ];

                            // Render only fields that have values in at least one period
                            return expenseFieldDefinitions.map(fieldDef => {
                              const hasValue = periodsData.some(p => (p[fieldDef.key as keyof typeof p] as number) > 0);
                              if (hasValue) {
                                return (
                                  <RowWithPercent
                                    key={fieldDef.key}
                                    label={fieldDef.label}
                                    values={periodsData.map(p => p[fieldDef.key as keyof typeof p] as number)}
                                    indent={20}
                                  />
                                );
                              }
                              return null;
                            });
                          })()}
                          <RowWithPercent label="Total Operating Expenses" values={periodsData.map(p => p.totalOpex)} bold />
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                            <div>Operating Income</div>
                            {periodsData.map((p, i) => {
                              const pct = p.revenue > 0 ? (p.operatingIncome / p.revenue) * 100 : 0;
                              return (
                                <div key={i} style={{ display: 'contents' }}>
                                  <div style={{ textAlign: 'right' }}>${p.operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                  <div style={{ textAlign: 'right', fontSize: '12px' }}>{pct.toFixed(1)}%</div>
                                </div>
                              );
                            })}
                          </div>
                          {periodsData.some(p => p.interestExpense > 0 || p.nonOperatingIncome > 0 || p.extraordinaryItems !== 0) && (
                            <>
                              <div style={{ margin: '12px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Other Income/(Expense)</div>
                              {periodsData.some(p => p.interestExpense > 0) && <RowWithPercent label="Interest Expense" values={periodsData.map(p => -p.interestExpense)} indent={20} />}
                              {periodsData.some(p => p.nonOperatingIncome > 0) && <RowWithPercent label="Non-Operating Income" values={periodsData.map(p => p.nonOperatingIncome)} indent={20} />}
                              {periodsData.some(p => p.extraordinaryItems !== 0) && <RowWithPercent label="Extraordinary Items" values={periodsData.map(p => p.extraordinaryItems)} indent={20} />}
                            </>
                          )}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '12px 8px', background: '#dcfce7', borderRadius: '4px', margin: '12px 0 0', fontWeight: '700', fontSize: '15px' }}>
                            <div style={{ color: '#166534' }}>Net Income</div>
                            {periodsData.map((p, i) => {
                              const pct = p.revenue > 0 ? (p.netIncome / p.revenue) * 100 : 0;
                              return (
                                <div key={i} style={{ display: 'contents' }}>
                                  <div style={{ textAlign: 'right', color: p.netIncome >= 0 ? '#166534' : '#991b1b' }}>
                                    {p.netIncome >= 0 ? '$' : '($'}{Math.abs(p.netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.netIncome < 0 ? ')' : ''}
                                  </div>
                                  <div style={{ textAlign: 'right', fontSize: '12px', color: p.netIncome >= 0 ? '#166534' : '#991b1b' }}>{pct.toFixed(1)}%</div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    );
                  }
                  
                  const revenue = periodMonths.reduce((sum, m) => sum + (m.revenue || 0), 0);
                  
                  const cogsPayroll = periodMonths.reduce((sum, m) => sum + (m.cogsPayroll || 0), 0);
                  const cogsOwnerPay = periodMonths.reduce((sum, m) => sum + (m.cogsOwnerPay || 0), 0);
                  const cogsContractors = periodMonths.reduce((sum, m) => sum + (m.cogsContractors || 0), 0);
                  const cogsMaterials = periodMonths.reduce((sum, m) => sum + (m.cogsMaterials || 0), 0);
                  const cogsCommissions = periodMonths.reduce((sum, m) => sum + (m.cogsCommissions || 0), 0);
                  const cogsOther = periodMonths.reduce((sum, m) => sum + (m.cogsOther || 0), 0);
                  const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                  
                  const grossProfit = revenue - cogs;
                  
                  const payroll = periodMonths.reduce((sum, m) => sum + (m.payroll || 0), 0);
                  const ownerBasePay = periodMonths.reduce((sum, m) => sum + (m.ownerBasePay || 0), 0);
                  const ownersRetirement = periodMonths.reduce((sum, m) => sum + (m.ownersRetirement || 0), 0);
                  const professionalFees = periodMonths.reduce((sum, m) => sum + (m.professionalFees || 0), 0);
                  const rent = periodMonths.reduce((sum, m) => sum + (m.rent || 0), 0);
                  const infrastructure = periodMonths.reduce((sum, m) => sum + (m.infrastructure || 0), 0);
                  const autoTravel = periodMonths.reduce((sum, m) => sum + (m.autoTravel || 0), 0);
                  const insurance = periodMonths.reduce((sum, m) => sum + (m.insurance || 0), 0);
                  const salesExpense = periodMonths.reduce((sum, m) => sum + (m.salesExpense || 0), 0);
                  const subcontractors = periodMonths.reduce((sum, m) => sum + (m.subcontractors || 0), 0);
                  const depreciationAmortization = periodMonths.reduce((sum, m) => sum + (m.depreciationAmortization || 0), 0);
                  const marketing = periodMonths.reduce((sum, m) => sum + (m.marketing || 0), 0);
                  
                  const totalOpex = payroll + ownerBasePay + ownersRetirement + professionalFees + 
                                   rent + infrastructure + autoTravel + insurance + 
                                   salesExpense + subcontractors + depreciationAmortization + marketing;
                  
                  const operatingIncome = grossProfit - totalOpex;
                  
                  const interestExpense = periodMonths.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                  const nonOperatingIncome = periodMonths.reduce((sum, m) => sum + (m.nonOperatingIncome || 0), 0);
                  const extraordinaryItems = periodMonths.reduce((sum, m) => sum + (m.extraordinaryItems || 0), 0);
                  
                  const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                  
                  const calcPercent = (value: number) => revenue > 0 ? ((value / revenue) * 100).toFixed(1) + '%' : '0.0%';
                  
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                        <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                          <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Common Size Income Statement</h2>
                          <div style={{ fontSize: '14px', color: '#64748b' }}>For the Period: {periodLabel}</div>
                        </div>

                        {/* Header Row */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '12px 0', borderBottom: '2px solid #1e293b', marginBottom: '16px', fontWeight: '600', color: '#1e293b' }}>
                          <div>Line Item</div>
                          <div style={{ textAlign: 'right' }}>Amount</div>
                          <div style={{ textAlign: 'right' }}>% of Revenue</div>
                        </div>

                        {/* Revenue */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '8px 0', borderBottom: '1px solid #e2e8f0', fontWeight: '600' }}>
                          <div style={{ color: '#1e293b' }}>Revenue</div>
                          <div style={{ textAlign: 'right', color: '#1e293b' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          <div style={{ textAlign: 'right', color: '#1e293b' }}>100.0%</div>
                        </div>

                        {/* COGS */}
                        <div style={{ marginTop: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px', fontSize: '14px' }}>Cost of Goods Sold</div>
                          {cogsPayroll > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>COGS - Payroll</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsPayroll)}</div>
                            </div>
                          )}
                          {cogsOwnerPay > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>COGS - Owner Pay</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsOwnerPay)}</div>
                            </div>
                          )}
                          {cogsContractors > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>COGS - Contractors</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsContractors)}</div>
                            </div>
                          )}
                          {cogsMaterials > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>COGS - Materials</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsMaterials)}</div>
                            </div>
                          )}
                          {cogsCommissions > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>COGS - Commissions</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsCommissions)}</div>
                            </div>
                          )}
                          {cogsOther > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>COGS - Other</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsOther)}</div>
                            </div>
                          )}
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '8px 0', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                            <div style={{ color: '#475569' }}>Total COGS</div>
                            <div style={{ textAlign: 'right', color: '#475569' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#475569' }}>{calcPercent(cogs)}</div>
                          </div>
                        </div>

                        {/* Gross Profit */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '12px 8px', background: '#dbeafe', borderRadius: '6px', margin: '16px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>Gross Profit</div>
                          <div style={{ textAlign: 'right' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          <div style={{ textAlign: 'right' }}>{calcPercent(grossProfit)}</div>
                        </div>

                        {/* Operating Expenses */}
                        <div style={{ marginTop: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px', fontSize: '14px' }}>Operating Expenses</div>
                          {payroll > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Payroll</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${payroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(payroll)}</div>
                            </div>
                          )}
                          {ownerBasePay > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Owner's Base Pay</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${ownerBasePay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(ownerBasePay)}</div>
                            </div>
                          )}
                          {ownersRetirement > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Owner's Retirement</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${ownersRetirement.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(ownersRetirement)}</div>
                            </div>
                          )}
                          {professionalFees > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Professional Services</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${professionalFees.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(professionalFees)}</div>
                            </div>
                          )}
                          {rent > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Rent/Lease</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${rent.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(rent)}</div>
                            </div>
                          )}
                          {infrastructure > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Infrastructure</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(utilities)}</div>
                            </div>
                          )}
                          {infrastructure > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Infrastructure</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(equipment)}</div>
                            </div>
                          )}
                          {autoTravel > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Auto & Travel</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${autoTravel.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(travel)}</div>
                            </div>
                          )}
                          {insurance > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Insurance</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${insurance.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(insurance)}</div>
                            </div>
                          )}
                          {salesExpense > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Sales & Marketing</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${salesExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(salesExpense)}</div>
                            </div>
                          )}
                          {subcontractors > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Contractors - Distribution</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${subcontractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(subcontractors)}</div>
                            </div>
                          )}
                          {depreciationAmortization > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Depreciation & Amortization</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${depreciationAmortization.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(depreciationAmortization)}</div>
                            </div>
                          )}
                          {marketing > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Other Operating Expenses</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${marketing.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(marketing)}</div>
                            </div>
                          )}
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '8px 0', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                            <div style={{ color: '#475569' }}>Total Operating Expenses</div>
                            <div style={{ textAlign: 'right', color: '#475569' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#475569' }}>{calcPercent(totalOpex)}</div>
                          </div>
                        </div>

                        {/* Operating Income */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '12px 8px', background: '#dbeafe', borderRadius: '6px', margin: '16px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>Operating Income</div>
                          <div style={{ textAlign: 'right' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          <div style={{ textAlign: 'right' }}>{calcPercent(operatingIncome)}</div>
                        </div>

                        {/* Other Income/Expense */}
                        {(interestExpense > 0 || nonOperatingIncome > 0 || extraordinaryItems !== 0) && (
                          <div style={{ marginTop: '16px' }}>
                            <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px', fontSize: '14px' }}>Other Income/(Expense)</div>
                            {interestExpense > 0 && (
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                                <div style={{ color: '#64748b' }}>Interest Expense</div>
                                <div style={{ textAlign: 'right', color: '#64748b' }}>(${ interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</div>
                                <div style={{ textAlign: 'right', color: '#64748b' }}>({calcPercent(interestExpense)})</div>
                              </div>
                            )}
                            {nonOperatingIncome > 0 && (
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                                <div style={{ color: '#64748b' }}>Non-Operating Income</div>
                                <div style={{ textAlign: 'right', color: '#64748b' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(nonOperatingIncome)}</div>
                              </div>
                            )}
                            {extraordinaryItems !== 0 && (
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                                <div style={{ color: '#64748b' }}>Extraordinary Items</div>
                                <div style={{ textAlign: 'right', color: '#64748b' }}>
                                  {extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}
                                </div>
                                <div style={{ textAlign: 'right', color: '#64748b' }}>
                                  {extraordinaryItems >= 0 ? calcPercent(extraordinaryItems) : `(${calcPercent(Math.abs(extraordinaryItems))})`}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Net Income */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '16px 8px', background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', borderRadius: '6px', marginTop: '24px', fontWeight: '700', fontSize: '16px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>
                          <div>Net Income</div>
                          <div style={{ textAlign: 'right' }}>
                            {netIncome >= 0 ? '$' : '($'}{Math.abs(netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{netIncome < 0 ? ')' : ''}
                          </div>
                          <div style={{ textAlign: 'right' }}>{calcPercent(netIncome)}</div>
                        </div>
                    </div>
                  );
                }
                
                // BALANCE SHEET - Latest point in time
                else if (statementType === 'balance-sheet') {
                  // Check if we're showing multiple periods side-by-side
                  if (displayPeriods.length > 1) {
                    // Multi-column comparative balance sheet
                    const calculateBalanceData = (months: any[]) => {
                      // For balance sheet, use the latest month's values (point-in-time)
                      const latest = months[months.length - 1];
                      // Assets - Use Data Review fields and imported totals
                      const cash = latest.cash || 0;
                      const ar = latest.ar || 0;
                      const inventory = latest.inventory || 0;
                      const otherCA = latest.otherCA || 0;
                      const tca = latest.tca || 0;  // Use imported total
                      
                      const fixedAssets = latest.fixedAssets || 0;
                      const otherAssets = latest.otherAssets || 0;
                      const totalAssets = latest.totalAssets || 0;  // Use imported total
                      
                      // Liabilities - Use Data Review fields and imported totals
                      const ap = latest.ap || 0;
                      const otherCL = latest.otherCL || 0;
                      const tcl = latest.tcl || 0;  // Use imported total
                      
                      const ltd = latest.ltd || 0;
                      const totalLiabilities = latest.totalLiab || 0;  // Use imported total
                      
                      // All equity detail fields
                      const ownersCapital = latest.ownersCapital || 0;
                      const ownersDraw = latest.ownersDraw || 0;
                      const commonStock = latest.commonStock || 0;
                      const preferredStock = latest.preferredStock || 0;
                      const retainedEarnings = latest.retainedEarnings || 0;
                      const additionalPaidInCapital = latest.additionalPaidInCapital || 0;
                      const treasuryStock = latest.treasuryStock || 0;
                      const paidInCapital = latest.paidInCapital || 0;
                      const totalEquity = latest.totalEquity || (ownersCapital + ownersDraw + commonStock + preferredStock + retainedEarnings + additionalPaidInCapital + treasuryStock + paidInCapital);
                      
                      const totalLAndE = latest.totalLAndE || (totalLiabilities + totalEquity);
                      
                      return {
                        cash, ar, inventory, otherCA, tca,
                        fixedAssets, otherAssets, totalAssets,
                        ap, otherCL, tcl,
                        ltd, totalLiabilities,
                        ownersCapital, ownersDraw, commonStock, preferredStock, retainedEarnings, additionalPaidInCapital, treasuryStock, paidInCapital, totalEquity,
                        totalLAndE
                      };
                    };
                    
                    const balanceData = displayPeriods.map(p => ({
                      label: p.label,
                      ...calculateBalanceData(p.months)
                    }));
                    
                    return (
                      <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', overflowX: 'auto' }}>
                        <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                          <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Comparative Balance Sheet</h2>
                          <div style={{ fontSize: '14px', color: '#64748b' }}>{periodLabel} - {statementDisplay === 'monthly' ? 'Monthly' : statementDisplay === 'quarterly' ? 'Quarterly' : 'Annual'}</div>
                        </div>
                        
                        {/* Table with multiple columns */}
                        <div style={{ minWidth: `${200 + (balanceData.length * 110)}px` }}>
                          {/* Header Row */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 0', borderBottom: '2px solid #1e293b', fontWeight: '600', color: '#1e293b', position: 'sticky', top: 0, background: 'white' }}>
                            <div>Line Item</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right' }}>{p.label}</div>
                            ))}
                          </div>
                          
                          {/* ASSETS Section Header */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 0 4px 0', fontSize: '15px', fontWeight: '700', marginTop: '8px' }}>
                            <div style={{ color: '#1e293b' }}>ASSETS</div>
                            {balanceData.map((p, i) => <div key={i}></div>)}
                          </div>
                          
                          {/* Current Assets Header */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '8px 0 4px 0', fontSize: '14px', fontWeight: '600' }}>
                            <div style={{ color: '#475569' }}>Current Assets</div>
                            {balanceData.map((p, i) => <div key={i}></div>)}
                          </div>
                          
                          {/* Current Assets Details */}
                          {balanceData.some(p => p.cash > 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Cash & Cash Equivalents</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cash.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.ar > 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Accounts Receivable</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.ar.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.inventory > 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Inventory</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.inventory.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.otherCA > 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Other Current Assets</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.otherCA.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '6px 0', fontSize: '14px', fontWeight: '600', borderTop: '1px solid #cbd5e1', marginTop: '4px' }}>
                            <div style={{ color: '#475569' }}>Total Current Assets</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#475569' }}>${p.tca.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                          
                          {/* Non-Current Assets */}
                          {balanceData.some(p => p.fixedAssets !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Fixed Assets</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.fixedAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.otherAssets !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Other Assets</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.otherAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          
                          {/* TOTAL ASSETS */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', marginTop: '8px', fontWeight: '700' }}>
                            <div style={{ color: '#1e40af' }}>TOTAL ASSETS</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#1e40af' }}>${p.totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                          
                          {/* LIABILITIES Section Header */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 0 4px 0', fontSize: '15px', fontWeight: '700', marginTop: '16px' }}>
                            <div style={{ color: '#1e293b' }}>LIABILITIES</div>
                            {balanceData.map((p, i) => <div key={i}></div>)}
                          </div>
                          
                          {/* Current Liabilities Header */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '8px 0 4px 0', fontSize: '14px', fontWeight: '600' }}>
                            <div style={{ color: '#475569' }}>Current Liabilities</div>
                            {balanceData.map((p, i) => <div key={i}></div>)}
                          </div>
                          
                          {balanceData.some(p => p.ap !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Accounts Payable</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.ap.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.otherCL !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Other Current Liabilities</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.otherCL.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '6px 0', fontSize: '14px', fontWeight: '600', borderTop: '1px solid #cbd5e1', marginTop: '4px' }}>
                            <div style={{ color: '#475569' }}>Total Current Liabilities</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#475569' }}>${p.tcl.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                          
                          {/* Long-Term Debt */}
                          {balanceData.some(p => p.ltd !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Long-Term Debt</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.ltd.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          
                          {/* TOTAL LIABILITIES */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#fef3c7', borderRadius: '4px', marginTop: '8px', fontWeight: '700' }}>
                            <div style={{ color: '#92400e' }}>TOTAL LIABILITIES</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#92400e' }}>${p.totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                          
                          {/* EQUITY Section Header */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 0 4px 0', fontSize: '15px', fontWeight: '700', marginTop: '16px' }}>
                            <div style={{ color: '#1e293b' }}>EQUITY</div>
                            {balanceData.map((p, i) => <div key={i}></div>)}
                          </div>
                          
                          {balanceData.some(p => p.ownersCapital !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Owner's Capital</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.ownersCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.ownersDraw !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Owner's Draw</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.ownersDraw.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.commonStock !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Common Stock</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.commonStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.preferredStock !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Preferred Stock</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.preferredStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.retainedEarnings !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Retained Earnings</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>
                                  {p.retainedEarnings >= 0 ? '$' : '($'}{Math.abs(p.retainedEarnings).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.retainedEarnings < 0 ? ')' : ''}
                                </div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.additionalPaidInCapital !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Additional Paid-In Capital</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.additionalPaidInCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.treasuryStock !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Treasury Stock</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.treasuryStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          {balanceData.some(p => p.paidInCapital !== 0) && (
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                              <div style={{ color: '#64748b', paddingLeft: '20px' }}>Paid-in Capital</div>
                              {balanceData.map((p, i) => (
                                <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${(p.paidInCapital || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              ))}
                            </div>
                          )}
                          
                          {/* TOTAL EQUITY */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dcfce7', borderRadius: '4px', marginTop: '8px', fontWeight: '700' }}>
                            <div style={{ color: '#166534' }}>TOTAL EQUITY</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: p.totalEquity >= 0 ? '#166534' : '#991b1b' }}>
                                {p.totalEquity >= 0 ? '$' : '($'}{Math.abs(p.totalEquity).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.totalEquity < 0 ? ')' : ''}
                              </div>
                            ))}
                          </div>
                          
                          {/* TOTAL LIABILITIES & EQUITY */}
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#f1f5f9', borderRadius: '4px', marginTop: '16px', fontWeight: '700' }}>
                            <div style={{ color: '#1e293b' }}>TOTAL LIABILITIES & EQUITY</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#1e293b' }}>
                                ${p.totalLAndE.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    );
                  }
                  
                  // Single period balance sheet (original logic)
                  const cash = latestMonth.cash || 0;
                  const ar = latestMonth.ar || 0;
                  const inventory = latestMonth.inventory || 0;
                  const otherCA = latestMonth.otherCA || 0;
                  const tca = cash + ar + inventory + otherCA;
                  
                  const fixedAssets = latestMonth.fixedAssets || 0;
                  const intangibleAssets = latestMonth.intangibleAssets || 0;
                  const otherNonCurrentAssets = latestMonth.otherNonCurrentAssets || 0;
                  const nonCurrentAssets = fixedAssets + intangibleAssets + otherNonCurrentAssets;
                  
                  const totalAssets = tca + nonCurrentAssets;
                  
                  const ap = latestMonth.ap || 0;
                  const shortTermDebt = latestMonth.shortTermDebt || 0;
                  const currentPortionLTD = latestMonth.currentPortionLTD || 0;
                  const otherCurrentLiabilities = latestMonth.otherCurrentLiabilities || 0;
                  const totalCurrentLiabilities = ap + shortTermDebt + currentPortionLTD + otherCurrentLiabilities;
                  
                  const ltd = latestMonth.ltd || 0;
                  const otherLongTermLiabilities = latestMonth.otherLongTermLiabilities || 0;
                  const totalLongTermLiabilities = ltd + otherLongTermLiabilities;
                  
                  const totalLiabilities = totalCurrentLiabilities + totalLongTermLiabilities;
                  
                  const paidInCapital = latestMonth.paidInCapital || 0;
                  const retainedEarnings = latestMonth.retainedEarnings || 0;
                  const totalEquity = paidInCapital + retainedEarnings;
                  
                  const totalLAndE = totalLiabilities + totalEquity;
                  
                  const latestDate = new Date(latestMonth.date || latestMonth.month);
                  const asOfDate = latestDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                  
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                      <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Balance Sheet</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>As of {asOfDate} (Period: {periodLabel})</div>
                      </div>

                      {/* ASSETS */}
                      <div style={{ marginBottom: '32px' }}>
                        <div style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b', marginBottom: '12px' }}>ASSETS</div>
                        
                        {/* Current Assets */}
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px' }}>Current Assets</div>
                          {cash > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Cash & Cash Equivalents</span>
                              <span style={{ color: '#64748b' }}>${cash.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {ar > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Accounts Receivable</span>
                              <span style={{ color: '#64748b' }}>${ar.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {inventory > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Inventory</span>
                              <span style={{ color: '#64748b' }}>${inventory.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {otherCA > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Other Current Assets</span>
                              <span style={{ color: '#64748b' }}>${otherCA.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 10px', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                            <span style={{ color: '#475569' }}>Total Current Assets</span>
                            <span style={{ color: '#475569' }}>${tca.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* Non-Current Assets */}
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px' }}>Non-Current Assets</div>
                          {fixedAssets > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Property, Plant & Equipment</span>
                              <span style={{ color: '#64748b' }}>${fixedAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {intangibleAssets > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Intangible Assets</span>
                              <span style={{ color: '#64748b' }}>${intangibleAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {otherNonCurrentAssets > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Other Non-Current Assets</span>
                              <span style={{ color: '#64748b' }}>${otherNonCurrentAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 10px', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                            <span style={{ color: '#475569' }}>Total Non-Current Assets</span>
                            <span style={{ color: '#475569' }}>${nonCurrentAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* TOTAL ASSETS */}
                        <div style={{ background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e40af' }}>TOTAL ASSETS</span>
                            <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e40af' }}>
                              ${totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* LIABILITIES */}
                      <div style={{ marginBottom: '32px' }}>
                        <div style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b', marginBottom: '12px' }}>LIABILITIES</div>
                        
                        {/* Current Liabilities */}
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px' }}>Current Liabilities</div>
                          {ap > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Accounts Payable</span>
                              <span style={{ color: '#64748b' }}>${ap.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {shortTermDebt > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Short-Term Debt</span>
                              <span style={{ color: '#64748b' }}>${shortTermDebt.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {currentPortionLTD > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Current Portion of LT Debt</span>
                              <span style={{ color: '#64748b' }}>${currentPortionLTD.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {otherCurrentLiabilities > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Other Current Liabilities</span>
                              <span style={{ color: '#64748b' }}>${otherCurrentLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 10px', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                            <span style={{ color: '#475569' }}>Total Current Liabilities</span>
                            <span style={{ color: '#475569' }}>${totalCurrentLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* Long-Term Liabilities */}
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px' }}>Long-Term Liabilities</div>
                          {ltd > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Long-Term Debt</span>
                              <span style={{ color: '#64748b' }}>${ltd.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          {otherLongTermLiabilities > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                              <span style={{ color: '#64748b' }}>Other Long-Term Liabilities</span>
                              <span style={{ color: '#64748b' }}>${otherLongTermLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                          )}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 10px', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                            <span style={{ color: '#475569' }}>Total Long-Term Liabilities</span>
                            <span style={{ color: '#475569' }}>${totalLongTermLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </div>

                        {/* TOTAL LIABILITIES */}
                        <div style={{ background: '#fef3c7', padding: '12px', borderRadius: '8px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ fontWeight: '700', fontSize: '16px', color: '#92400e' }}>TOTAL LIABILITIES</span>
                            <span style={{ fontWeight: '700', fontSize: '16px', color: '#92400e' }}>
                              ${totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* EQUITY */}
                      <div style={{ marginBottom: '32px' }}>
                        <div style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b', marginBottom: '12px' }}>EQUITY</div>
                        {paidInCapital > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Paid-in Capital</span>
                            <span style={{ color: '#64748b' }}>${paidInCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {retainedEarnings !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Retained Earnings</span>
                            <span style={{ color: '#64748b' }}>
                              {retainedEarnings >= 0 ? '$' : '($'}{Math.abs(retainedEarnings).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{retainedEarnings < 0 ? ')' : ''}
                            </span>
                          </div>
                        )}

                        {/* TOTAL EQUITY */}
                        <div style={{ background: '#dcfce7', padding: '12px', borderRadius: '8px', marginTop: '8px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ fontWeight: '700', fontSize: '16px', color: '#166534' }}>TOTAL EQUITY</span>
                            <span style={{ fontWeight: '700', fontSize: '16px', color: '#166534' }}>
                              {totalEquity >= 0 ? '$' : '($'}{Math.abs(totalEquity).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{totalEquity < 0 ? ')' : ''}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* TOTAL LIABILITIES & EQUITY */}
                      <div style={{ background: '#f1f5f9', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>TOTAL LIABILITIES & EQUITY</span>
                          <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>
                            ${totalLAndE.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                          </span>
                        </div>
                        {Math.abs(totalAssets - totalLAndE) > 0.01 && (
                          <div style={{ fontSize: '12px', color: '#ef4444', marginTop: '8px', textAlign: 'right' }}>
                            ?? Balance check: Assets - (Liabilities + Equity) = ${(totalAssets - totalLAndE).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                }
              }
              
              else {
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '48px 32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', minHeight: '400px', textAlign: 'center' }}>
                    <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>
                      ðŸ“Š Financial Statement Viewer
                    </div>
                    <p style={{ fontSize: '14px', color: '#94a3b8', maxWidth: '600px', margin: '0 auto' }}>
                      {monthly.length === 0 
                        ? 'No financial data available. Please import financial data or sync from QuickBooks.'
                        : 'Select options above to view financial statements.'}
                    </p>
                  </div>
                );
              }
            })()}

            {/* Hidden: Old P&L and Balance Sheet containers - will be removed in future update */}
            <div style={{ display: 'none' }}>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
              {/* Left: QuickBooks Raw Data */}
              <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              {/* Profit & Loss Report */}
              <div style={{ marginBottom: '48px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '20px', paddingBottom: '12px', borderBottom: '3px solid #667eea' }}>Profit & Loss</h2>
                {plRows.length > 0 ? (
                  <div>
                    {plRows.map((row, idx) => (
                      <div 
                        key={idx} 
                        style={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          padding: row.isHeader ? '12px 8px 8px' : (row.isTotal ? '10px 8px' : '6px 8px'),
                          paddingLeft: `${8 + (row.level * 20)}px`,
                          borderBottom: row.isTotal ? '2px solid #e2e8f0' : (row.isHeader ? '1px solid #e2e8f0' : 'none'),
                          background: row.isHeader ? '#f8fafc' : (row.isTotal ? '#f1f5f9' : 'transparent'),
                          fontWeight: row.isHeader || row.isTotal ? '600' : '400',
                          fontSize: row.isHeader ? '15px' : (row.isTotal ? '14px' : '13px'),
                          color: row.isHeader ? '#1e293b' : (row.isTotal ? '#0f172a' : '#475569')
                        }}
                      >
                        <span>{row.name}</span>
                        {!row.isHeader && <span style={{ fontFamily: 'monospace', whiteSpace: 'nowrap' }}>{row.value}</span>}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{ padding: '32px', textAlign: 'center', color: '#64748b' }}>No Profit & Loss data available</div>
                )}
              </div>

              {/* Balance Sheet Report */}
              <div>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '20px', paddingBottom: '12px', borderBottom: '3px solid #667eea' }}>Balance Sheet</h2>
                {bsRows.length > 0 ? (
                  <div>
                    {bsRows.map((row, idx) => (
                      <div 
                        key={idx} 
                        style={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          padding: row.isHeader ? '12px 8px 8px' : (row.isTotal ? '10px 8px' : '6px 8px'),
                          paddingLeft: `${8 + (row.level * 20)}px`,
                          borderBottom: row.isTotal ? '2px solid #e2e8f0' : (row.isHeader ? '1px solid #e2e8f0' : 'none'),
                          background: row.isHeader ? '#f8fafc' : (row.isTotal ? '#f1f5f9' : 'transparent'),
                          fontWeight: row.isHeader || row.isTotal ? '600' : '400',
                          fontSize: row.isHeader ? '15px' : (row.isTotal ? '14px' : '13px'),
                          color: row.isHeader ? '#1e293b' : (row.isTotal ? '#0f172a' : '#475569')
                        }}
                      >
                        <span>{row.name}</span>
                        {!row.isHeader && <span style={{ fontFamily: 'monospace', whiteSpace: 'nowrap' }}>{row.value}</span>}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{ padding: '32px', textAlign: 'center', color: '#64748b' }}>No Balance Sheet data available</div>
                )}
              </div>
              </div>

              {/* Right: Your Minimal Viable Financial Statement Structure */}
              <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                {/* Income Statement Structure */}
                <div style={{ marginBottom: '48px' }}>
                  <div style={{ marginBottom: '20px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '8px', paddingBottom: '12px', borderBottom: '3px solid #10b981' }}>Income Statement Fields</h2>
                    {qbRawData?.profitAndLoss?.Header && (() => {
                      const columns = qbRawData.profitAndLoss.Columns?.Column || [];
                      const hasMultipleMonths = columns.length > 2;
                      const lastMonthColumn = hasMultipleMonths && columns.length >= 2 ? columns[columns.length - 2] : null;
                      const monthLabel = lastMonthColumn?.ColTitle || qbRawData.profitAndLoss.Header.EndPeriod;
                      
                      return (
                        <div style={{ fontSize: '13px', marginTop: '8px' }}>
                          <div style={{ color: '#64748b' }}>
                            <strong>Report Period:</strong> {qbRawData.profitAndLoss.Header.StartPeriod || 'N/A'} to {qbRawData.profitAndLoss.Header.EndPeriod || 'N/A'}
                          </div>
                          <div style={{ color: '#10b981', fontWeight: '600', marginTop: '4px', padding: '8px', background: '#f0fdf4', borderRadius: '6px', border: '1px solid #86efac' }}>
                            ðŸ“… Displaying: {hasMultipleMonths ? `Monthly data for ${monthLabel}` : `Period total for ${monthLabel}`}
                          </div>
                          {!hasMultipleMonths && (
                            <div style={{ color: '#f59e0b', fontWeight: '500', fontSize: '12px', marginTop: '4px', padding: '6px', background: '#fffbeb', borderRadius: '6px', border: '1px solid #fcd34d' }}>
                              ?? Note: This appears to be cumulative for the entire period, not monthly breakdowns
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                  
                  {aiMappings.length > 0 ? (
                    <div style={{ fontSize: '13px' }}>
                      {/* Group mappings by category */}
                      {(() => {
                        // Deduplicate mappings by QB account name (keep first occurrence)
                        const uniqueMappings = aiMappings.filter((m, index, self) =>
                          index === self.findIndex((t) => t.qbAccount === m.qbAccount)
                        );
                        
                        const revenueMappings = uniqueMappings.filter(m => ['Revenue', 'Income'].some(c => m.qbAccountClassification?.includes(c)));
                        const cogsMappings = uniqueMappings.filter(m => ['Cost of Goods Sold', 'COGS'].some(c => m.qbAccountClassification?.includes(c)));
                        const expenseMappings = uniqueMappings.filter(m => m.qbAccountClassification?.includes('Expense'));
                        
                        // Helper to get amount - extract from the appropriate column
                        const getAmount = (qbAccountName: string) => {
                          if (!qbRawData) return 0;
                          const extractRows = (reportData: any) => {
                            const result: any[] = [];
                            if (!reportData || !reportData.Rows || !reportData.Rows.Row) return result;
                            
                            const processRow = (row: any) => {
                              if (row.type === 'Data' && row.ColData) {
                                const name = row.ColData[0]?.value || '';
                                if (name) {
                                  // Try to find a numeric value from the columns
                                  // Start from the end and work backwards to find the first valid number
                                  let value = 0;
                                  for (let i = row.ColData.length - 1; i >= 1; i--) {
                                    const colValue = row.ColData[i]?.value;
                                    if (colValue !== undefined && colValue !== '' && !isNaN(parseFloat(colValue))) {
                                      value = parseFloat(colValue);
                                      break;
                                    }
                                  }
                                  result.push({ name, value });
                                }
                              }
                              if (row.Rows && row.Rows.Row) {
                                const subRows = Array.isArray(row.Rows.Row) ? row.Rows.Row : [row.Rows.Row];
                                subRows.forEach((r: any) => processRow(r));
                              }
                            };
                            const rows = Array.isArray(reportData.Rows.Row) ? reportData.Rows.Row : [reportData.Rows.Row];
                            rows.forEach((r: any) => processRow(r));
                            return result;
                          };
                          const plRows = extractRows(qbRawData.profitAndLoss);
                          const accountRow = plRows.find((row: any) => row.name === qbAccountName);
                          return accountRow ? accountRow.value : 0;
                        };
                        
                        // Calculate totals
                        const totalRevenue = revenueMappings.reduce((sum, m) => sum + getAmount(m.qbAccount), 0);
                        const totalCOGS = cogsMappings.reduce((sum, m) => sum + getAmount(m.qbAccount), 0);
                        const totalExpenses = expenseMappings.reduce((sum, m) => sum + getAmount(m.qbAccount), 0);
                        const grossProfit = totalRevenue - totalCOGS;
                        const netIncome = grossProfit - totalExpenses;
                        
                        return (
                          <>
                            {/* REVENUE SECTION */}
                            {revenueMappings.length > 0 && (
                              <>
                                <div style={{ padding: '8px', background: '#f8fafc', fontWeight: '600', borderBottom: '1px solid #e2e8f0' }}>REVENUE</div>
                                {revenueMappings.map((m, i) => {
                                  const amount = getAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {/* COGS SECTION */}
                            {cogsMappings.length > 0 && (
                              <>
                                <div style={{ padding: '8px', background: '#f8fafc', fontWeight: '600', borderBottom: '1px solid #e2e8f0', marginTop: '12px' }}>COST OF GOODS SOLD</div>
                                {cogsMappings.map((m, i) => {
                                  const amount = getAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                                <div style={{ padding: '10px 16px', background: '#fee2e2', borderBottom: '2px solid #ef4444', display: 'flex', justifyContent: 'space-between', fontWeight: '700' }}>
                                  <span style={{ color: '#991b1b' }}>Total COGS</span>
                                  <span style={{ color: '#991b1b', fontFamily: 'monospace' }}>
                                    ${totalCOGS.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                  </span>
                                </div>
                                <div style={{ padding: '10px 16px', background: '#dbeafe', borderBottom: '3px solid #3b82f6', display: 'flex', justifyContent: 'space-between', fontWeight: '700', marginTop: '4px' }}>
                                  <span style={{ color: '#1e40af' }}>GROSS PROFIT</span>
                                  <span style={{ color: '#1e40af', fontFamily: 'monospace' }}>
                                    ${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                  </span>
                                </div>
                              </>
                            )}
                            
                            {/* EXPENSES SECTION */}
                            {expenseMappings.length > 0 && (
                              <>
                                <div style={{ padding: '8px', background: '#f8fafc', fontWeight: '600', borderBottom: '1px solid #e2e8f0', marginTop: '12px' }}>OPERATING EXPENSES</div>
                                {expenseMappings.map((m, i) => {
                                  const amount = getAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                                <div style={{ padding: '10px 16px', background: '#fef3c7', borderBottom: '2px solid #f59e0b', display: 'flex', justifyContent: 'space-between', fontWeight: '700' }}>
                                  <span style={{ color: '#92400e' }}>Total Operating Expenses</span>
                                  <span style={{ color: '#92400e', fontFamily: 'monospace' }}>
                                    ${totalExpenses.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                  </span>
                                </div>
                                <div style={{ padding: '12px 16px', background: '#dcfce7', borderBottom: '4px solid #10b981', display: 'flex', justifyContent: 'space-between', fontWeight: '700', marginTop: '4px' }}>
                                  <span style={{ color: '#166534', fontSize: '16px' }}>NET INCOME</span>
                                  <span style={{ color: '#166534', fontFamily: 'monospace', fontSize: '16px' }}>
                                    ${netIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                  </span>
                                </div>
                              </>
                            )}
                          </>
                        );
                      })()}
                    </div>
                  ) : (
                    <div style={{ padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '14px' }}>
                      No mappings saved yet. Generate and save mappings above to see them here.
                    </div>
                  )}
                </div>

                {/* Balance Sheet Structure */}
                <div>
                  <div style={{ marginBottom: '20px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '8px', paddingBottom: '12px', borderBottom: '3px solid #10b981' }}>Balance Sheet Fields</h2>
                    {qbRawData?.balanceSheet?.Header && (
                      <div style={{ fontSize: '13px', marginTop: '8px' }}>
                        <div style={{ color: '#64748b' }}>
                          As of: {qbRawData.balanceSheet.Header.Time || qbRawData.balanceSheet.Header.EndPeriod || 'N/A'}
                        </div>
                        <div style={{ color: '#3b82f6', fontWeight: '500', fontSize: '12px', marginTop: '4px' }}>
                          ðŸ“Š Balance Sheet shows point-in-time snapshot as of the date above
                        </div>
                      </div>
                    )}
                  </div>
                  
                  {aiMappings.length > 0 ? (
                    <div style={{ fontSize: '13px' }}>
                      {/* Group mappings by category */}
                      {(() => {
                        // Deduplicate mappings by QB account name (keep first occurrence)
                        const uniqueMappings = aiMappings.filter((m, index, self) =>
                          index === self.findIndex((t) => t.qbAccount === m.qbAccount)
                        );
                        
                        const assetMappings = uniqueMappings.filter(m => m.qbAccountClassification?.includes('Asset'));
                        const currentAssetMappings = assetMappings.filter(m => m.qbAccountClassification?.includes('Current'));
                        const fixedAssetMappings = assetMappings.filter(m => m.qbAccountClassification?.includes('Fixed') || m.qbAccountClassification?.includes('Property'));
                        const otherAssetMappings = assetMappings.filter(m => !m.qbAccountClassification?.includes('Current') && !m.qbAccountClassification?.includes('Fixed') && !m.qbAccountClassification?.includes('Property'));
                        
                        const liabilityMappings = uniqueMappings.filter(m => m.qbAccountClassification?.includes('Liability'));
                        const currentLiabMappings = liabilityMappings.filter(m => m.qbAccountClassification?.includes('Current'));
                        const longTermLiabMappings = liabilityMappings.filter(m => m.qbAccountClassification?.includes('Long') || !m.qbAccountClassification?.includes('Current'));
                        
                        const equityMappings = uniqueMappings.filter(m => m.qbAccountClassification?.includes('Equity'));
                        
                        // Helper to get amount from balance sheet - extract from the appropriate column
                        const getBSAmount = (qbAccountName: string) => {
                          if (!qbRawData) return 0;
                          const extractRows = (reportData: any) => {
                            const result: any[] = [];
                            if (!reportData || !reportData.Rows || !reportData.Rows.Row) return result;
                            
                            const processRow = (row: any) => {
                              if (row.type === 'Data' && row.ColData) {
                                const name = row.ColData[0]?.value || '';
                                if (name) {
                                  // Try to find a numeric value from the columns
                                  // Start from the end and work backwards to find the first valid number
                                  let value = 0;
                                  for (let i = row.ColData.length - 1; i >= 1; i--) {
                                    const colValue = row.ColData[i]?.value;
                                    if (colValue !== undefined && colValue !== '' && !isNaN(parseFloat(colValue))) {
                                      value = parseFloat(colValue);
                                      break;
                                    }
                                  }
                                  result.push({ name, value });
                                }
                              }
                              if (row.Rows && row.Rows.Row) {
                                const subRows = Array.isArray(row.Rows.Row) ? row.Rows.Row : [row.Rows.Row];
                                subRows.forEach((r: any) => processRow(r));
                              }
                            };
                            const rows = Array.isArray(reportData.Rows.Row) ? reportData.Rows.Row : [reportData.Rows.Row];
                            rows.forEach((r: any) => processRow(r));
                            return result;
                          };
                          const bsRows = extractRows(qbRawData.balanceSheet);
                          const accountRow = bsRows.find((row: any) => row.name === qbAccountName);
                          return accountRow ? accountRow.value : 0;
                        };
                        
                        // Calculate totals
                        const totalCurrentAssets = currentAssetMappings.reduce((sum, m) => sum + getBSAmount(m.qbAccount), 0);
                        const totalFixedAssets = fixedAssetMappings.reduce((sum, m) => sum + getBSAmount(m.qbAccount), 0);
                        const totalOtherAssets = otherAssetMappings.reduce((sum, m) => sum + getBSAmount(m.qbAccount), 0);
                        const totalAssets = totalCurrentAssets + totalFixedAssets + totalOtherAssets;
                        
                        const totalCurrentLiab = currentLiabMappings.reduce((sum, m) => sum + getBSAmount(m.qbAccount), 0);
                        const totalLongTermLiab = longTermLiabMappings.reduce((sum, m) => sum + getBSAmount(m.qbAccount), 0);
                        const totalLiabilities = totalCurrentLiab + totalLongTermLiab;
                        
                        const totalEquity = equityMappings.reduce((sum, m) => sum + getBSAmount(m.qbAccount), 0);
                        const totalLiabAndEquity = totalLiabilities + totalEquity;
                        
                        return (
                          <>
                            {/* ASSETS SECTION */}
                            <div style={{ padding: '8px', background: '#1e40af', fontWeight: '700', borderBottom: '2px solid #1e3a8a', color: 'white' }}>ASSETS</div>
                            
                            {currentAssetMappings.length > 0 && (
                              <>
                                <div style={{ padding: '6px 16px', background: '#eff6ff', fontWeight: '600', borderBottom: '1px solid #dbeafe', color: '#1e40af' }}>Current Assets</div>
                                {currentAssetMappings.map((m, i) => {
                                  const amount = getBSAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {fixedAssetMappings.length > 0 && (
                              <>
                                <div style={{ padding: '6px 16px', background: '#eff6ff', fontWeight: '600', borderBottom: '1px solid #dbeafe', color: '#1e40af', marginTop: '8px' }}>Fixed Assets</div>
                                {fixedAssetMappings.map((m, i) => {
                                  const amount = getBSAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {otherAssetMappings.length > 0 && (
                              <>
                                <div style={{ padding: '6px 16px', background: '#eff6ff', fontWeight: '600', borderBottom: '1px solid #dbeafe', color: '#1e40af', marginTop: '8px' }}>Other Assets</div>
                                {otherAssetMappings.map((m, i) => {
                                  const amount = getBSAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {/* LIABILITIES SECTION */}
                            <div style={{ padding: '8px', background: '#991b1b', fontWeight: '700', borderBottom: '2px solid #7f1d1d', color: 'white', marginTop: '16px' }}>LIABILITIES</div>
                            
                            {currentLiabMappings.length > 0 && (
                              <>
                                <div style={{ padding: '6px 16px', background: '#fef2f2', fontWeight: '600', borderBottom: '1px solid #fee2e2', color: '#991b1b' }}>Current Liabilities</div>
                                {currentLiabMappings.map((m, i) => {
                                  const amount = getBSAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {longTermLiabMappings.length > 0 && (
                              <>
                                <div style={{ padding: '6px 16px', background: '#fef2f2', fontWeight: '600', borderBottom: '1px solid #fee2e2', color: '#991b1b', marginTop: '8px' }}>Long-Term Liabilities</div>
                                {longTermLiabMappings.map((m, i) => {
                                  const amount = getBSAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {/* EQUITY SECTION */}
                            {equityMappings.length > 0 && (
                              <>
                                <div style={{ padding: '8px', background: '#166534', fontWeight: '700', borderBottom: '2px solid #14532d', color: 'white', marginTop: '16px' }}>EQUITY</div>
                                {equityMappings.map((m, i) => {
                                  const amount = getBSAmount(m.qbAccount);
                                  return (
                                    <div key={i} style={{ padding: '6px 16px 6px 32px', borderBottom: '1px solid #f1f5f9', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <div>
                                        <div style={{ color: '#475569', fontSize: '13px' }}>{m.qbAccount}</div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>? {m.targetField}</div>
                                      </div>
                                      <span style={{ color: '#0f172a', fontFamily: 'monospace', fontWeight: '600' }}>
                                        ${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                      </span>
                                    </div>
                                  );
                                })}
                              </>
                            )}
                            
                            {/* TOTAL LIABILITIES & EQUITY */}
                            <div style={{ padding: '12px 16px', background: '#8b5cf6', borderBottom: '4px solid #6b21a8', display: 'flex', justifyContent: 'space-between', fontWeight: '700', marginTop: '8px' }}>
                              <span style={{ color: 'white', fontSize: '16px' }}>TOTAL LIABILITIES & EQUITY</span>
                              <span style={{ color: 'white', fontFamily: 'monospace', fontSize: '16px' }}>
                                ${totalLiabAndEquity.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                              </span>
                            </div>
                            
                            {/* Balance Check */}
                            {Math.abs(totalAssets - totalLiabAndEquity) > 0.01 && (
                              <div style={{ padding: '10px 16px', background: '#fef2f2', border: '2px solid #ef4444', marginTop: '8px', borderRadius: '6px' }}>
                                <span style={{ color: '#991b1b', fontWeight: '600' }}>?? Balance Check: Assets and Liabilities+Equity do not match!</span>
                              </div>
                            )}
                          </>
                        );
                      })()}
                    </div>
                  ) : (
                    <div style={{ padding: '20px', textAlign: 'center', color: '#94a3b8', fontSize: '14px' }}>
                      No mappings saved yet. Generate and save mappings above to see them here.
                    </div>
                  )}
                </div>
              </div>
            </div>
            </div>
            {/* End hidden section */}
            </>
            )}

            {/* Line of Business Reporting Tab */}
            {financialStatementsTab === 'line-of-business' && (
              <LOBReportingTab
                company={company}
                selectedCompanyId={selectedCompanyId}
                accountMappings={aiMappings}
                statementType={statementType}
                selectedLineOfBusiness={selectedLineOfBusiness}
                statementPeriod={statementPeriod}
                statementDisplay={statementDisplay}
                onStatementTypeChange={setStatementType}
                onLineOfBusinessChange={setSelectedLineOfBusiness}
                onPeriodChange={setStatementPeriod}
                onDisplayChange={setStatementDisplay}
              />
            )}
          </div>
        );
      })()}

      {/* Financial Statements View - Works with CSV or QB data via monthly array */}
      {currentView === 'financial-statements' && selectedCompanyId && monthly.length > 0 && (
        <div style={{ maxWidth: '1800px', margin: '0 auto', padding: '32px' }}>
          <style>{`
            @media print {
              @page {
                size: portrait;
                margin: 0.2in 0.3in;
              }
              
              /* Hide all navigation and controls */
              .no-print,
              header,
              nav,
              aside,
              button,
              [role="navigation"] {
                display: none !important;
              }
              
              /* Remove all visual styling that takes space */
              * {
                box-shadow: none !important;
                border-radius: 0 !important;
              }
              
              /* Aggressively compress spacing */
              body, html {
                margin: 0 !important;
                padding: 0 !important;
              }
              
              /* Reduce all padding and margins */
              div {
                padding-top: 2px !important;
                padding-bottom: 2px !important;
                margin-top: 2px !important;
                margin-bottom: 2px !important;
              }
              
              /* Compress header section */
              div[style*="marginBottom: '32px'"] {
                margin-bottom: 4px !important;
                padding-bottom: 4px !important;
              }
              
              /* Compress blue/colored boxes (Gross Profit, Operating Income, etc) */
              div[style*="background: '#dbeafe'"],
              div[style*="background: '#dcfce7'"],
              div[style*="background: '#fef3c7'"] {
                padding: 4px 8px !important;
                margin: 2px 0 !important;
              }
              
              /* Reduce font sizes across the board */
              h2 {
                font-size: 14px !important;
                margin: 0 0 2px 0 !important;
                padding: 0 !important;
              }
              
              div[style*="fontSize: '24px'"] {
                font-size: 14px !important;
              }
              
              div[style*="fontSize: '14px'"],
              span[style*="fontSize: '14px'"] {
                font-size: 10px !important;
              }
              
              div[style*="fontSize: '13px'"],
              span[style*="fontSize: '13px'"] {
                font-size: 9px !important;
              }
              
              /* Reduce line item spacing */
              div[style*="padding: '6px 0 6px 20px'"],
              div[style*="padding: '8px 0'"] {
                padding: 2px 0 2px 12px !important;
                line-height: 1.1 !important;
              }
              
              /* Remove extra spacing from sections */
              div[style*="marginBottom: '12px'"] {
                margin-bottom: 2px !important;
              }
              
              /* Compress section headers */
              div[style*="marginBottom: '8px'"] {
                margin-bottom: 2px !important;
              }
              
              /* Keep sections together */
              div[style*="Cost of Goods Sold"],
              div[style*="Operating Expenses"],
              div[style*="Other Income"] {
                page-break-inside: avoid !important;
              }
            }
          `}</style>
          
          <div className="no-print" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Financial Statements</h1>
            {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
          </div>
          <p className="no-print" style={{ fontSize: '14px', color: '#64748b', marginBottom: '12px' }}>
            Based on imported financial data
          </p>

          {/* Tab Navigation */}
          <div className="no-print" style={{ display: 'flex', gap: '8px', marginBottom: '12px', borderBottom: '2px solid #e2e8f0' }}>
            <button
              onClick={() => setFinancialStatementsTab('aggregated')}
              style={{
                padding: '12px 24px',
                background: financialStatementsTab === 'aggregated' ? '#667eea' : 'transparent',
                color: financialStatementsTab === 'aggregated' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: financialStatementsTab === 'aggregated' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Aggregated Financials
            </button>
            <button
              onClick={() => setFinancialStatementsTab('line-of-business')}
              style={{
                padding: '12px 24px',
                background: financialStatementsTab === 'line-of-business' ? '#667eea' : 'transparent',
                color: financialStatementsTab === 'line-of-business' ? 'white' : '#64748b',
                border: 'none',
                borderBottom: financialStatementsTab === 'line-of-business' ? '3px solid #667eea' : '3px solid transparent',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                borderRadius: '8px 8px 0 0',
                transition: 'all 0.2s'
              }}
            >
              Line of Business Reporting
            </button>
          </div>

          {/* Aggregated Financials Tab */}
          {financialStatementsTab === 'aggregated' && (
          <>
          {/* Statement Controls */}
          <div className="no-print" style={{ marginBottom: '32px', padding: '24px', background: 'white', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px' }}>
              {/* Type of Statement */}
              <div>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                  Type of Statement
                </label>
                <select 
                  value={statementType}
                  onChange={(e) => setStatementType(e.target.value as any)}
                  style={{ 
                    width: '100%', 
                    padding: '10px 12px', 
                    border: '1px solid #cbd5e1', 
                    borderRadius: '6px', 
                    fontSize: '14px',
                    color: '#1e293b',
                    background: 'white',
                    cursor: 'pointer'
                  }}
                >
                  <option value="income-statement">Income Statement</option>
                  <option value="income-statement-percent">Income Stmt as % of Revenue</option>
                  <option value="balance-sheet">Balance Sheet</option>
                </select>
              </div>

              {/* Period */}
              <div>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                  Period
                </label>
                <select 
                  value={statementPeriod}
                  onChange={(e) => setStatementPeriod(e.target.value as any)}
                  style={{ 
                    width: '100%', 
                    padding: '10px 12px', 
                    border: '1px solid #cbd5e1', 
                    borderRadius: '6px', 
                    fontSize: '14px',
                    color: '#1e293b',
                    background: 'white',
                    cursor: 'pointer'
                  }}
                >
                  <option value="current-month">Current Month</option>
                  <option value="current-quarter">Current Quarter</option>
                  <option value="last-12-months">Last 12 months</option>
                  <option value="ytd">YTD</option>
                  <option value="last-year">Last Year</option>
                  <option value="last-3-years">Last 3 Years</option>
                </select>
              </div>

              {/* Display As */}
              <div>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                  Display As
                </label>
                <select 
                  value={statementDisplay}
                  onChange={(e) => setStatementDisplay(e.target.value as 'monthly' | 'quarterly' | 'annual')}
                  style={{ 
                    width: '100%', 
                    padding: '10px 12px', 
                    border: '1px solid #cbd5e1', 
                    borderRadius: '6px', 
                    fontSize: '14px',
                    color: '#1e293b',
                    background: 'white',
                    cursor: 'pointer'
                  }}
                >
                  <option value="monthly">Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="annual">Annual</option>
                </select>
              </div>
              
              {/* Print Button */}
              <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                <button
                  onClick={() => window.print()}
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    background: '#10b981',
                    color: 'white',
                    border: 'none',
                    borderRadius: '6px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                >
                  ðŸ–¨ï¸ Print
                </button>
              </div>
            </div>
          </div>

          {/* Statement Content Area */}
          {(() => {
            console.log('ðŸ“Š Financial Statement Render Check (CSV/Monthly Data):', {
              statementType,
              statementPeriod,
              monthlyLength: monthly?.length || 0,
              monthlyFirst: monthly?.[0],
              condition: statementType === 'income-statement' && statementPeriod === 'current-month'
            });
            
            if (statementType === 'income-statement' && statementPeriod === 'current-month') {
              const currentMonth = monthly[monthly.length - 1];
              const monthDate = new Date(currentMonth.date || currentMonth.month);
              const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

              // Revenue
              const revenue = currentMonth.revenue || 0;

              // Cost of Goods Sold
              const cogsPayroll = currentMonth.cogsPayroll || 0;
              const cogsOwnerPay = currentMonth.cogsOwnerPay || 0;
              const cogsContractors = currentMonth.cogsContractors || 0;
              const cogsMaterials = currentMonth.cogsMaterials || 0;
              const cogsCommissions = currentMonth.cogsCommissions || 0;
              const cogsOther = currentMonth.cogsOther || 0;
              const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;

              const grossProfit = revenue - cogs;
              const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

              // Operating Expenses - All fields that have data from DataReviewTab
              const payroll = currentMonth.payroll || 0;
              const benefits = currentMonth.benefits || 0;
              const insurance = currentMonth.insurance || 0;
              const professionalFees = currentMonth.professionalFees || 0;
              const subcontractors = currentMonth.subcontractors || 0;
              const rent = currentMonth.rent || 0;
              const taxLicense = currentMonth.taxLicense || 0;
              const phoneComm = currentMonth.phoneComm || 0;
              const infrastructure = currentMonth.infrastructure || 0;
              const autoTravel = currentMonth.autoTravel || 0;
              const salesExpense = currentMonth.salesExpense || 0;
              const marketing = currentMonth.marketing || 0;
              const mealsEntertainment = currentMonth.mealsEntertainment || 0;
              const otherExpense = currentMonth.otherExpense || 0;

              // Calculate total operating expenses including all expense fields from DataReviewTab
              const totalOpex = payroll + benefits + insurance + professionalFees + subcontractors +
                               rent + taxLicense + phoneComm + infrastructure + autoTravel +
                               salesExpense + marketing + mealsEntertainment + otherExpense;

              const operatingIncome = grossProfit - totalOpex;
              const operatingMargin = revenue > 0 ? (operatingIncome / revenue) * 100 : 0;
              
              // Other Income/Expense
              const interestExpense = currentMonth.interestExpense || 0;
              const nonOperatingIncome = currentMonth.nonOperatingIncome || 0;
              const extraordinaryItems = currentMonth.extraordinaryItems || 0;
              
              const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
              const netMargin = revenue > 0 ? (netIncome / revenue) * 100 : 0;
              
              return (
                <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Income Statement</h2>
                    <div style={{ fontSize: '14px', color: '#64748b' }}>For the Month Ended {monthName}</div>
                  </div>

                  {/* Revenue Section */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e2e8f0' }}>
                      <span style={{ fontWeight: '600', color: '#1e293b' }}>Revenue</span>
                      <span style={{ fontWeight: '600', color: '#1e293b' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                  </div>

                  {/* COGS Section */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Cost of Goods Sold</div>
                    {cogsPayroll > 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>COGS - Payroll</span>
                        <span style={{ color: '#475569' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {cogsOwnerPay > 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>COGS - Owner Pay</span>
                        <span style={{ color: '#475569' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {cogsContractors > 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>COGS - Contractors</span>
                        <span style={{ color: '#475569' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {cogsMaterials > 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>COGS - Materials</span>
                        <span style={{ color: '#475569' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {cogsCommissions > 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>COGS - Commissions</span>
                        <span style={{ color: '#475569' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {cogsOther > 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>COGS - Other</span>
                        <span style={{ color: '#475569' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                      <span style={{ fontWeight: '600', color: '#1e293b' }}>Total COGS</span>
                      <span style={{ fontWeight: '600', color: '#1e293b' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                  </div>

                  {/* Gross Profit */}
                  <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                      <span style={{ fontWeight: '700', color: '#1e40af' }}>Gross Profit</span>
                      <span style={{ fontWeight: '700', color: '#1e40af' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                    <div style={{ fontSize: '13px', color: '#1e40af', textAlign: 'right' }}>
                      {grossMargin.toFixed(1)}% margin
                    </div>
                  </div>

                  {/* Operating Expenses - Dynamic Rendering from monthly data */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Operating Expenses</div>
                    {(() => {
                      // Define all possible expense fields with their display names
                      const expenseFields = [
                        // Operating Expenses - Complete list in correct order
                        { key: 'payroll', label: 'Payroll' },
                        { key: 'benefits', label: 'Benefits' },
                        { key: 'insurance', label: 'Insurance' },
                        { key: 'professionalFees', label: 'Professional Services' },
                        { key: 'subcontractors', label: 'Subcontractors' },
                        { key: 'rent', label: 'Rent/Lease' },
                        { key: 'taxLicense', label: 'Tax & License' },
                        { key: 'phoneComm', label: 'Phone & Communication' },
                        { key: 'infrastructure', label: 'Infrastructure/Utilities' },
                        { key: 'autoTravel', label: 'Auto & Travel' },
                        { key: 'salesExpense', label: 'Sales & Marketing' },
                        { key: 'marketing', label: 'Marketing' },
                        { key: 'mealsEntertainment', label: 'Meals & Entertainment' },
                        { key: 'otherExpense', label: 'Other Expenses' }
                      ];

                      // Calculate total operating expenses dynamically
                      const totalOpex = expenseFields.reduce((sum, field) => {
                        return sum + (currentMonth[field.key as keyof typeof currentMonth] || 0);
                      }, 0);

                      return (
                        <>
                          {expenseFields.map(field => {
                            const value = currentMonth[field.key as keyof typeof currentMonth] || 0;
                            if (value > 0) {
                              return (
                                <div key={field.key} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                                  <span style={{ color: '#475569' }}>{field.label}</span>
                                  <span style={{ color: '#475569' }}>${value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                                </div>
                              );
                            }
                            return null;
                          })}
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Operating Expenses</span>
                            <span style={{ fontWeight: '600', color: '#1e293b' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        </>
                      );
                    })()}
                  </div>

                  {/* Operating Income */}
                  <div style={{ marginBottom: '12px', background: '#f0fdf4', padding: '12px', borderRadius: '8px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                      <span style={{ fontWeight: '700', color: '#166534' }}>Operating Income</span>
                      <span style={{ fontWeight: '700', color: '#166534' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                    <div style={{ fontSize: '13px', color: '#166534', textAlign: 'right' }}>
                      {operatingMargin.toFixed(1)}% margin
                    </div>
                  </div>

                  {/* Other Income/Expense */}
                  {(interestExpense > 0 || nonOperatingIncome > 0 || extraordinaryItems !== 0) && (
                    <div style={{ marginBottom: '12px' }}>
                      <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Other Income/(Expense)</div>
                      {nonOperatingIncome > 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Non-Operating Income</span>
                          <span style={{ color: '#10b981' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {interestExpense > 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Interest Expense</span>
                          <span style={{ color: '#ef4444' }}>($  {interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                        </div>
                      )}
                      {extraordinaryItems !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Extraordinary Items</span>
                          <span style={{ color: extraordinaryItems >= 0 ? '#10b981' : '#ef4444' }}>
                            {extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}
                          </span>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Net Income */}
                  <div style={{ background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>Net Income</span>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>
                        ${netIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                      </span>
                    </div>
                    <div style={{ fontSize: '14px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                      {netMargin.toFixed(1)}% net margin
                    </div>
                  </div>
                </div>
              );
            } else if (statementType === 'income-statement-percent' && statementPeriod === 'current-month') {
              // Copy the entire common size logic from QB version
              const currentMonth = monthly[monthly.length - 1];
              const monthDate = new Date(currentMonth.date || currentMonth.month);
              const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
              
              // Revenue
              const revenue = currentMonth.revenue || 0;
              
              // Cost of Goods Sold
              const cogsPayroll = currentMonth.cogsPayroll || 0;
              const cogsOwnerPay = currentMonth.cogsOwnerPay || 0;
              const cogsContractors = currentMonth.cogsContractors || 0;
              const cogsMaterials = currentMonth.cogsMaterials || 0;
              const cogsCommissions = currentMonth.cogsCommissions || 0;
              const cogsOther = currentMonth.cogsOther || 0;
              const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
              
              const grossProfit = revenue - cogs;
              const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;
              
              // Operating Expenses - All fields that have data from DataReviewTab
              const payroll = currentMonth.payroll || 0;
              const benefits = currentMonth.benefits || 0;
              const insurance = currentMonth.insurance || 0;
              const professionalFees = currentMonth.professionalFees || 0;
              const subcontractors = currentMonth.subcontractors || 0;
              const rent = currentMonth.rent || 0;
              const taxLicense = currentMonth.taxLicense || 0;
              const phoneComm = currentMonth.phoneComm || 0;
              const infrastructure = currentMonth.infrastructure || 0;
              const autoTravel = currentMonth.autoTravel || 0;
              const salesExpense = currentMonth.salesExpense || 0;
              const marketing = currentMonth.marketing || 0;
              const mealsEntertainment = currentMonth.mealsEntertainment || 0;
              const otherExpense = currentMonth.otherExpense || 0;

              // totalOpex is now calculated dynamically in the expense rendering section
              const totalOpex = 0; // Placeholder - calculated dynamically below
              
              const operatingIncome = grossProfit - totalOpex;
              const operatingMargin = revenue > 0 ? (operatingIncome / revenue) * 100 : 0;
              
              // Other Income/Expense
              const interestExpense = currentMonth.interestExpense || 0;
              const nonOperatingIncome = currentMonth.nonOperatingIncome || 0;
              const extraordinaryItems = currentMonth.extraordinaryItems || 0;
              
              const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
              const netMargin = revenue > 0 ? (netIncome / revenue) * 100 : 0;
              
              // Helper function to calculate percentage
              const pct = (amount: number) => revenue > 0 ? (amount / revenue) * 100 : 0;
              
              return (
                <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Income Statement - Common Size Analysis</h2>
                    <div style={{ fontSize: '14px', color: '#64748b' }}>For the Month Ended {monthName} - All items shown as % of Revenue</div>
                  </div>

                  {/* Column Headers */}
                  <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderBottom: '2px solid #cbd5e1', marginBottom: '12px', fontWeight: '600', fontSize: '13px', color: '#475569' }}>
                    <div>Line Item</div>
                    <div style={{ textAlign: 'right' }}>Amount</div>
                    <div style={{ textAlign: 'right' }}>% of Revenue</div>
                  </div>

                  {/* Revenue Section */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderBottom: '1px solid #e2e8f0', background: '#f8fafc' }}>
                      <span style={{ fontWeight: '600', color: '#1e293b' }}>Revenue</span>
                      <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>100.0%</span>
                    </div>
                  </div>

                  {/* COGS Section */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Cost of Goods Sold</div>
                    {cogsPayroll > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Payroll</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsPayroll).toFixed(1)}%</span>
                      </div>
                    )}
                    {cogsOwnerPay > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Owner Pay</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsOwnerPay).toFixed(1)}%</span>
                      </div>
                    )}
                    {cogsContractors > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Contractors</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsContractors).toFixed(1)}%</span>
                      </div>
                    )}
                    {cogsMaterials > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Materials</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsMaterials).toFixed(1)}%</span>
                      </div>
                    )}
                    {cogsCommissions > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Commissions</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsCommissions).toFixed(1)}%</span>
                      </div>
                    )}
                    {cogsOther > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>COGS - Other</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(cogsOther).toFixed(1)}%</span>
                      </div>
                    )}
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                      <span style={{ fontWeight: '600', color: '#1e293b', paddingLeft: '20px' }}>Total COGS</span>
                      <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>{pct(cogs).toFixed(1)}%</span>
                    </div>
                  </div>

                  {/* Gross Profit */}
                  <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr' }}>
                      <span style={{ fontWeight: '700', color: '#1e40af' }}>Gross Profit</span>
                      <span style={{ fontWeight: '700', color: '#1e40af', textAlign: 'right' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      <span style={{ fontWeight: '700', color: '#1e40af', textAlign: 'right' }}>{grossMargin.toFixed(1)}%</span>
                    </div>
                  </div>

                  {/* Operating Expenses */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Operating Expenses</div>
                    {payroll > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Payroll</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${payroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(payroll).toFixed(1)}%</span>
                      </div>
                    )}
                    {benefits > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Benefits</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${benefits.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(benefits).toFixed(1)}%</span>
                      </div>
                    )}
                    {insurance > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Insurance</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${insurance.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(insurance).toFixed(1)}%</span>
                      </div>
                    )}
                    {professionalFees > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Professional Services</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${professionalFees.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(professionalFees).toFixed(1)}%</span>
                      </div>
                    )}
                    {subcontractors > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Subcontractors</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${subcontractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(subcontractors).toFixed(1)}%</span>
                      </div>
                    )}
                    {rent > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Rent/Lease</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${rent.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(rent).toFixed(1)}%</span>
                      </div>
                    )}
                    {taxLicense > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Tax & License</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${taxLicense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(taxLicense).toFixed(1)}%</span>
                      </div>
                    )}
                    {phoneComm > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Phone & Communication</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${phoneComm.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(phoneComm).toFixed(1)}%</span>
                      </div>
                    )}
                    {infrastructure > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Infrastructure/Utilities</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(infrastructure).toFixed(1)}%</span>
                      </div>
                    )}
                    {autoTravel > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Auto & Travel</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${autoTravel.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(autoTravel).toFixed(1)}%</span>
                      </div>
                    )}
                    {salesExpense > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Sales & Marketing</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${salesExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(salesExpense).toFixed(1)}%</span>
                      </div>
                    )}
                    {marketing > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Marketing</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${marketing.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(marketing).toFixed(1)}%</span>
                      </div>
                    )}
                    {mealsEntertainment > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Meals & Entertainment</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${mealsEntertainment.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(mealsEntertainment).toFixed(1)}%</span>
                      </div>
                    )}
                    {otherExpense > 0 && (
                      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569', paddingLeft: '20px' }}>Other Expenses</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>${otherExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        <span style={{ color: '#475569', textAlign: 'right' }}>{pct(otherExpense).toFixed(1)}%</span>
                      </div>
                    )}
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                      <span style={{ fontWeight: '600', color: '#1e293b', paddingLeft: '20px' }}>Total Operating Expenses</span>
                      <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      <span style={{ fontWeight: '600', color: '#1e293b', textAlign: 'right' }}>{pct(totalOpex).toFixed(1)}%</span>
                    </div>
                  </div>

                  {/* Operating Income */}
                  <div style={{ marginBottom: '12px', background: '#f0fdf4', padding: '12px', borderRadius: '8px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr' }}>
                      <span style={{ fontWeight: '700', color: '#166534' }}>Operating Income</span>
                      <span style={{ fontWeight: '700', color: '#166534', textAlign: 'right' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      <span style={{ fontWeight: '700', color: '#166534', textAlign: 'right' }}>{operatingMargin.toFixed(1)}%</span>
                    </div>
                  </div>

                  {/* Other Income/Expense */}
                  {(interestExpense > 0 || nonOperatingIncome > 0 || extraordinaryItems !== 0) && (
                    <div style={{ marginBottom: '12px' }}>
                      <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Other Income/(Expense)</div>
                      {nonOperatingIncome > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Non-Operating Income</span>
                          <span style={{ color: '#10b981', textAlign: 'right' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          <span style={{ color: '#10b981', textAlign: 'right' }}>{pct(nonOperatingIncome).toFixed(1)}%</span>
                        </div>
                      )}
                      {interestExpense > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Interest Expense</span>
                          <span style={{ color: '#ef4444', textAlign: 'right' }}>($  {interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                          <span style={{ color: '#ef4444', textAlign: 'right' }}>({pct(interestExpense).toFixed(1)}%)</span>
                        </div>
                      )}
                      {extraordinaryItems !== 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', padding: '6px 0', fontSize: '14px' }}>
                          <span style={{ color: '#475569', paddingLeft: '20px' }}>Extraordinary Items</span>
                          <span style={{ color: extraordinaryItems >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                            {extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}
                          </span>
                          <span style={{ color: extraordinaryItems >= 0 ? '#10b981' : '#ef4444', textAlign: 'right' }}>
                            {extraordinaryItems >= 0 ? '' : '('}{pct(Math.abs(extraordinaryItems)).toFixed(1)}%{extraordinaryItems < 0 ? ')' : ''}
                          </span>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Net Income */}
                  <div style={{ background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr' }}>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>Net Income</span>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                        ${netIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                      </span>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                        {netMargin.toFixed(1)}%
                      </span>
                    </div>
                  </div>
                </div>
              );
            } else if (statementType === 'balance-sheet' && statementPeriod === 'current-month') {
              const currentMonth = monthly[monthly.length - 1];
              const monthDate = new Date(currentMonth.date || currentMonth.month);
              const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
              
                // Assets - Use imported totals directly from CSV
                const cash = currentMonth.cash || 0;
                const ar = currentMonth.ar || 0;
                const inventory = currentMonth.inventory || 0;
                const otherCA = currentMonth.otherCA || 0;
                const tca = currentMonth.tca || 0;  // Use imported total, don't calculate
                
                const fixedAssets = currentMonth.fixedAssets || 0;
                const otherAssets = currentMonth.otherAssets || 0;
                const totalAssets = currentMonth.totalAssets || 0;  // Use imported total, don't calculate
                
                // Liabilities - Use imported totals directly from CSV
                const ap = currentMonth.ap || 0;
                const otherCL = currentMonth.otherCL || 0;
                const tcl = currentMonth.tcl || 0;  // Use imported total, don't calculate
                
                const ltd = currentMonth.ltd || 0;
                const totalLiabilities = currentMonth.totalLiab || 0;  // Use imported total, don't calculate
              
              // Equity - Get detail fields
              const ownersCapital = currentMonth.ownersCapital || 0;
              const ownersDraw = currentMonth.ownersDraw || 0;
              const commonStock = currentMonth.commonStock || 0;
              const preferredStock = currentMonth.preferredStock || 0;
              const retainedEarnings = currentMonth.retainedEarnings || 0;
              const additionalPaidInCapital = currentMonth.additionalPaidInCapital || 0;
              const treasuryStock = currentMonth.treasuryStock || 0;
              
              // Calculate total equity from components to match Data Review page (do NOT use imported totalEquity)
              const totalEquity = ownersCapital + ownersDraw + commonStock + preferredStock + retainedEarnings + additionalPaidInCapital + treasuryStock;
              
              // Calculate Total Liabilities & Equity to match Data Review page (do NOT use imported totalLAndE)
              const totalLAndE = totalLiabilities + totalEquity;
              
              return (
                <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                  <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Balance Sheet</h2>
                    <div style={{ fontSize: '14px', color: '#64748b' }}>As of {monthName}</div>
                  </div>

                  {/* ASSETS */}
                  <div style={{ marginBottom: '32px' }}>
                    <div style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #667eea' }}>ASSETS</div>
                    
                    {/* Current Assets */}
                    <div style={{ marginBottom: '20px' }}>
                      <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Current Assets</div>
                      {cash !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Cash</span>
                          <span style={{ color: '#475569' }}>${cash.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {ar !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Accounts Receivable</span>
                          <span style={{ color: '#475569' }}>${ar.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {inventory !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Inventory</span>
                          <span style={{ color: '#475569' }}>${inventory.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {otherCA !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Other Current Assets</span>
                          <span style={{ color: '#475569' }}>${otherCA.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 20px', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                        <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Current Assets</span>
                        <span style={{ fontWeight: '600', color: '#1e293b' }}>${tca.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    </div>

                    {/* Non-Current Assets */}
                    {fixedAssets !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Fixed Assets</span>
                        <span style={{ color: '#475569' }}>${fixedAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {otherAssets !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Other Assets</span>
                        <span style={{ color: '#475569' }}>${otherAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #667eea', marginTop: '8px', background: '#f8fafc' }}>
                      <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>TOTAL ASSETS</span>
                      <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>${totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                  </div>

                  {/* LIABILITIES */}
                  <div style={{ marginBottom: '32px' }}>
                    <div style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #f59e0b' }}>LIABILITIES</div>
                    
                    {/* Current Liabilities */}
                    <div style={{ marginBottom: '20px' }}>
                      <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px', fontSize: '15px' }}>Current Liabilities</div>
                      {ap !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Accounts Payable</span>
                          <span style={{ color: '#475569' }}>${ap.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {otherCL !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#475569' }}>Other Current Liabilities</span>
                          <span style={{ color: '#475569' }}>${otherCL.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 20px', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                        <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Current Liabilities</span>
                        <span style={{ fontWeight: '600', color: '#1e293b' }}>${tcl.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    </div>

                    {/* Long-term Debt */}
                    {ltd !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Long-term Debt</span>
                        <span style={{ color: '#475569' }}>${ltd.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #f59e0b', marginTop: '8px', background: '#fef3c7' }}>
                      <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>TOTAL LIABILITIES</span>
                      <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>${totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                  </div>

                  {/* EQUITY */}
                  <div style={{ marginBottom: '12px' }}>
                    <div style={{ fontSize: '18px', fontWeight: '700', color: '#1e293b', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #10b981' }}>EQUITY</div>
                    
                    {/* Equity Detail Fields */}
                    {ownersCapital !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Owner's Capital</span>
                        <span style={{ color: '#475569' }}>${ownersCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {ownersDraw !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Owner's Draw</span>
                        <span style={{ color: '#475569' }}>${ownersDraw.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {commonStock !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Common Stock</span>
                        <span style={{ color: '#475569' }}>${commonStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {preferredStock !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Preferred Stock</span>
                        <span style={{ color: '#475569' }}>${preferredStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {retainedEarnings !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Retained Earnings</span>
                        <span style={{ color: '#475569' }}>${retainedEarnings.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {additionalPaidInCapital !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Additional Paid-In Capital</span>
                        <span style={{ color: '#475569' }}>${additionalPaidInCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    {treasuryStock !== 0 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: '14px' }}>
                        <span style={{ color: '#475569' }}>Treasury Stock</span>
                        <span style={{ color: '#475569' }}>${treasuryStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #10b981', marginTop: '4px', background: '#d1fae5' }}>
                      <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>TOTAL EQUITY</span>
                      <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e293b' }}>${totalEquity.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                    </div>
                  </div>

                  {/* TOTAL LIABILITIES & EQUITY */}
                  <div style={{ background: '#f1f5f9', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>TOTAL LIABILITIES & EQUITY</span>
                      <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>
                        ${totalLAndE.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                      </span>
                    </div>
                    {Math.abs(totalAssets - totalLAndE) > 0.01 && (
                      <div style={{ fontSize: '12px', color: '#ef4444', marginTop: '8px', textAlign: 'right' }}>
                        ?? Balance check: Assets - (Liabilities + Equity) = ${(totalAssets - totalLAndE).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                      </div>
                    )}
                  </div>
                </div>
              );
            }
            
            // Multi-period logic (Current Quarter, Last 12 Months, YTD, Last Year, Last 3 Years)
            else if (monthly.length > 0 && statementPeriod !== 'current-month') {
              // Helper function to get months for the selected period
              const getMonthsForPeriod = () => {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0-11
                
                switch (statementPeriod) {
                  case 'current-quarter':
                    // Last 3 months
                    return monthly.slice(-3);
                  
                  case 'last-12-months':
                    // Last 12 months
                    return monthly.slice(-12);
                  
                  case 'ytd':
                    // Year to date - from January of current year to now
                    return monthly.filter(m => {
                      const mDate = new Date(m.date || m.month);
                      return mDate.getFullYear() === currentYear;
                    });
                  
                  case 'last-year':
                    // Full previous year
                    return monthly.filter(m => {
                      const mDate = new Date(m.date || m.month);
                      return mDate.getFullYear() === currentYear - 1;
                    });
                  
                  case 'last-3-years':
                    // Last 36 months
                    return monthly.slice(-36);
                  
                  default:
                    return [];
                }
              };
              
              const periodMonths = getMonthsForPeriod();
              
              if (periodMonths.length === 0) {
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '48px 32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', minHeight: '400px', textAlign: 'center' }}>
                    <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>
                      ðŸ“Š No Data Available
                    </div>
                    <p style={{ fontSize: '14px', color: '#94a3b8' }}>
                      No financial data available for the selected period.
                    </p>
                  </div>
                );
              }
              
              // Get period label
              const getPeriodLabel = () => {
                const firstMonth = periodMonths[0];
                const lastMonth = periodMonths[periodMonths.length - 1];
                const firstDate = new Date(firstMonth.date || firstMonth.month);
                const lastDate = new Date(lastMonth.date || lastMonth.month);
                
                switch (statementPeriod) {
                  case 'current-quarter':
                    return `Current Quarter (${firstDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${lastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
                  case 'last-12-months':
                    return `Last 12 Months (${firstDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${lastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
                  case 'ytd':
                    return `Year to Date ${lastDate.getFullYear()} (Jan - ${lastDate.toLocaleDateString('en-US', { month: 'short' })})`;
                  case 'last-year':
                    return `Fiscal Year ${firstDate.getFullYear()}`;
                  case 'last-3-years':
                    return `Last 3 Years (${firstDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${lastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
                  default:
                    return '';
                }
              };
              
              const periodLabel = getPeriodLabel();
              const latestMonth = periodMonths[periodMonths.length - 1];
              
              // Helper function to group months by display period
              const groupMonthsByDisplay = () => {
                if (statementDisplay === 'monthly') {
                  // Each month is its own period
                  return periodMonths.map((m, idx) => {
                    const dateValue = m.date || m.month;
                    const dateObj = dateValue ? new Date(dateValue) : new Date();
                    const label = !isNaN(dateObj.getTime()) 
                      ? dateObj.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                      : 'Unknown';
                    
                    // DEBUG: Log first 3 periods
                    if (idx < 3) {
                      console.log(`?? Period ${idx}:`, { 
                        dateValue, 
                        dateObj, 
                        isValid: !isNaN(dateObj.getTime()), 
                        label,
                        fullMonth: m
                      });
                    }
                    
                    return { label, months: [m] };
                  });
                } else if (statementDisplay === 'quarterly') {
                  // Group by quarter
                  const quarters: { [key: string]: any[] } = {};
                  periodMonths.forEach(m => {
                    const dateValue = m.date || m.month;
                    const date = dateValue ? new Date(dateValue) : new Date();
                    if (!isNaN(date.getTime())) {
                      const year = date.getFullYear();
                      const quarter = Math.floor(date.getMonth() / 3) + 1;
                      const key = `Q${quarter} ${year}`;
                      if (!quarters[key]) quarters[key] = [];
                      quarters[key].push(m);
                    }
                  });
                  return Object.entries(quarters).map(([key, months]) => ({
                    label: key,
                    months
                  }));
                } else {
                  // Annual - group by year
                  const years: { [key: string]: any[] } = {};
                  periodMonths.forEach(m => {
                    const dateValue = m.date || m.month;
                    const date = dateValue ? new Date(dateValue) : new Date();
                    if (!isNaN(date.getTime())) {
                      const year = date.getFullYear().toString();
                      if (!years[year]) years[year] = [];
                      years[year].push(m);
                    }
                  });
                  return Object.entries(years).map(([year, months]) => ({
                    label: year,
                    months
                  }));
                }
              };
              
              const displayPeriods = groupMonthsByDisplay();
              
              // INCOME STATEMENT - Aggregate across period
              if (statementType === 'income-statement') {
                // Check if we're showing multiple periods side-by-side
                if (displayPeriods.length > 1) {
                // Multi-column comparative income statement
                const calculatePeriodData = (months: any[]) => {
                  const revenue = months.reduce((sum, m) => sum + (m.revenue || 0), 0);

                  // COGS detailed
                  const cogsPayroll = months.reduce((sum, m) => sum + (m.cogsPayroll || 0), 0);
                  const cogsOwnerPay = months.reduce((sum, m) => sum + (m.cogsOwnerPay || 0), 0);
                  const cogsContractors = months.reduce((sum, m) => sum + (m.cogsContractors || 0), 0);
                  const cogsMaterials = months.reduce((sum, m) => sum + (m.cogsMaterials || 0), 0);
                  const cogsCommissions = months.reduce((sum, m) => sum + (m.cogsCommissions || 0), 0);
                  const cogsOther = months.reduce((sum, m) => sum + (m.cogsOther || 0), 0);
                  const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                  const grossProfit = revenue - cogs;

                  // Dynamically calculate operating expense fields only
                  const expenseFields = [
                    'payroll', 'benefits', 'insurance', 'professionalFees', 'subcontractors',
                    'rent', 'taxLicense', 'phoneComm', 'infrastructure', 'autoTravel',
                    'salesExpense', 'marketing', 'mealsEntertainment', 'otherExpense'
                  ];

                  const expenses: { [key: string]: number } = {};
                  expenseFields.forEach(field => {
                    expenses[field] = months.reduce((sum, m) => sum + (m[field] || 0), 0);
                  });

                  // Calculate total operating expenses dynamically
                  const totalOpex = Object.values(expenses).reduce((sum, value) => sum + value, 0);
                  const operatingIncome = grossProfit - totalOpex;
                  
                  // Other Income/Expense
                  const interestExpense = months.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                  const nonOperatingIncome = months.reduce((sum, m) => sum + (m.nonOperatingIncome || 0), 0);
                  const extraordinaryItems = months.reduce((sum, m) => sum + (m.extraordinaryItems || 0), 0);
                  const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                  
                  return {
                    revenue,
                    cogsPayroll, cogsOwnerPay, cogsContractors, cogsMaterials, cogsCommissions, cogsOther, cogs,
                    grossProfit,
                    ...expenses, // Include all expense fields dynamically
                    totalOpex,
                    operatingIncome,
                    interestExpense, nonOperatingIncome, extraordinaryItems,
                    netIncome
                  };
                };
                  
                  const periodsData = displayPeriods.map(p => ({
                    ...calculatePeriodData(p.months),
                    label: p.label
                  }));
                  
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', overflowX: 'auto' }}>
                      <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Comparative Income Statement</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>{periodLabel} - {statementDisplay === 'monthly' ? 'Monthly' : statementDisplay === 'quarterly' ? 'Quarterly' : 'Annual'}</div>
                      </div>
                      
                      {/* Table with multiple columns */}
                      <div style={{ minWidth: `${200 + (periodsData.length * 110)}px` }}>
                        {/* Header Row */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 0', borderBottom: '2px solid #1e293b', fontWeight: '600', color: '#1e293b', position: 'sticky', top: 0, background: 'white', fontSize: '13px' }}>
                          <div>Line Item</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#1e293b' }}>{p.label || 'N/A'}</div>
                          ))}
                        </div>
                        
                        {/* Revenue */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '8px 0', borderBottom: '1px solid #e2e8f0', fontWeight: '600' }}>
                          <div style={{ color: '#1e293b' }}>Revenue</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#1e293b' }}>${p.revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          ))}
                        </div>
                        
                        {/* COGS Section Header */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 0 4px 0', fontSize: '14px', fontWeight: '600', marginTop: '8px' }}>
                          <div style={{ color: '#475569' }}>Cost of Goods Sold</div>
                          {periodsData.map((p, i) => <div key={i}></div>)}
                        </div>
                        
                        {/* COGS Details */}
                        {periodsData.some(p => p.cogsPayroll > 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>COGS - Payroll</div>
                            {periodsData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                        )}
                        {periodsData.some(p => p.cogsOwnerPay > 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>COGS - Owner Pay</div>
                            {periodsData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                        )}
                        {periodsData.some(p => p.cogsContractors > 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>COGS - Contractors</div>
                            {periodsData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                        )}
                        {periodsData.some(p => p.cogsMaterials > 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>COGS - Materials</div>
                            {periodsData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                        )}
                        {periodsData.some(p => p.cogsCommissions > 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>COGS - Commissions</div>
                            {periodsData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                        )}
                        {periodsData.some(p => p.cogsOther > 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>COGS - Other</div>
                            {periodsData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            ))}
                          </div>
                        )}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '6px 0', fontSize: '14px', fontWeight: '600', borderTop: '1px solid #cbd5e1', marginTop: '4px' }}>
                          <div style={{ color: '#475569' }}>Total COGS</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#475569' }}>${p.cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          ))}
                        </div>
                        
                        {/* Gross Profit */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', marginTop: '8px', fontWeight: '700' }}>
                          <div style={{ color: '#1e40af' }}>Gross Profit</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#1e40af' }}>${p.grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          ))}
                        </div>
                        
                        {/* Operating Expenses Section Header */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 0 4px 0', fontSize: '14px', fontWeight: '600', marginTop: '12px' }}>
                          <div style={{ color: '#475569' }}>Operating Expenses</div>
                          {periodsData.map((p, i) => <div key={i}></div>)}
                        </div>
                        
                        {/* Operating Expenses Details - Dynamic Rendering */}
                        {(() => {
                          // Define all possible expense fields with their display names
                          const expenseFieldDefinitions = [
                            // Operating Expenses - Complete list in correct order
                            { key: 'payroll', label: 'Payroll' },
                            { key: 'benefits', label: 'Benefits' },
                            { key: 'insurance', label: 'Insurance' },
                            { key: 'professionalFees', label: 'Professional Services' },
                            { key: 'subcontractors', label: 'Subcontractors' },
                            { key: 'rent', label: 'Rent/Lease' },
                            { key: 'taxLicense', label: 'Tax & License' },
                            { key: 'phoneComm', label: 'Phone & Communication' },
                            { key: 'infrastructure', label: 'Infrastructure/Utilities' },
                            { key: 'autoTravel', label: 'Auto & Travel' },
                            { key: 'salesExpense', label: 'Sales & Marketing' },
                            { key: 'marketing', label: 'Marketing' },
                            { key: 'mealsEntertainment', label: 'Meals & Entertainment' },
                            { key: 'otherExpense', label: 'Other Expenses' }
                          ];

                          // Render only fields that have values in at least one period
                          return expenseFieldDefinitions.map(fieldDef => {
                            const hasValue = periodsData.some(p => (p[fieldDef.key as keyof typeof p] as number) > 0);
                            if (hasValue) {
                              return (
                                <div key={fieldDef.key} style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                                  <div style={{ color: '#64748b', paddingLeft: '20px' }}>{fieldDef.label}</div>
                                  {periodsData.map((p, i) => (
                                    <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>
                                      ${(p[fieldDef.key as keyof typeof p] as number).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                  ))}
                                </div>
                              );
                            }
                            return null;
                          });
                        })()}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '6px 0', fontSize: '14px', fontWeight: '600', borderTop: '1px solid #cbd5e1', marginTop: '4px' }}>
                          <div style={{ color: '#475569' }}>Total Operating Expenses</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#475569' }}>${p.totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          ))}
                        </div>
                        
                        {/* Operating Income */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', marginTop: '8px', fontWeight: '700' }}>
                          <div style={{ color: '#1e40af' }}>Operating Income</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#1e40af' }}>${p.operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          ))}
                        </div>
                        
                        {/* Other Income/Expense Section */}
                        {periodsData.some(p => p.interestExpense > 0 || p.nonOperatingIncome > 0 || p.extraordinaryItems !== 0) && (
                          <>
                            <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 0 4px 0', fontSize: '14px', fontWeight: '600', marginTop: '12px' }}>
                              <div style={{ color: '#475569' }}>Other Income/(Expense)</div>
                              {periodsData.map((p, i) => <div key={i}></div>)}
                            </div>
                            {periodsData.some(p => p.interestExpense > 0) && (
                              <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                                <div style={{ color: '#64748b', paddingLeft: '20px' }}>Interest Expense</div>
                                {periodsData.map((p, i) => (
                                  <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>(${ p.interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</div>
                                ))}
                              </div>
                            )}
                            {periodsData.some(p => p.nonOperatingIncome > 0) && (
                              <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                                <div style={{ color: '#64748b', paddingLeft: '20px' }}>Non-Operating Income</div>
                                {periodsData.map((p, i) => (
                                  <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>${p.nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                ))}
                              </div>
                            )}
                            {periodsData.some(p => p.extraordinaryItems !== 0) && (
                              <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                                <div style={{ color: '#64748b', paddingLeft: '20px' }}>Extraordinary Items</div>
                                {periodsData.map((p, i) => (
                                  <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>
                                    {p.extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(p.extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.extraordinaryItems < 0 ? ')' : ''}
                                  </div>
                                ))}
                              </div>
                            )}
                          </>
                        )}
                        
                        {/* Net Income */}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 110px)`, gap: '4px', padding: '12px 8px', background: '#dcfce7', borderRadius: '4px', marginTop: '12px', fontWeight: '700', fontSize: '15px' }}>
                          <div style={{ color: '#166534' }}>Net Income</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: p.netIncome >= 0 ? '#166534' : '#991b1b' }}>
                              {p.netIncome >= 0 ? '$' : '($'}{Math.abs(p.netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.netIncome < 0 ? ')' : ''}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );
                }
                
                // Single period aggregation (original logic)
                const revenue = periodMonths.reduce((sum, m) => sum + (m.revenue || 0), 0);
                
                const cogsPayroll = periodMonths.reduce((sum, m) => sum + (m.cogsPayroll || 0), 0);
                const cogsOwnerPay = periodMonths.reduce((sum, m) => sum + (m.cogsOwnerPay || 0), 0);
                const cogsContractors = periodMonths.reduce((sum, m) => sum + (m.cogsContractors || 0), 0);
                const cogsMaterials = periodMonths.reduce((sum, m) => sum + (m.cogsMaterials || 0), 0);
                const cogsCommissions = periodMonths.reduce((sum, m) => sum + (m.cogsCommissions || 0), 0);
                const cogsOther = periodMonths.reduce((sum, m) => sum + (m.cogsOther || 0), 0);
                const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                
                const grossProfit = revenue - cogs;
                const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;
                
                const payroll = periodMonths.reduce((sum, m) => sum + (m.payroll || 0), 0);
                const ownerBasePay = periodMonths.reduce((sum, m) => sum + (m.ownerBasePay || 0), 0);
                const ownersRetirement = periodMonths.reduce((sum, m) => sum + (m.ownersRetirement || 0), 0);
                const professionalFees = periodMonths.reduce((sum, m) => sum + (m.professionalFees || 0), 0);
                const rent = periodMonths.reduce((sum, m) => sum + (m.rent || 0), 0);
                const infrastructure = periodMonths.reduce((sum, m) => sum + (m.infrastructure || 0), 0);
                const autoTravel = periodMonths.reduce((sum, m) => sum + (m.autoTravel || 0), 0);
                const insurance = periodMonths.reduce((sum, m) => sum + (m.insurance || 0), 0);
                const salesExpense = periodMonths.reduce((sum, m) => sum + (m.salesExpense || 0), 0);
                const subcontractors = periodMonths.reduce((sum, m) => sum + (m.subcontractors || 0), 0);
                const depreciationAmortization = periodMonths.reduce((sum, m) => sum + (m.depreciationAmortization || 0), 0);
                const marketing = periodMonths.reduce((sum, m) => sum + (m.marketing || 0), 0);
                
                const totalOpex = payroll + ownerBasePay + ownersRetirement + professionalFees + 
                                 rent + infrastructure + autoTravel + insurance + 
                                 salesExpense + subcontractors + depreciationAmortization + marketing;
                
                const operatingIncome = grossProfit - totalOpex;
                const operatingMargin = revenue > 0 ? (operatingIncome / revenue) * 100 : 0;
                
                const interestExpense = periodMonths.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                const nonOperatingIncome = periodMonths.reduce((sum, m) => sum + (m.nonOperatingIncome || 0), 0);
                const extraordinaryItems = periodMonths.reduce((sum, m) => sum + (m.extraordinaryItems || 0), 0);
                
                const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                const netMargin = revenue > 0 ? (netIncome / revenue) * 100 : 0;
                
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                      <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Income Statement</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>For the Period: {periodLabel}</div>
                      </div>

                      {/* Revenue Section */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e2e8f0' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Revenue</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* COGS Section */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Cost of Goods Sold</div>
                        {cogsPayroll > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Payroll</span>
                            <span style={{ color: '#475569' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsOwnerPay > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Owner Pay</span>
                            <span style={{ color: '#475569' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsContractors > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Contractors</span>
                            <span style={{ color: '#475569' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsMaterials > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Materials</span>
                            <span style={{ color: '#475569' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsCommissions > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Commissions</span>
                            <span style={{ color: '#475569' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {cogsOther > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>COGS - Other</span>
                            <span style={{ color: '#475569' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Total COGS</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Gross Profit */}
                      <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', color: '#1e40af' }}>Gross Profit</span>
                          <span style={{ fontWeight: '700', color: '#1e40af' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                        <div style={{ fontSize: '13px', color: '#1e40af', textAlign: 'right' }}>
                          {grossMargin.toFixed(1)}% margin
                        </div>
                      </div>

                      {/* Operating Expenses */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Operating Expenses</div>
                        {payroll > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Payroll</span>
                            <span style={{ color: '#475569' }}>${payroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {ownerBasePay > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Owner's Base Pay</span>
                            <span style={{ color: '#475569' }}>${ownerBasePay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {ownersRetirement > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Owner's Retirement</span>
                            <span style={{ color: '#475569' }}>${ownersRetirement.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {professionalFees > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Professional Services</span>
                            <span style={{ color: '#475569' }}>${professionalFees.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {rent > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Rent/Lease</span>
                            <span style={{ color: '#475569' }}>${rent.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {infrastructure > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Infrastructure</span>
                            <span style={{ color: '#475569' }}>${infrastructure.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {autoTravel > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Auto & Travel</span>
                            <span style={{ color: '#475569' }}>${autoTravel.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {insurance > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Insurance</span>
                            <span style={{ color: '#475569' }}>${insurance.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {salesExpense > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Sales & Marketing</span>
                            <span style={{ color: '#475569' }}>${salesExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {subcontractors > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Contractors - Distribution</span>
                            <span style={{ color: '#475569' }}>${subcontractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {depreciationAmortization > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Depreciation & Amortization</span>
                            <span style={{ color: '#475569' }}>${depreciationAmortization.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {marketing > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Other Operating Expenses</span>
                            <span style={{ color: '#475569' }}>${marketing.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid #e2e8f0', marginTop: '4px' }}>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>Total Operating Expenses</span>
                          <span style={{ fontWeight: '600', color: '#1e293b' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Operating Income */}
                      <div style={{ marginBottom: '12px', background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', color: '#1e40af' }}>Operating Income</span>
                          <span style={{ fontWeight: '700', color: '#1e40af' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                        <div style={{ fontSize: '13px', color: '#1e40af', textAlign: 'right' }}>
                          {operatingMargin.toFixed(1)}% operating margin
                        </div>
                      </div>

                      {/* Other Income/Expense */}
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Other Income/(Expense)</div>
                        {interestExpense > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Interest Expense</span>
                            <span style={{ color: '#475569' }}>(${ interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</span>
                          </div>
                        )}
                        {nonOperatingIncome > 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Non-Operating Income</span>
                            <span style={{ color: '#475569' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {extraordinaryItems !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0 6px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#475569' }}>Extraordinary Items</span>
                            <span style={{ color: '#475569' }}>{extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}</span>
                          </div>
                        )}
                      </div>

                      {/* Net Income */}
                      <div style={{ background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', padding: '16px', borderRadius: '8px', marginTop: '24px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>Net Income</span>
                          <span style={{ fontWeight: '700', fontSize: '18px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>
                            {netIncome >= 0 ? '$' : '($'}{Math.abs(netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{netIncome < 0 ? ')' : ''}
                          </span>
                        </div>
                        <div style={{ fontSize: '14px', color: netIncome >= 0 ? '#166534' : '#991b1b', textAlign: 'right' }}>
                          {netMargin.toFixed(1)}% net margin
                        </div>
                      </div>
                  </div>
                );
              }
              
              // COMMON SIZE INCOME STATEMENT - Aggregate with percentages
              else if (statementType === 'income-statement-percent') {
                // Check if showing multiple periods side-by-side
                if (displayPeriods.length > 1) {
                  const calc = (months: any[], field: string) => months.reduce((sum, m) => sum + (m[field] || 0), 0);
                  const periodsData = displayPeriods.map(p => {
                    const m = p.months;
                    const revenue = calc(m, 'revenue');
                    const cogsPayroll = calc(m, 'cogsPayroll');
                    const cogsOwnerPay = calc(m, 'cogsOwnerPay');
                    const cogsContractors = calc(m, 'cogsContractors');
                    const cogsMaterials = calc(m, 'cogsMaterials');
                    const cogsCommissions = calc(m, 'cogsCommissions');
                    const cogsOther = calc(m, 'cogsOther');
                    const payroll = calc(m, 'payroll');
                    const ownerBasePay = calc(m, 'ownerBasePay');
                    const ownersRetirement = calc(m, 'ownersRetirement');
                    const professionalFees = calc(m, 'professionalFees');
                    const rent = calc(m, 'rent');
                    const infrastructure = calc(m, 'utilities');
                    const autoTravel = calc(m, 'travel');
                    const insurance = calc(m, 'insurance');
                    const salesExpense = calc(m, 'salesExpense');
                    const subcontractors = calc(m, 'subcontractors');
                    const depreciationAmortization = calc(m, 'depreciationAmortization');
                    const marketing = calc(m, 'marketing');
                    const interestExpense = calc(m, 'interestExpense');
                    const nonOperatingIncome = calc(m, 'nonOperatingIncome');
                    const extraordinaryItems = calc(m, 'extraordinaryItems');
                    const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                    const totalOpex = payroll + ownerBasePay + ownersRetirement + professionalFees + rent + infrastructure + autoTravel + insurance + salesExpense + subcontractors + depreciationAmortization + marketing;
                    const grossProfit = revenue - cogs;
                    const operatingIncome = grossProfit - totalOpex;
                    const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                    return { label: p.label, revenue, cogsPayroll, cogsOwnerPay, cogsContractors, cogsMaterials, cogsCommissions, cogsOther, cogs, grossProfit, payroll, ownerBasePay, ownersRetirement, professionalFees, rent, infrastructure, autoTravel, insurance, salesExpense, subcontractors, depreciationAmortization, marketing, totalOpex, operatingIncome, interestExpense, nonOperatingIncome, extraordinaryItems, netIncome };
                  });
                  const RowWithPercent = ({ label, values, indent = 0, bold = false }: any) => (
                    <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '4px 0', fontSize: bold ? '14px' : '13px', fontWeight: bold ? '600' : 'normal' }}>
                      <div style={{ color: bold ? '#475569' : '#64748b', paddingLeft: `${indent}px` }}>{label}</div>
                      {values.map((v: number, i: number) => {
                        const pct = periodsData[i].revenue > 0 ? (v / periodsData[i].revenue) * 100 : 0;
                        return (
                          <div key={i} style={{ display: 'contents' }}>
                            <div style={{ textAlign: 'right', color: bold ? '#475569' : '#64748b' }}>${v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b', fontSize: '12px' }}>{pct.toFixed(1)}%</div>
                          </div>
                        );
                      })}
                    </div>
                  );
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', overflowX: 'auto' }}>
                      <div style={{ marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Comparative Common Size Income Statement</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>{periodLabel} - {statementDisplay === 'monthly' ? 'Monthly' : statementDisplay === 'quarterly' ? 'Quarterly' : 'Annual'}</div>
                      </div>
                      <div style={{ minWidth: `${200 + (periodsData.length * 150)}px` }}>
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '12px 0', borderBottom: '2px solid #1e293b', fontWeight: '600', color: '#1e293b' }}>
                          <div>Line Item</div>
                          {periodsData.map((p, i) => (
                            <div key={i} style={{ display: 'contents' }}>
                              <div style={{ textAlign: 'right' }}>{p.label}</div>
                              <div style={{ textAlign: 'right', fontSize: '12px' }}>% of Rev</div>
                            </div>
                          ))}
                        </div>
                        <RowWithPercent label="Revenue" values={periodsData.map(p => p.revenue)} bold />
                        <div style={{ margin: '8px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Cost of Goods Sold</div>
                        {periodsData.some(p => p.cogsPayroll > 0) && <RowWithPercent label="COGS - Payroll" values={periodsData.map(p => p.cogsPayroll)} indent={20} />}
                        {periodsData.some(p => p.cogsOwnerPay > 0) && <RowWithPercent label="COGS - Owner Pay" values={periodsData.map(p => p.cogsOwnerPay)} indent={20} />}
                        {periodsData.some(p => p.cogsContractors > 0) && <RowWithPercent label="COGS - Contractors" values={periodsData.map(p => p.cogsContractors)} indent={20} />}
                        {periodsData.some(p => p.cogsMaterials > 0) && <RowWithPercent label="COGS - Materials" values={periodsData.map(p => p.cogsMaterials)} indent={20} />}
                        {periodsData.some(p => p.cogsCommissions > 0) && <RowWithPercent label="COGS - Commissions" values={periodsData.map(p => p.cogsCommissions)} indent={20} />}
                        {periodsData.some(p => p.cogsOther > 0) && <RowWithPercent label="COGS - Other" values={periodsData.map(p => p.cogsOther)} indent={20} />}
                        <RowWithPercent label="Total COGS" values={periodsData.map(p => p.cogs)} bold />
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>Gross Profit</div>
                          {periodsData.map((p, i) => {
                            const pct = p.revenue > 0 ? (p.grossProfit / p.revenue) * 100 : 0;
                            return (
                              <div key={i} style={{ display: 'contents' }}>
                                <div style={{ textAlign: 'right' }}>${p.grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style={{ textAlign: 'right', fontSize: '12px' }}>{pct.toFixed(1)}%</div>
                              </div>
                            );
                          })}
                        </div>
                        <div style={{ margin: '12px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Operating Expenses</div>
                        {(() => {
                          // Define all possible expense fields with their display names
                          const expenseFieldDefinitions = [
                            // Operating Expenses - Complete list in correct order
                            { key: 'payroll', label: 'Payroll' },
                            { key: 'benefits', label: 'Benefits' },
                            { key: 'insurance', label: 'Insurance' },
                            { key: 'professionalFees', label: 'Professional Services' },
                            { key: 'subcontractors', label: 'Subcontractors' },
                            { key: 'rent', label: 'Rent/Lease' },
                            { key: 'taxLicense', label: 'Tax & License' },
                            { key: 'phoneComm', label: 'Phone & Communication' },
                            { key: 'infrastructure', label: 'Infrastructure/Utilities' },
                            { key: 'autoTravel', label: 'Auto & Travel' },
                            { key: 'salesExpense', label: 'Sales & Marketing' },
                            { key: 'marketing', label: 'Marketing' },
                            { key: 'mealsEntertainment', label: 'Meals & Entertainment' },
                            { key: 'otherExpense', label: 'Other Expenses' }
                          ];

                          // Render only fields that have values in at least one period
                          return expenseFieldDefinitions.map(fieldDef => {
                            const hasValue = periodsData.some(p => (p[fieldDef.key as keyof typeof p] as number) > 0);
                            if (hasValue) {
                              return (
                                <RowWithPercent
                                  key={fieldDef.key}
                                  label={fieldDef.label}
                                  values={periodsData.map(p => p[fieldDef.key as keyof typeof p] as number)}
                                  indent={20}
                                />
                              );
                            }
                            return null;
                          });
                        })()}
                        <RowWithPercent label="Total Operating Expenses" values={periodsData.map(p => p.totalOpex)} bold />
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>Operating Income</div>
                          {periodsData.map((p, i) => {
                            const pct = p.revenue > 0 ? (p.operatingIncome / p.revenue) * 100 : 0;
                            return (
                              <div key={i} style={{ display: 'contents' }}>
                                <div style={{ textAlign: 'right' }}>${p.operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style={{ textAlign: 'right', fontSize: '12px' }}>{pct.toFixed(1)}%</div>
                              </div>
                            );
                          })}
                        </div>
                        {periodsData.some(p => p.interestExpense > 0 || p.nonOperatingIncome > 0 || p.extraordinaryItems !== 0) && (
                          <>
                            <div style={{ margin: '12px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Other Income/(Expense)</div>
                            {periodsData.some(p => p.interestExpense > 0) && <RowWithPercent label="Interest Expense" values={periodsData.map(p => -p.interestExpense)} indent={20} />}
                            {periodsData.some(p => p.nonOperatingIncome > 0) && <RowWithPercent label="Non-Operating Income" values={periodsData.map(p => p.nonOperatingIncome)} indent={20} />}
                            {periodsData.some(p => p.extraordinaryItems !== 0) && <RowWithPercent label="Extraordinary Items" values={periodsData.map(p => p.extraordinaryItems)} indent={20} />}
                          </>
                        )}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${periodsData.length}, 90px 60px)`, gap: '4px', padding: '12px 8px', background: '#dcfce7', borderRadius: '4px', margin: '12px 0 0', fontWeight: '700', fontSize: '15px' }}>
                          <div style={{ color: '#166534' }}>Net Income</div>
                          {periodsData.map((p, i) => {
                            const pct = p.revenue > 0 ? (p.netIncome / p.revenue) * 100 : 0;
                            return (
                              <div key={i} style={{ display: 'contents' }}>
                                <div style={{ textAlign: 'right', color: p.netIncome >= 0 ? '#166534' : '#991b1b' }}>
                                  {p.netIncome >= 0 ? '$' : '($'}{Math.abs(p.netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.netIncome < 0 ? ')' : ''}
                                </div>
                                <div style={{ textAlign: 'right', fontSize: '12px', color: p.netIncome >= 0 ? '#166534' : '#991b1b' }}>{pct.toFixed(1)}%</div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );
                }
                
                const revenue = periodMonths.reduce((sum, m) => sum + (m.revenue || 0), 0);
                
                const cogsPayroll = periodMonths.reduce((sum, m) => sum + (m.cogsPayroll || 0), 0);
                const cogsOwnerPay = periodMonths.reduce((sum, m) => sum + (m.cogsOwnerPay || 0), 0);
                const cogsContractors = periodMonths.reduce((sum, m) => sum + (m.cogsContractors || 0), 0);
                const cogsMaterials = periodMonths.reduce((sum, m) => sum + (m.cogsMaterials || 0), 0);
                const cogsCommissions = periodMonths.reduce((sum, m) => sum + (m.cogsCommissions || 0), 0);
                const cogsOther = periodMonths.reduce((sum, m) => sum + (m.cogsOther || 0), 0);
                const cogs = cogsPayroll + cogsOwnerPay + cogsContractors + cogsMaterials + cogsCommissions + cogsOther;
                
                const grossProfit = revenue - cogs;

                // Dynamically calculate operating expense fields only - Complete list matching DataReviewTab
                const expenseFields = [
                  'payroll', 'benefits', 'insurance', 'professionalFees', 'subcontractors',
                  'rent', 'taxLicense', 'phoneComm', 'infrastructure', 'autoTravel',
                  'salesExpense', 'marketing', 'mealsEntertainment', 'otherExpense'
                ];

                const expenses: { [key: string]: number } = {};
                expenseFields.forEach(field => {
                  expenses[field] = periodMonths.reduce((sum, m) => sum + (m[field] || 0), 0);
                });

                // Calculate total operating expenses dynamically
                const totalOpex = Object.values(expenses).reduce((sum, value) => sum + value, 0);
                
                const operatingIncome = grossProfit - totalOpex;
                
                const interestExpense = periodMonths.reduce((sum, m) => sum + (m.interestExpense || 0), 0);
                const nonOperatingIncome = periodMonths.reduce((sum, m) => sum + (m.nonOperatingIncome || 0), 0);
                const extraordinaryItems = periodMonths.reduce((sum, m) => sum + (m.extraordinaryItems || 0), 0);
                
                const netIncome = operatingIncome - interestExpense + nonOperatingIncome + extraordinaryItems;
                
                const calcPercent = (value: number) => revenue > 0 ? ((value / revenue) * 100).toFixed(1) + '%' : '0.0%';
                
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                      <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Common Size Income Statement</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>For the Period: {periodLabel}</div>
                      </div>

                      {/* Header Row */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '12px 0', borderBottom: '2px solid #1e293b', marginBottom: '16px', fontWeight: '600', color: '#1e293b' }}>
                        <div>Line Item</div>
                        <div style={{ textAlign: 'right' }}>Amount</div>
                        <div style={{ textAlign: 'right' }}>% of Revenue</div>
                      </div>

                      {/* Revenue */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '8px 0', borderBottom: '1px solid #e2e8f0', fontWeight: '600' }}>
                        <div style={{ color: '#1e293b' }}>Revenue</div>
                        <div style={{ textAlign: 'right', color: '#1e293b' }}>${revenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        <div style={{ textAlign: 'right', color: '#1e293b' }}>100.0%</div>
                      </div>

                      {/* COGS */}
                      <div style={{ marginTop: '16px' }}>
                        <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px', fontSize: '14px' }}>Cost of Goods Sold</div>
                        {cogsPayroll > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                            <div style={{ color: '#64748b' }}>COGS - Payroll</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsPayroll.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsPayroll)}</div>
                          </div>
                        )}
                        {cogsOwnerPay > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                            <div style={{ color: '#64748b' }}>COGS - Owner Pay</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsOwnerPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsOwnerPay)}</div>
                          </div>
                        )}
                        {cogsContractors > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                            <div style={{ color: '#64748b' }}>COGS - Contractors</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsContractors.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsContractors)}</div>
                          </div>
                        )}
                        {cogsMaterials > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                            <div style={{ color: '#64748b' }}>COGS - Materials</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsMaterials.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsMaterials)}</div>
                          </div>
                        )}
                        {cogsCommissions > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                            <div style={{ color: '#64748b' }}>COGS - Commissions</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsCommissions.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsCommissions)}</div>
                          </div>
                        )}
                        {cogsOther > 0 && (
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                            <div style={{ color: '#64748b' }}>COGS - Other</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>${cogsOther.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(cogsOther)}</div>
                          </div>
                        )}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '8px 0', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                          <div style={{ color: '#475569' }}>Total COGS</div>
                          <div style={{ textAlign: 'right', color: '#475569' }}>${cogs.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          <div style={{ textAlign: 'right', color: '#475569' }}>{calcPercent(cogs)}</div>
                        </div>
                      </div>

                      {/* Gross Profit */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '12px 8px', background: '#dbeafe', borderRadius: '6px', margin: '16px 0', fontWeight: '700', color: '#1e40af' }}>
                        <div>Gross Profit</div>
                        <div style={{ textAlign: 'right' }}>${grossProfit.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        <div style={{ textAlign: 'right' }}>{calcPercent(grossProfit)}</div>
                      </div>

                      {/* Operating Expenses */}
                      <div style={{ marginTop: '16px' }}>
                        <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px', fontSize: '14px' }}>Operating Expenses</div>
                        {(() => {
                          // Define all possible expense fields with their display names
                          const expenseFieldDefinitions = [
                            // Operating Expenses - Complete list in correct order
                            { key: 'payroll', label: 'Payroll' },
                            { key: 'benefits', label: 'Benefits' },
                            { key: 'insurance', label: 'Insurance' },
                            { key: 'professionalFees', label: 'Professional Services' },
                            { key: 'subcontractors', label: 'Subcontractors' },
                            { key: 'rent', label: 'Rent/Lease' },
                            { key: 'taxLicense', label: 'Tax & License' },
                            { key: 'phoneComm', label: 'Phone & Communication' },
                            { key: 'infrastructure', label: 'Infrastructure/Utilities' },
                            { key: 'autoTravel', label: 'Auto & Travel' },
                            { key: 'salesExpense', label: 'Sales & Marketing' },
                            { key: 'marketing', label: 'Marketing' },
                            { key: 'mealsEntertainment', label: 'Meals & Entertainment' },
                            { key: 'otherExpense', label: 'Other Expenses' }
                          ];

                          // Render only fields that have values > 0
                          return expenseFieldDefinitions.map(fieldDef => {
                            const value = expenses[fieldDef.key] || 0;
                            if (value > 0) {
                              return (
                                <div key={fieldDef.key} style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                                  <div style={{ color: '#64748b' }}>{fieldDef.label}</div>
                                  <div style={{ textAlign: 'right', color: '#64748b' }}>${value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                  <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(value)}</div>
                                </div>
                              );
                            }
                            return null;
                          });
                        })()}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '8px 0', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                          <div style={{ color: '#475569' }}>Total Operating Expenses</div>
                          <div style={{ textAlign: 'right', color: '#475569' }}>${totalOpex.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                          <div style={{ textAlign: 'right', color: '#475569' }}>{calcPercent(totalOpex)}</div>
                        </div>
                      </div>

                      {/* Operating Income */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '12px 8px', background: '#dbeafe', borderRadius: '6px', margin: '16px 0', fontWeight: '700', color: '#1e40af' }}>
                        <div>Operating Income</div>
                        <div style={{ textAlign: 'right' }}>${operatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        <div style={{ textAlign: 'right' }}>{calcPercent(operatingIncome)}</div>
                      </div>

                      {/* Other Income/Expense */}
                      {(interestExpense > 0 || nonOperatingIncome > 0 || extraordinaryItems !== 0) && (
                        <div style={{ marginTop: '16px' }}>
                          <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px', fontSize: '14px' }}>Other Income/(Expense)</div>
                          {interestExpense > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Interest Expense</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>(${ interestExpense.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })})</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>({calcPercent(interestExpense)})</div>
                            </div>
                          )}
                          {nonOperatingIncome > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Non-Operating Income</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>${nonOperatingIncome.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>{calcPercent(nonOperatingIncome)}</div>
                            </div>
                          )}
                          {extraordinaryItems !== 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '4px 0 4px 20px', fontSize: '13px' }}>
                              <div style={{ color: '#64748b' }}>Extraordinary Items</div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>
                                {extraordinaryItems >= 0 ? '$' : '($'}{Math.abs(extraordinaryItems).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{extraordinaryItems < 0 ? ')' : ''}
                              </div>
                              <div style={{ textAlign: 'right', color: '#64748b' }}>
                                {extraordinaryItems >= 0 ? calcPercent(extraordinaryItems) : `(${calcPercent(Math.abs(extraordinaryItems))})`}
                              </div>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Net Income */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 0.7fr 0.7fr', gap: '16px', padding: '16px 8px', background: netIncome >= 0 ? '#dcfce7' : '#fee2e2', borderRadius: '6px', marginTop: '24px', fontWeight: '700', fontSize: '16px', color: netIncome >= 0 ? '#166534' : '#991b1b' }}>
                        <div>Net Income</div>
                        <div style={{ textAlign: 'right' }}>
                          {netIncome >= 0 ? '$' : '($'}{Math.abs(netIncome).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{netIncome < 0 ? ')' : ''}
                        </div>
                        <div style={{ textAlign: 'right' }}>{calcPercent(netIncome)}</div>
                      </div>
                  </div>
                );
              }
              
              // BALANCE SHEET - Latest point in time
              else if (statementType === 'balance-sheet') {
                // Check if showing multiple periods side-by-side
                if (displayPeriods.length > 1) {
                  const balanceData = displayPeriods.map(p => {
                    const latest = p.months[p.months.length - 1];
                    
                    // Assets - Use Data Review fields and imported totals
                    const cash = latest.cash || 0;
                    const ar = latest.ar || 0;
                    const inventory = latest.inventory || 0;
                    const otherCA = latest.otherCA || 0;
                    const tca = latest.tca || 0;  // Use imported total
                    
                    const fixedAssets = latest.fixedAssets || 0;
                    const otherAssets = latest.otherAssets || 0;
                    const totalAssets = latest.totalAssets || 0;  // Use imported total
                    
                    // Liabilities - Use Data Review fields and imported totals
                    const ap = latest.ap || 0;
                    const otherCL = latest.otherCL || 0;
                    const tcl = latest.tcl || 0;  // Use imported total
                    
                    const ltd = latest.ltd || 0;
                    const totalLiabilities = latest.totalLiab || 0;  // Use imported total
                    
                    // Equity - All detail fields
                    const ownersCapital = latest.ownersCapital || 0;
                    const ownersDraw = latest.ownersDraw || 0;
                    const commonStock = latest.commonStock || 0;
                    const preferredStock = latest.preferredStock || 0;
                    const retainedEarnings = latest.retainedEarnings || 0;
                    const additionalPaidInCapital = latest.additionalPaidInCapital || 0;
                    const treasuryStock = latest.treasuryStock || 0;
                    const paidInCapital = latest.paidInCapital || 0;
                    // Calculate Total Equity from detail fields to match Data Review page
                    const totalEquity = ownersCapital + ownersDraw + commonStock + preferredStock + retainedEarnings + additionalPaidInCapital + treasuryStock;
                    
                    // Calculate Total Liabilities & Equity to match Data Review page (do NOT use imported totalLAndE)
                    const totalLAndE = totalLiabilities + totalEquity;
                    
                    return { label: p.label, cash, ar, inventory, otherCA, tca, fixedAssets, otherAssets, totalAssets, ap, otherCL, tcl, ltd, totalLiabilities, ownersCapital, ownersDraw, commonStock, preferredStock, retainedEarnings, additionalPaidInCapital, treasuryStock, paidInCapital, totalEquity, totalLAndE };
                  });
                  const Row = ({ label, values, indent = 0, bold = false }: any) => (
                    <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: bold ? '14px' : '13px', fontWeight: bold ? '600' : 'normal' }}>
                      <div style={{ color: bold ? '#475569' : '#64748b', paddingLeft: `${indent}px` }}>{label}</div>
                      {values.map((v: number, i: number) => (
                        <div key={i} style={{ textAlign: 'right', color: bold ? '#475569' : '#64748b' }}>${(v || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                      ))}
                    </div>
                  );
                  return (
                    <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', overflowX: 'auto' }}>
                      <div style={{ marginBottom: '12px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Comparative Balance Sheet</h2>
                        <div style={{ fontSize: '14px', color: '#64748b' }}>{periodLabel} - {statementDisplay === 'monthly' ? 'Monthly' : statementDisplay === 'quarterly' ? 'Quarterly' : 'Annual'}</div>
                      </div>
                      <div style={{ minWidth: `${200 + (balanceData.length * 110)}px` }}>
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 0', borderBottom: '2px solid #1e293b', fontWeight: '600', color: '#1e293b' }}>
                          <div>Line Item</div>
                          {balanceData.map((p, i) => <div key={i} style={{ textAlign: 'right' }}>{p.label}</div>)}
                        </div>
                        <div style={{ margin: '8px 0 4px', fontSize: '15px', fontWeight: '700', color: '#1e293b' }}>ASSETS</div>
                        <div style={{ margin: '8px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Current Assets</div>
                        {balanceData.some(p => p.cash !== 0) && <Row label="Cash" values={balanceData.map(p => p.cash)} indent={20} />}
                        {balanceData.some(p => p.ar !== 0) && <Row label="Accounts Receivable" values={balanceData.map(p => p.ar)} indent={20} />}
                        {balanceData.some(p => p.inventory !== 0) && <Row label="Inventory" values={balanceData.map(p => p.inventory)} indent={20} />}
                        {balanceData.some(p => p.otherCA !== 0) && <Row label="Other Current Assets" values={balanceData.map(p => p.otherCA)} indent={20} />}
                        <Row label="Total Current Assets" values={balanceData.map(p => p.tca)} bold />
                        {balanceData.some(p => p.fixedAssets !== 0) && <Row label="Fixed Assets" values={balanceData.map(p => p.fixedAssets)} />}
                        {balanceData.some(p => p.otherAssets !== 0) && <Row label="Other Assets" values={balanceData.map(p => p.otherAssets)} />}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#dbeafe', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#1e40af' }}>
                          <div>TOTAL ASSETS</div>
                          {balanceData.map((p, i) => <div key={i} style={{ textAlign: 'right' }}>${p.totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>)}
                        </div>
                        <div style={{ margin: '12px 0 4px', fontSize: '15px', fontWeight: '700', color: '#1e293b' }}>LIABILITIES</div>
                        <div style={{ margin: '8px 0 4px', fontSize: '14px', fontWeight: '600', color: '#475569' }}>Current Liabilities</div>
                        {balanceData.some(p => p.ap !== 0) && <Row label="Accounts Payable" values={balanceData.map(p => p.ap)} indent={20} />}
                        {balanceData.some(p => p.otherCL !== 0) && <Row label="Other Current Liabilities" values={balanceData.map(p => p.otherCL)} indent={20} />}
                        <Row label="Total Current Liabilities" values={balanceData.map(p => p.tcl)} bold />
                        {balanceData.some(p => p.ltd !== 0) && <Row label="Long-Term Debt" values={balanceData.map(p => p.ltd)} />}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '10px 8px', background: '#fef3c7', borderRadius: '4px', margin: '8px 0', fontWeight: '700', color: '#92400e' }}>
                          <div>TOTAL LIABILITIES</div>
                          {balanceData.map((p, i) => <div key={i} style={{ textAlign: 'right' }}>${p.totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>)}
                        </div>
                        <div style={{ margin: '12px 0 4px', fontSize: '15px', fontWeight: '700', color: '#1e293b' }}>EQUITY</div>
                        {balanceData.some(p => p.ownersCapital !== 0) && <Row label="Owner's Capital" values={balanceData.map(p => p.ownersCapital)} indent={20} />}
                        {balanceData.some(p => p.ownersDraw !== 0) && <Row label="Owner's Draw" values={balanceData.map(p => p.ownersDraw)} indent={20} />}
                        {balanceData.some(p => p.commonStock !== 0) && <Row label="Common Stock" values={balanceData.map(p => p.commonStock)} indent={20} />}
                        {balanceData.some(p => p.preferredStock !== 0) && <Row label="Preferred Stock" values={balanceData.map(p => p.preferredStock)} indent={20} />}
                        {balanceData.some(p => p.retainedEarnings !== 0) && (
                          <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '4px 0', fontSize: '13px' }}>
                            <div style={{ color: '#64748b', paddingLeft: '20px' }}>Retained Earnings</div>
                            {balanceData.map((p, i) => (
                              <div key={i} style={{ textAlign: 'right', color: '#64748b' }}>
                                {p.retainedEarnings >= 0 ? '$' : '($'}{Math.abs(p.retainedEarnings).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.retainedEarnings < 0 ? ')' : ''}
                              </div>
                            ))}
                          </div>
                        )}
                        {balanceData.some(p => p.additionalPaidInCapital !== 0) && <Row label="Additional Paid-In Capital" values={balanceData.map(p => p.additionalPaidInCapital)} indent={20} />}
                        {balanceData.some(p => p.treasuryStock !== 0) && <Row label="Treasury Stock" values={balanceData.map(p => p.treasuryStock)} indent={20} />}
                        {balanceData.some(p => p.paidInCapital !== 0) && <Row label="Paid-in Capital" values={balanceData.map(p => p.paidInCapital)} indent={20} />}
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 8px', background: '#dcfce7', borderRadius: '4px', margin: '12px 0 0', fontWeight: '700', fontSize: '15px' }}>
                          <div style={{ color: '#166534' }}>TOTAL EQUITY</div>
                          {balanceData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: p.totalEquity >= 0 ? '#166534' : '#991b1b' }}>
                              {p.totalEquity >= 0 ? '$' : '($'}{Math.abs(p.totalEquity).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{p.totalEquity < 0 ? ')' : ''}
                            </div>
                          ))}
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: `180px repeat(${balanceData.length}, 110px)`, gap: '4px', padding: '12px 8px', background: '#f1f5f9', borderRadius: '4px', margin: '16px 0 0', fontWeight: '700', fontSize: '15px' }}>
                          <div style={{ color: '#1e293b' }}>TOTAL LIABILITIES & EQUITY</div>
                          {balanceData.map((p, i) => (
                            <div key={i} style={{ textAlign: 'right', color: '#1e293b' }}>
                              ${p.totalLAndE.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );
                }
                
                // For balance sheet, use Data Review fields and imported totals
                const cash = latestMonth.cash || 0;
                const ar = latestMonth.ar || 0;
                const inventory = latestMonth.inventory || 0;
                const otherCA = latestMonth.otherCA || 0;
                const tca = latestMonth.tca || 0;  // Use imported total
                
                const fixedAssets = latestMonth.fixedAssets || 0;
                const otherAssets = latestMonth.otherAssets || 0;
                const totalAssets = latestMonth.totalAssets || 0;  // Use imported total
                
                const ap = latestMonth.ap || 0;
                const otherCL = latestMonth.otherCL || 0;
                const tcl = latestMonth.tcl || 0;  // Use imported total
                
                const ltd = latestMonth.ltd || 0;
                const totalLiabilities = latestMonth.totalLiab || 0;  // Use imported total
                
                // All equity detail fields
                // Equity - Use imported total
                const ownersCapital = latestMonth.ownersCapital || 0;
                const ownersDraw = latestMonth.ownersDraw || 0;
                const commonStock = latestMonth.commonStock || 0;
                const preferredStock = latestMonth.preferredStock || 0;
                const retainedEarnings = latestMonth.retainedEarnings || 0;
                const additionalPaidInCapital = latestMonth.additionalPaidInCapital || 0;
                const treasuryStock = latestMonth.treasuryStock || 0;
                const paidInCapital = latestMonth.paidInCapital || 0;
                const totalEquity = latestMonth.totalEquity || 0;  // Use imported total
                
                const totalLAndE = latestMonth.totalLAndE || 0;  // Use imported total
                
                const latestDate = new Date(latestMonth.date || latestMonth.month);
                const asOfDate = latestDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                
                return (
                  <div style={{ background: 'white', borderRadius: '12px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                    <div style={{ marginBottom: '32px', borderBottom: '2px solid #e2e8f0', paddingBottom: '16px' }}>
                      <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '4px' }}>Balance Sheet</h2>
                      <div style={{ fontSize: '14px', color: '#64748b' }}>As of {asOfDate} (Period: {periodLabel})</div>
                    </div>

                    {/* ASSETS */}
                    <div style={{ marginBottom: '32px' }}>
                      <div style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b', marginBottom: '12px' }}>ASSETS</div>
                      
                      {/* Current Assets */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px' }}>Current Assets</div>
                        {cash !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Cash</span>
                            <span style={{ color: '#64748b' }}>${cash.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {ar !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Accounts Receivable</span>
                            <span style={{ color: '#64748b' }}>${ar.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {inventory !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Inventory</span>
                            <span style={{ color: '#64748b' }}>${inventory.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {otherCA !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Other Current Assets</span>
                            <span style={{ color: '#64748b' }}>${otherCA.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 10px', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                          <span style={{ color: '#475569' }}>Total Current Assets</span>
                          <span style={{ color: '#475569' }}>${tca.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Non-Current Assets */}
                      {fixedAssets !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Fixed Assets</span>
                          <span style={{ color: '#64748b' }}>${fixedAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {otherAssets !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Other Assets</span>
                          <span style={{ color: '#64748b' }}>${otherAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}

                      {/* TOTAL ASSETS */}
                      <div style={{ background: '#dbeafe', padding: '12px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                          <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e40af' }}>TOTAL ASSETS</span>
                          <span style={{ fontWeight: '700', fontSize: '16px', color: '#1e40af' }}>
                            ${totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* LIABILITIES */}
                    <div style={{ marginBottom: '32px' }}>
                      <div style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b', marginBottom: '12px' }}>LIABILITIES</div>
                      
                      {/* Current Liabilities */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontWeight: '600', color: '#475569', marginBottom: '8px' }}>Current Liabilities</div>
                        {ap !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Accounts Payable</span>
                            <span style={{ color: '#64748b' }}>${ap.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        {otherCL !== 0 && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                            <span style={{ color: '#64748b' }}>Other Current Liabilities</span>
                            <span style={{ color: '#64748b' }}>${otherCL.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                          </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0 8px 10px', borderTop: '1px solid #cbd5e1', marginTop: '4px', fontWeight: '600' }}>
                          <span style={{ color: '#475569' }}>Total Current Liabilities</span>
                          <span style={{ color: '#475569' }}>${tcl.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      </div>

                      {/* Long-Term Debt */}
                      {ltd !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Long-Term Debt</span>
                          <span style={{ color: '#64748b' }}>${ltd.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}

                      {/* TOTAL LIABILITIES */}
                      <div style={{ background: '#fef3c7', padding: '12px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                          <span style={{ fontWeight: '700', fontSize: '16px', color: '#92400e' }}>TOTAL LIABILITIES</span>
                          <span style={{ fontWeight: '700', fontSize: '16px', color: '#92400e' }}>
                            ${totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* EQUITY */}
                    <div style={{ marginBottom: '32px' }}>
                      <div style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b', marginBottom: '12px' }}>EQUITY</div>
                      {ownersCapital !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Owner's Capital</span>
                          <span style={{ color: '#64748b' }}>${ownersCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {ownersDraw !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Owner's Draw</span>
                          <span style={{ color: '#64748b' }}>${ownersDraw.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {commonStock !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Common Stock</span>
                          <span style={{ color: '#64748b' }}>${commonStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {preferredStock !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Preferred Stock</span>
                          <span style={{ color: '#64748b' }}>${preferredStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {retainedEarnings !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Retained Earnings</span>
                          <span style={{ color: '#64748b' }}>
                            {retainedEarnings >= 0 ? '$' : '($'}{Math.abs(retainedEarnings).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{retainedEarnings < 0 ? ')' : ''}
                          </span>
                        </div>
                      )}
                      {additionalPaidInCapital !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Additional Paid-In Capital</span>
                          <span style={{ color: '#64748b' }}>${additionalPaidInCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {treasuryStock !== 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Treasury Stock</span>
                          <span style={{ color: '#64748b' }}>${treasuryStock.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      {paidInCapital > 0 && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0 4px 20px', fontSize: '14px' }}>
                          <span style={{ color: '#64748b' }}>Paid-in Capital</span>
                          <span style={{ color: '#64748b' }}>${paidInCapital.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                        </div>
                      )}

                      {/* TOTAL EQUITY */}
                      <div style={{ background: '#dcfce7', padding: '12px', borderRadius: '8px', marginTop: '8px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                          <span style={{ fontWeight: '700', fontSize: '16px', color: '#166534' }}>TOTAL EQUITY</span>
                          <span style={{ fontWeight: '700', fontSize: '16px', color: '#166534' }}>
                            {totalEquity >= 0 ? '$' : '($'}{Math.abs(totalEquity).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}{totalEquity < 0 ? ')' : ''}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* TOTAL LIABILITIES & EQUITY */}
                    <div style={{ background: '#f1f5f9', padding: '16px', borderRadius: '8px', marginTop: '32px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>TOTAL LIABILITIES & EQUITY</span>
                        <span style={{ fontWeight: '700', fontSize: '18px', color: '#1e293b' }}>
                          ${totalLAndE.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                        </span>
                      </div>
                      {Math.abs(totalAssets - totalLAndE) > 0.01 && (
                        <div style={{ fontSize: '12px', color: '#ef4444', marginTop: '8px', textAlign: 'right' }}>
                          ?? Balance check: Assets - (Liabilities + Equity) = ${(totalAssets - totalLAndE).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                        </div>
                      )}
                    </div>
                  </div>
                );
              }
            }
            
            else {
              return (
                <div style={{ background: 'white', borderRadius: '12px', padding: '48px 32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', minHeight: '400px', textAlign: 'center' }}>
                  <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>
                    ðŸ“Š Financial Statement Viewer
                  </div>
                  <p style={{ fontSize: '14px', color: '#94a3b8', maxWidth: '600px', margin: '0 auto' }}>
                    Select options above to view financial statements.
                  </p>
                </div>
              );
            }
          })()}
          </>
          )}

          {/* Line of Business Reporting Tab */}
          {financialStatementsTab === 'line-of-business' && (
            <LOBReportingTab
              company={company}
              selectedCompanyId={selectedCompanyId}
              accountMappings={aiMappings}
              statementType={statementType}
              selectedLineOfBusiness={selectedLineOfBusiness}
              statementPeriod={statementPeriod}
              statementDisplay={statementDisplay}
              onStatementTypeChange={setStatementType}
              onLineOfBusinessChange={setSelectedLineOfBusiness}
              onPeriodChange={setStatementPeriod}
              onDisplayChange={setStatementDisplay}
            />
          )}
        </div>
      )}

      {/* Financial Statements View - No Data Available */}
      {currentView === 'financial-statements' && selectedCompanyId && monthly.length === 0 && (
        <div style={{ maxWidth: '1800px', margin: '0 auto', padding: '32px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Financial Statements</h1>
            {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
          </div>
          <div style={{ background: 'white', borderRadius: '12px', padding: '48px 32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', minHeight: '400px', textAlign: 'center', marginTop: '32px' }}>
            <div style={{ fontSize: '18px', fontWeight: '600', color: '#64748b', marginBottom: '12px' }}>
              ðŸ“Š No Financial Data Available
            </div>
            <p style={{ fontSize: '14px', color: '#94a3b8', maxWidth: '600px', margin: '0 auto' }}>
              Please import financial data via CSV or sync from QuickBooks to view financial statements.
            </p>
          </div>
        </div>
      )}

      {/* Management Assessment - Questionnaire View */}
      {(() => {
        const hasCompanyId = selectedCompanyId || currentUser?.companyId;
        const hasCorrectRole = (currentUser?.role === 'user' && currentUser?.userType === 'assessment') || currentUser?.role === 'consultant';
        const canView = currentView === 'ma-questionnaire' && hasCompanyId && hasCorrectRole;
        
        console.log('ðŸ“‹ Questionnaire render check:', {
          currentView,
          isQuestionnaireView: currentView === 'ma-questionnaire',
          selectedCompanyId,
          userCompanyId: currentUser?.companyId,
          hasCompanyId,
          role: currentUser?.role,
          userType: currentUser?.userType,
          hasCorrectRole,
          canView
        });
        
        return canView;
      })() && (
        <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
            <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', margin: 0 }}>Management Assessment Questionnaire</h1>
            {companyName && <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b' }}>{companyName}</div>}
          </div>
          
          {currentUser?.role === 'consultant' && (
            <div style={{ background: '#fffbeb', border: '2px solid #fbbf24', borderRadius: '12px', padding: '20px', marginBottom: '12px' }}>
              <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#92400e', marginBottom: '8px' }}>? Consultant View Only</h3>
              <p style={{ fontSize: '14px', color: '#78350f', margin: 0 }}>
                As a consultant, you can view this questionnaire but cannot fill it out. Only company users can complete assessments. 
                Navigate to "View Assessments" in the Administrator Dashboard to see user responses.
              </p>
            </div>
          )}
          
          <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)', opacity: currentUser?.role === 'consultant' ? 0.6 : 1, pointerEvents: currentUser?.role === 'consultant' ? 'none' : 'auto' }}>
            <div style={{ background: '#f0f9ff', border: '1px solid #bae6fd', borderRadius: '8px', padding: '16px', marginBottom: '12px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#0c4a6e', marginBottom: '8px' }}>Rating Scale</h3>
              <div style={{ fontSize: '13px', color: '#0c4a6e', lineHeight: '1.6' }}>
                <strong>1:</strong> No evidence to support practices or any knowledge of subject<br />
                <strong>2:</strong> Limited practices in place, limited knowledge of subject<br />
                <strong>3:</strong> Basic practices in place, basic awareness of subject<br />
                <strong>4:</strong> Clear practices in place, above average knowledge of subject<br />
                <strong>5:</strong> Extensive practices in place, extensive knowledge of subject
              </div>
            </div>

            {assessmentData.map((category) => (
              <div key={category.id} style={{ marginBottom: '32px', background: '#f8fafc', borderRadius: '8px', padding: '20px', border: '1px solid #e2e8f0' }}>
                <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#1e293b', marginBottom: '16px', borderBottom: '2px solid #cbd5e1', paddingBottom: '8px' }}>
                  {category.id}. {category.name}
                </h2>
                
                {category.questions.map((question) => (
                  <div key={question.id} style={{ marginBottom: '16px', background: 'white', borderRadius: '8px', padding: '16px', border: unansweredQuestions.includes(question.id) ? '2px solid #ef4444' : '1px solid #e2e8f0' }}>
                    <label style={{ display: 'block', fontSize: '14px', color: '#475569', marginBottom: '12px', fontWeight: '500' }}>
                      {question.text}
                    </label>
                    <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                      {[1, 2, 3, 4, 5].map((rating) => (
                        <label key={rating} style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', padding: '8px 12px', background: assessmentResponses[question.id] === rating ? '#667eea' : '#f1f5f9', color: assessmentResponses[question.id] === rating ? 'white' : '#475569', borderRadius: '6px', fontSize: '14px', fontWeight: '600', border: assessmentResponses[question.id] === rating ? '2px solid #667eea' : '1px solid #cbd5e1', transition: 'all 0.2s' }}>
                          <input 
                            type="radio" 
                            name={question.id} 
                            value={rating} 
                            checked={assessmentResponses[question.id] === rating}
                            onChange={() => setAssessmentResponses(prev => ({ ...prev, [question.id]: rating }))}
                            style={{ display: 'none' }}
                          />
                          {rating}
                        </label>
                      ))}
                    </div>
                    {unansweredQuestions.includes(question.id) && (
                      <div style={{ marginTop: '8px', fontSize: '12px', color: '#ef4444', fontWeight: '600' }}>
                        âš ï¸ Please select a rating
                      </div>
                    )}
                  </div>
                ))}
                
                <div style={{ marginTop: '16px' }}>
                  <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#475569', marginBottom: '8px' }}>
                    Notes for {category.name}:
                  </label>
                  <textarea
                    value={assessmentNotes[category.id] || ''}
                    onChange={(e) => setAssessmentNotes(prev => ({ ...prev, [category.id]: e.target.value }))}
                    style={{ width: '100%', minHeight: '80px', padding: '12px', borderRadius: '8px', border: '1px solid #cbd5e1', fontSize: '14px', fontFamily: 'inherit', resize: 'vertical' }}
                    placeholder="Add notes or action items..."
                  />
                </div>
              </div>
            ))}

            <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', marginTop: '32px' }}>
              <button 
                onClick={async () => {
                  const allQuestions = assessmentData.flatMap(cat => cat.questions.map(q => q.id));
                  const unanswered = allQuestions.filter(qId => !assessmentResponses[qId]);
                  setUnansweredQuestions(unanswered);
                  
                  if (unanswered.length === 0) {
                    setIsLoading(true);
                    try {
                      const totalScore = Object.values(assessmentResponses).reduce((sum, val) => sum + val, 0) / Object.keys(assessmentResponses).length;
                      
                      const { record } = await assessmentsApi.create({
                        userId: currentUser!.id,
                        companyId: selectedCompanyId,
                        responses: assessmentResponses,
                        notes: assessmentNotes,
                        overallScore: totalScore,
                        isCompleted: true
                      });
                      
                      // Add to local state with proper structure
                      const assessmentRecord: AssessmentRecord = {
                        id: record.id,
                        userEmail: currentUser?.email || '',
                        userName: currentUser?.name || '',
                        companyId: selectedCompanyId,
                        companyName: company?.name || '',
                        responses: assessmentResponses,
                        notes: assessmentNotes,
                        completedDate: record.completedAt,
                        overallScore: totalScore
                      };
                      
                      setAssessmentRecords(prev => [...prev, assessmentRecord]);
                      alert('Assessment saved successfully!');
                      setCurrentView('ma-your-results');
                    } catch (error) {
                      alert(error instanceof ApiError ? error.message : 'Failed to save assessment');
                    } finally {
                      setIsLoading(false);
                    }
                  } else {
                    alert(`Please answer all ${unanswered.length} unanswered question(s) before saving.`);
                  }
                }}
                disabled={isLoading}
                style={{ padding: '14px 32px', background: isLoading ? '#94a3b8' : '#667eea', color: 'white', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: isLoading ? 'not-allowed' : 'pointer', boxShadow: '0 4px 12px rgba(102,126,234,0.3)', opacity: isLoading ? 0.7 : 1 }}
              >
                {isLoading ? 'Saving...' : 'Save Assessment'}
              </button>
              <button 
                onClick={() => {
                  if (confirm('Are you sure you want to reset all responses?')) {
                    setAssessmentResponses({});
                    setAssessmentNotes({});
                    setUnansweredQuestions([]);
                  }
                }}
                style={{ padding: '14px 32px', background: '#f1f5f9', color: '#475569', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: 'pointer' }}
              >
                Reset
              </button>
            </div>
          </div>
        </div>
      )}
          </>
          )}

      {/* Management Assessment - Your Results View */}
      {currentView === 'ma-your-results' && selectedCompanyId && ((currentUser?.role === 'user' && currentUser?.userType === 'assessment') || currentUser?.role === 'consultant') && (
        <MAYourResultsView
          selectedCompanyId={selectedCompanyId}
          currentUser={currentUser}
          companyName={companyName}
          assessmentRecords={assessmentRecords}
          assessmentData={assessmentData}
          assessmentResponses={assessmentResponses}
          setCurrentView={setCurrentView}
        />
      )}

      {/* Management Assessment Views - Available to all users including assessment users */}
          {/* Management Assessment - Welcome View */}
      {currentView === 'ma-welcome' && ((currentUser?.role === 'user' && currentUser?.userType === 'assessment') || currentUser?.role === 'consultant') && (
        <MAWelcomeView
          companyName={companyName}
          assessmentData={assessmentData}
          setCurrentView={setCurrentView}
        />
      )}

      {/* Management Assessment - Scores Summary View */}
      {currentView === 'ma-scores-summary' && selectedCompanyId && ((currentUser?.role === 'user' && currentUser?.userType === 'assessment') || currentUser?.role === 'consultant') && (
        <MAScoresSummaryView
          selectedCompanyId={selectedCompanyId}
          assessmentData={assessmentData}
          assessmentRecords={assessmentRecords}
        />
      )}

      {/* Management Assessment - Scoring Guide View */}
      {currentView === 'ma-scoring-guide' && ((currentUser?.role === 'user' && currentUser?.userType === 'assessment') || currentUser?.role === 'consultant') && (
        <MAScoringGuideView />
      )}

      {/* Management Assessment - Charts View */}
      {currentView === 'ma-charts' && selectedCompanyId && ((currentUser?.role === 'user' && currentUser?.userType === 'assessment') || currentUser?.role === 'consultant') && (
        <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px' }}>
          <h1 style={{ fontSize: '32px', fontWeight: '700', color: '#1e293b', marginBottom: '32px' }}>Assessment Charts</h1>
          
          {(currentUser?.role === 'consultant' ? assessmentRecords.filter(r => r.companyId === selectedCompanyId).length === 0 : Object.keys(assessmentResponses).length === 0) ? (
            <div style={{ background: 'white', borderRadius: '12px', padding: '40px', textAlign: 'center', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#64748b', marginBottom: '16px' }}>No Assessment Data</h2>
              <p style={{ fontSize: '16px', color: '#94a3b8', marginBottom: '12px' }}>
                {currentUser?.role === 'consultant' ? 'No users have completed assessments for this company yet.' : 'Please complete the questionnaire first to view charts.'}
              </p>
              {currentUser?.role !== 'consultant' && (
                <button 
                  onClick={() => setCurrentView('ma-questionnaire')}
                  style={{ padding: '12px 32px', background: '#667eea', color: 'white', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: 'pointer' }}
                >
                  Go to Questionnaire
                </button>
              )}
            </div>
          ) : (
            <>
              <div style={{ background: 'white', borderRadius: '12px', padding: '24px', marginBottom: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>
                  {currentUser?.role === 'consultant' ? 'Average Category Scores - All Participants' : 'Category Scores - Bar Chart'}
                </h2>
                
                <div style={{ padding: '20px' }}>
              {assessmentData.map((category) => {
                const categoryQuestions = category.questions.map(q => q.id);
                
                let avgScore = 0;
                if (currentUser?.role === 'consultant') {
                  // Calculate average across all assessment records for this company
                  const companyRecords = assessmentRecords.filter(r => r.companyId === selectedCompanyId);
                  const allCategoryScores = companyRecords.map(record => {
                    const categoryResponses = categoryQuestions.map(qId => record.responses[qId]).filter(r => r !== undefined);
                    return categoryResponses.length > 0 ? categoryResponses.reduce((sum, val) => sum + val, 0) / categoryResponses.length : 0;
                  }).filter(s => s > 0);
                  avgScore = allCategoryScores.length > 0 ? allCategoryScores.reduce((sum, val) => sum + val, 0) / allCategoryScores.length : 0;
                } else {
                  // Use current user's responses
                  const categoryResponses = categoryQuestions.map(qId => assessmentResponses[qId]).filter(r => r !== undefined);
                  avgScore = categoryResponses.length > 0 ? categoryResponses.reduce((sum, val) => sum + val, 0) / categoryResponses.length : 0;
                }
                
                const percentage = (avgScore / 5) * 100;
                
                return (
                  <div key={category.id} style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                      <span style={{ fontSize: '14px', fontWeight: '600', color: '#475569' }}>{category.name}</span>
                      <span style={{ fontSize: '14px', fontWeight: '700', color: '#667eea' }}>{avgScore.toFixed(2)} / 5.0</span>
                    </div>
                    <div style={{ background: '#e2e8f0', borderRadius: '8px', height: '24px', overflow: 'hidden' }}>
                      <div style={{ background: 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)', height: '100%', width: `${percentage}%`, transition: 'width 0.5s', display: 'flex', alignItems: 'center', justifyContent: 'flex-end', paddingRight: '8px' }}>
                        {percentage > 15 && <span style={{ fontSize: '12px', fontWeight: '600', color: 'white' }}>{percentage.toFixed(0)}%</span>}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', marginBottom: '12px' }}>Category Scores - Radar Chart</h2>
            
            <div style={{ display: 'flex', justifyContent: 'center', padding: '20px' }}>
              <svg width="500" height="500" viewBox="0 0 500 500">
                <g transform="translate(250, 250)">
                  {/* Draw concentric circles */}
                  {[1, 2, 3, 4, 5].map((level) => (
                    <circle
                      key={level}
                      cx="0"
                      cy="0"
                      r={level * 40}
                      fill="none"
                      stroke="#e2e8f0"
                      strokeWidth="1"
                    />
                  ))}
                  
                  {/* Draw axis lines and labels */}
                  {assessmentData.map((category, idx) => {
                    const angle = (idx * 2 * Math.PI) / assessmentData.length - Math.PI / 2;
                    const x2 = Math.cos(angle) * 200;
                    const y2 = Math.sin(angle) * 200;
                    const labelX = Math.cos(angle) * 220;
                    const labelY = Math.sin(angle) * 220;
                    
                    return (
                      <g key={category.id}>
                        <line x1="0" y1="0" x2={x2} y2={y2} stroke="#cbd5e1" strokeWidth="1" />
                        <text
                          x={labelX}
                          y={labelY}
                          textAnchor="middle"
                          fontSize="11"
                          fontWeight="600"
                          fill="#475569"
                          dominantBaseline="middle"
                        >
                          {category.name.length > 20 ? category.name.substring(0, 18) + '...' : category.name}
                        </text>
                      </g>
                    );
                  })}
                  
                  {/* Draw data polygon */}
                  <polygon
                    points={assessmentData.map((category, idx) => {
                      const categoryQuestions = category.questions.map(q => q.id);
                      
                      let avgScore = 0;
                      if (currentUser?.role === 'consultant') {
                        // Calculate average across all assessment records for this company
                        const companyRecords = assessmentRecords.filter(r => r.companyId === selectedCompanyId);
                        const allCategoryScores = companyRecords.map(record => {
                          const categoryResponses = categoryQuestions.map(qId => record.responses[qId]).filter(r => r !== undefined);
                          return categoryResponses.length > 0 ? categoryResponses.reduce((sum, val) => sum + val, 0) / categoryResponses.length : 0;
                        }).filter(s => s > 0);
                        avgScore = allCategoryScores.length > 0 ? allCategoryScores.reduce((sum, val) => sum + val, 0) / allCategoryScores.length : 0;
                      } else {
                        // Use current user's responses
                        const categoryResponses = categoryQuestions.map(qId => assessmentResponses[qId]).filter(r => r !== undefined);
                        avgScore = categoryResponses.length > 0 ? categoryResponses.reduce((sum, val) => sum + val, 0) / categoryResponses.length : 0;
                      }
                      
                      const angle = (idx * 2 * Math.PI) / assessmentData.length - Math.PI / 2;
                      const radius = (avgScore / 5) * 200;
                      const x = Math.cos(angle) * radius;
                      const y = Math.sin(angle) * radius;
                      return `${x},${y}`;
                    }).join(' ')}
                    fill="rgba(102, 126, 234, 0.2)"
                    stroke="#667eea"
                    strokeWidth="3"
                  />
                  
                  {/* Draw data points */}
                  {assessmentData.map((category, idx) => {
                    const categoryQuestions = category.questions.map(q => q.id);
                    
                    let avgScore = 0;
                    if (currentUser?.role === 'consultant') {
                      // Calculate average across all assessment records for this company
                      const companyRecords = assessmentRecords.filter(r => r.companyId === selectedCompanyId);
                      const allCategoryScores = companyRecords.map(record => {
                        const categoryResponses = categoryQuestions.map(qId => record.responses[qId]).filter(r => r !== undefined);
                        return categoryResponses.length > 0 ? categoryResponses.reduce((sum, val) => sum + val, 0) / categoryResponses.length : 0;
                      }).filter(s => s > 0);
                      avgScore = allCategoryScores.length > 0 ? allCategoryScores.reduce((sum, val) => sum + val, 0) / allCategoryScores.length : 0;
                    } else {
                      // Use current user's responses
                      const categoryResponses = categoryQuestions.map(qId => assessmentResponses[qId]).filter(r => r !== undefined);
                      avgScore = categoryResponses.length > 0 ? categoryResponses.reduce((sum, val) => sum + val, 0) / categoryResponses.length : 0;
                    }
                    
                    const angle = (idx * 2 * Math.PI) / assessmentData.length - Math.PI / 2;
                    const radius = (avgScore / 5) * 200;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    return (
                      <circle key={category.id} cx={x} cy={y} r="6" fill="#667eea" stroke="white" strokeWidth="2">
                        <title>{category.name}: {avgScore.toFixed(2)}</title>
                      </circle>
                    );
                  })}
                  
                  {/* Center circle with legend */}
                  <circle cx="0" cy="0" r="30" fill="white" stroke="#cbd5e1" strokeWidth="1" />
                  <text x="0" y="-5" textAnchor="middle" fontSize="10" fontWeight="600" fill="#64748b">Scale</text>
                  <text x="0" y="8" textAnchor="middle" fontSize="10" fill="#64748b">1 to 5</text>
                </g>
              </svg>
            </div>
          </div>
            </>
          )}
        </div>
      )}

      {/* Custom Print View - For Consultants and Company Users */}
      {currentView === 'custom-print' && (currentUser?.role === 'consultant' || (currentUser?.role === 'user' && currentUser?.userType === 'company')) && (
        <div style={{ maxWidth: '1000px', margin: '0 auto', padding: '32px' }}>
          <div style={{ background: 'white', borderRadius: '12px', padding: '40px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <h1 style={{ fontSize: '36px', fontWeight: '700', color: '#1e293b', marginBottom: '16px' }}>Custom Print Package</h1>
            <p style={{ fontSize: '16px', color: '#64748b', marginBottom: '32px' }}>
              Select the reports you want to include in your custom print package
            </p>
            
            <div style={{ marginBottom: '32px' }}>
              {/* MD&A Report */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={printPackageSelections.mda}
                    onChange={(e) => setPrintPackageSelections({...printPackageSelections, mda: e.target.checked})}
                    style={{ width: '18px', height: '18px', marginRight: '12px', cursor: 'pointer' }}
                  />
                  <div>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>MD&A (Management Discussion & Analysis)</div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Includes all 3 tabs: Key Metrics, Analysis, and Recommendations</div>
                  </div>
                </label>
              </div>

              {/* Financial Score */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={printPackageSelections.financialScore}
                    onChange={(e) => setPrintPackageSelections({...printPackageSelections, financialScore: e.target.checked})}
                    style={{ width: '18px', height: '18px', marginRight: '12px', cursor: 'pointer' }}
                  />
                  <div>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Financial Score</div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Score summary and trends</div>
                  </div>
                </label>
              </div>

              {/* Priority Ratios */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={printPackageSelections.priorityRatios}
                    onChange={(e) => setPrintPackageSelections({...printPackageSelections, priorityRatios: e.target.checked})}
                    style={{ width: '18px', height: '18px', marginRight: '12px', cursor: 'pointer' }}
                  />
                  <div>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Priority Ratios</div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Key financial ratios and metrics</div>
                  </div>
                </label>
              </div>

              {/* Working Capital */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={printPackageSelections.workingCapital}
                    onChange={(e) => setPrintPackageSelections({...printPackageSelections, workingCapital: e.target.checked})}
                    style={{ width: '18px', height: '18px', marginRight: '12px', cursor: 'pointer' }}
                  />
                  <div>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Working Capital</div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Working capital analysis</div>
                  </div>
                </label>
              </div>

              {/* Dashboard */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={printPackageSelections.dashboard}
                    onChange={(e) => setPrintPackageSelections({...printPackageSelections, dashboard: e.target.checked})}
                    style={{ width: '18px', height: '18px', marginRight: '12px', cursor: 'pointer' }}
                  />
                  <div>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Dashboard</div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Custom dashboard with selected metrics and charts</div>
                  </div>
                </label>
              </div>

              {/* Cash Flow Tabs */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <div style={{ marginBottom: '12px' }}>
                  <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Cash Flow Analysis</div>
                  <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Cash flow reports</div>
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginLeft: '0px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '14px', color: '#475569' }}>
                    <input 
                      type="checkbox" 
                      checked={printPackageSelections.cashFlow4Quarters}
                      onChange={(e) => setPrintPackageSelections({...printPackageSelections, cashFlow4Quarters: e.target.checked})}
                      style={{ width: '16px', height: '16px', marginRight: '8px', cursor: 'pointer' }} 
                    />
                    Last 4 Quarters
                  </label>
                  <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '14px', color: '#475569' }}>
                    <input 
                      type="checkbox" 
                      checked={printPackageSelections.cashFlow3Years}
                      onChange={(e) => setPrintPackageSelections({...printPackageSelections, cashFlow3Years: e.target.checked})}
                      style={{ width: '16px', height: '16px', marginRight: '8px', cursor: 'pointer' }} 
                    />
                    Last 3 Years
                  </label>
                </div>
              </div>

              {/* Financial Statements */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <div>
                  <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Financial Statements</div>
                  <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '12px' }}>Select specific financial statements</div>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginLeft: '0px' }}>
                    {/* Income Statement with sub-options */}
                    <div>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Income Statement</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', marginLeft: '16px' }}>
                        <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '14px', color: '#475569' }}>
                          <input 
                            type="checkbox" 
                            checked={printPackageSelections.incomeStatement12MonthsQuarterly}
                            onChange={(e) => setPrintPackageSelections({...printPackageSelections, incomeStatement12MonthsQuarterly: e.target.checked})}
                            style={{ width: '16px', height: '16px', marginRight: '8px', cursor: 'pointer' }} 
                          />
                          Income Statement, Last 12 months, Quarterly
                        </label>
                        <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '14px', color: '#475569' }}>
                          <input 
                            type="checkbox" 
                            checked={printPackageSelections.incomeStatement3YearsAnnual}
                            onChange={(e) => setPrintPackageSelections({...printPackageSelections, incomeStatement3YearsAnnual: e.target.checked})}
                            style={{ width: '16px', height: '16px', marginRight: '8px', cursor: 'pointer' }} 
                          />
                          Income Statement, Last 3 Years, Annual
                        </label>
                      </div>
                    </div>
                    {/* Balance Sheet with sub-options */}
                    <div style={{ marginTop: '12px' }}>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#1e293b', marginBottom: '8px' }}>Balance Sheet</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', marginLeft: '16px' }}>
                        <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '14px', color: '#475569' }}>
                          <input 
                            type="checkbox" 
                            checked={printPackageSelections.balanceSheet12MonthsQuarterly}
                            onChange={(e) => setPrintPackageSelections({...printPackageSelections, balanceSheet12MonthsQuarterly: e.target.checked})}
                            style={{ width: '16px', height: '16px', marginRight: '8px', cursor: 'pointer' }} 
                          />
                          Balance Sheet, Last 12 months, Quarterly
                        </label>
                        <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '14px', color: '#475569' }}>
                          <input 
                            type="checkbox" 
                            checked={printPackageSelections.balanceSheet3YearsAnnual}
                            onChange={(e) => setPrintPackageSelections({...printPackageSelections, balanceSheet3YearsAnnual: e.target.checked})}
                            style={{ width: '16px', height: '16px', marginRight: '8px', cursor: 'pointer' }} 
                          />
                          Balance Sheet, Last 3 Years, Annual
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Company Profile */}
              <div style={{ marginBottom: '20px', padding: '16px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={printPackageSelections.profile}
                    onChange={(e) => setPrintPackageSelections({...printPackageSelections, profile: e.target.checked})}
                    style={{ width: '18px', height: '18px', marginRight: '12px', cursor: 'pointer' }}
                  />
                  <div>
                    <div style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>Company Profile</div>
                    <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>Business profile, financial overview, ratios, and disclosures</div>
                  </div>
                </label>
              </div>
            </div>

            {/* Action Buttons */}
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', paddingTop: '24px', borderTop: '2px solid #e2e8f0' }}>
              <button
                onClick={handleGeneratePrintPackage}
                style={{
                  padding: '14px 32px',
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  boxShadow: '0 2px 8px rgba(102, 126, 234, 0.3)',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#5568d3'}
                onMouseLeave={(e) => e.currentTarget.style.background = '#667eea'}
              >
                ðŸ–¨ï¸ Generate Print Package
              </button>
              <button
                onClick={() => {
                  setPrintPackageSelections({
                    mda: false,
                    financialScore: false,
                    priorityRatios: false,
                    workingCapital: false,
                    dashboard: false,
                    cashFlow4Quarters: false,
                    cashFlow3Years: false,
                    incomeStatement12MonthsQuarterly: false,
                    incomeStatement3YearsAnnual: false,
                    balanceSheet12MonthsQuarterly: false,
                    balanceSheet3YearsAnnual: false,
                    profile: false
                  });
                }}
                style={{
                  padding: '14px 32px',
                  background: '#f1f5f9',
                  color: '#475569',
                  border: '1px solid #cbd5e1',
                  borderRadius: '8px',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#e2e8f0';
                  e.currentTarget.style.borderColor = '#94a3b8';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = '#f1f5f9';
                  e.currentTarget.style.borderColor = '#cbd5e1';
                }}
              >
                Clear All
              </button>
            </div>

            {/* Info Box */}
            <div style={{ marginTop: '32px', padding: '16px', background: '#eff6ff', border: '1px solid #bfdbfe', borderRadius: '8px' }}>
              <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
                <span style={{ fontSize: '20px' }}>??</span>
                <div style={{ fontSize: '14px', color: '#1e40af', lineHeight: '1.6' }}>
                  <strong>How it works:</strong> Select the reports you want to include, then click "Generate Print Package" to create a combined PDF with all selected reports in a single document ready for printing.
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
        </main>
      </div>

      {/* Delete Company Confirmation Modal - Global (accessible from all views) */}
      {showDeleteConfirmation && companyToDelete && (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999 }}>
          <div style={{ background: 'white', borderRadius: '12px', padding: '32px', maxWidth: '500px', width: '90%', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3)' }}>
            <div style={{ textAlign: 'center', marginBottom: '24px' }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ðŸ—‘ï¸</div>
              <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', marginBottom: '12px' }}>Delete Company</h2>
              <p style={{ fontSize: '16px', color: '#64748b', lineHeight: '1.6' }}>
                Are you sure you want to delete <strong style={{ color: '#ef4444' }}>"{companyToDelete.companyName}"</strong>?
              </p>
              <p style={{ fontSize: '14px', color: '#ef4444', marginTop: '12px', fontWeight: '600' }}>
                This action cannot be undone. All data associated with this company will be permanently deleted.
              </p>
            </div>
            
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
              <button
                onClick={() => {
                  setShowDeleteConfirmation(false);
                  setCompanyToDelete(null);
                }}
                style={{
                  padding: '12px 24px',
                  background: '#f1f5f9',
                  color: '#475569',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#e2e8f0'}
                onMouseLeave={(e) => e.currentTarget.style.background = '#f1f5f9'}
              >
                Cancel
              </button>
              <button
                onClick={handleDeleteCompany}
                style={{
                  padding: '12px 24px',
                  background: '#ef4444',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#dc2626'}
                onMouseLeave={(e) => e.currentTarget.style.background = '#ef4444'}
              >
                Delete Company
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Dynamic import to disable SSR for this complex component
const DynamicFinancialScorePage = dynamic(() => Promise.resolve(FinancialScorePage), {
  ssr: false,
  loading: () => <div>Loading...</div>
});

export default DynamicFinancialScorePage;


